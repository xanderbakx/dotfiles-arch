/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2018 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

*/
function initializeBookmarksPlaceHolder(){"true"==localStorage.getItem("bookmarksEnabled")&&(document.getElementsByClassName("bookmarks-placeholder")[0].style.display="block")}initializeBookmarksPlaceHolder(),window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[]},Backbone.Events),Backbone.View=function(t){return t.extend({constructor:function(e){this.options=e||{},t.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;function getConst(e){var t={classInputLengthError:"invalid-length",minMarginSmoothScroll:50,timeContentItemAnimation:200,timeToggleClassTwice:100,timeSettingsFade:150,timeSmoothScroll:500,weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}[e];return void 0===t&&console.warn("constant not found:",e),t}function getEndPunctuationChars(){return[33,34,39,40,41,46,63,91,93,96,123,125,8216,8217,8220,8221,8230]}function momoInit(){return!0}function validateEmail(e){return/[^@]+@[^@]+\.[^@]+/.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function toggleLocalStorageBool(e){localStorage[e]="true"===localStorage[e]?"false":"true"}function getLocalStorageBool(e){return"true"===localStorage[e]}function getActiveDateString(){return activeDateStringForDate(new Date)}function activeDateStringForDate(e){var t=new Date(e);return t.getHours()<5&&(t=new Date(t.getTime()-864e5)),t.getFullYear().toString()+"-"+twoDigit(t.getMonth()+1)+"-"+twoDigit(t.getDate())}function getWeekdayName(e){return getConst("weekdayNames")[e.getDay()]}function getMonthName(e){return getConst("monthNames")[e.getMonth()]}function getFriendlyDate(e){var t,i,o=new Date;return i=(t=e instanceof Date?e:parseIsoDatetime(e)).getFullYear()===o.getFullYear()?"":", "+t.getFullYear(),getConst("monthNamesShort")[t.getMonth()]+" "+t.getDate()+i}function parseIsoDatetime(e){var t=e.split(/[: T-]/).map(parseFloat);return new Date(t[0],t[1]-1,t[2],t[3]||0,t[4]||0,t[5]||0,0)}function toUTC(e){return new Date(e.getTime()+-6e4*e.getTimezoneOffset())}function replaceLastOccurrence(e,t,i){var o=e.lastIndexOf(t);return o?e.slice(0,o)+e.slice(o).replace(t,i):e}function endsWithEndPunctuation(e){return _.contains(getEndPunctuationChars(),e.charCodeAt(e.length-1))}function capitalizeFirstLetter(e){return e.slice(0,1).toUpperCase()+e.slice(1)}function twoDigit(e){var t=parseInt(e);return(10<=t?t:"0"+t.toString()).toString()}function getRandomBool(){return getRandomBoolByFrequency(.5)}function getRandomBoolByFrequency(e){return Math.random()<e}function getNextIndex(e,t){return t===e.length-1?0:t+1}function getPrevIndex(e,t){return 0===t?e.length-1:t-1}function getRandomIntInclusive(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function getRandomItem(e){return e[Math.floor(Math.random()*e.length)]}function betweenInclusive(e,t,i){return t<=e&&e<=i}function topPosition(e){return e.offset().top}function rightPosition(e){return e.offset().left+e.outerWidth()}function bottomPosition(e){return e.offset().top+e.outerHeight()}function leftPosition(e){return e.offset().left}function distanceBelow(e,t,i){var o=bottomPosition(e)-bottomPosition(t);return i&&(o+=i),o}function smoothScrollToElement(e,t,i,o,n,s,a){void 0===s&&(s=getConst("timeSmoothScroll")),void 0===a&&(a=getConst("minMarginSmoothScroll")),void 0===o&&(o=0);var l=distanceBelow(e,t,a);setTimeout(function(){0<l?t.animate({scrollTop:l},{duration:s,complete:function(){smoothScrollHelper(e,i,n)}}):smoothScrollHelper(e,i,n)},o)}function smoothScrollHelper(e,t,i){t&&e.addClass("pulse"),i&&i()}function removePulseClass(e){"pulse"!==e.originalEvent.animationName&&"pulselight"!==e.originalEvent.animationName||$(e.target).removeClass("pulse")}function scrollToBottom(e){var t=e[0];t.scrollTop=t.scrollHeight}function toggleClassTwice(e,t){e.toggleClass(t),setTimeout(function(){e.toggleClass(t)},getConst("timeToggleClassTwice"))}function isChrome(){return null==m.globals.isChrome&&(m.globals.isChrome=/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())),m.globals.isChrome}function getBrowserName(){return isChrome()?"Chrome":"Firefox"}function getBrowserVersion(){return parseInt(navigator.userAgent.match(new RegExp("rv:([0-9]+)"))[1])}function getBrowser(){return isChrome()?chrome:browser}function getFavIcon(e){var t=document.createElement("a");t.href=e;var i=t.hostname;if(!i.startsWith("www.")){var o=i.split(".");(o.length<3||3==o.length&&o[1].length<4)&&(i="www."+i)}return"https://icons.duckduckgo.com/ip2/"+i+".ico"}function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function capitalizeWords(e){var i=e.split(" ");return i.forEach(function(e,t){i[t]=e.charAt(0).toUpperCase()+e.slice(1)}),i.join(" ")}function getClientId(){return getUserId()+"-"+m.globals.platform}function getUserId(){var e=m.models.customization.get("ga-user-id");return e||(e=uuidv4(),m.models.customization.set("ga-user-id",e)),e}function submitStats(e){}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveDateString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function handleDblclickFromDashboard(e){e.manager.dblclickFromDashboard&&(e.manager.dblclickFromDashboard=!1,setTimeout(function(){e.dblclickFromDashboardCb()},0))}function flashInputLengthError(e){toggleClassTwice(e,getConst("classInputLengthError"))}function checkForInputMaxLengthError(e){e.is("input")&&e.val().length>=e.attr("maxlength")&&flashInputLengthError(e)}function updateCharCount(e,t,i,o){var n=$(e.currentTarget.form);o=o||n.find("input");var s=n.find(".char-count"),a=o.val().length,l=t.inputLengthMaxDatabase-a;s.text(l).removeClass("warn over"),s.toggle(a>=t.inputLengthShow),o.removeClass("over"),a>t.inputLengthMaxDatabase?(s.addClass("over"),o.addClass("over")):a>=t.inputLengthWarn&&s.addClass("warn"),i&&i(n,a,l)}function updateListAddFormBorder(e,t){e.toggleClass("no-top-border",t)}function moveCursorToEndOfInput(e){var t=e[0];t.selectionStart=t.selectionEnd=t.value.length}function scrollToEndOfInput(e,t){void 0===t&&(t=0);var i=e[0];i.scrollWidth>i.clientWidth&&(0!==e.scrollLeft()&&e.scrollLeft(0),e.animate({scrollLeft:i.scrollWidth-i.clientWidth},t))}function toggleAdvanced(e){var t=e.$(".button-advanced"),i=e.$(".wrapper-advanced");t.toggleClass("active"),i.is(":visible")?(i.slideUp(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",0)},100)):(i.css("opacity",0).slideDown(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",1)},100))}function sendEventToggleFeed(e,t,i){m.sendEvent(e,t,"turned "+(i?"on":"off"))}function getInitialFeedSettings(e){var t=!0,i=!1;return"false"===localStorage.getItem(e.feedMomentumName)&&(t=!1),"true"===localStorage.getItem(e.feedCustomName)&&(i=!0),{feedMomentumClass:t?"on":"",feedCustomClass:i?"on":""}}function setFeedVars(e){e.$feedMomentumSlider=e.$("#feed-momentum-slider"),e.$feedCustomSlider=e.$("#feed-custom-slider")}function updateFeedSettings(e){var t=e.settings.get(e.manager.feedMomentumName),i=e.settings.get(e.manager.feedCustomName);e.$("#feed-momentum-slider").toggleClass("on",t),e.$("#feed-custom-slider").toggleClass("on",i),localStorage.setItem(e.manager.feedMomentumName,t),localStorage.setItem(e.manager.feedCustomName,i)}function handleStickySubnav(e){if(void 0!==e.subnav){var t=e.$(".settings-subnav"),i=e.$(".settings-subnav-placeholder"),o=(t.hasClass("sticky")?i.position().top:t.position().top)<0,n=m.models.customization.get("themeColour"),s={dark:"rgba(0,0,0,0.85)",light:"rgba(255,255,255,0.95)",custom:m.models.themeManager.getThemeColourRGBA()};i.outerHeight()!==t.outerHeight()&&i.css("height",t.outerHeight()),isChrome()||0===e.$(".subpanel-header").width()||t.css("width",e.$(".subpanel-header").width()),m.conditionalFeatures.featureEnabled("plus")&&t.css("background-color",o?s[n]:{dark:"rgba(0,0,0,0)",light:"rgba(255,255,255,1)",custom:"rgba(0,0,0,0)"}[n]),t.toggleClass("sticky",o),i.toggle(o)}}function scrollToTopStickySubnav(e){e.$(".settings-subnav").hasClass("sticky")&&e.$el.scrollTop(e.$(".settings-subnav-placeholder").position().top+e.$el.scrollTop())}function handleSelectStickySubnav(e){handleStickySubnav(e),scrollToTopStickySubnav(e)}function subnavAddAll(t,i,e,o,n){var s=t.main||t;_.each(t.subViews,function(e){e.destroy()}),t.subViews=[],t.collection.each(function(e){t.addOne(e,i)}),setTimeout(function(){handleStickySubnav(s)},0),t.$empty.removeClass("loading"),t.handleCollectionUpdate(),void 0!==o&&o(t),e.show(),void 0!==n&&n()}function subnavAddOne(e,t,i,o,n){var s=t.render().$el;e.subViews.push(t),o?i.prepend(s):i.append(s),n&&s.hide().slideDown(getConst("timeContentItemAnimation"))}function renderSubnav(e,t,i){e.$(".list-body").hide(),t.render(),e.$(".subnav-titles").find("h4").removeClass("active").siblings("."+i).addClass("active"),t.$el.show(),e.subnav=i}function updateEmptyState(e){e.$empty.toggle(0===e.collection.length)}function subnavHistoryLoadMore(e,t,i){e.stopPropagation(),i.LoadMoreHistory(),subnavHistoryUpdateLoadMore(t)}function subnavHistoryUpdateLoadMore(e){void 0===e&&(e=this),e.$(".load-more").toggle(!!e.collection.load_more)}function handleCollectionUpdateCustom(e,t,i){e.deletingFinalItem?setTimeout(function(){e.deletingFinalItem=!1,e.cancelListAdd(),displayEmptyStateAndAddForm(e,t,i)},getConst("timeContentItemAnimation")):displayEmptyStateAndAddForm(e,t,i)}function displayEmptyStateAndAddForm(e,t,i){t.toggle(i),updateListAddFormBorder(e.$listAddForm,i),handleStickySubnav(e)}function cancelListAdd(e){e.$listAddForm.is(":visible")&&(e.resetListAdd(!0),e.toggleListAddForm())}function changeToEditMode(e,t){triggerItemEditing(e),e.$el.addClass("editing"),t.focus(),moveCursorToEndOfInput(t),scrollToEndOfInput(t,getConst("timeSmoothScroll"))}function handleKeypressEnter(e,t,i){13===e.keyCode?(e.preventDefault(),e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||t()):void 0!==i&&checkForInputMaxLengthError(i)}function handleKeyupEsc(e,t){27===e.keyCode&&(e.stopPropagation(),t())}function triggerItemEditing(e){e.main.itemEditingId=e.model.id,e.manager.trigger("item-editing")}function preventMultipleEdits(e){void 0===e&&(e=this),e.model.id!==e.main.itemEditingId&&returnToViewMode(e)}function getOutOfEditMode(e){e.$el.removeClass("editing"),e.updateTooltip&&e.updateTooltip()}function returnToViewMode(e){void 0===e&&(e=this),e.$el.hasClass("editing")&&e.processEditForm(),e.$(".delete-group").is(":visible")&&e.toggleDeleteConf()}function onDestroyModel(){1===this.main.collection.length&&(this.main.deletingFinalItem=!0),this.$el.slideUp(getConst("timeContentItemAnimation"),_.bind(this.destroy,this))}function toggleDeleteConf(e){var t=e.$(".controls"),i=e.$(".controls > .control"),o=e.$(".delete-group");o.css("display",o.is(":visible")?"none":"inline-block"),o.is(":visible")&&triggerItemEditing(e),t.toggleClass("delete-clicked"),i.toggle()}function processEditFormBasic(e){var t=e.$input.val().trim();betweenInclusive(t.length,1,e.main.inputLengthMaxDatabase)?(e.model.save({body:t},{wait:!0,success:function(){getOutOfEditMode(e),e.manager.handleItemEdit(e.model)},error:function(){console.error("edit content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Edit")):flashInputLengthError(e.$input)}function abortEditBasic(e){e.$input.val(e.model.get("body")),getOutOfEditMode(e)}function deleteItemBasic(e){e.model.destroy({wait:!0,success:function(){e.manager.handleItemDelete(e.model,getConst("timeContentItemAnimation"))},error:function(){console.error("delete content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Delete")}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setEndOfContenteditable(e){var t,i;document.createRange&&((t=document.createRange()).selectNodeContents(e),t.collapse(!1),(i=window.getSelection()).removeAllRanges(),i.addRange(t))}Backbone.sync=function(e,t,i){(i=i||{}).beforeSend=function(e){setMomentumAuthHeader(e),e.overrideMimeType("application/json")},backboneSync(e,t,i)},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="background-info-title">'+(null!=(n=typeof(s=null!=(s=t.title||(null!=e?e.title:e))?s:a)===l?s.call(e,{name:"title",hash:{},data:o}):s)?n:"")+'<i class="icon-angle-right"></i></span>\n<span class="background-info-source">\n    <span class="background-info-source-link" data-url="'+r(typeof(s=null!=(s=t.sourceUrl||(null!=e?e.sourceUrl:e))?s:a)===l?s.call(e,{name:"sourceUrl",hash:{},data:o}):s)+'">'+(null!=(n=typeof(s=null!=(s=t.attribution||(null!=e?e.attribution:e))?s:a)===l?s.call(e,{name:"attribution",hash:{},data:o}):s)?n:"")+'</span><span class="control control-heart '+r(typeof(s=null!=(s=t.fav_class||(null!=e?e.fav_class:e))?s:a)===l?s.call(e,{name:"fav_class",hash:{},data:o}):s)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.baseMetric=m.templates.baseMetric||{},m.templates.baseMetric.baseMetric=Handlebars.template({1:function(e,t,i,o){var n;return'\t<div class="metric metric-empty metric-empty-add">\n\t\t\t<div class="metric-stat">+</div>\n\t\t\t<div class="metric-label">'+this.escapeExpression("function"==typeof(n=null!=(n=t.metricTitle||(null!=e?e.metricTitle:e))?n:t.helperMissing)?n.call(e,{name:"metricTitle",hash:{},data:o}):n)+"</div>\n\t</div>\n"},3:function(e,t,i,o,n,s){var a;return'\t<div class="metric-row">\n'+(null!=(a=t.if.call(e,null!=e?e.randomMetric:e,{name:"if",hash:{},fn:this.program(4,o,0,n,s),inverse:this.noop,data:o}))?a:"")+(null!=(a=t.if.call(e,null!=e?e.selectedMetric:e,{name:"if",hash:{},fn:this.program(6,o,0,n,s),inverse:this.noop,data:o}))?a:"")+(null!=(a=t.each.call(e,null!=e?e.metrics:e,{name:"each",hash:{},fn:this.program(8,o,0,n,s),inverse:this.noop,data:o}))?a:"")+"\n\t</div>\n"},4:function(e,t,i,o,n,s){var a;return'\t\t\t<div class="metric-item random-metric" data-id="'+this.escapeExpression(this.lambda(null!=(a=null!=e?e.randomMetric:e)?a.id:a,e))+'">\n'+(null!=(a=this.invokePartial(t.lookup.call(e,s[1],"template",{name:"lookup",hash:{},data:o}),null!=e?e.randomMetric:e,{data:o,indent:"\t\t\t\t",helpers:t,partials:i}))?a:"")+"\t\t\t</div>\n"},6:function(e,t,i,o,n,s){var a;return'\t\t\t<div class="metric-item selected-metric" data-id="'+this.escapeExpression(this.lambda(null!=(a=null!=e?e.selectedMetric:e)?a.id:a,e))+'">\n'+(null!=(a=this.invokePartial(t.lookup.call(e,s[1],"template",{name:"lookup",hash:{},data:o}),null!=e?e.selectedMetric:e,{data:o,indent:"\t\t\t\t",helpers:t,partials:i}))?a:"")+"\t\t\t</div>\n"},8:function(e,t,i,o,n,s){var a;return null!=(a=t.if.call(e,null!=e?e.pinned:e,{name:"if",hash:{},fn:this.program(9,o,0,n,s),inverse:this.noop,data:o}))?a:""},9:function(e,t,i,o,n,s){var a,l;return'\t\t\t\t<div class="metric-item pinned-metric" data-id="'+this.escapeExpression("function"==typeof(l=null!=(l=t.id||(null!=e?e.id:e))?l:t.helperMissing)?l.call(e,{name:"id",hash:{},data:o}):l)+'">\n'+(null!=(a=this.invokePartial(t.lookup.call(e,s[2],"template",{name:"lookup",hash:{},data:o}),e,{data:o,indent:"\t\t\t\t\t",helpers:t,partials:i}))?a:"")+"\t\t\t\t</div>\n"},11:function(e,t,i,o,n,s){var a;return null!=(a=t.each.call(e,null!=e?e.archivedMetrics:e,{name:"each",hash:{},fn:this.program(12,o,0,n,s),inverse:this.noop,data:o}))?a:""},12:function(e,t,i,o,n,s){var a,l;return'\t\t\t\t\t\t<li data-id="'+this.escapeExpression("function"==typeof(l=null!=(l=t.id||(null!=e?e.id:e))?l:t.helperMissing)?l.call(e,{name:"id",hash:{},data:o}):l)+'" class="pane-list-item metric-list-item metric-option">\n\n'+(null!=(a=this.invokePartial(t.lookup.call(e,s[1],"template",{name:"lookup",hash:{},data:o}),e,{data:o,indent:"\t\t\t\t\t\t\t",helpers:t,partials:i}))?a:"")+"\n\t\t\t\t\t\t</li>\n"},14:function(e,t,i,o){var n;return null!=(n=t.if.call(e,null!=e?e.showArchive:e,{name:"if",hash:{},fn:this.program(15,o,0),inverse:this.noop,data:o}))?n:""},15:function(e,t,i,o){return'\t\t\t\t\t<li class="metric-archived-header">\n\t\t\t\t\t\tArchive is empty\n\t\t\t\t\t</li>\n\t\t\t\t'},17:function(e,t,i,o){var n;return'\t\t\t\t\t<div class="metric-guide pane-description">'+this.escapeExpression("function"==typeof(n=null!=(n=t.metricDescription||(null!=e?e.metricDescription:e))?n:t.helperMissing)?n.call(e,{name:"metricDescription",hash:{},data:o}):n)+"</div>\n"},19:function(e,t,i,o,n,s){var a,l;return'\t\t\t\t\t\t<li data-id="'+this.escapeExpression("function"==typeof(l=null!=(l=t.id||(null!=e?e.id:e))?l:t.helperMissing)?l.call(e,{name:"id",hash:{},data:o}):l)+'" class="pane-list-item metric-list-item metric-option '+(null!=(a=t.if.call(e,null!=e?e.active:e,{name:"if",hash:{},fn:this.program(20,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'">\n\n'+(null!=(a=this.invokePartial(t.lookup.call(e,s[1],"template",{name:"lookup",hash:{},data:o}),e,{data:o,indent:"\t\t\t\t\t\t\t",helpers:t,partials:i}))?a:"")+"\n\t\t\t\t\t\t</li>\n"},20:function(e,t,i,o){var n;return" "+(null!=(n=t.unless.call(e,null!=e?e.pinned:e,{name:"unless",hash:{},fn:this.program(21,o,0),inverse:this.noop,data:o}))?n:"")+" "},21:function(e,t,i,o){return" active "},23:function(e,t,i,o){return'\t\t\t\t\t\t\t\t<li class="archive">\n\t\t\t\t\t\t\t\t\tUn-archive\n\t\t\t\t\t\t\t\t</li>\n'},25:function(e,t,i,o){return'\t\t\t\t\t\t\t\t<li class="archive">\n\t\t\t\t\t\t\t\t\tArchive\n\t\t\t\t\t\t\t\t</li>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o,n,s){var a,l;return(null!=(a=t.if.call(e,null!=e?e.empty:e,{name:"if",hash:{},fn:this.program(1,o,0,n,s),inverse:this.noop,data:o}))?a:"")+"\n"+(null!=(a=t.unless.call(e,null!=e?e.empty:e,{name:"unless",hash:{},fn:this.program(3,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'\n<div class="pane metric-pane widget-pop nipple-top-right"> \x3c!-- Get that widget-pop out of here? --\x3e\n\t<div class="subpanes-wrapper">\n\t\t<div class="subpanes">\x3c!--\n\t\t--\x3e<div class="subpane pane-detail archive-pane">\n\t\t\t\t<header class="pane-header">\x3c!--\n\t\t\t\t\t--\x3e<span class="pane-header-filler">&nbsp;</span>\x3c!--\n\t\t\t\t\t--\x3e<span class="subpane-title">Archive</span>\x3c!--\n\t\t\t\t\t--\x3e<span class="pane-back"><i class="icon icon-right"></i></span>\x3c!--\n\t\t\t\t--\x3e</header>\n\t\t\t<div class="loading-message"><span class="loading hidden"><span class="loading-placeholder"></span>Loading</span><span class="error hidden">Trouble connecting… <span class="retry">Retry</span></span></div>\n\t\t\t<ul class="metric-list">\n'+(null!=(a=t.if.call(e,null!=e?e.archivedMetrics:e,{name:"if",hash:{},fn:this.program(11,o,0,n,s),inverse:this.program(14,o,0,n,s),data:o}))?a:"")+'\t\t\t</ul>\n\t\t\t</div>\x3c!--\n\t\t\t--\x3e<div class="subpane pane-list">\n\t\t\t\t<header class="pane-header">\n\t\t\t\t\t<span class="pane-title">'+this.escapeExpression("function"==typeof(l=null!=(l=t.metricTitle||(null!=e?e.metricTitle:e))?l:t.helperMissing)?l.call(e,{name:"metricTitle",hash:{},data:o}):l)+'</span>\n\t\t\t\t\t\x3c!-- <span class="pane-description">Countdown lorem ipsum dolor sit amet</span> --\x3e\n\n\t\t\t\t\t<div class="pane-header-controls">\n\t\t\t\t\t\t<div class="pane-header-control pane-header-add">\n\t\t\t\t\t\t\t<i class="icon-plus"></i>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="pane-header-control pane-settings">\n\t\t\t\t\t\t\t<div class="pane-settings-icon-wrapper">\n\t\t\t\t\t\t\t\t<i class="icon-ellipsis pane-settings-icon"></i>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dropdown pane-settings-dropdown metric-settings">\n\t\t\t\t\t\t\t\t<ul class="dropdown-list">\n\t\t\t\t\t\t\t\t\t<li class="show-archived">\n\t\t\t\t\t\t\t\t\t\tView Archive\n\t\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t<li class="toggle-random" title="Disables the randomly displayed metric on the dashboard when one or more metrics are pinned.">\n\t\t\t\t\t\t\t\t\t\t<span class="setting-title">\n\t\t\t\t\t\t\t\t\t\t\tPinned Only\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n'+(null!=(a=t.if.call(e,null!=e?e.empty:e,{name:"if",hash:{},fn:this.program(17,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'\t\t\t\t<ul class="metric-list">\n'+(null!=(a=t.each.call(e,null!=e?e.metrics:e,{name:"each",hash:{},fn:this.program(19,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'\t\t\t\t</ul>\n\t\t\t</div>\x3c!--\n\t\t\t--\x3e<div class="subpane pane-detail metric-detail metric-detail-add">\n\t\t\t\t<header class="pane-header">\n\t\t\t\t\t<span class="pane-back"><i class="icon icon-left"></i></span>\n\n\t\t\t\t\t<div class="pane-settings edit-mode pane-header-controls">\n\t\t\t\t\t\t<div class="pane-header-control">\n\t\t\t\t\t\t<i class="icon-ellipsis pane-settings-icon"></i>\n\n\t\t\t\t\t\t<div class="dropdown pane-settings-dropdown">\n\t\t\t\t\t\t\t<ul class="dropdown-list">\n'+(null!=(a=t.if.call(e,null!=e?e.archived:e,{name:"if",hash:{},fn:this.program(23,o,0,n,s),inverse:this.program(25,o,0,n,s),data:o}))?a:"")+'\t\t\t\t\t\t\t\t<li class="delete">\n\t\t\t\t\t\t\t\t\tDelete\n\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n\t\t\t\t<div class="metric-detail-specific"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n'},usePartial:!0,useData:!0,useDepths:!0}),m.templates=m.templates||{},m.templates.bookmarks=m.templates.bookmarks||{},m.templates.bookmarks.bookmark=Handlebars.template({1:function(e,t,i,o){return"local"},3:function(e,t,i,o){var n;return'<span class="bookmark-label">'+this.escapeExpression("function"==typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:t.helperMissing)?n.call(e,{name:"title",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<a draggable="false" href="'+r(typeof(s=null!=(s=t.url||(null!=e?e.url:e))?s:a)===l?s.call(e,{name:"url",hash:{},data:o}):s)+'" title="'+r(typeof(s=null!=(s=t.tooltip||(null!=e?e.tooltip:e))?s:a)===l?s.call(e,{name:"tooltip",hash:{},data:o}):s)+'" class="bookmark '+r(typeof(s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a)===l?s.call(e,{name:"classes",hash:{},data:o}):s)+" "+(null!=(n=t.if.call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'"><img draggable="false" src="'+r(typeof(s=null!=(s=t.favicon_url||(null!=e?e.favicon_url:e))?s:a)===l?s.call(e,{name:"favicon_url",hash:{},data:o}):s)+'" class="bookmark-icon">'+(null!=(n=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+"</a>\n"},useData:!0}),m.templates.bookmarks.bookmarkfolder=Handlebars.template({1:function(e,t,i,o){var n;return'<span class="bookmark-folder-label">'+this.escapeExpression("function"==typeof(n=null!=(n=t.label||(null!=e?e.label:e))?n:t.helperMissing)?n.call(e,{name:"label",hash:{},data:o}):n)+"</span>"},3:function(e,t,i,o){var n;return'<span class="bookmark-label">'+this.escapeExpression("function"==typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:t.helperMissing)?n.call(e,{name:"title",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span draggable="false" class="bookmark toggle-folder main-button '+r(typeof(s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a)===l?s.call(e,{name:"classes",hash:{},data:o}):s)+'" title="'+r(typeof(s=null!=(s=t.tooltip||(null!=e?e.tooltip:e))?s:a)===l?s.call(e,{name:"tooltip",hash:{},data:o}):s)+'">\n\t'+(null!=(n=t.unless.call(e,null!=e?e.title:e,{name:"unless",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\n\n\t\x3c!-- Folder icon --\x3e\n\t<svg draggable="false" class="bookmark-icon bookmark-icon-folder" xmlns="http://www.w3.org/2000/svg" width="510" height="510" viewBox="0 0 510 510"><path d="M204 51H51C22.95 51 0 73.95 0 102v306c0 28.05 22.95 51 51 51h408c28.05 0 51-22.95 51-51V153c0-28.05-22.95-51-51-51H255l-51-51z"/></svg>\x3c!--\n\n\t--\x3e'+(null!=(n=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+'\n\n\t<ul class= "bookmarks-folder-list"></ul>\n</span>\n'},useData:!0}),m.templates.bookmarks.bookmarks=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="bookmarks-wrapper" style="left:0">\n\t<ul class="bookmarks-list" id="active-bookmarks">\n\t</ul>\n\t<ul class="bookmarks-list" id="active-bookmarks-alt">\n\t</ul>\n\t<div class="bookmarks-guide">\n\t\t<div class="bookmarks-guide-wrapper"><img src="/img/icon-pointer.svg" class="bookmarks-guide-icon"> Drag for more bookmarks</div>\n\t</div>\n</div>\n'},useData:!0}),m.templates.bookmarks.primer=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<div class="overlay-permissions-content">\n\t<div class="overlay-permissions-icon"><i class="icon-angle-up"></i></div>\n\t<div class="overlay-permissions-content-title">Would you like to see your bookmarks?</div>\n\t<div class="overlay-permissions-content-description">'+this.escapeExpression("function"==typeof(n=null!=(n=t.browser||(null!=e?e.browser:e))?n:t.helperMissing)?n.call(e,{name:"browser",hash:{},data:o}):n)+" requires your permission.</div>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock.clock=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h1 class="time">'+l(typeof(n=null!=(n=t.time||(null!=e?e.time:e))?n:s)===a?n.call(e,{name:"time",hash:{},data:o}):n)+'</h1>\n<span class="format">'+l(typeof(n=null!=(n=t.format||(null!=e?e.format:e))?n:s)===a?n.call(e,{name:"format",hash:{},data:o}):n)+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.focus=m.templates.focus||{},m.templates.focus["focus-prompt-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<h3>What is your main focus for today?</h3>\n<input type="text">'},useData:!0}),m.templates.focus["focus-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return"<h3>"+l(typeof(n=null!=(n=t.day||(null!=e?e.day:e))?n:s)===a?n.call(e,{name:"day",hash:{},data:o}):n)+'</h3>\n<span class="control checkbox"><i class="icon icon-checkbox-empty focus-open"></i><i class="icon icon-checkbox focus-done"></i></span><p class="todays-focus">'+l(typeof(n=null!=(n=t.focus||(null!=e?e.focus:e))?n:s)===a?n.call(e,{name:"focus",hash:{},data:o}):n)+'</p><span class="control delete"><i>✕</i></span>\n'},useData:!0}),m.templates.focus["focuses-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<ol></ol>\n<div class="message focus-message">\n    <i class="loading-icon"></i>Loading...</span>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h2>Good <span class="period">'+l(typeof(n=null!=(n=t.period||(null!=e?e.period:e))?n:s)===a?n.call(e,{name:"period",hash:{},data:o}):n)+'</span>, <span class="name" spellcheck="false">'+l(typeof(n=null!=(n=t.name||(null!=e?e.name:e))?n:s)===a?n.call(e,{name:"name",hash:{},data:o}):n)+"</span>.</h2>"},useData:!0}),m.templates=m.templates||{},m.templates.introduction=m.templates.introduction||{},m.templates.introduction["introduction-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<button class="button">'+this.escapeExpression("function"==typeof(n=null!=(n=t.value||(null!=e?e.value:e))?n:t.helperMissing)?n.call(e,{name:"value",hash:{},data:o}):n)+"</button>"},useData:!0}),m.templates.introduction["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<div class="prompt">\n\t<div id="introduction-question"><span class="introduction-question-title">'+this.escapeExpression("function"==typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:t.helperMissing)?n.call(e,{name:"message",hash:{},data:o}):n)+'</span></div>\n\t<div class="tip"></div>\n</div>\n<div class="buttons"></div>\n'},useData:!0}),m.templates.introduction["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<p class="logo"><img src="img/logo-white.svg"></p>\n<p class=content></p>\n'},useData:!0}),m.templates.introduction["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return"<div>"+this.escapeExpression("function"==typeof(n=null!=(n=t.value||(null!=e?e.value:e))?n:t.helperMissing)?n.call(e,{name:"value",hash:{},data:o}):n)+"</div>"},useData:!0}),m.templates=m.templates||{},m.templates.metric=m.templates.metric||{},m.templates.metric.widget=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div><span class="metric-stat">'+l(typeof(n=null!=(n=t.statvalue||(null!=e?e.statvalue:e))?n:s)===a?n.call(e,{name:"statvalue",hash:{},data:o}):n)+'</span></div><span class="metric-label">'+l(typeof(n=null!=(n=t.statlabel||(null!=e?e.statlabel:e))?n:s)===a?n.call(e,{name:"statlabel",hash:{},data:o}):n)+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.notification=m.templates.notification||{},m.templates.notification.notification=Handlebars.template({1:function(e,t,i,o){var n,s;return'<div class="notification-title">'+(null!=(n=t.if.call(e,null!=e?e.icon_url:e,{name:"if",hash:{},fn:this.program(2,o,0),inverse:this.noop,data:o}))?n:"")+" "+this.escapeExpression("function"==typeof(s=null!=(s=t.title||(null!=e?e.title:e))?s:t.helperMissing)?s.call(e,{name:"title",hash:{},data:o}):s)+"</div>"},2:function(e,t,i,o){var n;return'<img src="'+this.escapeExpression("function"==typeof(n=null!=(n=t.icon_url||(null!=e?e.icon_url:e))?n:t.helperMissing)?n.call(e,{name:"icon_url",hash:{},data:o}):n)+'" style="height: 20px">'},4:function(e,t,i,o){var n;return'<button class="notification-button">'+this.escapeExpression("function"==typeof(n=null!=(n=t.cta_text||(null!=e?e.cta_text:e))?n:t.helperMissing)?n.call(e,{name:"cta_text",hash:{},data:o}):n)+"</button>"},6:function(e,t,i,o){var n;return'<span class="button-text secondary-text">'+this.escapeExpression("function"==typeof(n=null!=(n=t.secondary_text||(null!=e?e.secondary_text:e))?n:t.helperMissing)?n.call(e,{name:"secondary_text",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s;return'<div class="pane widget-pop nipple-bottom-left notification">\n    <span class="hide notification-hide">✕</span>\n    '+(null!=(n=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\n    <div class="notification-description">'+this.escapeExpression("function"==typeof(s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing)?s.call(e,{name:"message",hash:{},data:o}):s)+"</div>\n    "+(null!=(n=t.if.call(e,null!=e?e.cta_cmd:e,{name:"if",hash:{},fn:this.program(4,o,0),inverse:this.noop,data:o}))?n:"")+(null!=(n=t.if.call(e,null!=e?e.secondary_cmd:e,{name:"if",hash:{},fn:this.program(6,o,0),inverse:this.noop,data:o}))?n:"")+"\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.quicklinks=m.templates.quicklinks||{},m.templates.quicklinks.dashlinks=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<span data-momo-id="chromeTab" data-place="dash" data-url="chrome-search://local-ntp/local-ntp.html" class="optional-link toggle toggle-icon toggle-chrome-tab" title="Chrome Tab"><svg class="icon-svg icon-chrome-tab" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.401 497.401"><g><path d="M478.742 154.382H320.714c28.366 21.765 47.111 55.717 47.111 94.307 0 30.63-14.345 56.386-30.933 79.445-28.322 39.41-95.817 168.878-95.817 168.878 2.567.043 5.026.388 7.636.388 137.341 0 248.69-111.348 248.69-248.69-.022-33.412-6.709-65.229-18.659-94.328z"/><path d="M248.172 129.619c54.402-.388 217.628-2.049 217.628-2.049C423.24 51.511 342.069 0 248.69 0 170.819 0 101.361 35.829 55.782 91.848l75.972 134.925c10.268-55.113 58.349-96.744 116.418-97.154z"/><path d="M248.668 367.825c-51.964 0-91.568-35.117-111.974-79.855-20.535-45.018-98.061-171.984-98.061-171.984C14.301 154.425 0 199.832 0 248.69c0 124.744 91.935 227.744 211.696 245.648l77.288-134.019c-12.641 4.615-26.101 7.506-40.316 7.506z"/><circle cx="248.668" cy="248.711" r="80.416"/></g></svg></span>\x3c!--\n--\x3e<span data-momo-id="apps" data-place="dash" data-url="chrome://apps" class="optional-link toggle toggle-icon toggle-apps" title="Apps"><svg class="icon-svg icon-apps" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M3 3h6v6H3V3zm10 0h6v6h-6V3zm10 0h6v6h-6V3zM3 13h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6zM3 23h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6z"/></svg></span>\n'},useData:!0}),m.templates.quicklinks["quicklinks-item-template"]=Handlebars.template({1:function(e,t,i,o){return' class="local"'},3:function(e,t,i,o){var n;return'<img src="'+this.escapeExpression("function"==typeof(n=null!=(n=t.favicon_url||(null!=e?e.favicon_url:e))?n:t.helperMissing)?n.call(e,{name:"favicon_url",hash:{},data:o}):n)+'">'},5:function(e,t,i,o){return' <span class="link-icon-placeholder">&nbsp;</span> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div draggable="true" class="'+r(typeof(s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a)===l?s.call(e,{name:"classes",hash:{},data:o}):s)+'">\n\t<a draggable="false" href="'+r(typeof(s=null!=(s=t.url||(null!=e?e.url:e))?s:a)===l?s.call(e,{name:"url",hash:{},data:o}):s)+'"'+(null!=(n=t.if.call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+">"+(null!=(n=t.if.call(e,null!=e?e.favicon_url:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.program(5,o,0),data:o}))?n:"")+" "+r(typeof(s=null!=(s=t.title||(null!=e?e.title:e))?s:a)===l?s.call(e,{name:"title",hash:{},data:o}):s)+'</a>\n    <span draggable="false" class="control destroy">✕</span>\n</div>\n'},useData:!0}),m.templates.quicklinks["quicklinks-template"]=Handlebars.template({1:function(e,t,i,o){return'\t\t\t<li data-momo-id="chromeTab" data-place="links" class="optional-link"><a href="chrome-search://local-ntp/local-ntp.html" class="local"><svg class="icon-svg icon-chrome-tab" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.401 497.401"><g><path d="M478.742 154.382H320.714c28.366 21.765 47.111 55.717 47.111 94.307 0 30.63-14.345 56.386-30.933 79.445-28.322 39.41-95.817 168.878-95.817 168.878 2.567.043 5.026.388 7.636.388 137.341 0 248.69-111.348 248.69-248.69-.022-33.412-6.709-65.229-18.659-94.328z"/><path d="M248.172 129.619c54.402-.388 217.628-2.049 217.628-2.049C423.24 51.511 342.069 0 248.69 0 170.819 0 101.361 35.829 55.782 91.848l75.972 134.925c10.268-55.113 58.349-96.744 116.418-97.154z"/><path d="M248.668 367.825c-51.964 0-91.568-35.117-111.974-79.855-20.535-45.018-98.061-171.984-98.061-171.984C14.301 154.425 0 199.832 0 248.69c0 124.744 91.935 227.744 211.696 245.648l77.288-134.019c-12.641 4.615-26.101 7.506-40.316 7.506z"/><circle cx="248.668" cy="248.711" r="80.416"/></g></svg> Chrome Tab</a></li>\n\t\t\t<li data-momo-id="apps" class="optional-link" data-place="links"><a href="chrome://apps" id="app-return" class="local"><svg class="icon-svg icon-apps" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M3 3h6v6H3V3zm10 0h6v6h-6V3zm10 0h6v6h-6V3zM3 13h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6zM3 23h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6z"/></svg> Apps</a></li>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<span class="quicklinks-show top-nav toggle" href="">Links</span>\n\n<div class="pane-container quicklinks-wrapper nipple-top-left">\n\t<div class="pane quicklinks-pane">\n\t\t<div class="message connection-message"><i class="loading-icon"></i>Loading...</div>\n\n\t\t<ol>\n'+(null!=(n=t.if.call(e,null!=e?e.isChrome:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\t\t</ol>\n\n\t\t<div class="empty links-empty">\n\t\t\t<p class="links-empty-title">No links yet</p>\n\t\t\t<p class="links-empty-description">Add your favorite links</p>\n\t\t</div>\n\t\t<div class="quicklinks-new">\n\t\t\t<span class="hide quicklinks-new-hide">✕</span>\n\t\t\t<input type="text" id="quicklinks-new-title" class="quicklinks-new-title quicklinks-new-toggle" placeholder="New Link">\n\t\t\t<input type="text" id="quicklinks-new-url" class="quicklinks-new-url" placeholder="URL">\n\t\t</div>\n\t\t<div class="add-error-message message">Connection required to add link. <span class="message-action retry-add">Retry</span></div>\n\t</div>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote.quote=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<p class="quote-body">\n\t<span class="quote-body-text">&ldquo;'+l(typeof(n=null!=(n=t.body||(null!=e?e.body:e))?n:s)===a?n.call(e,{name:"body",hash:{},data:o}):n)+'&rdquo;</span><i class="icon-angle-right"></i>\n\t<span class="quote-source"><span class="quote-source-text">'+l(typeof(n=null!=(n=t.source||(null!=e?e.source:e))?n:s)===a?n.call(e,{name:"source",hash:{},data:o}):n)+'</span><span class="control control-heart '+l(typeof(n=null!=(n=t.fav_class||(null!=e?e.fav_class:e))?n:s)===a?n.call(e,{name:"fav_class",hash:{},data:o}):n)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span><span data-url="'+l(typeof(n=null!=(n=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?n:s)===a?n.call(e,{name:"twitterIntentUrl",hash:{},data:o}):n)+'" class="control control-twitter"><i class="icon icon-twitter"></i></span></span>\n</p>'},useData:!0}),m.templates=m.templates||{},m.templates.settings=m.templates.settings||{},m.templates.settings.about=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<div class="pop-body settings-about">\n\t<img src="icon-512.png" class="about-logo">\n\t<h3>Momentum</h3>\n\t<p class="made">Personal Dashboard <span id="momo-version">v'+this.escapeExpression("function"==typeof(n=null!=(n=t.version||(null!=e?e.version:e))?n:t.helperMissing)?n.call(e,{name:"version",hash:{},data:o}):n)+'</span></p>\n\t<p class="thanks">Thank you for your support!</p>\n\t<p class="links">\n\t\t<a href="http://momentumdash.com/help" target="_blank">Feedback</a>\n\t\t<a href="http://momentumdash.com" target="_blank">Website</a>\n\t\t<a href="http://momentumdash.com/blog" target="_blank">Blog</a>\n\t\t<a href="http://www.instagram.com/momentumdash" target="_blank">Instagram</a>\n\t\t<a href="https://www.facebook.com/momentumdash" target="_blank">Facebook</a>\n\t\t<a href="https://twitter.com/momentumdash" target="_blank">Twitter</a>\n\t</p>\n\t<p class="footer">\n\t\tMade with &#9829; in beautiful BC, Canada\n\t</p>\n</div>\n'},useData:!0}),m.templates.settings["color-picker-popup"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="cp-color-picker nipple-bottom-right">\n    <div class="cp-xy-slider">\n        <div class="cp-white"></div>\n        <div class="cp-xy-cursor"></div>\n    </div>\n    <div class="cp-z-slider">\n        <div class="cp-z-cursor"></div>\n    </div>\n    <div class="cp-alpha-container">\n        <div class="cp-alpha">\n            <div class="cp-alpha-cursor"></div>\n        </div>\n    </div>\n</div>'},useData:!0}),m.templates.settings["color-picker"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="swatch-container"><div class="swatch" style="background: #222;"></div></div>'},useData:!0}),m.templates.settings.connect=Handlebars.template({1:function(e,t,i,o){return"GitHub"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="back action action-back"><i class="icon icon-angle-left"></i></span>\n\n<section class="provider">\n\t<div class="provider-logo-box">\n\t\t<img  src="'+r(typeof(s=null!=(s=t.large_icon_url||(null!=e?e.large_icon_url:e))?s:a)===l?s.call(e,{name:"large_icon_url",hash:{},data:o}):s)+'" class="provider-logo '+(null!=(n=t.if.call(e,null!=e?e.GitHub:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'">\n\t</div>\n\t<h2 class="provider-title">Connect to '+r(typeof(s=null!=(s=t.provider_title||(null!=e?e.provider_title:e))?s:a)===l?s.call(e,{name:"provider_title",hash:{},data:o}):s)+'</h2>\n</section>\n\x3c!--<section class="extra-info">--\x3e\n\t\x3c!--<label for="blah">Please enter your account name</label>--\x3e\n\t\x3c!--<input type="text" name="blah" id="blah" class="input">--\x3e\n\x3c!--</section>--\x3e\n\n<p class="description">A secure window will open.</p>\n<section class="button-group">\n\t<span id="connect-button" class="button">Connect</span>\n\t<p class="description">Momentum won\'t ever have access to your login information.</p>\n</section>\n'},useData:!0}),m.templates.settings["general-toggle-options"]=Handlebars.template({1:function(e,t,i,o){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,o,n,s){var a;return null!=(a=t.unless.call(e,o&&o.last,{name:"unless",hash:{},fn:this.program(4,o,0,n,s),inverse:this.program(9,o,0,n,s),data:o}))?a:""},4:function(e,t,i,o,n,s){var a,l,r=this.lambda,d=this.escapeExpression,c=t.helperMissing,h="function";return'\t\t\t\t<span class="toggle-option '+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+d(typeof(l=null!=(l=t.value||(null!=e?e.value:e))?l:c)===h?l.call(e,{name:"value",hash:{},data:o}):l)+'><div class="sub-view"></div>'+d(typeof(l=null!=(l=t.label||(null!=e?e.label:e))?l:c)===h?l.call(e,{name:"label",hash:{},data:o}):l)+"</span>"+(null!=(a=t.if.call(e,null!=e?e.breakafter:e,{name:"if",hash:{},fn:this.program(5,o,0,n,s),inverse:this.program(7,o,0,n,s),data:o}))?a:"")+"\n"},5:function(e,t,i,o){return"<br>"},7:function(e,t,i,o){return' <span class="toggle-divider">|</span> '},9:function(e,t,i,o,n,s){var a,l=this.lambda,r=this.escapeExpression,d=t.helperMissing,c="function";return'\t\t\t\t<span class="toggle-option '+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+r(typeof(a=null!=(a=t.value||(null!=e?e.value:e))?a:d)===c?a.call(e,{name:"value",hash:{},data:o}):a)+'><div class="sub-view"></div>'+r(typeof(a=null!=(a=t.label||(null!=e?e.label:e))?a:d)===c?a.call(e,{name:"label",hash:{},data:o}):a)+"</span>\n"},11:function(e,t,i,o){var n;return'<span class="option-message">'+this.escapeExpression("function"==typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:t.helperMissing)?n.call(e,{name:"message",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o,n,s){var a,l,r=t.helperMissing,d="function",c=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+c(typeof(l=null!=(l=t.widget||(null!=e?e.widget:e))?l:r)===d?l.call(e,{name:"widget",hash:{},data:o}):l)+'">\n\t<span class="setting-name">'+c(typeof(l=null!=(l=t.name||(null!=e?e.name:e))?l:r)===d?l.call(e,{name:"name",hash:{},data:o}):l)+"</span>\n\t"+(null!=(a=t.if.call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'\n\t<span class="toggle-options">\n'+(null!=(a=t.each.call(e,null!=e?e.options:e,{name:"each",hash:{},fn:this.program(3,o,0,n,s),inverse:this.noop,data:o}))?a:"")+"\t</span>\n\t"+(null!=(a=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(11,o,0,n,s),inverse:this.noop,data:o}))?a:"")+'\n\t<div class="option-clear"></div>\n</li>\n'},useData:!0,useDepths:!0}),m.templates.settings["general-toggle-slider"]=Handlebars.template({1:function(e,t,i,o){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,o){return'<span class="badge beta-badge">Preview</span>'},5:function(e,t,i,o){var n;return'<span class="option-message">'+this.escapeExpression("function"==typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:t.helperMissing)?n.call(e,{name:"message",hash:{},data:o}):n)+"</span>"},7:function(e,t,i,o){var n;return'<span class="config-button">'+this.escapeExpression("function"==typeof(n=null!=(n=t.configLabel||(null!=e?e.configLabel:e))?n:t.helperMissing)?n.call(e,{name:"configLabel",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+r(typeof(s=null!=(s=t.widget||(null!=e?e.widget:e))?s:a)===l?s.call(e,{name:"widget",hash:{},data:o}):s)+'">\n\t<input type="checkbox">\n\t<span class="setting-name">'+r(typeof(s=null!=(s=t.name||(null!=e?e.name:e))?s:a)===l?s.call(e,{name:"name",hash:{},data:o}):s)+"</span>\n\t"+(null!=(n=t.if.call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+"\n\t"+(null!=(n=t.if.call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+'\n\t<span class="toggle-slider">\n\t\t<svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg>\n\t</span>\n\t'+(null!=(n=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(5,o,0),inverse:this.noop,data:o}))?n:"")+"\n\t"+(null!=(n=t.if.call(e,null!=e?e.configLabel:e,{name:"if",hash:{},fn:this.program(7,o,0),inverse:this.noop,data:o}))?n:"")+"\n\n</li>\n"},useData:!0}),m.templates.settings.general=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pop-body">\n\t<h3>General</h3>\n\t<p class="description">Customize your dashboard</p>\n\n\t<h4>Show</h4>\n\t<ul id="widgets-list" class="settings-list options-list"></ul>\n\n\n\t<h4>Customize</h4>\n\t<ul id="customize-list" class="settings-list options-list"></ul>\n\n\n\t<h4>Options</h4>\n\t<ul id="misc-list" class="settings-list options-list"></ul>\n\n\n\t<h5>Tip</h5>\n\t<p class="no-top-margin">Many items in Momentum can be edited by double clicking on them, including: <strong>your name</strong>, <strong>location</strong>, <strong>clock</strong>, <strong>temperature</strong>, and <strong>todos</strong>.\n\t</p>\n\n</div>\n'},useData:!0}),m.templates.settings.help=Handlebars.template({1:function(e,t,i,o){return'<strong class="hotkey">C</strong>Chrome Tab<br> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<div class="pop-body settings-help">\n\t<h3>Help</h3>\n\t<p class="description"></p>\n\n\t<h5>Tips</h5>\n\t<p>To change your name, toggle the temperature between C and F, change your location, or toggle the clock between 12 and 24 hour, <strong>double click</strong> on the setting you wish to change.</p>\n\n\t<h5>Hotkeys</h5>\n\t<p class="hotkeys">\n\t\t<span class="col">\n\t\t\t<strong class="hotkey">T</strong> - Todo<br>\n\t\t\t<strong class="hotkey">F</strong> - Focus<br>\n\t\t\t<strong class="hotkey">B</strong> - Bookmarks bar<br>\n\t\t\t<strong class="hotkey">,</strong> - Settings<br>\n\t\t\t<strong class="hotkey">ESC</strong> - Cancel, close\n\t\t</span><span class="col">\n\t\t\t<strong class="hotkey">L</strong>Links<br>\n\t\t\t<strong class="hotkey">S</strong>Search<br>\n\t\t\t'+(null!=(n=t.if.call(e,null!=e?e.isChrome:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\n\t\t\t<strong class="hotkey">W</strong>Weather<br>\n\t\t\t<strong class="hotkey">SPACE</strong>Hold to admire photo<br>\n\t\t</span>\n\t</p>\n\t<p>\n\t\tPress <strong class="hotkey" style="margin: 0 2px;">TAB</strong> to focus Momentum when opening a new tab to be able to use hotkeys. You may need to press tab more than once.\n\t</p>\n\n\t<h5>Need more help?</h5>\n\t<p>\n\t\t<a href="http://momentumdash.com/help" class="button button-inline" target="_blank">Check out our Help Center</a>\n\n\t</p>\n</div>\n'},useData:!0}),m.templates.settings.loading=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pop-body settings-loading">\n    <p class="settings-loading-loading-message"><i class="loading-icon"></i>Loading...</span></p>\n    <p class="settings-loading-error-message">We\'re having trouble loading these settings.</p>\n    <span class="button button-retry">Retry</span>\n</div>'},useData:!0}),m.templates.settings.main=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pane pane-container widget-pop settings nipple-bottom-left">\n    <ul id="nav-menu" class="settings-nav border-right"></ul>\n    <div class="subpanel-container upsell-parent"></div>\n</div>\n'},useData:!0}),m.templates.settings.navmenu=Handlebars.template({1:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t<li data-navitem="'+l(typeof(n=null!=(n=t.id||(null!=e?e.id:e))?n:s)===a?n.call(e,{name:"id",hash:{},data:o}):n)+'" class="main-nav-item">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+"</li>\n"},3:function(e,t,i,o){var n;return null!=(n=t.if.call(e,o&&o.first,{name:"if",hash:{},fn:this.program(4,o,0),inverse:this.program(6,o,0),data:o}))?n:""},4:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<li data-navitem="'+l(typeof(n=null!=(n=t.id||(null!=e?e.id:e))?n:s)===a?n.call(e,{name:"id",hash:{},data:o}):n)+'" class="main-nav-item secondary secondary-first">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+"</li>\n"},6:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<li data-navitem="'+l(typeof(n=null!=(n=t.id||(null!=e?e.id:e))?n:s)===a?n.call(e,{name:"id",hash:{},data:o}):n)+'" class="main-nav-item secondary">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+"</li>\n"},8:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t<div class="user no-transition">\n\t\t<div class="user-info" title="'+l(typeof(n=null!=(n=t.email||(null!=e?e.email:e))?n:s)===a?n.call(e,{name:"email",hash:{},data:o}):n)+'">\n\t\t\t<div class="user-avatar-wrapper">\n\t\t\t\t<div class="user-avatar"><img src="/img/gravatar_unknown.jpg"></div>\n\t\t\t\t<div class="user-avatar-hidden"><img src=""></div>\n\t\t\t\t<div class="user-badge-wrapper">\n\t\t\t\t\t<span class="badge plus-badge">PLUS</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<span class="user-info-name">'+l(typeof(n=null!=(n=t.displayName||(null!=e?e.displayName:e))?n:s)===a?n.call(e,{name:"displayName",hash:{},data:o}):n)+'</span>\n\t\t\t<i class="icon icon-angle-up user-info-icon"></i>\n\t\t</div>\n\t\t\t<div class="user-hidden">\n\t\t\t\t<ul class="user-nav">\n\t\t\t\t\t<li class="slide-toggle sync-option" title="'+l(typeof(n=null!=(n=t.syncMessage||(null!=e?e.syncMessage:e))?n:s)===a?n.call(e,{name:"syncMessage",hash:{},data:o}):n)+'">\n\t\t\t\t\t\t<input class="sync-check" type="checkbox">\n\t\t\t\t\t\t<span class="sync-caption setting-name">Account Sync</span>\n\t\t\t\t\t\t<span class="toggle-slider"><span class="toggle-switch"></span></span>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li class="action action-profile">Profile</li>\n\t\t\t\t\t<li class="action action-logout">Log Out</li>\n\t\t\t\t</ul>\n\t\t\t<div class="user-close"></div>\n\t\t</div>\n\t</div>\n\n'},10:function(e,t,i,o){return'\t<div class="user login">\n\t\t<div class="login-button">\n\t\t\t<div class="login-title">Log In</div>\n\t\t\t<div class="login-description">Sync your account and more!</div>\n\t\t</div>\n\t</div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return(null!=(n=t.each.call(e,null!=(n=null!=e?e.menu:e)?n.navItems:n,{name:"each",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+(null!=(n=t.each.call(e,null!=(n=null!=e?e.menu:e)?n.secondaryNavItems:n,{name:"each",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+(null!=(n=t.if.call(e,null!=e?e.loggedIn:e,{name:"if",hash:{},fn:this.program(8,o,0),inverse:this.program(10,o,0),data:o}))?n:"")},useData:!0}),m.templates.settings.upgrade=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<div class="hero upgrade-hero">\n\t<style type="text/css">\n\t\t.upgrade-hero { padding-bottom: 30px; border-bottom: 1px solid #444; }\n\t\t.upgrade-hero h3 { margin-bottom: 6px; }\n\t\t.upgrade-hero .description { margin-bottom: 15px; opacity: 0.8; }\n\t\t.settings-upgrade .button { padding: 12px 30px; font-size: 95%; font-weight: 500; text-transform: uppercase; }\n\t</style>\n\n\t<h3>Momentum Plus is Here!</h3>\n\t<p class="description" style="margin-bottom: 15px; opacity: 0.8;" ">Level up your focus with customization, integrations, and new widgets.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span>\n\t<span class="special">Launch Special!<strong style="margin-left: 5px;"><i class="fa fa-sun-o"></i> 33% Off</strong></span>\n\t<span class="price-line"><span class="price">$1.99/month</span> or <span class="price">$19.99/year</span> (equal to 2 months free!)<br></span>\n</div>\n\n\n\n<div class="feature-list">\n\t<style type="text/css">\n\t\t.feature-list { margin-top: 30px; }\n\t\t.feature-list h4 { margin-bottom: 15px; font-size: 95%; opacity: 0.8; text-transform: uppercase; }\n\t\t.feature-list-icon { width: 40px; margin-top: -2px; float: left; font-size: 120%; text-align: center; }\n\t\t.feature-list-info { margin-left: 40px; margin-bottom: 20px; }\n\t\t.feature-list-info h5 { margin: 0 0 4px; font-size: 92%; opacity: 1; }\n\t\t.feature-list-info p { margin-top: 5px; font-size: 13px; line-height: 135%; opacity: 0.7; }\n\t</style>\n\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Todo Integrations</h5>\n\t\t<p>Momentum Plus connects with your favorite task management services! See, update, and create new tasks from Trello, Todoist, Wunderlist, and Google Tasks.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Background Photos</h5>\n\t\t<p>Light up your day every time you open a new tab. Add your own photos or choose from your favorites or past photos in Momentum.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Personalize Font and Color</h5>\n\t\t<p>Make Momentum your own by choosing a font and color that suits your personality. Incorporate your own style to motivate, inspire, and bring focus to your day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Quotes</h5>\n\t\t<p>Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Skip Photo/Quote</h5>\n\t\t<p>Not feeling the photo or quote of the day? No problem; a new one is just a refresh away. Cycle between five photos and five quotes per day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Autofocus Mode</h5>\n\t\t<p>Set your priorities at the start of the day and Momentum will show you the one thing you need to focus on at a time. Check it off, and the next up todo becomes your focus.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Inbox, Today, and Done Lists</h5>\n\t\t<p>Keep your todo list clutter free with the Inbox list. Know exactly what you need to do for the day with the Today list. Follow up on what you’ve completed with the Done list.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Priority Support</h5>\n\t\t<p>Plus subscribers can be assured that their messages, suggestions and requests will be answered promptly by a real human. Your satisfaction is of the utmost importance to us.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Early Access</h5>\n\t\t<p>Get exclusive early access to exciting new Momentum features. Have a say in the direction of the product. Next early release feature: Notes.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Support Momentum</h5>\n\t\t<p>Your subscription helps Momentum  Plus subscriptions help sustain Momentum and enable the addition of more features. Thank you for your support — we are incredibly grateful!</p>\n\t</div>\n</div>\n\n\n\n<div class="cta">\n\t<style type="text/css">\n\t\t.settings-upgrade .cta { margin: 50px 0 70px; padding: 25px 10px 10px; border-top: 1px solid #444; border-bottom: 1px solid #444; text-align: center; }\n\t\t.settings-upgrade .cta .pitch { margin: 0 0 19px; font-size: 125%; line-height: 135%; }\n\t\t.settings-upgrade .cta .button { margin-bottom: 0; }\n\t\t.settings-upgrade .link { margin: 3px 0 0; padding: 8px; display: inline-block; background: none !important; cursor: pointer; opacity: 0.5; text-decoration: none; -webkit-transition: all 0.1s ease; }\n\t\t.settings-upgrade .link:hover { opacity: 0.7; }\n\t</style>\n\n\t<p class="pitch">Upgrade to Momentum Plus today and turn<br>your potential into progress.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span><br>\n\t<a href="https://momentumdash.com/plus?'+this.escapeExpression("function"==typeof(n=null!=(n=t.campaignDetails||(null!=e?e.campaignDetails:e))?n:t.helperMissing)?n.call(e,{name:"campaignDetails",hash:{},data:o}):n)+'" class="link">Learn More</a>\n</div>\n\n\n\n<div class="faq">\n\t<style type="text/css">\n\t\t.settings-upgrade .faq { margin-top: 0; padding: 0 75px; font-size: 90%; opacity: 1; }\n\t\t.settings-upgrade .faq:first-child { margin-top: 0; }\n\t\t.settings-upgrade .faq:last-child { margin-bottom: 10px !important; }\n\n\t\t.settings-upgrade .faq-question { opacity: 0.9; }\n\t\t.settings-upgrade .faq-answer { opacity: 0.7; }\n\t</style>\n\t<p>\n\t\t<span class="faq-question">What are the available integrations?</span>\n\t\t<span class="faq-answer">Currently we integrate with Wunderlist, Google Tasks, Todoist, and Fitbit. Coming soon: Trello and Asana.\x3c!--Github, Google Analytics, Uservoice, Harvest.--\x3e</span>\n\t</p>\n\n\t<p>\n\t\t<span class="faq-question">I thought Momentum was free?</span>\n\t\t<span class="faq-answer">Momentum Free will always be free. We created Momentum Plus to bring more control and functionality to those who desire it, while still keeping the experience simple and focused.</span>\n\t</p>\n</div>'},useData:!0}),m.templates.settings.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="right">\n\t<span class="button upsell-action">'+l(typeof(n=null!=(n=t.buttonText||(null!=e?e.buttonText:e))?n:s)===a?n.call(e,{name:"buttonText",hash:{},data:o}):n)+'</span>\n\t<span class="hide upsell-hide">✕</span>\n</div>\n<div class="available">Available on Plus</div>\n<div class="title">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+'</div>\n<div class="description">'+l(typeof(n=null!=(n=t.description||(null!=e?e.description:e))?n:s)===a?n.call(e,{name:"description",hash:{},data:o}):n)+"</div>\n"},useData:!0}),m.templates.settings.whatsnew=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pop-body settings-detail whatsnew">\n\t<div class="settings-detail-header">\n\t\t<h3>What\'s New</h3>\n\t\t<p class="description">Updates from the Momentum Team</p>\n\t</div>\n\n\t<div class="whatsnew-body">\n\t\t<h4>October 17</h4>\n\t\t<p>\n\t\t\t- "Last seen" now shows on the Favorites and History detail pages.\n\t\t</p>\n\n\n\t\t<h4>October 7</h4>\n\t\t<p>\n\t\t\t<strong>Favorites and History are here!</strong><br>\n\t\t<p>One of the most popular suggestions that we’ve received has been the ability to view past Momentum backgrounds. With this week’s update, this is now possible.</p>\n\n\t\t<p>On the Favorites page, you can view the backgrounds that you’ve favorited (aka “hearted”). On the History page, you can view all of the past backgrounds that have displayed on your Momentum dashboard.</p>\n\n\t\t<p>Explore your Favorites and History pages by clicking <strong>Settings → Backgrounds</strong>.</p>\n\n\t\t<p>Plus users can also make any favorite or past photo into their current background just as they would a custom background.</p>\n\n\t\t<p>To learn more check out the help articles: <a href="http://help.momentumdash.com/knowledgebase/articles/1083655-backgrounds-favorites">Favorites Help</a> • <a href="http://help.momentumdash.com/knowledgebase/articles/1083682-backgrounds-history">History Help</a>.</p>\n\n\n\n\t\t<h4>October 3</h4>\n\t\t<p>\n\t\t\t<strong>Account page, now with fewer infinite loops</strong><br>\n\t\t\tThe account page has gotten an overhaul and added functionality. You can now:<br>\n\t\t\t- Change your personal details<br>\n\t\t\t- Add multiple emails to your account<br>\n\t\t\t- Manage your Plus account much more easily<br>\n\t\t\t<br>\n\t\t\tFind Account in Settings → General by your name, or go to <a href="http://account.momentumdash.com">http://account.momentumdash.com</a>.</p>\n\n\n\n\t\t<h4>August 26</h4>\n\t\t<p>\n\t\t\t- Added Custom Backgrounds (Plus)<br>\n\t\t\t- Disconnect integration now possible!<br>\n\t\t\t- Drag and drop an image onto Momentum to add to Custom Backgrounds<br>\n\t\t\t- Ongoing work with the drag and drop to reorder todo<br>\n\t\t\t- Settings panels now loaded on the fly<br>\n\t\t\t- Many improvements to the Settings widget\n\t\t</p>\n\n\n\n\t\t<h4>July 13</h4>\n\t\t<p>\n\t\t\t<strong>New on Plus: Custom Backgrounds</strong><br>\n\t\t\tCurate your own quote collection. Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.<br>\n\t\t</p>\n\n\n\n\t\t<h4>July 6</h4>\n\t\t<p>\n\t\t\t<strong>New on Plus: Trello!</strong><br>\n\t\t\tWe\'re super excited to announce the new Trello integration! Add any Trello boards you\'d like to see in the Momentum Todo. See all the cards in each list and check off a card to move it to the next list.  To switch between lists, use the list dropdown (or left/right arrow keys). To switch quickly between boards, hold shift and use the left and right arrow keys.\n\t\t</p>\n\n\n\n\t\t<h4>June 3</h4>\n\t\t<p>\n\t\t\t<strong>0.90.1 Update</strong><br>\n\t\t\tWe continue to work toward expanding the Plus offering. With this latest update we put one more plumbing style feature in place for the Trello integration. We will launch a beta of it soon which people can join.</p>\n\n\t\t<p>\n\t\t\t- Plus signs will now work in email addresses.<br>\n\t\t\t- Getting one more plumbing feature in place for the Trello integration.<br>\n\t\t\t- Cleanups and bug fixes.\n\t\t</p>\n\n\n\t\t<h4>May 23</h4>\n\t\t<h5 style="margin: 0; font-size: 130%; opacity: 1;">Make Momentum your own</h5>\n\t\t<p style="margin: 2px 0; line-height: 130%; opacity: 0.6;">Favorites, Custom Themes, Skip Photo/Quote, Trello Integration, and more! (v0.90 Update)</p>\n\n\t\t<h5 style="margin-top: 1em">Summary</h5>\n\n\t\t<p>This exciting new update is loaded with features that enable endless personalization possibilities. <strong>Customize</strong> your dashboard with new <strong>fonts</strong> and widget <strong>colors</strong>. Save your favorite background photos and inspiring quotes with the new Favorite feature, and pass by the ones you dislike with the new <strong>Skip</strong> feature. Also, introducing our newest integration — <strong>Trello </strong> — coming next. Thank you everyone for the support!</p>\n\n\t\tNew features:<br>\n\t\t- Favorite photos/quotes<br>\n\t\t- Custom font and color (Plus)<br>\n\t\t- Skip photo/quote (Plus)<br>\n\t\t- Trello integration (Plus)<br>\n\t\t- Many bug fixes and improvements<br>\n\t\t- New look to notifications<br>\n\t\t- Next focus: Two new widgets!<br>\n\n\n\t\t<h5>A message to the Momentum Community</h5>\n\n\t\t<p>We are super excited to announce our latest update to Momentum (v. 0.90). The Momentum team has been really busy for the past couple months bringing this update to light, and late last night (May 22) we finally got it ready to launch and began the release process.</p>\n\n\t\t<p>One of our main focuses right now is building out the value of our Plus offering to deliver more value to our existing subscribers and build out the appeal to potential subscribers. Momentum Plus represents our path to sustainability so we can continue to build out the product without sacrificing the vision to profit incentives of investors. We are approaching an official launch for Plus with a few more major things to come. We\'re very grateful to those of you who have signed up for Plus. It supports the Momentum team and continued development of the product!</p>\n\n\n\t\t<h5>Favorite Photos and Quotes</h5>\n\n\t\t<p>Like the background or quote of the day? Highlight the location or quote and click the heart to favorite it. In the future we will have a way to browse your favorites to see a nice collection of your tastes.</p>\n\n\n\t\t<h5>Personalize the look and feel of Momentum! (Plus)</h5>\n\n\t\t<p>Make Momentum your own by choosing a font and color theme for Momentum’s widgets. Our favorite font is Modern but we\'ve added quite a few options to suit a variety of different tastes: Modern, Startup, Retro, Warehouse, and Quirky. Head over to Customize in General settings and try them out!</p>\n\n\t\t<p>Additionally, you can significantly change the look of your dashboard by switching your widget theme color! This new feature literally provides you with the ability to let your true colors shine through your dashboard. Our lead developer Jason is in to the new Light theme, but our community manager Ben is digging the dark green. The choice is yours! :)</p>\n\n\t\t<p>These features started as a way of freshening up Momentum internally with a new font (Modern on Mac) and a light mode. We quickly realized it was a fun way to personalize and freshen things up for everyone, so we added more fonts and the ability to set any color. We have more in mind for personalization, including a photo match mode.</p>\n\n\n\t\t<h5>Skip Photo/Quote (Plus)</h5>\n\n\t\t<p>Ever have those days where you\'re not quite feeling the photo or quote? Us too. With this new feature you can change the photo or quote by simply hovering your mouse over the background location or quote and then click the "Next" arrow to get a new one!\n\t\t</p>\n\n\t\t<p>We still love the idea of putting a limit on the number of images to prevent binge behavior and support focus, so we\'ve set a limit of 5 images per day. When skipping the last image it will cycle back to the first image of the day, so you can set it to the one you like the most and switch it up throughout the day.</p>\n\n\n\t\t<h5>Trello integration (Plus)</h5>\n\n\t\t<p>We\'re heavy Trello users here at Momentum, so this one is pretty exciting for us. Hook up your Trello boards and sync your cards right into Momentum. Choose the boards you want to appear in Momentum and quickly switch between them with shift+left/right arrow. Switch between lists with the left/right arrow keys. There\'s also an option to show only cards assigned to you, to quickly cut through the clutter.</p>\n\n\t\t<p>Trello will be rolling out later this week or early next week as we complete some of the back end functionality.</p>\n\n\t\t<h5>Many, many Todo improvements</h5>\n\n\t\t<p>Ah yes, the classic "bug fixes and performance improvements". We\'ve done a pile of fixes, including a lot of stuff to the Todo. We also fixed the What\'s New which was stuck on an update from last month.</p>\n\n\n\t\t<h5>New look to notifications</h5>\n\n\t\t<p>When Momentum first launched we needed a way to tell people we were rolling out updates, and as we added things like user accounts we used that same widget to notify about new account, logging out, etc. As often happens in software, it stuck around because we were too busy with other projects. With this recent update, your notifications will now be displayed at the bottom left corner of your dashboard and will mirror your customized theming. It\'s a lot prettier than the old one. :)</p>\n\n\n\t\t<h5>A new product</h5>\n\n\t\t<p>With all these updates, Momentum really feels like a new product to us. And we\'re really excited for what\'s on the horizon. We couldn\'t do it without you, so thank you for your support. In our next update we will be announcing two new widgets! Stay tuned for more on those.</p>\n\n\t\t<p>Also, if any of you are interested in a new visualization mode for the clock, message in and we\'ll send you instructions on how to enable it. It\'s in an early testing mode right now and we\'d love to get your feedback.</p>\n\n\t\t<p>We\'d love to hear your feedback on the new update and any suggestions for the future, so please <a href="https://momentumdash.com/contact">get in touch</a>!</p>\n\n\n\n\t\t<h4>May 18</h4>\n\n\t\t<p>All pending account sync requests have been activated. Also, account sync will now automatically activate when enabled. Yay to instant and automatic.</p>\n\n\t\t<p>We are putting the finishing touches on our next release which adds a lot of control and customization to the Momentum Plus experience. If you\'ve ever found yourself not too enthused about the image of the day, you can now skip it. Same for the quote. We are also adding more fonts and color themes to freshen things up and add more personalization. Oh, and this release also includes the much anticipated Trello integration!</p>\n\n\t\t<p>Both Momentum Plus and Free will also be getting Favorite background/quote. This will open the door to a Favorites page to see your favourite backgrounds and quotes anytime!</p>\n\n\t\t<h5>Join the Momentum Kiva team</h5>\n\t\t<p>Did you know we have a Momentum Kiva team? <a href="https://www.kiva.org/invitedto/momentum_dash/by/levibe">Join today</a> and empower people in challenging circumstances to improve their lives!</p>\n\n\n\t\t<h4>April 29</h4>\n\n\t\t<h5>Todoist</h5>\n\t\t<p>Sorting of todos now works a lot better, especially those with nested todos. Nested todos will show properly indented in the next release.</p>\n\n\t\t<p>Delete todo is now working for Google Tasks and Wunderlist. Todoist delete still needs some work.</p>\n\n\n\t\t<h4>April 26</h4>\n\n\t\t<p>After much confusion, we discovered that many of the messages from our website contact form weren\'t coming through. Fixed! However, if you already sent a message and haven\'t heard a response, then we likely lost your message. :( Please reach out again and we\'ll be very happy to hear from you.</p>\n\n\n\t\t<h4>April 25</h4>\n\t\t<h5>Wunderlist</h5>\n\t\t<p>Default ordering of the todos will now be the same in Momentum as in Wunderlist.</p>\n\n\t\t<h5>Todoist</h5>\n\t\t<p>You can now choose separate Todoist lists instead of todos all being lumped into Today.</p>\n\n\n\t\t<h4>April 19</h4>\n\t\t<p>Google search now goes directly to the results page on Google.com. We were using a custom feed through Google and they shut it down.</p>\n\n\n\t\t<h4>April 15</h4>\n\t\t<h5>Todoist & Wunderlist</h5>\n\t\t<p>Wunderlist, Todoist, and Google Tasks now work with our autofocus/set to focus features. Sorting on Todoist needs a bit more work, due to nested tasks. More to come on that in an upcoming release.</p>\n\n\t\t<h4>April 14</h4>\n\t\t<p>Plus users! We have a major release for the Todo widget to announcing including an exciting new feature that has been in the works for quite some time: <strong>automatically set your todos as your main focus</strong>.</p>\n\n\t\t<h5>Autofocus Mode</h5>\n\t\t<p>You can now have Momentum automatically set your top ordered todo as your main focus. To enable Autofocus mode, go into Settings or click the loop icon near the settings icon in the Todo list.</p>\n\n\t\t<p>In the morning, set up your todo list in order of priority, then throughout the day you can simply check off your Focus and your next task will fill in as your main focus. Magic! Combine autofocus with integrations and you can have end to end integration from your other todo source right into your main focus.</p>\n\n\t\t<p>You can also manually set a todo to your focus by clicking the <span class="hotkey">•••</span> dropdown and going to "Set to focus".</p>\n\n\t\t<h5>Hotkeys to switch between lists and todo sources (integrations)</h5>\n\t\t<p>\n\t\t\t- Use <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to move between lists (e.g. Inbox to Today)<br>\n\t\t\t- Use <span class="hotkey">shift</span> + <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to switch between sources/integrations (e.g. Momentum Todo to Todoist)</p>\n\n\t\t<h5>Todo completely rebuilt</h5>\n\t\t<p>We completely revamped the Todo widget to perform much better and fix a bunch of bugs. Sorting todos (by dragging and dropping) and moving todos between lists should now work properly. The Done list will also now show headings for the days todos were completed.</p>\n\n\t\t<h5>Did you know?</h5>\n\t\t<p>You can quickly move a todo between your Inbox and Today lists by hovering over the todo with your mouse and pressing <span class="hotkey">space</span>? We encourage keeping your Today list short and focused, and this is a way to help you do that!</p>\n\n\t\t<h5>Momentum Free & Plus Updates</h5>\n\t\t<p>\n\t\t\t- Responsive styling added so Momentum will shrink down better on smaller screens<br>\n\t\t\t- Setting a manual weather location (double click on location) will stay set again<br>\n\t\t\t- Bug where weather will sometimes show a super high temperature has been fixed<br>\n\t\t\t- Many bug fixes and improvements\n\t\t</p>\n\n\t\t<h4>Feb 17-18</h4>\n\t\t<p>Wunderlist and Google Tasks Todos were broken when it came to editing and checking off. Fixed!</p>\n\n\t\t<h4>Feb 12</h4>\n\t\t<p>So, we had a pretty bad bug that we had trouble tracking down where the focus disappeared for some people after they saved it. Well, we finally found it and fixed it! It turns out it was happening for heavy focus users, who are the people for whom we want the focus to work the best! Sorry :(</p>\n\n\t\t<h4>Feb 10</h4>\n\t\t<p>Hello from the Momentum team! We have added this section to share real time updates on what we have been up to at Momentum, like a changelog. Keep checking back!</p>\n\n\t\t<h4>Feb 8</h4>\n\t\t<p>\n\t\t\t- Todoist integration will now show just Today tasks instead of a firehose of all tasks. Project lists coming soon!<br>\n\t\t\t- "Awaiting authorization" no longer shows when an integration is already authorized.<br>\n\t\t\t- Fixed a bug on the Contact form on the website where emails wouldn\'t send if the person had a plugin that added an extra field into the form.\n\t\t</p>\n\t</div>\n</div>'},useData:!0}),m.templates=m.templates||{},m.templates.todos=m.templates.todos||{},m.templates.todos.addtodolist=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div id="add-label" class="todo-list-add-button"><i class="icon icon-plus"></i> Add List</div>\n<input id="list-new" class="todo-input todo-list-add-input" type="text" placeholder="New List" />\n<span class="loading new-list-loading"><i class="loading-icon"></i> <span >Loading...</span></span>\n'},useData:!0}),m.templates.todos.dropdownmenu=Handlebars.template({1:function(e,t,i,o){var n;return'\t<i class="control control-dropdown icon '+this.escapeExpression("function"==typeof(n=null!=(n=t.iClassName||(null!=e?e.iClassName:e))?n:t.helperMissing)?n.call(e,{name:"iClassName",hash:{},data:o}):n)+'"></i>\n'},3:function(e,t,i,o){var n;return null!=(n=t.if.call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(4,o,0),inverse:this.program(6,o,0),data:o}))?n:""},4:function(e,t,i,o){var n;return'\t<span class="control control-dropdown"><img class="todo-provider-icon" src="'+this.escapeExpression("function"==typeof(n=null!=(n=t.providerLogo||(null!=e?e.providerLogo:e))?n:t.helperMissing)?n.call(e,{name:"providerLogo",hash:{},data:o}):n)+'"><svg class="todo-menu-dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 34 32"><path d="M16,17H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M16,10H2A1,1,0,0,1,2,8H16a1,1,0,0,1,0,2Z"/><path d="M16,24H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M28.5,19.12a.87.87,0,0,1-.62-.26l-4.5-4.5a.88.88,0,0,1,1.24-1.24L28.5,17l3.88-3.88a.88.88,0,0,1,1.24,1.24l-4.5,4.5A.87.87,0,0,1,28.5,19.12Z"/></svg></span>\n'},6:function(e,t,i,o){return'\t\x3c!-- Do we need the header class below? --\x3e\n\t<i class="control-dropdown icon icon-ellipsis todo-actions-toggle"></i>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s;return(null!=(n=t.if.call(e,null!=e?e.iClassName:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.program(3,o,0),data:o}))?n:"")+'<div class="dropdown '+this.escapeExpression("function"==typeof(s=null!=(s=t.dropdownClassName||(null!=e?e.dropdownClassName:e))?s:t.helperMissing)?s.call(e,{name:"dropdownClassName",hash:{},data:o}):s)+'">\n\t<ul class="dropdown-list"></ul>\n\t<ul class="dropdown-detail"></ul>\n</div>\n'},useData:!0}),m.templates.todos["legacy-todo-complete"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="metric-stat">'+l(typeof(n=null!=(n=t.done||(null!=e?e.done:e))?n:s)===a?n.call(e,{name:"done",hash:{},data:o}):n)+'</span>\n<span class="metric-label">'+l(typeof(n=null!=(n=t.item||(null!=e?e.item:e))?n:s)===a?n.call(e,{name:"item",hash:{},data:o}):n)+" complete</span>"},useData:!0}),m.templates.todos["legacy-todo-item"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<i class="control destroy">✕</i>\n<i class="loading-icon"></i>\n<i class="control error-icon">!</i>\n<label><input class="todo-item-checkbox" type="checkbox"></label><span class="todo-item-title" >'+this.escapeExpression("function"==typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:t.helperMissing)?n.call(e,{name:"title",hash:{},data:o}):n)+"</span>\n"},useData:!0}),m.templates.todos["legacy-todo"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pane-container todo-pane-container nipple-bottom-right">\n    <div class="pane todo-pane todo-pane-legacy">\n        <div class="todo-header">\n            <ul>\n                <li><span class="todo-count"><i class="loading-icon"></i>Loading...</span></li>\n            </ul>\n            <div class="error-message">Connection required to add Todo</div>\n        </div>\n        <div class="empty empty-todo">\n            <div class="content">\n                <div class="graphic">☺</div>\n                <div class="title">Nothing to do</div>\n                <div class="description">One step at a time...</div>\n            </div>\n        </div>\n        <ol class="todo-list"></ol>\n        <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n    </div>\n</div>\n<span id="todo-remaining"></span>\n<span class="toggle todo-toggle">Todo</span>\n'},useData:!0}),m.templates.todos.parentlistactive=Handlebars.template({1:function(e,t,i,o){var n;return'<img class="todo-provider-icon" src="'+this.escapeExpression("function"==typeof(n=null!=(n=t.providerLogo||(null!=e?e.providerLogo:e))?n:t.helperMissing)?n.call(e,{name:"providerLogo",hash:{},data:o}):n)+'">'},3:function(e,t,i,o){var n;return'<div class="message todo-message"><span class="message-title">'+this.escapeExpression("function"==typeof(n=null!=(n=t.statusMessage||(null!=e?e.statusMessage:e))?n:t.helperMissing)?n.call(e,{name:"statusMessage",hash:{},data:o}):n)+"</span>"},5:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="message-action" id="status-action" data-action="'+l(typeof(n=null!=(n=t.action||(null!=e?e.action:e))?n:s)===a?n.call(e,{name:"action",hash:{},data:o}):n)+'">'+l(typeof(n=null!=(n=t.actionMessage||(null!=e?e.actionMessage:e))?n:s)===a?n.call(e,{name:"actionMessage",hash:{},data:o}):n)+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li>\n\t<div class="todo-list-color" style="background-color: '+r(typeof(s=null!=(s=t.color||(null!=e?e.color:e))?s:a)===l?s.call(e,{name:"color",hash:{},data:o}):s)+'">&nbsp;</div>\n\t'+(null!=(n=t.if.call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\x3c!--\n\t--\x3e<span class="todo-list-name-wrapper">\x3c!--\n\t\t--\x3e<span class="todo-list-name">'+r(typeof(s=null!=(s=t.listTitle||(null!=e?e.listTitle:e))?s:a)===l?s.call(e,{name:"listTitle",hash:{},data:o}):s)+'</span>\x3c!--\n\t\t--\x3e<i class="icon icon-angle-down"></i>\x3c!--\n\t--\x3e</span>\x3c!--\n\t--\x3e\n\t<div class="todo-external-label">View in '+r(typeof(s=null!=(s=t.providerTitle||(null!=e?e.providerTitle:e))?s:a)===l?s.call(e,{name:"providerTitle",hash:{},data:o}):s)+"</div>\n</li>\n"+(null!=(n=t.if.call(e,null!=e?e.statusMessage:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+"\n"+(null!=(n=t.if.call(e,null!=e?e.actionMessage:e,{name:"if",hash:{},fn:this.program(5,o,0),inverse:this.noop,data:o}))?n:"")+"\n"},useData:!0}),m.templates.todos["todo-list-empty-state"]=Handlebars.template({1:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="empty-link" data-target-list-id="'+l(typeof(n=null!=(n=t.targetListId||(null!=e?e.targetListId:e))?n:s)===a?n.call(e,{name:"targetListId",hash:{},data:o}):n)+'" data-use-command="'+l(typeof(n=null!=(n=t.use_command||(null!=e?e.use_command:e))?n:s)===a?n.call(e,{name:"use_command",hash:{},data:o}):n)+'">'+l(typeof(n=null!=(n=t.submessage||(null!=e?e.submessage:e))?n:s)===a?n.call(e,{name:"submessage",hash:{},data:o}):n)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s;return'<li class="empty">\n    <div><span class="empty-title">'+this.escapeExpression("function"==typeof(s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing)?s.call(e,{name:"message",hash:{},data:o}):s)+"</span>\n    "+(null!=(n=t.if.call(e,null!=e?e.submessage:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+"\n    </div>\n</li>"},useData:!0}),m.templates.todos.todoitem=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n;return'<span class="todo-item-wrapper">\n\t<div class="dropdown-container">\n\t</div>\n\n\t<i class="loading-icon"></i>\n\t<i class="control error-icon" title="Error saving click to retry">!</i>\n\n\t<label><input class="todo-item-checkbox" type="checkbox"></label>\n\t<span class="todo-item-title" >'+this.escapeExpression("function"==typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:t.helperMissing)?n.call(e,{name:"title",hash:{},data:o}):n)+"</span>\n</span>\n"},useData:!0}),m.templates.todos.todolistactive=Handlebars.template({1:function(e,t,i,o){return"has-projects "},3:function(e,t,i,o){var n;return null!=(n=t.if.call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(4,o,0),inverse:this.noop,data:o}))?n:""},4:function(e,t,i,o){return"has-lists"},6:function(e,t,i,o){return'<div class="todo-provider-wrapper"><div class="dropdown-container todo-project-chooser"></div></div>\n\n\t'},8:function(e,t,i,o){var n;return null!=(n=t.if.call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(9,o,0),inverse:this.noop,data:o}))?n:""},9:function(e,t,i,o){var n;return'<div class="todo-provider-wrapper"><img class="todo-provider-icon" src="'+this.escapeExpression("function"==typeof(n=null!=(n=t.providerLogo||(null!=e?e.providerLogo:e))?n:t.helperMissing)?n.call(e,{name:"providerLogo",hash:{},data:o}):n)+'"></div>'},11:function(e,t,i,o){return"no-caps"},13:function(e,t,i,o){var n;return'<div class="message todo-message"><span class="message-title">'+this.escapeExpression("function"==typeof(n=null!=(n=t.statusMessage||(null!=e?e.statusMessage:e))?n:t.helperMissing)?n.call(e,{name:"statusMessage",hash:{},data:o}):n)+"</span>"},15:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="message-action" id="status-action" data-action="'+l(typeof(n=null!=(n=t.action||(null!=e?e.action:e))?n:s)===a?n.call(e,{name:"action",hash:{},data:o}):n)+'">'+l(typeof(n=null!=(n=t.actionMessage||(null!=e?e.actionMessage:e))?n:s)===a?n.call(e,{name:"actionMessage",hash:{},data:o}):n)+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="'+(null!=(n=t.if.call(e,null!=e?e.supportProjects:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.program(3,o,0),data:o}))?n:"")+'">\n\t<div class="todo-list-color" style="background-color: '+r(typeof(s=null!=(s=t.color||(null!=e?e.color:e))?s:a)===l?s.call(e,{name:"color",hash:{},data:o}):s)+'">&nbsp;</div>\n\n\t'+(null!=(n=t.if.call(e,null!=e?e.supportProjects:e,{name:"if",hash:{},fn:this.program(6,o,0),inverse:this.program(8,o,0),data:o}))?n:"")+'\n\n\t<div class="todo-list-name-wrapper">\x3c!--\n\t\t--\x3e<span class="todo-list-name '+(null!=(n=t.if.call(e,null!=e?e.no_caps:e,{name:"if",hash:{},fn:this.program(11,o,0),inverse:this.noop,data:o}))?n:"")+'" title='+r(typeof(s=null!=(s=t.listTitle||(null!=e?e.listTitle:e))?s:a)===l?s.call(e,{name:"listTitle",hash:{},data:o}):s)+">"+r(typeof(s=null!=(s=t.listTitle||(null!=e?e.listTitle:e))?s:a)===l?s.call(e,{name:"listTitle",hash:{},data:o}):s)+'</span>\x3c!--\n\t\t--\x3e<i class="icon icon-angle-down"></i>\x3c!--\n\t--\x3e</div>\x3c!--\n\n\t--\x3e<div class="todo-actions">\n\t\t<div class="dropdown-container" id="todo-top-menu"></div>\n\t</div>\n</li>\n'+(null!=(n=t.if.call(e,null!=e?e.statusMessage:e,{name:"if",hash:{},fn:this.program(13,o,0),inverse:this.noop,data:o}))?n:"")+"\n"+(null!=(n=t.if.call(e,null!=e?e.actionMessage:e,{name:"if",hash:{},fn:this.program(15,o,0),inverse:this.noop,data:o}))?n:"")+"\n"},useData:!0}),m.templates.todos.todolistchoice=Handlebars.template({1:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<li class="'+l(typeof(n=null!=(n=t.class||(null!=e?e.class:e))?n:s)===a?n.call(e,{name:"class",hash:{},data:o}):n)+'" data-list-id="'+l(typeof(n=null!=(n=t.listId||(null!=e?e.listId:e))?n:s)===a?n.call(e,{name:"listId",hash:{},data:o}):n)+'">\n    <div class="todo-list-color" style="background-color: '+l(typeof(n=null!=(n=t.color||(null!=e?e.color:e))?n:s)===a?n.call(e,{name:"color",hash:{},data:o}):n)+'">&nbsp;</div>'+l(typeof(n=null!=(n=t.parentTitle||(null!=e?e.parentTitle:e))?n:s)===a?n.call(e,{name:"parentTitle",hash:{},data:o}):n)+"</li>"},3:function(e,t,i,o){return"todo-list-section"},5:function(e,t,i,o){var n;return'<div class="todo-list-color" style="background-color: '+this.escapeExpression("function"==typeof(n=null!=(n=t.color||(null!=e?e.color:e))?n:t.helperMissing)?n.call(e,{name:"color",hash:{},data:o}):n)+'">&nbsp;</div>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=t.helperMissing,l="function",r=this.escapeExpression;return(null!=(n=t.if.call(e,null!=e?e.parentTitle:e,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.noop,data:o}))?n:"")+'\n<li class="'+r(typeof(s=null!=(s=t.class||(null!=e?e.class:e))?s:a)===l?s.call(e,{name:"class",hash:{},data:o}):s)+" "+(null!=(n=t.if.call(e,null!=e?e.hasParent:e,{name:"if",hash:{},fn:this.program(3,o,0),inverse:this.noop,data:o}))?n:"")+'" data-list-id="'+r(typeof(s=null!=(s=t.listId||(null!=e?e.listId:e))?s:a)===l?s.call(e,{name:"listId",hash:{},data:o}):s)+'">\n\t'+(null!=(n=t.unless.call(e,null!=e?e.hasParent:e,{name:"unless",hash:{},fn:this.program(5,o,0),inverse:this.noop,data:o}))?n:"")+'\n\t<span class="todo-list-name">'+r(typeof(s=null!=(s=t.title||(null!=e?e.title:e))?s:a)===l?s.call(e,{name:"title",hash:{},data:o}):s)+'</span>\n\t<span class="todo-count">'+r(typeof(s=null!=(s=t.count||(null!=e?e.count:e))?s:a)===l?s.call(e,{name:"count",hash:{},data:o}):s)+"</span>\n</li>\n"},useData:!0}),m.templates.todos.todopane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){return'<div class="pane-container todo-pane-container nipple-bottom-right">\n\t<div class="pane todo-pane">\n\t\t<div class="drop-zone drop-left-zone">\n\t\t\t<span class="u--bg bar left-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\t\t<div class="drop-zone drop-right-zone">\n\t\t\t<span class="u--bg bar right-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\t\t<div class="todo-header">\n\t\t\t<ul class="todo-list-chooser todo-list-active main-list-active">\n\t\t\t\t<li><span class="todo-list-name"></span><span class="todo-count active-todo-count"></span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\n\t\t\t<ul class="todo-list-chooser todo-list-chooser-dropdown main-list-chooser" style="display: none"></ul>\n\n\t\t</div>\n\t\t<div class="todo-list-wrapper">\n\t\t\t<ol class="todo-list animating"></ol>\n\t\t</div>\n\t\t<input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n\t</div>\n</div>\n<span class="toggle todo-toggle">Todo</span></div>\n'},useData:!0}),m.templates.todos.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="hide upsell-hide">✕</span>\n<div class="available">Available on Plus</div>\n<div class="title">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+'</div>\n<div class="description">'+l(typeof(n=null!=(n=t.description||(null!=e?e.description:e))?n:s)===a?n.call(e,{name:"description",hash:{},data:o}):n)+'</div>\n<a href="" class="button upsell-action">'+l(typeof(n=null!=(n=t.buttonText||(null!=e?e.buttonText:e))?n:s)===a?n.call(e,{name:"buttonText",hash:{},data:o}):n)+"</a>\n"},useData:!0}),m.templates=m.templates||{},m.templates.weather=m.templates.weather||{},m.templates.weather.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="hide upsell-hide">✕</span>\n<div class="available">Available on Plus</div>\n<div class="title">'+l(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:s)===a?n.call(e,{name:"title",hash:{},data:o}):n)+'</div>\n<div class="description">'+l(typeof(n=null!=(n=t.description||(null!=e?e.description:e))?n:s)===a?n.call(e,{name:"description",hash:{},data:o}):n)+'</div>\n<a href="" class="button upsell-action">'+l(typeof(n=null!=(n=t.buttonText||(null!=e?e.buttonText:e))?n:s)===a?n.call(e,{name:"buttonText",hash:{},data:o}):n)+"</a>\n"},useData:!0}),m.templates.weather.weather=Handlebars.template({1:function(e,t,i,o){var n,s,a=this.lambda,l=this.escapeExpression,r=t.helperMissing,d="function";return'\t\t\t<span class="icon icon-weather" data-icon="'+l(a(null!=(n=null!=e?e.now:e)?n.icon:n,e))+'" title="'+l(a(null!=(n=null!=e?e.now:e)?n.condition:n,e))+'"></span><span class="metric-stat-number">'+l(a(null!=(n=null!=e?e.now:e)?n.temperature:n,e))+'</span><span class="weather-degree">&deg;</span><span class="unit '+l(typeof(s=null!=(s=t.unitClass||(null!=e?e.unitClass:e))?s:r)===d?s.call(e,{name:"unitClass",hash:{},data:o}):s)+'">'+l(typeof(s=null!=(s=t.unit||(null!=e?e.unit:e))?s:r)===d?s.call(e,{name:"unit",hash:{},data:o}):s)+"</span>\n"},3:function(e,t,i,o){return"\t\t\t&nbsp;\n"},5:function(e,t,i,o){return"loading"},7:function(e,t,i,o){var n;return'<span class="weather-header-message">'+this.escapeExpression("function"==typeof(n=null!=(n=t.displayDay||(null!=e?e.displayDay:e))?n:t.helperMissing)?n.call(e,{name:"displayDay",hash:{},data:o}):n)+"</span>"},9:function(e,t,i,o){var n;return'<span class="weather-header-message">'+this.escapeExpression("function"==typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:t.helperMissing)?n.call(e,{name:"message",hash:{},data:o}):n)+"</span>"},11:function(e,t,i,o){return'\t\t\t\t\t\t\t<li class="weather-attribution no-hover">\n\t\t\t\t\t\t\t\t<img class="weather-attribution-logo" src="../img/logo-accuweather.png">\n\t\t\t\t\t\t\t</li>\n'},13:function(e,t,i,o){var n;return null!=(n=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(14,o,0),inverse:this.noop,data:o}))?n:""},14:function(e,t,i,o){return'<i class="icon-angle-down"></i>'},16:function(e,t,i,o){var n;return'<span class="weather-current-temp">'+this.escapeExpression(this.lambda(null!=(n=null!=e?e.selected:e)?n.temperature:n,e))+"&deg;</span>"},18:function(e,t,i,o){var n,s=this.lambda,a=this.escapeExpression;return'<span class="weather-current-temp">'+a(s(null!=(n=null!=e?e.selected:e)?n.high:n,e))+'&deg;</span><span class="weather-current-temp-low">'+a(s(null!=(n=null!=e?e.selected:e)?n.low:n,e))+"&deg;</span>"},20:function(e,t,i,o){var n,s=this.lambda,a=this.escapeExpression;return'\t\t\t<div class="weather-current-details toggle-details">\n\t\t\t\t'+(null!=(n=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(14,o,0),inverse:this.noop,data:o}))?n:"")+'\n\t\t\t\t<div title="'+a(s(null!=(n=null!=e?e.selected:e)?n.hoursOfSun:n,e))+' hours of sun">\n\t\t\t\t\t<span class="weather-current-details-title">Feels like</span>\n\t\t\t\t\t<span class="weather-current-details-value"  >\n\t\t\t\t\t\t'+(null!=(n=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(21,o,0),inverse:this.program(23,o,0),data:o}))?n:"")+'\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div title="'+a(s(null!=(n=null!=e?e.selected:e)?n.precipitationExpected:n,e))+" "+a(s(null!=(n=null!=e?e.selected:e)?n.precipType:n,e))+' expected">\n\t\t\t\t\t<span class="weather-current-details-title">Chance of '+a(s(null!=(n=null!=e?e.selected:e)?n.precipType:n,e))+'</span>\n\t\t\t\t\t<span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.precipChance:n,e))+'%</span>\n\t\t\t\t</div>\n\t\t\t\t<div title="Gust '+a(s(null!=(n=null!=e?e.now:e)?n.windGust:n,e))+'">\n\t\t\t\t\t<span class="weather-current-details-title">Wind</span>\n\t\t\t\t\t<span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.windSpeed:n,e))+" "+(null!=(n=t.if.call(e,null!=(n=null!=e?e.selected:e)?n.windSpeed:n,{name:"if",hash:{},fn:this.program(25,o,0),inverse:this.noop,data:o}))?n:"")+"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n"},21:function(e,t,i,o){var n;return this.escapeExpression(this.lambda(null!=(n=null!=e?e.selected:e)?n.apparentTemperature:n,e))+"&deg;\n\t\t\t\t\t\t"},23:function(e,t,i,o){var n,s=this.lambda,a=this.escapeExpression;return a(s(null!=(n=null!=e?e.selected:e)?n.apparentHigh:n,e))+'&deg;<span class="weather-current-details-value-low">'+a(s(null!=(n=null!=e?e.selected:e)?n.apparentLow:n,e))+"&deg;</span>\n"},25:function(e,t,i,o){var n;return'<svg class="weather-arrow" style="transform: rotate('+this.escapeExpression(this.lambda(null!=(n=null!=e?e.selected:e)?n.windDirection:n,e))+'deg)" xmlns="http://www.w3.org/2000/svg" width="73.168" height="73.168" viewBox="0 0 73.168 73.168"><path d="M58.079 22.316L40.682 1.633A4.581 4.581 0 0 0 37.249 0c-1.392.075-2.599.534-3.485 1.52L15.185 22.204a4.584 4.584 0 0 0 .35 6.468 4.583 4.583 0 0 0 6.472-.354l10.109-11.253v51.531a4.578 4.578 0 0 0 4.584 4.572 4.577 4.577 0 0 0 4.581-4.572v-52.02l9.785 11.63a4.554 4.554 0 0 0 3.509 1.632 4.591 4.591 0 0 0 2.945-1.068 4.58 4.58 0 0 0 .559-6.454z"/></svg>'},27:function(e,t,i,o){var n,s=this.lambda,a=this.escapeExpression;return'\t\t<div class="weather-optional weather-hourly '+(null!=(n=t.if.call(e,null!=e?e.hourlyVisible:e,{name:"if",hash:{},fn:this.program(28,o,0),inverse:this.noop,data:o}))?n:"")+'" >\n\t\t\t<div class="weather-forecast weather-forecast-hourly">\n'+(null!=(n=t.each.call(e,null!=e?e.hours:e,{name:"each",hash:{},fn:this.program(30,o,0),inverse:this.noop,data:o}))?n:"")+'\t\t\t</div>\n\t\t</div>\n\n\t\t<div class="weather-optional weather-detail '+(null!=(n=t.if.call(e,null!=e?e.detailVisible:e,{name:"if",hash:{},fn:this.program(28,o,0),inverse:this.noop,data:o}))?n:"")+'">\n\t\t\t<div class="weather-extra">\n\t\t\t\t<div class="weather-extra-col">\n\t\t\t\t\t<div class="weather-extra-cell" title="Moon '+a(s(null!=(n=null!=e?e.selected:e)?n.moonPhase:n,e))+'">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Sunrise</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.sunrise:n,e))+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Sunset</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.sunset:n,e))+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Dewpoint</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.dewPoint:n,e))+'&deg;</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="pressure-text">\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Pressure</span> <span class="weather-current-details-value" '+(null!=(n=t.unless.call(e,null!=(n=null!=e?e.selected:e)?n.pressureDirectionVisible:n,{name:"unless",hash:{},fn:this.program(32,o,0),inverse:this.noop,data:o}))?n:"")+">"+(null!=(n=t.if.call(e,null!=(n=null!=e?e.selected:e)?n.pressureDirectionVisible:n,{name:"if",hash:{},fn:this.program(34,o,0),inverse:this.noop,data:o}))?n:"")+a(s(null!=(n=null!=e?e.selected:e)?n.pressure:n,e))+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="weather-extra-col">\n\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Humidity</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.humidity:n,e))+'%</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div title="In the past 24 hours">\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Precipitation</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.precipAmount:n,e))+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t<div title="'+a(s(null!=(n=null!=e?e.selected:e)?n.uvIndexText:n,e))+'">\n\t\t\t\t\t\t\t<span class="weather-current-details-title">UV Index</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.uvIndex:n,e))+'</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div title="'+a(s(null!=(n=null!=e?e.selected:e)?n.visibilityText:n,e))+'">\n\t\t\t\t\t\t\t<span class="weather-current-details-title">Visibility</span> <span class="weather-current-details-value">'+a(s(null!=(n=null!=e?e.selected:e)?n.visibility:n,e))+"</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n"},28:function(e,t,i,o){return"active"},30:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t\t\t<div class="weather-forecast-item" title="'+l(typeof(n=null!=(n=t.condition||(null!=e?e.condition:e))?n:s)===a?n.call(e,{name:"condition",hash:{},data:o}):n)+" ("+l(typeof(n=null!=(n=t.precipChance||(null!=e?e.precipChance:e))?n:s)===a?n.call(e,{name:"precipChance",hash:{},data:o}):n)+"% chance of "+l(typeof(n=null!=(n=t.precipType||(null!=e?e.precipType:e))?n:s)===a?n.call(e,{name:"precipType",hash:{},data:o}):n)+", "+l(typeof(n=null!=(n=t.windSpeed||(null!=e?e.windSpeed:e))?n:s)===a?n.call(e,{name:"windSpeed",hash:{},data:o}):n)+' wind)">\n\t\t\t\t\t<div class="weather-forecast-label">'+l(typeof(n=null!=(n=t.hour||(null!=e?e.hour:e))?n:s)===a?n.call(e,{name:"hour",hash:{},data:o}):n)+'</div>\n\t\t\t\t\t<span class="icon icon-weather weather-forecast-icon" data-icon="'+l(typeof(n=null!=(n=t.icon||(null!=e?e.icon:e))?n:s)===a?n.call(e,{name:"icon",hash:{},data:o}):n)+'"></span>\n\t\t\t\t\t<span class="weather-forecast-high">'+l(typeof(n=null!=(n=t.temperature||(null!=e?e.temperature:e))?n:s)===a?n.call(e,{name:"temperature",hash:{},data:o}):n)+"&deg;</span>\n\t\t\t\t</div>\n"},32:function(e,t,i,o){var n;return'title="'+this.escapeExpression(this.lambda(null!=(n=null!=e?e.selected:e)?n.pressureTendency:n,e))+'"'},34:function(e,t,i,o){var n;return'<svg class="weather-arrow weather-arrow-pressure" style="transform: rotate('+this.escapeExpression(this.lambda(null!=(n=null!=e?e.selected:e)?n.pressureDirection:n,e))+'deg)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 73.168 73.168"><path d="M58.079 22.316L40.682 1.633A4.581 4.581 0 0 0 37.249 0c-1.392.075-2.599.534-3.485 1.52L15.185 22.204a4.584 4.584 0 0 0 .35 6.468 4.583 4.583 0 0 0 6.472-.354l10.109-11.253v51.531a4.578 4.578 0 0 0 4.584 4.572 4.577 4.577 0 0 0 4.581-4.572v-52.02l9.785 11.63a4.554 4.554 0 0 0 3.509 1.632 4.591 4.591 0 0 0 2.945-1.068 4.58 4.58 0 0 0 .559-6.454z"/></svg>'},36:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<div class="weather-forecast-item weather-forecast-day" data-day="'+l(typeof(n=null!=(n=t.day||(null!=e?e.day:e))?n:s)===a?n.call(e,{name:"day",hash:{},data:o}):n)+'" title="'+l(typeof(n=null!=(n=t.condition||(null!=e?e.condition:e))?n:s)===a?n.call(e,{name:"condition",hash:{},data:o}):n)+'">\n\t\t\t<div class="weather-forecast-label">'+l(typeof(n=null!=(n=t.dayShort||(null!=e?e.dayShort:e))?n:s)===a?n.call(e,{name:"dayShort",hash:{},data:o}):n)+'</div>\n\t\t\t<span class="icon icon-weather weather-forecast-icon" data-icon="'+l(typeof(n=null!=(n=t.icon||(null!=e?e.icon:e))?n:s)===a?n.call(e,{name:"icon",hash:{},data:o}):n)+'" ></span>\n\t\t\t<span class="weather-forecast-high">'+l(typeof(n=null!=(n=t.high||(null!=e?e.high:e))?n:s)===a?n.call(e,{name:"high",hash:{},data:o}):n)+'&deg;</span><span class="weather-forecast-low">'+l(typeof(n=null!=(n=t.low||(null!=e?e.low:e))?n:s)===a?n.call(e,{name:"low",hash:{},data:o}):n)+"&deg;</span>\n\t\t</div>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s,a=this.lambda,l=this.escapeExpression,r=t.helperMissing,d="function";return'\x3c!-- Metric --\x3e\n<div class="weather-toggle" title="'+l(a(null!=(n=null!=e?e.now:e)?n.condition:n,e))+'">\n\t<div class="metric-stat">\n'+(null!=(n=t.if.call(e,null!=(n=null!=e?e.now:e)?n.icon:n,{name:"if",hash:{},fn:this.program(1,o,0),inverse:this.program(3,o,0),data:o}))?n:"")+'\t</div>\n\t<span class="location metric-label data" title="'+l(typeof(s=null!=(s=t.locationExact||(null!=e?e.locationExact:e))?s:r)===d?s.call(e,{name:"locationExact",hash:{},data:o}):s)+'">'+l(typeof(s=null!=(s=t.location||(null!=e?e.location:e))?s:r)===d?s.call(e,{name:"location",hash:{},data:o}):s)+'</span>\n\t<span class="metric-message">'+l(typeof(s=null!=(s=t.message||(null!=e?e.message:e))?s:r)===d?s.call(e,{name:"message",hash:{},data:o}):s)+'</span>\n</div>\n\n\n<div class="pane weather-pane widget-pop nipple-top-right">\n\n\t\x3c!-- Main weather area --\x3e\n\t<section class="weather-current">\n\n\t\t\x3c!-- Header --\x3e\n\t\t<header class="weather-current-header">\n\n\t\t\t<span class="weather-current-location '+(null!=(n=t.if.call(e,null!=e?e.loading:e,{name:"if",hash:{},fn:this.program(5,o,0),inverse:this.noop,data:o}))?n:"")+'" title="'+l(typeof(s=null!=(s=t.locationExact||(null!=e?e.locationExact:e))?s:r)===d?s.call(e,{name:"locationExact",hash:{},data:o}):s)+'">\n\t\t\t\t<span class="weather-location-name">'+l(typeof(s=null!=(s=t.location||(null!=e?e.location:e))?s:r)===d?s.call(e,{name:"location",hash:{},data:o}):s)+"</span>\n\t\t\t\t"+(null!=(n=t.unless.call(e,null!=e?e.today:e,{name:"unless",hash:{},fn:this.program(7,o,0),inverse:this.noop,data:o}))?n:"")+(null!=(n=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(9,o,0),inverse:this.noop,data:o}))?n:"")+'<i class="loading-icon"></i>\n\n\t\t\t\t<span class="weather-location-icon weather-location-edit"><i class="icon-edit"></i></span>\n\t\t\t\t<span class="weather-location-icon weather-location-reset" title="Use location"><svg class="weather-location-reset-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 51.636 51.636"><path d="M51.353.914a.999.999 0 0 0-1.135-.213L.583 23.481a1 1 0 0 0 .252 1.895l22.263 3.731 2.545 21.038a1.002 1.002 0 0 0 1.889.324l24-48.415a1 1 0 0 0-.179-1.14z"/></svg></span>\n\n\t\t\t\t<span class="weather-current-conditions">'+l(a(null!=(n=null!=e?e.selected:e)?n.condition:n,e))+'</span>\n\t\t\t</span>\n\t\t\t\x3c!-- Popup --\x3e\n\t\t\t<div class="pane-settings weather-settings">\n\t\t\t\t<div class="pane-settings-icon-wrapper"><i class="icon-ellipsis pane-settings-icon"></i></div>\n\t\t\t\t<div class="dropdown pane-settings-dropdown">\n\t\t\t\t\t<ul class="dropdown-list">\n\t\t\t\t\t\t<li class="toggle-hourly">\n\t\t\t\t\t\t\tHourly forecast\n\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t\t<li class="toggle-details">\n\t\t\t\t\t\t\tExtra weather info\n\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t\t<li class="line"></li>\n\t\t\t\t\t\t<li class="toggle-metric">\n\t\t\t\t\t\t\tMetric units\n\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t\t<li class="weather-location-edit-menu">Edit location</li>\n'+(null!=(n=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(11,o,0),inverse:this.noop,data:o}))?n:"")+'\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</header>\n\n\t\t<div class="weather-current-temp-row">\n\t\t\t\x3c!-- Main temp --\x3e\n\t\t\t<div class="weather-current-temp-wrapper toggle-hourly">\n\t\t\t\t'+(null!=(n=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(13,o,0),inverse:this.noop,data:o}))?n:"")+'\n\t\t\t\t<span class="icon icon-weather weather-current-icon" data-icon="'+l(a(null!=(n=null!=e?e.selected:e)?n.icon:n,e))+'" title="'+l(a(null!=(n=null!=e?e.selected:e)?n.condition:n,e))+'"></span>'+(null!=(n=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(16,o,0),inverse:this.program(18,o,0),data:o}))?n:"")+"\n\t\t\t</div>\n\n\t\t\t\x3c!-- Main details --\x3e\n"+(null!=(n=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(20,o,0),inverse:this.noop,data:o}))?n:"")+"\t\t</div>\n\n\n\t\t\x3c!-- Extra weather info --\x3e\n"+(null!=(n=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(27,o,0),inverse:this.noop,data:o}))?n:"")+'\t</section>\n\n\n\t\x3c!-- 5-day advance forecast --\x3e\n\t<section class="weather-forecast weather-forecast-daily">\n'+(null!=(n=t.each.call(e,null!=e?e.days:e,{name:"each",hash:{},fn:this.program(36,o,0),inverse:this.noop,data:o}))?n:"")+"\t</section>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n\t<div class="primary">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+l(typeof(n=null!=(n=t.metricValue||(null!=e?e.metricValue:e))?n:s)===a?n.call(e,{name:"metricValue",hash:{},data:o}):n)+'</span><span class="metric-stat-unit">'+l(typeof(n=null!=(n=t.metricUnit||(null!=e?e.metricUnit:e))?n:s)===a?n.call(e,{name:"metricUnit",hash:{},data:o}):n)+'</span>\n\t\t</div>\n\t\t<span class="metric-label">'+l(typeof(n=null!=(n=t.metricLabel||(null!=e?e.metricLabel:e))?n:s)===a?n.call(e,{name:"metricLabel",hash:{},data:o}):n)+'</span>\n\t</div>\n\t<span class="metric-message"></span>\n</div>'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,o){var n,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="pane-container pane-placeholder">\n\t<div class="pane pane-placeholder-loading"><i class="loading-icon"></i>Loading...</div>\n</div>\n<span class="toggle '+l(typeof(n=null!=(n=t.label||(null!=e?e.label:e))?n:s)===a?n.call(e,{name:"label",hash:{},data:o}):n)+'-toggle">'+l(typeof(n=null!=(n=t.label||(null!=e?e.label:e))?n:s)===a?n.call(e,{name:"label",hash:{},data:o}):n)+"</span>"},useData:!0}),m.globals.version="0.101.2",m.globals.platform="chrome",m.globals.googleAnalyticsCode="UA-44319322-10",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",m.sendEvent=function(e,t,i,o){m.devTools&&m.devTools.getDebugGoogleAnalytics()&&console.log("GA:",e,"•",t,"•",i,"•",o),o||(o="event");var n=100;if(isChrome()&&(n=1),!(100*Math.random()>n))try{var s=window.navigator.userLanguage||window.navigator.language,a=window.screen.availWidth+"x"+window.screen.availHeight,l=window.screen.colorDepth,r=window.innerWidth+"x"+window.innerHeight,d=new XMLHttpRequest,c="v=1&tid="+m.globals.googleAnalyticsCode+"&cid="+getClientId()+"&uid="+getUserId()+"&t="+o+"&sf="+n+"&ul="+s+"&sr="+a+"&vp="+r+"&de="+document.characterSet+"&sd="+l;e&&(c+="pageview"==o?"&dp="+e:"&ec="+e),t&&(c+="&ea="+t),i&&(c+="&el="+i),d.open("POST","https://www.google-analytics.com/collect",!0),d.send(c)}catch(e){console.log("Error sending report to Google Analytics.\n"+e)}},m.models.Manager=Backbone.Model.extend({}),m.collect.Manager=Backbone.Collection.extend({}),m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){var e=this;this.addinCollection=new m.collect.AddinCollection,setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var i=this;_.each(m.addins,function(e,t){i.addinCollection.findWhere({id:t})||i.loadEvaluatedAddin(t,e)}),e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},ensureAddinLoaded:function(id,success,loading,error){var addin=this.addinCollection.get(id);if(addin&&addin.get("loaded"))success&&success(addin);else{if(loading)try{loading()}catch(e){}if(addin||(addin=this.addinCollection.add({id:id,evaluated:!1,processed:!0,lazy:!0})),!addin.get("loading")){addin.set("loading",!0);var dataType="text",url=m.globals.urlRootApi+"scripts/"+id;$.ajax({url:url,cache:!0,beforeSend:m.utils.setMomentumAuthHeader,dataType:dataType,success:function(text){try{"text"==dataType&&eval(text),addin.set({evaluated:!0,rawCode:text,loaded:!0,loading:!1})}catch(e){if(addin.set("loading",!1),error)return void error(e)}success&&success(addin)},error:function(e){addin.set("loading",!1),error&&error(e)}})}}},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,lazy:!1}),function(e){try{var t=e.get("addInCode");t&&(e.set({processed:!0}),t(m,$))}catch(e){console.log(e)}})},evaluatePending:function(){_.each(this.addinCollection.where({evaluated:!1,lazy:!1}),function(addin){try{var rawCode=addin.get("rawCode");if(rawCode){addin.set({evaluated:!0});var addIn=eval(rawCode);addin.set({addInCode:addIn})}}catch(e){console.log(e)}})}}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=m.collect.Manager.extend({model:m.models.Command,initialize:function(){var t=this;this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(e){t.registerCommandModel(e,!1)})},registerCommandModel:function(e,t){var i=new e;if(i&&i.id&&(t||!this.get(i.id))){var o=this.get(i.id);o&&this.remove(o),this.add(i)}},registerCommandSources:function(e){e&&0<e.length&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,o){var n={defaults:{id:e},execute:t};i&&(n.canExecute=i);var s=m.models.Command.extend(n);this.registerCommandModel(s,o)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(t,i,o,n){var s=this,a=this.get(t);if(a)i&&i(a);else{if(o)try{o()}catch(e){}var l=this.commandSources.get(t);l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),i&&i(a)},o,function(e){l.set("loading",!1),n&&n(e)})):(url=m.globals.urlRootApi+"commands/"+encodeURIComponent(t),$.ajax({url:url,beforeSend:m.utils.setMomentumAuthHeader,success:function(e){e&&(s.registerCommandSource(e),(l=s.commandSources.get(t))?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),i&&i(a)},o,function(e){l.set("loading",!1),n&&n(e)})):n&&n("no command with that id is registered"))},error:function(e){n&&n("no command with that id is registered")}}))}},execute:function(e){var t=this.getCommand(e);if(t)return t.execute.apply(t,[].slice.call(arguments,1))},canExecute:function(e){var t=this.getCommand(e);return!t||t.canExecute.apply(t,[].slice.call(arguments,1))},getProperties:function(e){var t=this.getCommand(e);return!t||!t.getProperties||t.getProperties.apply(t,[].slice.call(arguments,1))}}),m.models.SettingsManager=Backbone.Model.extend({initialize:function(){this.listenTo(m,"settings:register:nav",this.registerNavItem),this.listenTo(m,"settings:register:subnav",this.registerSubNavItem),this.listenTo(m,"settings:register:panel",this.registerPanel),window.addEventListener("storage",function(e){"loggedOut"!=e.key&&"loggedIn"!=e.key||window.location.reload()}),this.registerStockCommandSources()},stockNavItems:null,navItems:[],secondaryNavItems:[],panelItems:[],registerNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.navItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.navItems,e)&&(this.navItems.push(e),!0))},registerPanel:function(e){return!this.addOrReplaceIfOverride(this.panelItems,e)&&(this.panelItems.push(e),!0)},registerSubNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.secondaryNavItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.secondaryNavItems,e)&&(this.secondaryNavItems.push(e),!0))},addOrReplaceIfOverride:function(e,t,i){var o=i||{id:t.id},n=_.findWhere(e,o);return!!n&&(t.override&&(e.splice(e.indexOf(n),1),e.push(t)),!0)},registerNavItems:function(e){var t=this,i=!1;e&&(e.nav&&_.each(e.nav,function(e){t.registerNavItem(e)&&(i=!0)}),e.subNav&&_.each(e.subNav,function(e){t.registerSubNavItem(e)&&(i=!0)}),e.panels&&_.each(e.panels,function(e){t.registerPanel(e)}),i&&this.trigger("navItemsChanged"))},getNavItems:function(){return this.populateStockNavItems(),{navItems:_.chain(this.stockNavItems.navItems).union(this.navItems).sortBy("position").value(),secondaryNavItems:_.chain(this.stockNavItems.secondaryNavItems).union(this.secondaryNavItems).sortBy("position").value()}},getPanelItems:function(){return this.panelItems},registerStockCommandSources:function(){m.commandManager.registerCommandSources([{id:"settings.panels.quotes",addin:"DD106F35-669C-4079-A9E3-82DDC5244D0B"},{id:"settings.panels.backgrounds",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"settings.panels.todo",addin:"270AAED6-337F-433F-9D02-A471B435EADA"},{id:"settings.panels.balance",addin:"1E373FA7-A454-4652-8D77-1A4FCC88C069"},{id:"settings.panels.metrics",addin:"DB0B33AA-8ED6-4FFC-B0E0-732A9FF3391D"},{id:"background.custom.uploadfiles",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"tour.plus.show",addin:"E38E9785-27CE-4CAB-8497-8B34AB56B6A1"},{id:"settings.panels.trello.config",addin:"C61B7775-7AB8-443A-A6B7-C8C8DE6FC755"},{id:"todo.zenhub.config",addin:"B81CC20D-5C5A-4163-8FC8-BB0CEEF2882E"},{id:"settings.panels.bookmarks",addin:"E464EB61-05CA-4A56-9C17-6A02673AA136"}]),this.registerPanel({id:"trello",section:"todo",cmd:"settings.panels.trello.config"})},populateStockNavItems:function(){if(!this.stockNavItems){var e=[],t=[];m.conditionalFeatures.featureEnabled("plus")?(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"background-settings",title:"Photos",cmd:"settings.panels.backgrounds",position:30},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"metrics",title:"Metrics",cmd:"settings.panels.metrics",position:60},{id:"bookmark-settings",title:"Links",cmd:"settings.panels.bookmarks",position:70},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:80}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30}]):(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"background-settings",title:"Photos",cmd:"settings.panels.backgrounds",position:30},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"bookmark-settings",title:"Links",cmd:"settings.panels.bookmarks",position:70},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:80}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30},{id:"upgrade",title:"Upgrade to Plus",cmd:"upsell.website",cmdonly:!0,options:{source:"nav-upgrade-plus"},position:40}]),this.stockNavItems={navItems:e,secondaryNavItems:t}}},infinispin:function(){var e=localStorage.getItem("infinispin");return e=!!e&&JSON.parse(e)},toggleInfinispin:function(){var e=!this.infinispin();return localStorage.setItem("infinispin",e),e}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'"Helvetica Neue",Helvetica,Arial,sans-serif',initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColour),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.listenTo(m,"user:successfulLogin user:successfulLogout",this.onLoginEvent),this.loadAllThemeValues()},loadAllThemeValues:function(){this.loadThemeColour(),this.setThemeColour(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColour()},saveThemeColour:function(){this.colors&&m.models.customization.set("themeColourCustom",this.toRgbA(this.colors))},loadThemeColour:function(){try{if(m.models.customization.has("themeColourCustom")){var e=m.models.customization.get("themeColourCustom");e&&(this.colors=new Colors({color:e}).colors)}}catch(e){}},getThemeColour:function(){return this.colors},getThemeColourRGBA:function(){return this.colors?this.toRgbA(this.colors):null},setThemeColour:function(){var e,t=$("body"),i=$("head");if(t.removeClass("light"),m.conditionalFeatures.featureEnabled("plus")){var o=m.models.customization.get("themeColour");"light"==o?(t.addClass("light"),e=".dropdown, .u--bg, .todo-list-chooser-dropdown, .todo-list-chooser.choosing { background-color: #fff; }"):"dark"==o?e=".dropdown, .u--bg, .todo-list-chooser-dropdown, .todo-list-chooser.choosing { background-color: #000; }":"custom"==o&&this.colors&&(e=(e=(e=(e=".pane { background-color: "+this.toRgbA(this.colors)+" !important; }")+".dropdown, .u--bg, .todo-list-chooser-dropdown, .todo-list-chooser.choosing, .user.open { background-color: #"+this.colors.HEX+" !important; }")+".nipple-bottom-left:before, .nipple-bottom-right:before { border-top-color: "+this.toRgbA(this.colors)+" !important}")+".nipple-top-left:before, .nipple-top-right:before { border-bottom-color: "+this.toRgbA(this.colors)+" !important}",t.toggleClass("light",.5<this.colors.RGBLuminance)),this.$themeColourCustom?this.$themeColourCustom.html(e):(i.append('<style type="text/css" id="themeColourCustom">'+e+"</style>"),this.$themeColourCustom=i.find("#themeColourCustom").first())}else this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null)},toRgbA:function(e){return"rgba("+Math.round(255*e.rgb.r)+","+Math.round(255*e.rgb.g)+","+Math.round(255*e.rgb.b)+","+e.alpha+")"},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var t=this,i=m.models.customization.get("themeFont")||"default";if(m.conditionalFeatures.featureEnabled("plus")){var o=this.defaultFontFamily;if(i&&"default"!=i){var e=null,n=localStorage.getItem("font-"+i);if(n)e=JSON.parse(n),o=this.setFontFromInfo(e)||this.defaultFontFamily,this.setActiveFont(o,i);else try{$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"fonts/"+i}).done(function(e){e&&(localStorage.setItem("font-"+i,JSON.stringify(e)),o=t.setFontFromInfo(e)||t.defaultFontFamily)}).fail(function(e,t){}).always(function(){t.setActiveFont(o,i)})}catch(e){}}else this.setActiveFont(o,i)}else this.setActiveFont(this.defaultFontFamily,i)},setFontFromInfo:function(e){var t=null;if(e){if(!e.builtin){var i=$("head"),o=i.find("#font-"+e.font).first();if(!o||0==o.length){var n=null;e.fontInline?(n=$('<style type="text/css"></style>')).html(e.fontInline):e.fontUrl&&(n=$('<link rel="stylesheet" type="text/css">')).attr("href",e.fontUrl),n&&(n.attr("id","font-"+e.font),i.append(n))}}t=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily}return t},setActiveFont:function(e,t){var i="body, input, select, textarea, button {font-family: "+e+"; !important}",o=document.createElement("style"),n=$(o);n.attr("type","text/css"),document.head.appendChild(o),o.sheet.insertRule(i,0),n.attr("id","font-override");var s=$("body");_.each(this.getAvailableFonts(),function(e){e.value==t?s.addClass("f--"+e.value):s.removeClass("f--"+e.value)}),$user=$(".user"),$user.hasClass("open")||$user.css("transform","translateY("+$("user-hidden").height()+"px)")},onLoginEvent:function(){this.listenToOnce(m,"sync:settings:complete",this.loadAllThemeValues)}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){try{var n=this;if(!localStorage.client_uuid)return;var t=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var i=[];-1<e.indexOf("quote")&&(i[i.length]="quote",localStorage.removeItem(n.ddlQuoteString())),-1<e.indexOf("background")&&(i[i.length]="background",localStorage.removeItem(n.ddlBackgroundString())),0<i.length?t+=i.join(","):t+="all"}else t+="all",localStorage.removeItem(n.ddlBackgroundString()),localStorage.removeItem(n.ddlQuoteString());if(t=t+"&localDate="+getActiveDateString(),!localStorage.firstSynchronized){var o=m.models.activeBackground.activeBackgroundUuid();if(!o){var s=m.collect.legacyBackgrounds.getCurrentLocalBackground();s&&(o=s.backgroundUuid())}o&&(t=t+"&legacyBackground="+o)}$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:t}).done(function(e){e.quotes&&0<e.quotes.length&&(m.collect.quotes.reset(e.quotes),m.collect.quotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote"),localStorage.setItem(n.ddlQuoteString(),Date.now()),e.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(e.ts_quotes))),e.backgrounds&&0<e.backgrounds.length&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),localStorage.setItem(n.ddlBackgroundString(),Date.now()),e.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(e.ts_backgrounds))),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,t){if(0<e.status){var i=m.models.backgroundManager.latestBackgroundDate();i&&i>Date.parse(getActiveDateString())&&localStorage.setItem(n.ddlBackgroundString(),Date.now());var o=m.models.quoteManager.latestQuoteDate();o&&o>Date.parse(getActiveDateString())&&localStorage.setItem(n.ddlQuoteString(),Date.now())}else m.trigger("sync:error")})}catch(e){}},doDownloadIfNeeded:function(e){var t=!1,i=!1;if(e){if(e.ts_backgrounds){var o=localStorage.getItem("ts_backgrounds");o?e.ts_backgrounds>JSON.parse(o)&&(t=!0):t=!0}if(e.ts_quotes){var n=localStorage.getItem("ts_quotes");n?e.ts_quotes>JSON.parse(n)&&(i=!0):i=!0}}t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),t&&i?this.doDownload():t?this.doDownload("background"):i&&this.doDownload("quote")},pingApi:function(t,i){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization.getPersistentSettings()),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){var o={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(o),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e){e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features,!0),e.customization&&m.models.customization.save(e.customization),e.lists&&0<e.lists.length&&m.models.todoListManager&&m.models.todoListManager.mergeLists(e.lists),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),m.settingsManager.registerNavItems(e.nav),e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications);var t=null;e.ts_backgrounds&&((t=t||{}).ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&((t=t||{}).ts_quotes=e.ts_quotes),t&&m.trigger("sync:downloadIfNeeded",t)}}).fail(function(e,t){}).always(function(){t.syncSettingsInProgress=!1,m.trigger("sync:settings:complete"),e&&e()})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(e){this.customization=e.customization||m.models.customization;try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(e){this.featureList=[]}},featureEnabled:function(e){return _.contains(this.featureList,e)},setFeatures:function(e,t){var i=_.contains(this.featureList,"servertodos");localStorage.f3t6b23d!==e&&(localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),t&&!i&&_.contains(this.featureList,"servertodos")?window.location.reload():m.trigger("feature:changed"))},clearFeatures:function(){this.featureList=[],localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,n,s,a,i,t){var o=null,l=this;if(this.featureEnabled(e)){for(var r=!1,d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(s+"-")){r=!0;break}if(r)try{var c=new Date,h=c.getFullYear().toString()+"-"+twoDigit(c.getMonth()+1)+"-"+twoDigit(c.getDate())+"-"+twoDigit(c.getHours())+":"+twoDigit(c.getMinutes())+":"+twoDigit(c.getSeconds()),u="migrated-"+s+"-"+h,g=[],p=[];for(d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(s+"-")){p.push(keyName);var f=localStorage.getItem(keyName);if(f){var v=JSON.parse(f);g.push(v)}}var w={items:g},b=JSON.stringify(w);$.ajax({type:"POST",contentType:"application/json",data:b,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+s}).done(function(e,t,i){for(var o in localStorage.setItem(u,b),p)localStorage.removeItem(p[o]);localStorage.removeItem(s),m.trigger("sync:customization"),n&&!l.customization.getComputedSetting(n)||a()}).fail(function(e,t){n&&!l.customization.getComputedSetting(n)||i()})}catch(e){console.log(e)}else o=a}else o=i;o&&(!n||this.customization.getComputedSetting(n)?o():t?t(o):this.setPreferenceChangeListener(n,o))},setPreferenceChangeListener:function(e,t){var i=this;m.listenToOnce(this.customization,"change:"+e,function(){i.customization.getComputedSetting(e)?t():i.setPreferenceChangeListener(e,t)})},checkPreferenceForRender:function(e,t,i){t&&(!e||this.customization.getComputedSetting(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("#"+e).fadeTo(0,0).html(this.template(model.toJSON())).fadeTo(500,1),this},attributes:function(){return{id:this.model.get("id"),class:this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow"},initialize:function(){var t=this;this.region=this.model.get("region"),this.visibleStateKey=this.model.get("visibleState"),this.render(),this.model.get("closeOnEsc")&&this.listenTo(m,"globalEvent:esc",this.handleGlobalEsc),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow),this.model.get("hideEvents")&&_.each(this.model.get("hideEvents"),function(e){t.listenTo(m,e,t.onHideEvent)});var e=this.model.get("visibleSetting");e&&this.listenTo(m.models.customization,"change:"+e,this.visibleChanged),this.shouldShowPane()&&this.showPane()},attributes:function(){return{id:this.model.get("id")+"-wrapper",class:"widget-"+this.model.get("region")}},render:function(){var e=this.model.get("label"),t=(this.model.get("order")||"append")+"To";if(!this.renderedOnce){this.$el[t]("#"+this.region).fadeTo(0,0).html(this.template({label:e})).fadeTo(500,1),this.$pane=this.$(".pane");var i=this.model.get("width")+"px",o="200px";if(this.model.has("height"))o=this.model.get("height")+"px";else{var n=this.storedPaneHeight();n&&(o=n+"px")}this.$pane.css({width:i,height:o}),this.$el.find(".pane-container").addClass("nipple-"+this.region),this.renderedOnce=!0}return this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),t=localStorage[e];if(t)return JSON.parse(t)}return null},toggleShow:function(e){e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault(),this.open?this.hidePane():this.showPane()},showPane:function(){if(!this.open){if(this.open=!0,localStorage.setItem(this.visibleStateKey,this.open),this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),this.realView)this.realView.onShowPane&&this.realView.onShowPane();else{if(this.loading)return;if(!this.model.has("addin"))return;this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin"))}m.trigger("globalEvent:toggle:"+this.region,this),m.trigger("globalEvent:toggle",this)}},hidePane:function(){var t=this;this.open&&(this.open=!1,localStorage.setItem(this.visibleStateKey,this.open),this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")}),this.realView&&this.realView.onHidePane&&this.realView.onHidePane())},shouldShowPane:function(){if(this.model.has("visibleState")){var e=localStorage[this.visibleStateKey];if(e)return JSON.parse(e)}return!1},addRealView:function(e){this.realView=e,this.open&&this.realView.onShowPane&&this.realView.onShowPane()},handleGlobalEsc:function(e){!this.open||this.realView&&this.realView.preventCloseOnEsc&&this.realView.preventCloseOnEsc()||this.toggleShow(e)},onHideEvent:function(e){e!=this&&this.hidePane()},visibleChanged:function(e){var t=this.model.get("visibleSetting");m.models.customization.getComputedSetting(t)?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25)},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={},t=this.model.get("cachedKey");t&&(e=JSON.parse(localStorage.getItem(t)));var i=this.model.get("region"),o=(this.model.get("order")||"append")+"To";this.$el[o]("#"+i).fadeTo(0,0).html(this.template(e)).fadeTo(500,1)}return this},addRealView:function(e){this.realView=e}}),m.models.WidgetManager=m.models.Manager.extend({skippedPlaceholders:[],initialize:function(){this.regions={},this.regions["top-right"]={widgets:["metrics-pane"],overlappingRegion:"bottom-right"},this.regions["bottom-right"]={widgets:["todo-pane","notes-pane"],overlappingRegion:"top-right"};var e=this;m.models.customization.initialized?e.setup():this.listenToOnce(m.models.customization,"initialized",function(){e.setup()})},setup:function(){this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.listenTo(m,"user:successfulLogin",this.onSuccessfulLogin),this.populatePlaceholders()},populatePlaceholders:function(){this.widgets.add({id:"notes",label:"Notes",type:"pane",region:"bottom-right",order:"prepend",storedHeight:"notes-pane-height",visibleState:"showNotes",width:450,height:450,addin:"23c67761-9831-415e-b358-c6844eb6c244",requiredFeature:"notes",toggleEvent:"globalEvent:key:N",hideEvents:["globalEvent:toggle:bottom-left","globalEvent:toggle:bottom-right","globalEvent:toggle:top-right"],closeOnEsc:!0,visibleSetting:"notesVisible"}),this.widgets.add({type:"metric",id:"countdown",class:"generic-metric metric countdown add-shadow",region:"top-right",order:"prepend",addin:"fb230b62-96ce-44b5-87c5-4a563553038b",requiredFeature:"countdown",visibleSetting:"countdownVisible"})},onAdd:function(e){this.addWidget(e)},onSuccessfulLogin:function(){var t=this,e=this.skippedPlaceholders;this.skippedPlaceholders=[],_.each(e,function(e){t.addWidget(e)})},addWidget:function(t,e){var i=this;if(e=e||!1,!t.has("requiredFeature")||m.conditionalFeatures.featureEnabled(t.get("requiredFeature"))){if(!e&&t.has("visibleSetting")){var o=t.get("visibleSetting");if(!m.models.customization.getComputedSetting(o))return void this.listenToOnce(m.models.customization,"change:"+o,function(){var e=!!m.models.customization.getComputedSetting(o);i.addWidget(t,e)})}var n=null;n="metric"==t.get("type")?new m.views.MetricPlaceholder({model:t}):new m.views.PanePlaceholder({model:t}),t.placeholder=n}else this.skippedPlaceholders.push(t)},handover:function(e,t,i){i=i||{};var o=this.widgets.find({id:e});if(o){var n=o.placeholder;if(!n)return void console.log("error: no placeholder");var s=o.get("type");"pane"==s?i.el=n.$pane:"metric"==s&&(i.el=n.el);var a=new t(i);return n.addRealView(a),o.realview=a}return new t(i)},refocusOverlap:function(e){$("#"+this.regions[e].overlappingRegion).removeClass("unfocus")},unfocusOverlap:function(e,t){var i=this.regions[e].overlappingRegion,o=this.regions[i],n=$("#"+i),s=[];o.widgets.forEach(function(e){var t=$("."+e);s.push(t?t.height():0)});var a=$("#"+e).outerHeight(!0)+n.outerHeight(!0)+Math.max.apply(null,s),l=$(".bookmarks-wrapper"),r=0;l.css("transform")&&(r=parseInt(l.css("height"))-parseInt(l.css("transform").split(",")[5])),$("body").height()-(a+r+4)<t&&n.addClass("unfocus")}}),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t,i=this.get("filename");return 0===i.indexOf("http")?null:2==(t=i.split("/")).length&&2==(t=t[1].split(".")).length?t[0]:null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){0<e.backgrounds.length&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var t=this.fallbackKey(),e=localStorage.getItem(t),i=null,o=this;e?this.legacyBackgrounds.getBackground(e,function(e){e||(e=o.legacyBackgrounds.getCurrentLocalBackground())&&localStorage.setItem(t,e.backgroundUuid()),e&&(o.usingFallback=!0,o.setActiveBackground(e))}):i||(i=o.legacyBackgrounds.getCurrentLocalBackground())&&(localStorage.setItem(t,i.backgroundUuid()),o.usingFallback=!0,o.setActiveBackground(i))},collectionReady:function(){this.usingFallback||this.checkActiveBackground()},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){0<this.backgrounds.length?this.backgrounds.get(getActiveDateString())||this.checkActiveBackground():this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;this.backgrounds&&0<this.backgrounds.length&&(e=this.backgrounds.getActiveBackground())?this.setActiveBackground(e):this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem),this.preCacheFutureBackgroundImages()},setActiveBackground:function(e){e&&(e.has("_id")&&this.lastBgId==e.get("_id")||(this.lastBgId=e.get("_id"),this.backgroundItem&&this.backgroundItem.cid==e.cid||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e))))},generateUUID:function(){var i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==e?t:3&t|8).toString(16)})},preCacheFutureBackgroundImages:function(){var i=this,o=Date.parse(getActiveDateString());this.backgrounds&&0<this.backgrounds.length&&this.backgrounds.map(function(e){var t=Date.parse(e.get("forDate"));o<t&&i.preCacheBackgroundImage(e)})},preCacheBackgroundImage:function(e){if(e){var t=e.get("filename");if(t&&0===t.indexOf("http"))try{var i=new Image;i.addEventListener("load",function(e){i.removeEventListener("load",arguments.callee,!1)},!1),i.src=t}catch(e){}}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t,i=e.id;i||2==(t=e.filename.split("/")).length&&2==(t=t[1].split(".")).length&&(i=t[0]);this.set({id:i,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(t){return filtered=this.filter(function(e){return e.get("fallbackDate")<t}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){this.initialized=!1,this.listenTo(this,"reset",function(){this.initialized=!0}),localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getBackground:function(e,t){if(this.initialized)t(this.get(e));else{var i=this;setTimeout(function(){i.getBackground(e,t)},10)}},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),i=localStorage.getItem(t);if(i&&(e=this.get(i)),!e){if(!this.parseRecentFallbacks())return null;var o=Math.floor(.75*this.models.length),n=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),s=_.first(n,o),a=_.map(s,function(e){return e.get("backgroundGuid")}),l=this.pluck("id");if(m.collect.backgrounds){var r=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});o=Math.floor(.25*this.models.length);var d=_.first(r,o),c=_.map(d,function(e){return e.get("_id")});a=_.union(a,c)}var h=_.difference(l,a);if(0<h.length){var u=_.sample(h);e=this.get(u)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var s=this;return $.each(localStorage,function(e,t){if(0===e.indexOf("fallback-")){var i=e.slice(9),o=Date.parse(i),n=new Backbone.Model({fallbackDate:o,backgroundGuid:t});s.fallbacks.add(n)}}),!0}}),m.models.BackgroundManager=Backbone.Model.extend({initialize:function(e,t){m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds})},firstFetch:function(){m.collect.backgrounds.fetch({reset:!0}),m.collect.legacyBackgrounds.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new background. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},skipBackground:function(i){var o=this,e=m.globals.urlRootApi+"backgrounds",t={operation:"skip",active_uuid:m.models.activeBackground.activeBackgroundUuid()};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(t),url:e}).done(function(e){if(e&&e.success&&m.trigger("sync:download","background"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.displayedMaxSkips)return;localStorage.displayedMaxSkips=!0}m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",o.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",o.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i,t){var o=this,n=m.globals.urlRootApi+"backgrounds/favorites",s={operation:"favorite",active_uuid:m.models.activeBackground.activeBackgroundUuid(),is_favorite:e};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:n}).done(function(e){e&&e.success&&(m.trigger("sync:download","background"),m.trigger("background:favorite",{id:s.active_uuid,is_favorite:s.is_favorite}),t&&t())}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",o.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",o.favouriteErrorMessage),i&&i()}},latestBackgroundDate:function(){var i=null;return m.collect.backgrounds.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},events:{click:"closeTrays"},isBackgroundLoaded:!1,initialize:function(){this.model=m.models.backgroundManager,this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(n){var s=this,e=!1;s.isBackgroundLoaded&&(e=!0);var a=n.get("filename"),l=n.backgroundUuid(),r=(n.get("title"),n.get("source"),n.get("sourceUrl"),(this.options.order||"append")+"To");$("#background").css("background-image",$("#background").find("li").css("background-image")),this.lastId=l,this.loadCompleted=!1,"true"==localStorage.getItem("failed:"+a)&&(s.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback")),$("<img/>").on("load",function(){var e=!1,t=n.get("height"),i=n.get("width");t&&i?this.height==t&&this.width==i||(e=!0):n.get("skip_check")||(this.height<750||this.width<1e3)&&(e=!0);if(e)return m.models.activeBackground.trigger("background:fallback"),localStorage.setItem("failed:"+a,"true"),void(s.loadCompleted=!0);var o="fadein";s.isBackgroundLoaded&&(o="fadein-slow"),s.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(l),s.isBackgroundLoaded=!0,l===s.lastId&&(s.$el[r]("#"+s.options.region).css("background-image","url("+a+")").addClass(o),$(this).remove(),$(".widgets").addClass("show-widgets"),setTimeout(function(){$(".background-overlay").addClass("show")},5)),setTimeout(function(){m.trigger("background:loadSuccessful",l)},200)}).on("error",function(e){s.loadCompleted=!0,s.isBackgroundLoaded?m.trigger("background:error",l):m.models.activeBackground.trigger("background:fallback")}).attr("src",a),e||window.setTimeout(function(){s.loadCompleted||(s.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback"))},4e3)},closeTrays:function(e){$(".show").each(function(){removeClass("show")})}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{id:"background-info",class:"background-info"},template:m.templates.background["background-info"],timeAdmireDelay:4e3,timeoutIdAdmire:null,events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff",click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-source-link":"clickSource","click .source-url":"trackClick","click .control-heart":"toggleFavorite","click .control-refresh":"skipBackground"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady),this.listenTo(m.models.activeBackground,"background:error",this.skipFailed),this.listenTo(m,"sync:error",this.skipFailed),this.listenTo(m,"globalEvent:windowBlur",this.unfocusBg)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){m.models.activeBackground&&m.models.activeBackground.backgroundItem&&this.setBackground(m.models.activeBackground.backgroundItem),this.$bgOverlay=$(".background-overlay")},setBackground:function(e){var t=this,i="",o=null,n="",s="",a="",l="",r=!1,d=!1;e&&(i=e.get("title"),s=e.get("sourceUrl"),a=e.get("detail_url"),o=e.get("attribution"),n=e.get("source"),o||(o="Photo by "+n),e.get("is_favorite")&&(r=!0,l="active")),this.activeBackground?this.activeBackground.backgroundUuid()!=e.backgroundUuid()?d=!0:i==this.activeBackground.get("title")&&o==this.activeBackground.get("attribution")||(d=!0):d=!0,d&&(this.activeBackground=e),a&&0<a.length?(this.detail_url=a,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link"));var c={title:i,source:n,sourceUrl:s,attribution:o,fav_class:l};if(this.renderedOnce)d&&this.$el.fadeTo(500,0,function(){t.$background_info_title.html(i+'<i class="icon-angle-right"></i>'),t.$background_info_source_link.text(o),t.$el.fadeTo(500,1)});else{var h=(this.options.order||"append")+"To";this.$el[h]("#"+this.options.region).fadeTo(0,0).html(this.template(c)).fadeTo(500,1),this.$background_info_source_link=this.$el.find(".background-info-source-link").first(),this.$background_info_title=this.$el.find(".background-info-title").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.renderedOnce=!0}return s&&0<s.length?(this.$background_info_source_link.data("url",s),this.$background_info_source_link.removeClass("no-link")):(this.$background_info_source_link.data("url",null),this.$background_info_source_link.addClass("no-link")),this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1),m.conditionalFeatures.featureEnabled("skip-bg")?this.$control_refresh.show():this.$control_refresh.hide(),this.$control_heart.show(),r?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),this},handleHoverOn:function(){var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":1})},300),this.clearTimeoutAdmire(),this.timeoutIdAdmire=setTimeout(function(){e.focusOnBg()},this.timeAdmireDelay)},clearTimeoutAdmire:function(){null!==this.timeoutIdAdmire&&(clearTimeout(this.timeoutIdAdmire),this.timeoutIdAdmire=null)},handleHoverOff:function(){this.clearTimeoutAdmire();var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":2}),e.unfocusBg()},300)},focusOnBg:function(){if(!this.focusing&&!this.unfocusing){this.focusing=!0,this.focused=!0;var e=this;setTimeout(function(){e.focusing=!1},1e3),$(".widgets").first().children().each(function(e,t){"bottom-left"==t.id?$(t).addClass("show-photo"):"top-bar"!=t.id&&$(t).stop(!0).fadeOut(1e3)}),this.$bgOverlay.addClass("slow"),setTimeout(function(){e.$bgOverlay.removeClass("show")},5),$(".add-shadow").stop(!0).fadeOut(1e3)}},unfocusBg:function(){if(this.focused){this.unfocusing=!0,this.focused=!1;var e=this;setTimeout(function(){e.unfocusing=!1},1e3),$(".widgets").first().children().each(function(e,t){"bottom-left"==t.id?$(t).removeClass("show-photo"):"top-bar"!=t.id&&$(t).stop(!0).fadeIn(1e3)}),this.$bgOverlay.addClass("show"),setTimeout(function(){e.$bgOverlay.removeClass("slow")},1e3),$(".add-shadow").stop(!0).fadeIn(1e3)}},clickWidget:function(e){this.detail_url&&0<this.detail_url.length&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&0<this.detail_url.length&&$(this.$el).addClass("has-link")},clickSource:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("url");t&&window.open(t,"_blank")},trackClick:function(){m.sendEvent("BackgroundInfo","Click",localStorage.background)},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.backgroundManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Background",t?"Favourite":"Unfavourite")},skipFailed:function(){this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1)},skipBackground:function(e){var t=this;e.stopPropagation(),this.skipInProgress||(this.skipInProgress=!0,$(e.currentTarget).addClass("active"),m.models.backgroundManager.skipBackground(function(){t.skipFailed()}),m.sendEvent("Background","Skip"))}}),m.views.Search=Backbone.View.extend({id:"search",className:"search top-widget",events:{"focusin .search-input":"handleFocusIn","focusout .search-input":"handleFocusOut","keyup .search-input":"checkForEscape","submit .search-form":"doSearch"},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"globalEvent:click",this.hideResults),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleSearch",this.toggleShow),this.listenTo(m.models.customization,"change:searchVisible",this.visibleChanged),this.render()},render:function(){var e=(this.options.order||"append")+"To";return this.$el[e]("#"+this.options.region).fadeTo(0,0).html($.trim('<form class="search-form"><span class="search-underline"></span><i class="icon-search"></i><input type="text" id="search-input" class="search-input" autocomplete="off"></form><iframe src="" class="search-results"></iframe>')).fadeTo(500,1),this.$input=this.$el.find("input"),this.renderedOnce=!0,this},visibleChanged:function(e){m.models.customization.get("searchVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doSearch:function(e){e.preventDefault();var n=this.$el.find(".search-input")[0].value;if(0<n.length){var t=m.globals.urlRootApi+"search";if(!localStorage.token){var i=m.models.customization.get("searchProvider");i||(i="google"),t=t+"?provider="+i}$.ajax({type:"GET",beforeSend:m.utils.setMomentumAuthHeader,url:t}).done(function(e,t,i){if(e&&e.searchUrl){var o=e.searchUrl+encodeURIComponent(n);e.searchOutput&&"redirect"==e.searchOutput?window.location.href=o:$(".search-results").attr("src",o).attr("target","_top").addClass("fadein").css("display","block")}}).fail(function(e,t){var i="https://search.momentumdash.com/?q="+encodeURIComponent(n);$(".search-results").attr("src",i).attr("target","_top").addClass("fadein").css("display","block")}),m.sendEvent("Search","Searched")}},handleFocusIn:function(){$(".search").addClass("active"),m.sendEvent("Search","Focused")},handleFocusOut:function(){$(".search").removeClass("active")},hideResults:function(e){(!$.contains(this.el,e.target)&&$(".search-results").hasClass("fadein")||1==e.hide)&&$(".search-results").removeClass("fadein").css("display","none")},checkForEscape:function(e){27==e.keyCode&&this.hideResults({hide:"true"})},toggleShow:function(e){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.bootstrappers.RenderSearch=function(t,e){t.conditionalFeatures.checkPreferenceForRender("searchVisible",function(){t.models.customization.get("searchVisible")&&(t.views.search=new t.views.Search({region:"top-left",order:"append"}),t.widgets.push(t.views.search),t.stopListening(t.models.customization,"change:searchVisible"))},function(e){t.listenTo(t.models.customization,"change:searchVisible",e)})},m.collect.SyncedCollection=Backbone.Collection.extend({initialize:function(e){this.model=e.model,this.localStorage=new Backbone.LocalStorage(e.name),this.apiUrl=m.globals.urlRootApi+e.name,this.listenTo(this,"add",this.onAdd),this.listenTo(this,"remove",this.onRemove),this.listenTo(this,"change",this.onChange),this.listenTo(this,"reset",this.onReset),this.includeArchived=!1},activeItems:function(){return this.filter(function(e){return!e.get("deleted")&&!e.get("archived")})},archivedItems:function(){return this.filter(function(e){return!e.get("deleted")&&e.get("archived")})},onRemove:function(i){var o=this;$.ajax({url:this.apiUrl+"/"+i.id,contentType:"application/json",type:"DELETE",beforeSend:m.utils.setMomentumAuthHeader}).done(function(){}).fail(function(e,t){o.add(i,{silent:!0})})},onReset:function(){var e=this;this.models.length;this.syncToServer(function(){e.fetchFromServer()})},findHavingAttribute:function(t){return this.filter(function(e){return e.has(t)})},hasAttribute:function(t){return!!this.find(function(e){return e.has(t)})},onAdd:function(i,e,t){if(!t||!t.ignoreSave){var o=i.toJSON(),n=this;$.ajax({url:this.apiUrl,contentType:"application/json",type:"POST",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(e){if(e&&e.success){var t=i.get("id");i.save({changed_props:null,id:e.id,serverSetId:!0},{ignoreSave:!0,ignoreRender:!0}),n.fetch({silent:!0}),n.findWhere({id:t}).destroy({silent:!0})}}).fail(function(e,t){})}},onChange:function(e,t){var i=this;if(!t.ignoreSave){var o=e.changedAttributes();if(o&&!o.id&&!t.createdNow){var n,s=null,a=!1;for(n in o)o.hasOwnProperty(n)&&"changed_props"!=n&&(s||(s=e.get("changed_props")||[]),_.contains(s,n)||("id"!=n&&e.get("serverSetId")&&s.push(n),a=!0));a&&s&&e.save({changed_props:s},{silent:!0,ignoreSave:!0,ignoreRender:!0,success:function(){setTimeout(function(){i.syncToServer()},50)}})}}},syncToServer:function(e){var s=this,t=this.findHavingAttribute("changed_props"),i=this.findWhere({serverSetId:!1});i?Array.isArray(i)||(i=[i]):i=[],i.forEach(function(e){s.onAdd(e)}),t&&0!=t.length?nimble.each(t,function(t,e){var i=t.get("changed_props");if(i&&0!=i.length){var o={};_.each(i,function(e){"changed_props"!=e&&(o[e]=t.get(e))});var n=s.apiUrl+"/"+encodeURIComponent(t.id);$.ajax({url:n,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(e){e&&e.success&&(t.get("deleted")?t.destroy({silent:!0}):t.save({changed_props:null},{silent:!0}))}).fail(function(e,t){}).always(function(){e()})}else e()},function(){e&&e()}):e&&e()},fetchFromServer:function(e,t){var o=this;$.ajax({url:this.apiUrl+(this.includeArchived?"?includeArchived=true":""),contentType:"application/json",type:"GET",beforeSend:m.utils.setMomentumAuthHeader}).done(function(e){if(e&&Array.isArray(e)){var i=[];_.each(e,function(e){i.push(e.id);var t=o.findWhere({id:e.id+""});e.serverSetId=!0,t?t.save(e,{ignoreSave:!0,ignoreRender:!0}):o.create(e,{ignoreSave:!0,ignoreRender:!0})}),o.trigger("change",null,{ignoreSave:!0}),_.each(o.models,function(e){i.indexOf(e.get("id"))<0&&setTimeout(function(){e.destroy({silent:!0}),o.trigger("refresh")},1)})}}).fail(function(){t&&t()}).always(function(){e&&e()})}}),m.models.GenericMetric=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var c=this;this.set("label","");var e=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:e}).done(function(e,t,i){if(e.metricInfo)c.set("id",e.metricInfo.metricId),c.set("value",e.metricInfo.metricValue),c.set("label",e.metricInfo.metricLabel),e.metricInfo.metricLink?c.set("link",e.metricInfo.metricLink):c.set("link",null);else if(e.status&&"authRequired"==e.status&&e.authorizationUrl&&c.authAttempts<2){c.authAttempts++;var o=e.winWidth?e.winWidth:600,n=e.winHeight?e.winHeight:510,s=e.windowFeatures?e.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-o/2,l=window.screen.height/2-n/2,r=window.open(e.authorizationUrl,"MomentumAuthWindow",s+",left="+a+",top="+l+",width="+o+",height="+n),d=setInterval(function(){r.closed&&(clearInterval(d),c.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(e){}},clickMetric:function(){this.get("link")}}),m.views.GenericMetric=Backbone.View.extend({attributes:{id:"generic-stats",class:"metric"},template:m.templates.metric.widget,events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var i={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var o=(this.options.order||"append")+"To";this.$el[o]("#"+this.options.region).fadeTo(0,0).html(this.template(i)).fadeTo(500,1),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.views.BaseMetric=Backbone.View.extend({attributes:{class:"metric generic-metric add-shadow"},template:m.templates.baseMetric.baseMetric,events:{mouseenter:"mouseEnter",mouseleave:"mouseLeave","click .add-integration":"addIntegration","click .delete":"deleteMetric","click .archive":"toggleArchive","click .metric-list-item-unarchive":"unarchive","click .show-archived":"showArchived","click .toggle-random":"toggleRandom","click .metric-list-item-pin":"pinMetric","click .pane-header-add":"toggleAdding","click .metric-item":"togglePopup","click .metric-list-item-edit":"editDetail","click .metric-option":"selectMetric","dblclick .metric-option":"editDetail","click .pane-back":"hideDetail","click .metric-empty-add":"addMetricFromDashboard","click .pane-settings":"toggleDropdown","webkitAnimationEnd .metric-instance":"onAnimationEnd","mouseenter .metric-list-item-random":"enterRandomMetricIcon","mouseleave .metric-list-item-random":"leaveRandomMetricIcon"},getCustomizationKey:function(){return this.metricType.toLowerCase()+"Visible"},initialize:function(e){this.desiredTop=0,this.desiredRight=0,this.isOpen=!1,this.renderedOnce=!1,this.leaveRandomMetricIconActive=!1,this.listenTo(m,"globalEvent:esc globalEvent:click",this.hide),this.collection=e.collection,this.metricTitle=e.metricTitle,this.metricType=e.metricType,this.metricDescription=e.metricDescription,this.instanceView=new e.instanceView({el:this.$el,collection:this.collection,parentView:this}),this.instanceTemplate=e.instanceTemplate,this.detailTemplate=e.detailTemplate,this.updateInterval=e.updateInterval,this.listenTo(m.models.customization,"change:"+this.getCustomizationKey(),this.visibleChanged);var n=this;this.listenTo(this.collection,"refresh",function(){this.render()}),this.listenTo(this.collection,"add remove reset",function(e,t,i){e.get("id")&&this.render(i,e)}),this.listenTo(this.collection,"change",function(e,t){if(e){var i=Object.keys(e.changed);if(1===i.length&&"id"===i[0])return;if(0<=i.indexOf("id")&&e.get("serverSetId")){var o=e._previousAttributes.id;n.$el.find('.metric-item[data-id="'+o+'"]').attr("data-id",e.get("id")),el=n.$el.find('.metric-option[data-id="'+o+'"]').attr("data-id",e.get("id"))}}this.render(t,e)}),this.render(),this.updateInterval&&setInterval(function(){n.isOpen||n.render()},this.updateInterval)},visibleChanged:function(e){m.models.customization.get(this.getCustomizationKey())?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},updateDetails:function(){this.$el.find(".toggle-random .toggle-slider").toggleClass("on",m.models.customization.get("hideRandomMetric"))},render:function(e,t){if(e&&(e.ignoreRender||e.silent||this.$subpanes.hasClass("third")))this.$subpanes.hasClass("third")&&(this.missedRender=!0);else{this.dropdownOpen=!1;var i=[],o=[],n=this.collection.activeItems?this.collection.activeItems():this.collection.models;n.forEach(function(e){i.push(e.getViewData())}),this.collection.includeArchived&&this.collection.archivedItems().forEach(function(e){o.push(e.getViewData())}),this.sort(i),this.sort(o);var s={metrics:i,showArchive:this.collection.includeArchived,archivedMetrics:o,metricType:this.metricType,metricTitle:this.metricTitle,metricDescription:this.metricDescription,template:this.instanceTemplate,countdown:"Countdown"==this.metricType},a=i[0]&&n[0].getDetailViewVariables()||{},l=this.getPinned();this.selectedMetric&&l.indexOf(this.selectedMetric)<0&&(s.selectedMetric=this.selectedMetric.getViewData()),s.randomMetric=null;var r=0==l.length;if(this.selectedMetric)this.randomModel=null;else if(!this.randomModel||0<=l.indexOf(this.randomModel)||n.indexOf(this.randomModel)<0){var d=[];n.forEach(function(e){l.indexOf(e)<0&&d.push(e)}),(r||!m.models.customization.get("hideRandomMetric"))&&0<d.length?this.randomModel=d[Math.floor(Math.random()*d.length)]:this.randomModel=null}var c=this;if(s.randomMetric=this.randomModel?this.randomModel.getViewData():null,i.map(function(e){(e.pinned||s.selectedMetric&&e.id==s.selectedMetric.id||s.randomMetric&&e.id==s.randomMetric.id)&&(e.active=!0),c.randomModel&&e.id==c.randomModel.id&&1<i.length&&(e.random=!0)}),s.empty=0==n.length,this.renderedOnce)this.$el.html(this.template(s));else{var h=(this.options.order||"append")+"To";this.$el[h]("#"+this.options.region),this.$el.html(this.template(s)),this.$el.fadeTo(500,1),this.renderedOnce=!0}this.$el.find(".metric-detail-specific").html(this.detailTemplate(a)),this.$popup=this.$(".widget-pop"),this.isOpen&&this.show(null,null,!0,t),this.$el.find(".pane").addClass("metrics-pane"),this.$subpanes=this.$el.find(".subpanes").first(),this.$el.addClass(this.metricType.toLowerCase()),this.$el.find(".subpane").css("max-height",this.getHeightLimit()+"px"),e&&e.createdNow&&this.selectMetricByModel(t),this.$el.find(".toggle-archived .toggle-slider").toggleClass("on",this.collection.includeArchived),this.updateDetails()}},sort:function(e){return e.sort(function(e,t){if(e.pinned&&!t.pinned||e.pinned===t.pinned&&e.date.getTime()<t.date.getTime())return-1;if(t.pinned&&!e.pinned||e.pinned===t.pinned&&t.date.getTime()<e.date.getTime())return 1;return 0})},createMetric:function(e){var t=this.collection.create(e,{createdNow:!0,ignoreRender:!0}),i=t.getViewData();this.$el.find(".metric-item.random-metric").remove(),this.$el.find(".metric-item.selected-metric").remove();var o=$('<div class="metric-item selected-metric" data-id="'+t.get("id")+'"></div>');o.html(this.instanceTemplate(i)),this.$el.find(".metric-row").prepend(o);var n=$('<li data-id="'+t.get("id")+'" class="pane-list-item metric-list-item metric-option active">');return n.html(this.instanceTemplate(i)),this.$el.find(".metric-list").append(n),t},updateMetric:function(e,t){var i=e.getViewData(),o=this.$el.find('.metric-item[data-id="'+e.get("id")+'"]');o.html(this.instanceTemplate(i)),(o=this.$el.find('.metric-option[data-id="'+e.get("id")+'"]')).html(this.instanceTemplate(i)),t&&this.switchTo("second")},deleteMetric:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.activeMetric.delete(),this.activeMetric=null,this.render(),this.switchTo("second")},toggleArchive:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.activeMetric.toggleArchive(),this.render(),this.switchTo("second")},unarchive:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=$(e.currentTarget).closest(".metric-option");metric=this.collection.findWhere({id:t[0].dataset.id}),metric.toggleArchive()},addIntegration:function(e){e.stopPropagation(),e.preventDefault(),m.commandManager.execute("settings.toggle",null,{section:"metrics"}),this.hide()},pinMetric:function(e){e.preventDefault(),e.stopPropagation();var t=this.collection.findWhere({id:$(e.currentTarget).closest(".metric-option")[0].dataset.id});this.randomModel&&this.randomModel.get("id")==t.get("id")&&(this.randomModel=null),t.togglePinned(),this.$el.find(".pane-settings-dropdown .archive").html("Archive")},toggleAdding:function(e){this.instanceView.startAdding(),this.showDetail(e),this.$el.find(".edit-mode").removeClass("visible")},togglePopup:function(e){this.lastTarget&&this.lastTarget[0]==e.currentTarget?this.hide():this.show(e)},show:function(e,t,i,o){var n,s,a,l,r,d,c,h,u=this;if(this.$popup.removeClass("animated"),this.isOpen=!0,this.$el.find(".metric-option").removeClass("selected"),e?(n=$(e.currentTarget),this.lastTarget=n,this.lastTargetId=e.currentTarget.dataset.id):(o&&(a=o.get("id"),(l=this.$el.find('.metric-item[data-id="'+a+'"]')).is(":visible")&&(this.lastTarget=l,this.lastTargetId=a)),this.lastTarget.is(":visible")?n=this.lastTarget:s=this.$el.find('.metric-item[data-id="'+this.lastTargetId+'"]'),s&&s.is(":visible")&&(n=s),n||(0<(r=this.$el.find(".selected-metric")).length?n=r:(pinned=this.$el.find(".pinned-metric"),n=0<pinned.length?pinned.first():this.$el.find(".random-metric")))),this.$el.find('.metric-option[data-id="'+n.data("id")+'"]').addClass("selected"),0===n.length?this.desiredRight=0:(d=n[0].getBoundingClientRect(),c=this.$el[0].getBoundingClientRect(),h=this.desiredRight,this.desiredRight=c.left-d.left+c.width-d.width,this.desiredTop=d.height),i)return this.$popup.addClass("immediate-show"),this.$popup.css({right:h}),this.$popup.addClass("animated"),setTimeout(function(){u.$popup.css({right:u.desiredRight,top:u.desiredTop})},1),this.$subpanes=this.$el.find(".subpanes"),this.switchTo(this.currentSubpane),m.widgetManager.unfocusOverlap(this.options.region,this.$popup.height()),this.selectedMetric!==this.lastMetric&&this.$el.find(".selected-metric").addClass("pulse"),!0;this.$popup.css({right:this.desiredRight,top:this.desiredTop}),this.$popup.addClass("show"),this.switchTo("second"),setTimeout(function(){u.$popup.addClass("fade-in"),t&&t()},20),m.widgetManager.unfocusOverlap(this.options.region,this.$popup.height()),this.updateDetails()},switchTo:function(e){this.$subpanes.removeClass("second third"),this.$subpanes.addClass(e),this.currentSubpane=e,this.setHeight()},hide:function(e){if(e&&$.contains(this.$el.find(".metric-settings")[0],e.target)||this.dropdownOpen&&this.toggleDropdown(),!e||!$.contains(this.$el[0],e.target)&&this.isOpen){this.isOpen=!1,this.lastTarget=null,m.widgetManager.refocusOverlap(this.options.region),this.$popup.removeClass("fade-in"),this.$popup.removeClass("immediate-show");var t=this;setTimeout(function(){t.$popup.removeClass("show"),t.switchTo("second"),t.missedRender&&t.render()},200)}},setHeight:function(){var e=this.$subpanes.hasClass("third")?2:this.$subpanes.hasClass("second")?1:0;this.$subpanes.css("max-height",$(this.$subpanes.children()[e]).outerHeight(!0)+"px")},showDetail:function(e){this.switchTo("third");var t=this;setTimeout(function(){t.instanceView.focus&&t.instanceView.focus()},300)},hideDetail:function(e){this.switchTo("second"),this.activeMetric=null,this.$el.find(".edit-mode").removeClass("visible")},editDetail:function(e){e.stopPropagation();var t=$(e.currentTarget).closest(".metric-option");this.activeMetric=this.collection.findWhere({id:t[0].dataset.id}),this.$el.find(".edit-mode").addClass("visible"),this.instanceView.editDetail(this.activeMetric),this.showDetail(),this.$el.find(".pane-settings-dropdown .archive").html(this.activeMetric.get("archived")?"Unarchive":"Archive")},selectMetric:function(e){e.stopPropagation();var t=$(e.currentTarget);this.selectMetricById(t[0].dataset.id)},selectMetricById:function(e){var t=this.collection.findWhere({id:e});this.selectMetricByModel(t)&&this.render(null,t)},selectMetricByModel:function(e){return e.get("pinned")?(this.$el.find('.pinned-metric[data-id="'+e.get("id")+'"]').addClass("pulse"),this.show(null,null,!0,e),!1):(this.lastMetric=this.selectedMetric,this.selectedMetric=e,!0)},getPinned:function(){var e=this.collection.findPinned();return e?Array.isArray(e)||(e=[e]):e=[],e},addMetricFromDashboard:function(e){this.isOpen?this.hide():this.show(e),this.toggleAdding()},getHeightLimit:function(){var e=$("#top-right").outerHeight(!0)+$("#bottom-right").outerHeight(!0),t=$(".bookmarks-wrapper"),i=0;return t.css("transform")&&(i=parseInt(t.css("height"))-parseInt(t.css("transform").split(",")[5])),document.body.getBoundingClientRect().height-(e+i+4)},toggleDropdown:function(e){var t;e?(e.stopPropagation(),(t=$(e.currentTarget).parent()).toggleClass("active",!this.dropdownOpen)):t=this.$el,t.find(".pane-settings-dropdown").toggle(!this.dropdownOpen),this.dropdownOpen=!this.dropdownOpen},showArchived:function(e){e&&e.stopPropagation(),this.$el.find(".archive-pane .error-icon").addClass("hidden");var t=this;t.collection.includeArchived||(t.$el.find(".archive-pane .loading").removeClass("hidden"),t.$el.find(".archive-pane .loading-placeholder").toggleClass("loading-icon"),t.collection.includeArchived=!0),t.switchTo(""),this.collection.fetchFromServer(function(){t.$el.find(".archive-pane .loading").addClass("hidden")},function(){t.$el.find(".archive-pane .error").removeClass("hidden"),t.$el.find(".archive-pane .loading").addClass("hidden")})},toggleRandom:function(e){e&&e.stopPropagation(),m.models.customization.set("hideRandomMetric",!m.models.customization.get("hideRandomMetric")),this.$el.find(".toggle-random .toggle-slider").toggleClass("on"),this.selectedMetric=null,this.randomModel=null,this.render(),this.toggleDropdown()},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$el.find(".selected-metric").removeClass("pulse")},setHeightInAnimation:function(){var e=this;this.setHeight(),setTimeout(function(){e.setHeight()},1),setTimeout(function(){e.setHeight()},100)},enterRandomMetricIcon:function(e){var t=this;this.$randomMetricOption=$(e.target).closest(".metric-option"),this.$randomMetricOption.find(".metric-label-wrapper").addClass("hide-label"),setTimeout(function(){t.leaveRandomMetricIconActive||t.$randomMetricOption.find(".metric-label-wrapper").addClass("show-tooltip")},100)},leaveRandomMetricIcon:function(e){var t=this;this.leaveRandomMetricIconActive=!0,this.$randomMetricOption=$(e.target).closest(".metric-option"),this.$randomMetricOption.find(".metric-label-wrapper").removeClass("show-tooltip"),setTimeout(function(){t.$randomMetricOption.find(".metric-label-wrapper").removeClass("hide-label"),t.leaveRandomMetricIconActive=!1},100)}}),m.models.Quote=Backbone.Model.extend({idAttribute:"forDate"}),m.collect.Quotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.Quote,getActiveQuote:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.models.QuoteManager=Backbone.Model.extend({initialize:function(e,t){m.collect.quotes=new m.collect.Quotes},firstFetch:function(){m.collect.quotes.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new quote. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},getActiveQuote:function(){var e=this;if(m.collect.quotes){var t=m.collect.quotes.getActiveQuote();if(!t)return null;var i=!1;if(this.currentQuote&&this.currentQuote.get("_id")==t.get("_id")){var o=this.currentQuote;o.get("body")==t.get("body")&&o.get("source")==t.get("source")&&o.get("twitter")==t.get("twitter")&&o.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentQuote=t,i=!0)}else this.currentQuote=t,i=!0;return i&&setTimeout(function(){m.trigger("quote:active_changed",e.currentQuote.get("_id"))},50),t}return null},skipQuote:function(i){var o=this,e=m.globals.urlRootApi+"quotes",t=this.getActiveQuote(),n={operation:"skip",active_uuid:t.get("_id"),is_custom:t.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(n),url:e}).done(function(e){e&&e.success&&m.trigger("sync:download","quote"),e&&e.notification&&m.commandManager.execute("notification.show.enhanced",e.notification)}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",o.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",o.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i){var o=this,t=m.globals.urlRootApi+"quotes/favorites",n=this.getActiveQuote(),s={operation:"favorite",active_uuid:n.get("_id"),is_favorite:e,is_custom:n.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:t}).done(function(e){e&&e.success&&(m.trigger("sync:download","quote"),m.trigger("quote:favorite",{id:s.active_uuid,is_favorite:s.is_favorite}))}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",o.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",o.favouriteErrorMessage),i&&i()}},latestQuoteDate:function(){var i=null;return m.collect.quotes.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Quote=Backbone.View.extend({tagName:"blockquote",attributes:{class:"quote",id:"shortquote"},template:m.templates.quote.quote,events:{click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .control-twitter":"shareTwitter","click .control-heart":"toggleFavorite","click .control-refresh":"skipQuote"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1;var n=this;this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged),$(window).on("resize",function(){if(n.$quote_body_text){var e=n.$quote_body_text.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=(n.$quote_body_text.height(),n.$quote_body_text.clone());i.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),i.css("position","absolute"),i.css("width","100%"),i.css("top","0"),i.css("left","0"),i.css("margin","0"),i.css("padding","0"),i.appendTo(n.$quote_body_text);var o=i.height();(o<1.75*t||2.75*t<o)&&n.$quote_body_text.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),n.render(),i.remove()}})},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){0<e.collection.length&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){m.trigger("quote:downloaded"),this.isCollectionReady=!0,this.isParentReady&&this.render()},visibleChanged:function(e){m.models.customization.get("quoteVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},render:function(e){if(0!==this.collection.length){var t=m.models.quoteManager.getActiveQuote();if(t){var i=!1;if(this.currentlyActiveQuote&&this.currentlyActiveQuote.get("_id")==t.get("_id")){var o=this.currentlyActiveQuote;o.get("body")==t.get("body")&&o.get("source")==t.get("source")&&o.get("twitter")==t.get("twitter")&&o.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentlyActiveQuote=t,i=!0)}else this.currentlyActiveQuote=t,i=!0;var l=this,r=t.get("body"),n=t.get("source"),s=t.get("detail_url"),a=t.get("twitter"),d=t.get("twitterIntentUrl"),c=!1,h="";if(t.get("is_favorite")&&(c=!0,h="active"),!d){var u="";u=a?'"'+r+'" —@'+a:'"'+r+'" —'+n,d="https://twitter.com/intent/tweet?text="+encodeURIComponent(u)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}var g=0;if(i&&this.renderedOnce&&(g=650),this.renderedOnce)i&&this.$el.fadeTo(500,0,function(){l.$quote_body_text.html("&ldquo;"+r+"&rdquo;"),l.$quote_source_text.html(n),l.$control_twitter.data("url",d),l.$el.fadeTo(500,1)});else{var p={body:r,source:n,twitterIntentUrl:d,fav_class:h},f=(this.options.order||"append")+"To";e?this.$el[f]("#"+l.options.region).html(l.template(p)).fadeTo(500,1):this.$el[f]("#"+l.options.region).fadeTo(0,0).html(l.template(p)).fadeTo(500,1),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.$quote_body_text=this.$el.find(".quote-body-text").first(),this.$quote_source_text=this.$el.find(".quote-source-text").first(),this.$control_twitter=this.$el.find(".control-twitter").first(),this.renderedOnce=!0}s&&0<s.length?(this.detail_url=s,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-qt")?this.$el.find(".control-refresh").show():this.$el.find(".control-refresh").hide(),this.$control_heart.show(),c?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),setTimeout(function(){var e=l.$quote_body_text.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=l.$quote_body_text.height(),o=!1;if(1.75*t<i&&i<2.75*t){var n,s="",a=r.split(" ");for(n=0;n<a.length;n++)s+=a[n],!o&&s.length>(r.length+5)/2?(s+="<br>",o=!0):n!=a.length-1&&(s+=" ");l.$quote_body_text.html("&ldquo;"+s+"&rdquo;"),2.75*t<(i=l.$quote_body_text.height())&&l.$quote_body_text.html("&ldquo;"+r+"&rdquo;")}},g)}else m.trigger("sync:downloadIfNeeded")}else m.trigger("sync:downloadIfNeeded")},clickWidget:function(e){this.detail_url&&0<this.detail_url.length&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&0<this.detail_url.length&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.stopPropagation();var t=screen.width/2-272.5,i=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+i+",width=545,height=420,resizeable=0")},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.quoteManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Quote",t?"Favourite":"Unfavourite")},skipQuote:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.quoteManager.skipQuote(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Quote","Skip"))}}),m.bootstrappers.InitializeQuote=function(e,t){e.models.quoteManager=new e.models.QuoteManager},m.bootstrappers.RenderQuote=function(t,e,i){t.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){t.models.customization.get("quoteVisible")&&(t.views.quote=new t.views.Quote({collection:t.collect.quotes,model:t.models.date,region:"bottom"}),t.models.quoteManager.firstFetch(),t.views.quote.parentReady(i),t.widgets.push(t.views.quote),t.stopListening(t.models.customization,"change:quoteVisible"))},function(e){t.listenTo(t.models.customization,"change:quoteVisible",e)})},m.models.FocusBase=Backbone.Model.extend({defaults:{focus:"",day:"",forDate:null,archived:!1,createdDate:new Date,archivedDate:null,completed:!1,completedDate:null,cached:!1},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{}},archive:function(){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())},toggleCompleted:function(){var e=this.saveOptions(),t=!this.get("completed");return this.save({completed:t,completedDate:this.get("completed")?null:new Date},e),t}}),m.models.Focus=m.models.FocusBase.extend({urlRoot:function(){return this.collection?null:m.globals.urlRoot+"focus"},toggleCompleted:function(){var o=this,e=this.saveOptions(),n=!this.get("completed");if(m.conditionalFeatures.featureEnabled("pinfocus")){var s=o.get("todoId");e.success=function(){m.trigger("focus:toggled",n),o.get("refreshTodo")&&s&&m.trigger("todo:refresh",s)},e.error=function(e,t,i){200==t.status&&(m.trigger("focus:toggled",n),o.get("refreshTodo")&&s&&m.trigger("todo:refresh",s))};var t={completed:n,completedDate:this.get("completed")?new Date:null};this.id.startsWith("todo-")&&(t.todoId=this.get("todoId"),t.projectId=this.get("projectId"),t.providerId=this.get("providerId"),t.listId=this.get("listId"),t.focus=this.get("focus")),this.save(t,e),m.trigger("todo:set:done",s,n)}else this.save({completed:n,completedDate:this.get("completed")?null:new Date},e);return n},archive:function(){if(!this.id.startsWith("todo-")){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())}m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.models.customization.set("autoFocus",!1)},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{patch:!0}}}),m.collect.FocusesBase=Backbone.Collection.extend({saveOptions:{},attributes:{},successfulLoad:!1,loadingFromServer:!0,fetchedOnce:!1,initialize:function(){this.on("reset",this.onReset,this),this.on("add",this.onAdd,this),this.on("change",this.onModelChanged,this)},fetch:function(e){this.fetchedOnce=!0;return e=_.extend(e||{},{}),Backbone.Collection.prototype.fetch.call(this,e)},onReset:function(){this.successfulLoad=!0,this.loadingFromServer=!1,this.trigger("loadingFromServerChanged")},onModelChanged:function(e){var t=e.changedAttributes(),i=_.keys(t);0<_.without(i,"archived","archivedDate").length&&this.saveCachedFocus(e)},comparator:function(e){var t=e.get("completedDate");return t||(t=e.get("createdDate"))?-Date.parse(t):0},activeFocus:function(){return this.activeFocusBase()},activeFocusBase:function(){if(this.loadingFromServer)return this.fetchedOnce||this.fetch({reset:!0}),this.cachedFocus();if(0===this.length)return localStorage.removeItem("cachedFocus"),null;var i=null,e=getActiveDateString(),t=this.where({completed:!1,archived:!1,forDate:e});if(1===t.length)i=t[0];else if(0===t.length)if(1===(t=this.where({completed:!0,archived:!1,forDate:e})).length)i=t[0];else if(0===t.length)return localStorage.removeItem("cachedFocus"),null;return null==i&&_.each(t,function(e){if(null==i)i=e;else{var t=e.get("completedDate");i.get("completedDate")<t&&(i=e)}}),i?this.saveCachedFocus(i):localStorage.removeItem("cachedFocus"),i},saveCachedFocus:function(e){localStorage.cachedFocus=JSON.stringify(e)},cachedFocus:function(){if(localStorage.cachedFocus){var e=JSON.parse(localStorage.cachedFocus),t=getActiveDateString();if(e&&e.forDate===t)return e.cached=!0,new this.model(e)}return null}}),m.collect.Focuses=m.collect.FocusesBase.extend({model:m.models.Focus,url:m.globals.urlRoot+"focus",saveOptions:{patch:!0},activeFocus:function(){if(!m.conditionalFeatures.featureEnabled("pinfocus")||!m.models.customization.getComputedSetting("autoFocus"))return this.activeFocusBase();if(m.models.todoListManager&&m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedList){var e=m.models.todoListManager.activeProvider.selectedList();if(e&&e.itemCollection&&(0<e.itemCollection.length||!e.itemCollection.loadingFromServer)){var t=null;if(m.views.todoPane&&m.views.todoPane.todoList&&m.views.todoPane.todoList.reordered){var i=m.views.todoPane.todoList.getTopActiveTodoId();i&&(t=e.itemCollection.get(i))}else{var o=_(e.itemCollection.activeToday()).chain().filter(function(e){var t=!1;if(e.get("viewSection")){var i="collapsed-"+e.get("listId")+":"+e.get("viewSection");t=m.models.customization.get(i)}return!e.get("done")&&"subsection"!=e.get("viewType")&&!t}).value();o&&0<o.length&&(t=o[0])}if(t){var n={};n.id="todo-"+t.id,n.focus=t.get("title"),n.day="today",n.todoId=t.id;var s=t.collection.parentList.project;n.listId=t.get("listId"),n.projectId=t.get("projectId")||s.id,n.providerId=s.provider.id,n.forDate=getActiveDateString();var a=new m.models.Focus(n);return this.saveCachedFocus(a),a}return this.fetchedOnce?this.successfulLoad?this.activeFocusBase():this.cachedFocus():(this.fetch({reset:!0}),this.cachedFocus())}return e&&e.itemCollection&&e.itemCollection.doFetchIfNeeded(),this.cachedFocus()}return this.cachedFocus()},triggerCollectionReset:function(){this.trigger("reset")},selectedListCacheKey:function(){return localStorage.activeTodoProvider?"activeTodoListId-"+localStorage.activeTodoProvider:null}}),m.collect.FocusesLegacy=m.collect.FocusesBase.extend({model:m.models.FocusBase,localStorage:new Backbone.LocalStorage("momentum-focus"),saveOptions:{},onReset:function(){this.loadingFromServer=!1,this.fixNullForDate(),this.trigger("loadingFromServerChanged")},fixNullForDate:function(){var e=this.where({archived:!1,forDate:null});e&&0<e.length&&_.each(e,function(e){var t=e.get("createdDate");t?activeDateStringForDate(Date.parse(t))!=getActiveDateString()&&e.archive():e.archive()},focus)}}),m.views.Focus=Backbone.View.extend({tagName:"li",attributes:{class:"focus"},template:m.templates.focus["focus-template"],events:{"click .delete":"destroy","click .checkbox":"toggleCompleted"},initialize:function(e){e&&e.skipRender||this.render(),this.listenTo(this.model,"change",this.render),m.conditionalFeatures.featureEnabled("pinfocus")&&(this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m,"todo:changing",this.todoChanging),this.listenTo(m,"focus:toggled",this.focusToggled),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged))},todoChanged:function(e,t){e==this.model.get("todoId")&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.collect.focuses&&t.hasOwnProperty("done")&&m.collect.focuses.fetch({reset:!0})},todoChanging:function(e,t){e==this.model.get("todoId")&&(t.hasOwnProperty("done")&&this.model.set("completed",t.done),t.hasOwnProperty("title")&&this.model.set("focus",t.title),t.hasOwnProperty("done")&&this.displayAutoPinMessage(t.done))},render:function(){var e={focus:m.utils.captionFormatter(this.model.get("focus")),day:"Today"};return this.$el.html(this.template(e)),this.model.changed.hasOwnProperty("completed")?this.$el.toggleClass("complete",this.model.changed.completed):this.$el.toggleClass("complete",this.model.get("completed")),this.$el.toggleClass("cached",this.model.get("cached")),this},displayAutoPinMessage:function(e){m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.views.focuses.displayLoadingMessage(e)},focusToggled:function(e){e&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&(this.displayAutoPinMessage(e),m.collect.focuses&&m.collect.focuses.fetch({reset:!0}))},destroy:function(){if(this.$el.hasClass("complete"))m.sendEvent("Focus","Add New"),m.trigger("setNewFocus");else{m.sendEvent("Focus","Delete");var e=this;this.$el.fadeTo(500,0,function(){e.destroyed=!0,e.model.archive(),e.remove(),m.trigger("deleteFocus")})}},autoFocusChanged:function(){this.destroyed&&m.conditionalFeatures.featureEnabled("pinfocus")&&!m.models.customization.getComputedSetting("autoFocus")&&m.trigger("setNewFocus")},removeView:function(){this.remove(),this.unbind()},toggleCompleted:function(){m.views.focuses.randomizeCongratsMessage();var e=this.model.toggleCompleted();m.views.focuses.displayLoadingMessage(e),m.conditionalFeatures.featureEnabled("serverfocus")||setTimeout(function(){m.views.focuses.dismissConnectionMessage()},3e3),this.$el.toggleClass("complete",e),m.sendEvent("Focus","Done")}}),m.views.FocusPrompt=Backbone.View.extend({attributes:{class:"prompt"},template:m.templates.focus["focus-prompt-template"],events:{click:"focusInput","focus input":"handleFocus","keypress input":"handleInput","keyup input":"handleKeyup","blur input":"handleBlur"},initialize:function(){this.focusedOnce=!1,this.listenTo(m,"globalEvent:toggleFocus",this.toggleShow),this.listenTo(m,"globalEvent:esc",this.hide),this.render()},render:function(){return this.$el.html(this.template()),this.$input=this.$el.find("input"),this.collection.loadingFromServer||this.$input.focus(),this},focusInput:function(){this.$input.focus()},handleFocus:function(e){this.focusedOnce=!0,m.views.focuses.promptFocused()},handleBlur:function(){this.focusedOnce=!1,this.$el.removeClass("loading")},handleInput:function(e){this.collection.loadingFromServer&&e.preventDefault(),this.clearHelpTimeout(),13==e.keyCode?this.save():this.startHelpTimeout()},handleKeyup:function(){0==this.getInput().length&&m.views.focuses.dismissConnectionMessage()},getInput:function(){return this.$input.val().trim()},inputTimeout:"",startHelpTimeout:function(){var e=this;this.inputTimeout=setTimeout(function(){e.displayHelpMessage()},5e3)},clearHelpTimeout:function(){0<this.inputTimeout&&clearTimeout(this.inputTimeout)},displayHelpMessage:function(){0<this.getInput().length&&m.views.focuses.displayConnectingText("Press enter to set your focus",!0)},save:function(){var e=this.getInput();if(e){var o=this;m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString();m.collect.focuses.create({focus:e,day:"today",forDate:t},{wait:!0,success:function(){m.views.focuses.successfulConnection(),m.views.focuses.successfullyCreatedNewFocus()},error:function(e,t,i){o.$input.addClass("pulse"),m.views.focuses.failedConnection(!0)}})}},toggleShow:function(){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.views.Focuses=Backbone.View.extend({attributes:{id:"focuses"},template:m.templates.focus["focuses-template"],events:{"mouseover .todays-focus":"onMouseOver","click .todays-focus":"onClickFocus","click .prompt":"onClickFocus","click .retry":"retryConnection"},offline:!0,loading:!1,clickedOnce:!1,retrying:!0,initialize:function(){this.congratsList=["Great work!","Good job!","Nice.","Way to go!"],this.listenTo(m,"newDay",this.changeDay,this),this.listenTo(m,"setNewFocus",this.setNewFocus,this),this.listenTo(m,"deleteFocus",this.setNewFocus,this),this.listenTo(m,"todo:loadingStateChange",this.todoLoadingStateChanged),this.listenTo(m,"todo:managerReady",this.todoLoadingStateChanged),this.listenTo(m,"todo:globalChange",this.todoLoadingStateChanged),this.listenTo(m.collect.focuses,"change:archived",this.todayArchived),this.listenTo(m.collect.focuses,"reset",this.collectionReady),this.listenTo(m.collect.focuses,"sync",this.successfulConnection),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:focusVisible",this.visibleChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.onShowAssignedTodosOnlyChanged),this.listenTo(m,"todo:sectionExpansion",this.onSectionExpansion),this.renderedOnce=!1,this.lastStateFocused=!1,this.focusStateChanged=!0,this.randomizeCongratsMessage(),this.render()},onMouseOver:function(){this.loading&&this.displayConnectingText(null,!0)},onClickFocus:function(){this.offline&&this.displayConnectingText(null,!0),this.clickedOnce=!0},visibleChanged:function(e){m.models.customization.getComputedSetting("focusVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},collectionRequest:function(){this.loading=!0,this.clickedOnce||this.connectingTextOverride},promptFocused:function(){this.loadedOnce||this.displayConnectingText()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$message.html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$message.addClass("loading"),this.$message.is(":visible")||this.$message.fadeIn(500)},randomizeCongratsMessage:function(){this.loadingMessage=this.congratsList[Math.floor(Math.random()*this.congratsList.length)]},displayLoadingMessage:function(e){var t=this;e?this.displayConnectingText('<i class="loading-icon"></i>'+this.loadingMessage,!0):this.displayConnectingText('<i class="loading-icon"></i> Loading...',!0),setTimeout(function(){t.dismissConnectionMessage()},4e3)},todoLoadingStateChanged:function(e){e&&"Selected"===e||this.render()},onShowAssignedTodosOnlyChanged:function(){this.render()},onSectionExpansion:function(){this.render()},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.displayConnectingText('<i class="loading-icon"></i>Loading...',!0),this.retrying=!0;var t=this;m.views.focusPrompt?m.syncCoordinator.pingApi(function(){t.successfulConnection(),m.views.focusPrompt&&m.views.focusPrompt.focusInput()},function(){t.failedConnection(!0)}):this.collection.fetch({reset:!0})},successfulConnection:function(){this.dismissConnectionMessage(!0),this.loading=!1,this.offline=!1,this.retrying=!1,this.loadedOnce=!0},failedConnection:function(e){this.loading=!1,this.offline=!0,this.render(),this.displayConnectingText('Trouble connecting… <span class="retry">Retry</span>',e||this.clickedOnce)},dismissConnectionMessage:function(e){this.$message&&this.$message.is(":visible")&&this.$message.fadeOut(e?0:300)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render(),this.successfulConnection()},setNewFocus:function(){this.render(!0),m.views.focusPrompt&&m.views.focusPrompt.focusInput(),this.dismissConnectionMessage()},autoFocusChanged:function(){this.render()},setFocusState:function(e){this.lastStateFocused==e?this.focusStateChanged=!1:this.focusStateChanged=!0,this.lastStateFocused=e},render:function(e){var t=!1;m.views.focusPrompt&&(t=m.views.focusPrompt.controlFocusedOnce);var i=this;if(!this.renderedOnce){var o=(this.options.order||"append")+"To";this.$el[o]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$message=this.$(".message")}var n=this.renderedOnce;this.renderedOnce=!0;var s=null;if(e||(s=this.collection.activeFocus()),s&&m.views.todayFocus&&m.views.todayFocus.model.id==s.id&&!m.views.todayFocus.model.get("cached"))return this;if(s){this.setFocusState(!0);var a=!1,l=null;if(m.views.todayFocus?m.views.todayFocus.model.id!=s.id?m.views.todayFocus.model.id.startsWith("todo-")?m.views.todayFocus.model.get("todoId")!=s.get("todoId")&&(a=!0,l=m.views.todayFocus):(a=!0,l=m.views.todayFocus):m.views.todayFocus.model.collection||(a=!0,l=m.views.todayFocus,n=!1):a=!0,n=n&&(a&&!l||l&&!l.model.get("cached")),a){this.dismissConnectionMessage(),i.$el.find(".prompt").fadeTo(500,0),n&&l&&l.$el.fadeTo(500,0),m.views.focusPrompt=null,m.views.todayFocus=new m.views.Focus({model:s,skipRender:!0});var r=0<i.$el.find(".prompt").length;setTimeout(function(){if(r&&i.$el.find(".prompt").remove(),l&&l.removeView(),m.views.todayFocus){var e=m.views.todayFocus.render().$el.fadeTo(n?500:0,1),t=i.$el.find("ol li");0<t.length?t.replaceWith(e):i.$el.find("ol").append(e)}},l?500:0)}}else this.setFocusState(!1),m.views.todayFocus&&(i.$el.find("li").fadeTo(0,0).remove(),m.views.todayFocus=null),m.views.focusPrompt||(m.views.focusPrompt=new m.views.FocusPrompt({collection:this.collection}),this.$el.prepend(m.views.focusPrompt.render().$el.fadeIn(this.focusStateChanged?500:0))),t&&m.views.focusPrompt.focusInput();return this},addToday:function(e){m.sendEvent("Focus","Save"),m.views.todayFocus=new m.views.Focus({model:e}),this.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(500,1))},successfullyCreatedNewFocus:function(){m.views.focuses.successfulConnection(),this.render()},changeDay:function(){m.collect.focuses.fetch({reset:!0})},todayArchived:function(){this.render()}}),m.bootstrappers.InitializeFocus=function(e,t){},m.bootstrappers.RenderFocus=function(e,t,i){e.conditionalFeatures.checkFeatureAndMigrateData("serverfocus","focusVisible","momentum-focus",function(){e.collect.focuses=new e.collect.Focuses,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.conditionalFeatures.featureEnabled("pinfocus")&&e.models.customization.getComputedSetting("autoFocus")||e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)},function(){e.collect.focuses=new e.collect.FocusesLegacy,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)})},m.models.legacy=m.models.legacy||{},m.collect.legacy=m.collect.legacy||{},m.views.legacy=m.views.legacy||{},m.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t}}),m.models.legacy.Todo=m.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),m.models.legacy.TodoProxy=m.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.collect.legacy.TodosBase=Backbone.Collection.extend({model:m.models.legacy.Todo,saveOptions:{},initialize:function(){this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){return this.completeToday().length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return null==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.legacy.Todos=m.collect.legacy.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){}).fail(function(e,t){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(e){this.saveCachedCompletedCount()},completedCount:function(){return this.loadingFromServer?this.cachedCompletedCount():this.completeToday().length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var e=this.completeToday().length,t=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:e,forDate:t}),e!=this.previousCount&&(this.previousCount=e,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return e.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return!0}return!1},parse:function(e){return e.items?e.items:e}}),m.collect.legacy.TodosLegacy=m.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var t=100;this.each(function(e){e.save({order:t},{silent:!0}),t+=100})},clearCompleted:function(){var i=!1,e=this.completeToday();_.each(e,function(e){var t=e.get("completedDate");t&&(activeDateStringForDate(Date.parse(t))!=getActiveDateString()&&(e.archive(),i=!0))}),i&&this.trigger("reset")},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),o=0<e.move_offset?1:-1,n=this.indexOf(i),s=1;if(0<=n+o&&n+o<this.length){var a=this.at(n+o);(s=Math.abs(a.get("order")-i.get("order")))<=20&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*o;t.save({order:l},{silent:!0})}}),m.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo",class:"widget-bottom-right todo"},template:m.templates.todos["legacy-todo"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser-dropdown":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend",drop:"drop"},initialize:function(){this.subViews=[],this.proxyCollection=new Backbone.Collection({model:m.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:window:resize",this.setMaxWidgetHeight),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.showPopup(),this.doFetchIfNeeded()),setTimeout(function(){try{if(m.conditionalFeatures.featureEnabled("plus")&&!localStorage.plus_first_load&&(localStorage.plus_first_load=!0,m.views.legacy.todos))try{m.views.legacy.todos.$el.hide(),m.views.legacy.todos.undelegateEvents(),m.views.legacy.todos.$el.removeData().unbind(),m.views.legacy.todos.remove(),Backbone.View.prototype.remove.call(m.views.legacy.todos),m.bootstrappers.RenderTodos(m,$)}catch(e){}}catch(e){}},500)},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),this.renderedOnce=!0,this.setMaxWidgetHeight(),this.visibleChanged()}return this},visibleChanged:function(){m.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},setMaxWidgetHeight:function(){var e=$(window).height()-125;$(".pane").css("max-height",e);var t=$(".todo-pane");if(t){var i=t.find(".todo-header").outerHeight(),o=t.find(".todo-message").outerHeight(!0),n=t.find(".todo-new").outerHeight();0==i&&(i=34),null==o&&(o=0),0==n&&(n=39),t.find(".todo-list").css("max-height",e-(i+o+n))}return e},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),m.conditionalFeatures.featureEnabled("localtodonotify"))){var t=this;window.addEventListener("storage",function(e){if(e.key&&0===e.key.indexOf("todos-updated")){if(t.fetching)return;t.fetching=!0,t.collection.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(e){localStorage.greetings&&((e=JSON.parse(atob(localStorage.greetings)).todo)&&(e.none&&(this.emptyTodoGreetings=e.none),e.completed&&(this.completedTodoGreetings=e.completed)));this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var e=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(e,1)[0]}return this.emptyTodoGreeting},addOne:function(e){var t=new m.views.legacy.Todo({model:e,parent:this});this.subViews.push(t),this.$(".todo-list").append(t.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection(),this.setMaxWidgetHeight()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(e){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},successfulConnection:function(){var e=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),e&&this.trigger("connectionOnline")},failedConnection:function(e){this.offline=!0,this.displayConnectingText(e||'Trouble connecting… <span class="retry">Retry</span>'),this.checkEmptyPaneState()},handleInput:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(e){e.preventDefault(),e.stopPropagation(),this.retryConnection()},retryConnection:function(){var t=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(e){t.createNewModel(e,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(e){t.saveToModel(e)})):this.collection.fetch({reset:!0})},createNewModel:function(o,e){var n=this;e?n.displayConnectingText('<i class="loading-icon"></i>Retrying...'):n.displayConnectingText('<i class="loading-icon"></i>Saving...'),o.set({saveFailed:!1,isLoading:!0}),n.collection.create({title:o.get("title")},{wait:!0,success:function(){n.successfulConnection(),o.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(e,t,i){n.failedConnection('Error saving… <span class="retry">Retry</span>'),o.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(n,e){var s=this;s.displayConnectingText('<i class="loading-icon"></i>Saving...');var t=n.saveOptions();t.wait=!0,t.success=function(){var e={};jQuery.extend(e,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),setTimeout(function(){n.set(e),s.successfulConnection()},50)},t.error=function(e,t,i){if(200==t.status){var o={};jQuery.extend(o,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(o,{saveFailed:!1,isLoading:!1}),setTimeout(function(){n.set(o),s.successfulConnection()},50)}else n.set({saveFailed:!0,isLoading:!1}),s.failedConnection('Error saving… <span class="retry">Retry</span>')},e?(n.attemptedSaveValues?jQuery.extend(n.attemptedSaveValues,e):n.attemptedSaveValues=e,n.save(e,t)):n.attemptedSaveValues&&(e=n.attemptedSaveValues,n.save(n.attemptedSaveValues,t)),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),n.set(e)},createOnEnter:function(e){var t=this.$el.find("#todo-new")[0].value.trim();if(t){var i=new m.models.legacy.TodoProxy({title:t});this.proxyCollection.add(i),this.$el.find("#todo-new")[0].value="",this.createNewModel(i)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),!(e.originalEvent.dataTransfer.dropEffect="move")},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},drop:function(e){e.preventDefault(),e.stopPropagation()},li_index:function(e){return this.$("li").index(e)},toggleShow:function(e){e&&e.preventDefault(),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),this.$el.hasClass("show")?this.hidePopup(e):this.showPopup(),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList)},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto"),this.$el.find("#todo-new").focus()},hidePopup:function(){if(this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show").find(".pane").css("height","auto")})}},showCompleted:function(e){e.preventDefault(),e.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(e){var i=!1;$(".todo-item-title").each(function(e,t){"true"==$(this).attr("contentEditable")&&(i=!0)}),!i&&this.$el.hasClass("show")&&this.toggleShow()},openList:function(e){this.$el.find(".todo-list-chooser-dropdown").show()},chooseList:function(e){this.$el.find(".todo-list-chooser-dropdown").hide()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},collectionModelChanged:function(e){this.checkEmptyPaneState()},checkEmptyPaneState:function(){if(this.subViews){var e=_.every(this.subViews,function(e){return!e.$el.is(":visible")});0!=this.collection.activeToday().length&&(e=!1),this.$el.find(".todo-pane").toggleClass("is-empty",e),this.offline||this.showcompleted||!e?this.$el.find(".todo-pane").css("min-height",""):this.$el.find(".todo-pane").css("min-height",200),this.updateTodoCount()}},updateTodoCount:function(){if(!this.offline){var e=this.collection.remaining().length;switch(e){case 0:break;case 1:break;default:}this.$(".todo-count").html(e+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),m.views.legacy.Todo=Backbone.View.extend({tagName:"li",className:"todo-item todo-item-legacy",template:m.templates.todos["legacy-todo-item"],events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","click .destroy":"clear","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(e){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(m,"globalEvent:esc",this.abortEdit)},render:function(){var e="",t=m.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)e="checked";var i={title:t,checked:e};return this.$el.html(this.template(i)),this.$el.find(".todo-item-checkbox").prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this.$title=this.$el.find(".todo-item-title").first(),this.$title.text(t),this},destroy:function(){this.remove(),this.unbind()},clear:function(){m.sendEvent("Todo","Delete"),this.$el.hide(),m.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing&&(this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),el.attr("contentEditable",!1),el.closest(".todo-item").attr("draggable",!0),this.editing=!1)},setEditable:function(e,t){e.attr("contentEditable",t),e.closest(".todo-item").attr("draggable",!t)},saveEdit:function(){if(this.editing){this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.editing=!1;var e=this.$title.text();this.setEditable(this.$title,!1),e?m.views.legacy.todos.saveToModel(this.model,{title:e}):this.clear()}},retrySave:function(){this.model.isTrue("isProxy")?m.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&m.views.legacy.todos.saveToModel(this.model)},edit:function(e){this.editing||(this.originalText=this.$title.text(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.removeClass("viewing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){if(this.editing)return!1;e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,m.sendEvent("Todo","Reorder")},dragenter:function(e){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},dragleave:function(e){},toggleDone:function(){m.sendEvent("Todo","Done");var e=!this.model.get("done");m.views.legacy.todos.saveToModel(this.model,{done:e,completedDate:e?new Date:null})},handleInput:function(e){this.editing&&(13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete",class:"metric"},template:m.templates.todos["legacy-todo-complete"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var e=this.collection.completedCount(),t="todos";1==e&&(t="todo");var i={done:e,item:t},o=(this.options.order||"append")+"To";return this.$el[o]("#"+this.options.region).html(this.template(i)).fadeTo(500,1),e?this.$el.show():this.$el.hide(),this}}),m.bootstrappers.RenderTodos=function(e,t){e.conditionalFeatures.featureEnabled("enhancedtodo")?e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.views.todoPane=new e.views.TodoPane({region:"bottom-right",order:"append"}),e.widgets.push(e.views.todoPane)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)}):e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.collect.legacy.todos=new e.collect.legacy.Todos,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)})},m.views.Weather=Backbone.View.extend({attributes:{id:"weather",class:"metric weather"},template:m.templates.weather.weather,events:{"paste .weather-location-name":"handlePaste","dblclick .weather-current-location":"editLocation","mousedown .weather-location-reset":"resetLocation","click .weather-location-edit":"editLocation","click .weather-location-edit-menu":"editLocation","click .ready-to-set":"setLocation","click .weather-toggle":"togglePopup","click .weather-forecast-day":"switchDay","click .toggle-details":"toggleDetails","click .toggle-hourly":"toggleHourly","click .toggle-metric":"toggleUnit","keypress .weather-current-location":"onKeypress","keydown .weather-current-location":"onKeydown","keyup .weather-current-location":"onKeyup","blur .weather-current-location":"saveLocation","webkitAnimationEnd .weather-current-location":"onAnimationEnd","click .pane-settings-icon":"toggleDropdown"},initialize:function(){var t=this;this.loadingMessage="Loading...",this.today=!0,this.setBaseCodes(),this.setYahooCodes(),this.renderedOnce=!1;var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0),this.detailVisible=!1,this.hourlyVisible=!1,this.listenTo(m.models.customization,"change:hour12clock",this.render),this.listenTo(m.models.customization,"change:temperatureUnit",this.render),this.listenTo(m.models.customization,"change:weatherDetail",this.updateDetails),this.listenTo(m.models.customization,"change:weatherHourly",this.updateHourly),this.listenTo(this.model,"change:error",this.render),this.listenTo(this.model,"change:now",this.render),this.listenTo(this.model,"change:location",this.render),this.listenTo(this.model,"change:hours",this.render),this.listenTo(this.model,"change:loading",this.setLoading),this.render(this.options.unitClass="hide"),this.listenTo(m.models.customization,"change:weatherVisible",this.visibleChanged),this.listenTo(this.model,"change:location",function(){var e=t.model.get("location");e&&e.countryCode&&t.setUnit(e.countryCode)}),this.listenTo(m,"globalEvent:esc globalEvent:click",this.hide)},handlePaste:function(e){e.preventDefault(),$(e.currentTarget).html("")},updateDetails:function(){var e=this,t=this.detailVisible;function i(){e.$el.find(".weather-detail").toggleClass("active",t),e.$el.find(".toggle-details .toggle-slider").toggleClass("on",t),e.$el.find(".weather-current-details").toggleClass("active",t),e.detailVisible=t}i(),(t=1==m.models.customization.get("weatherDetail")&&null!=this.model.get("hours")&&m.conditionalFeatures.featureEnabled("plus")&&this.today)!=this.detailVisible?setTimeout(function(){i()},10):i()},updateHourly:function(){var e=this,t=this.hourlyVisible;function i(){e.$el.find(".weather-hourly").toggleClass("active",t),e.$el.find(".toggle-hourly .toggle-slider").toggleClass("on",t),e.$el.find(".weather-current-temp-wrapper").toggleClass("active",t),e.hourlyVisible=t}i(),(t=1==m.models.customization.get("weatherHourly")&&null!=this.model.get("hours")&&m.conditionalFeatures.featureEnabled("plus")&&this.today)!=this.hourlyVisible?setTimeout(function(){i()},10):i()},updateDaily:function(){this.$el.find(".weather-forecast-daily").toggleClass("active",this.model.get("daily"))},updateCurrentInfo:function(){this.$el.find(".weather-current-details").toggleClass("active",null!=this.model.get("now").apparentTemperature)},setBaseCodes:function(){var e=this.baseCodes={};e.tornado="F",e.tropicalStorm="F",e.hurricane="F",e.severeThunderstorm="O",e.thunderstorm="P",e.mixedRainAndSnow="X",e.drizzle="Q",e.rain="R",e.freezingRain="X",e.showers="Q",e.sunnyShowers="Q",e.snowFlurries="U",e.snow="W",e.hail="X",e.sleet="X",e.dust="J",e.foggy="M",e.haze="J",e.smoky="M",e.blustery="F",e.windy="F",e.cold="G",e.cloudy="Y",e.mostlyCloudyNight="I",e.mostlyCloudyDay="H",e.partlyCloudyNight="E",e.partlyCloudyDay="H",e.clearNight="C",e.clearDay="B",e.scatteredThunderstorm="O",e.scatteredShowers="Q",e.heavySnow="W",e.thundershowers="O",e.snowShowers="W",e.unknown=")"},setYahooCodes:function(){var e=this.yahooCodes={},t=this.baseCodes;e[0]=t.tornado,e[1]=t.tropicalStorm,e[2]=t.hurricane,e[3]=t.severeThunderstorm,e[4]=t.thunderstorm,e[5]=t.mixedRainAndSnow,e[6]=t.mixedRainAndSnow,e[7]=t.mixedRainAndSnow,e[8]=t.mixedRainAndSnow,e[9]=t.drizzle,e[10]=t.freezingRain,e[11]=t.rain,e[12]=t.rain,e[13]=t.snowFlurries,e[14]=t.snowFlurries,e[15]=t.snowFlurries,e[16]=t.snow,e[17]=t.hail,e[18]=t.sleet,e[19]=t.dust,e[20]=t.foggy,e[21]=t.haze,e[22]=t.smoky,e[23]=t.blustery,e[24]=t.windy,e[25]=t.cold,e[26]=t.cloudy,e[27]=t.mostlyCloudyNight,e[28]=t.mostlyCloudyDay,e[29]=t.partlyCloudyNight,e[30]=t.partlyCloudyDay,e[31]=t.clearNight,e[32]=t.clearDay,e[33]=t.clearNight,e[34]=t.clearDay,e[35]=t.mixedRainAndSnow,e[36]=t.clearDay,e[37]=t.scatteredThunderstorm,e[38]=t.scatteredThunderstorm,e[39]=t.scatteredShowers,e[40]=t.scatteredShowers,e[41]=t.heavySnow,e[42]=t.mixedRainAndSnow,e[43]=t.heavySnow,e[44]=t.partlyCloudyDay,e[45]=t.thundershowers,e[46]=t.snowShowers,e[47]=t.scatteredThunderstorm,e[3200]=t.unknown},show:function(){this.model.updateWeather(!0),this.$popup.addClass("show"),this.updateDetails(),this.updateHourly(),this.open=!0;var e=this;m.widgetManager.unfocusOverlap(this.options.region,this.$popup.height()),setTimeout(function(){e.$popup.addClass("fade-in")},5)},hide:function(e){if(!(0<this.$el.find(".upsell-overlay.active").length)&&this.open){if(e&&27===e.keyCode&&this.$el.hasClass("editing"))return this.$location.html(this.model.get("location").locationName),void this.doneEditingLocation();if(e&&$.contains(this.$el.find(".weather-settings")[0],e.target)||this.dropdownOpen&&this.toggleDropdown(),!e||!$.contains(this.$el[0],e.target)){this.$popup.removeClass("fade-in"),this.open=!1;var t=this;m.widgetManager.refocusOverlap(this.options.region),setTimeout(function(){t.$popup.removeClass("show")},250)}}},togglePopup:function(e){this.$popup.hasClass("show")?this.hide():this.show()},toggleDetails:function(e){if(e&&e.stopPropagation(),this.today)if(m.conditionalFeatures.featureEnabled("plus"))m.models.customization.set("weatherDetail",!m.models.customization.get("weatherDetail"));else{m.commandManager.execute("upsell.message",{targetRegion:"weather",sourceEvent:"weather-detail",buttonText:"Learn more",title:"Weather Details",description:"View wind, chance of rain, and much more!"})}},toggleHourly:function(e){if(e&&e.stopPropagation(),this.today)if(m.conditionalFeatures.featureEnabled("plus"))m.models.customization.set("weatherHourly",!m.models.customization.get("weatherHourly"));else{if($(e.currentTarget).hasClass("weather-current-temp-wrapper"))return;m.commandManager.execute("upsell.message",{targetRegion:"weather",sourceEvent:"weather-hourly",buttonText:"Learn more",title:"Hourly Forecast",description:"See the hour by hour forecast for the day"})}},switchDay:function(e){e.stopPropagation(),this.$el.find(".weather-forecast-day").removeClass("selected");var t=e.currentTarget.dataset.day;t!=this.selectedDayName&&(this.selectedDayName=t,this.today=this.model.get("days")[0].day==t,this.daySelectionActive=!0,$(e.currentTarget).addClass("selected"),this.render())},getLastWeatherLocation:function(){var e=localStorage.getItem("last-weather-location");return e?JSON.parse(e):null},render:function(){if(!this.$location||!this.$location.hasClass("editing")){var e="Set Location",t=this.model.get("location")&&this.model.get("location").locationName,i=this.model.get("location")&&this.model.get("location").locationExact,h=this;this.model.get("firstLoad")&&(t+=", "+this.model.get("location").countryCode,setTimeout(function(){h.model.set("firstLoad",!1)},5e3)),t&&0!=t.length||this.model.get("loading")||(t=e);var o,n,s,a,l,r=[],d=[],c=this.model;this.today&&(s=c.get("now")),c.get("days")&&(this.selectedDayName||(this.selectedDayName=c.get("days")[0].day,this.today=!0),this.today?this.selectedDayName=c.get("days")[0].day:a=this.selectedDayName,c.get("days").forEach(function(e){s||e.day!=h.selectedDayName||(s=e),r.push({high:h.calculateDisplayTemperature(e.high),low:h.calculateDisplayTemperature(e.low),condition:e.condition,icon:h.getIconFromCode(e.code,c.get("provider")),unitClass:h.options.unitClass,dayShort:e.day.substr(0,3),day:e.day})})),c.get("hours")&&c.get("hours").forEach(function(e){l=k(e);var t=e.hour.substr(e.hour.indexOf("T")+1,2);d.push({temperature:h.calculateDisplayTemperature(e.temperature),condition:e.condition,icon:h.getIconFromCode(e.code,c.get("provider")),unitClass:h.options.unitClass,hour:m.models.customization.get("hour12clock")?h.convertTo12H(parseInt(t)):t,precipChance:l.chance,precipType:l.type,windSpeed:h.calculateDisplaySpeed(e.windSpeed),windGust:h.calculateDisplaySpeed(e.windGust)})});var u,g=this.model.get("now");if(g){l=k(g);var p=g.sunset?g.sunset.substr(g.sunset.indexOf("T")+1,5):null,f=g.sunrise?g.sunrise.substr(g.sunrise.indexOf("T")+1,5):null,v=m.models.customization.get("hour12clock"),w=0,b=!0;"Falling"==g.pressureTendency?w=180:"Steady"==g.pressureTendency&&(b=!1),n={condition:g.condition,cloudCover:g.cloudCover,windDirection:g.windDirection+180,windSpeed:h.calculateDisplaySpeed(g.windSpeed),windGust:h.calculateDisplaySpeed(g.windGust),temperature:h.calculateDisplayTemperature(c.get("now").temperature),apparentHigh:h.calculateDisplayTemperature(g.apparentHigh),apparentLow:h.calculateDisplayTemperature(g.apparentLow),apparentTemperature:h.calculateDisplayTemperature(g.apparentTemperature),uvIndex:g.uvIndex,uvIndexText:g.uvIndexText,icon:h.getIconFromCode(g.code,c.get("provider")),humidity:g.humidity,dewPoint:h.calculateDisplayTemperature(g.dewPoint),pressure:h.calculateDisplayPressure(g.pressure),pressureTendency:g.pressureTendency,pressureDirection:w,pressureDirectionVisible:b,high:h.calculateDisplayTemperature(g.high),low:h.calculateDisplayTemperature(g.low),sunset:p?v?h.convertTo12H(p.substr(0,2),p.substr(3,2)):p:null,sunrise:f?v?h.convertTo12H(f.substr(0,2),f.substr(3,2)):f:null,moonPhase:g.moonPhase,precipChance:l.chance,precipType:l.type,precipAmount:h.calculateDisplayLength(g.precipAmount),visibility:h.calculateDisplayLongLength(g.visibility),visibilityText:g.visibilityText,precipitationExpected:h.calculateDisplayLength(s.precipitationExpected),hoursOfSun:Math.round(g.hoursOfSun)}}s==g?u=n:s&&(l=k(s),u={condition:s.condition,cloudCover:s.cloudCover,windDirection:s.windDirection+180,windSpeed:h.calculateDisplaySpeed(s.windSpeed),windGust:h.calculateDisplaySpeed(s.windGust),temperature:h.calculateDisplayTemperature(c.get("now").temperature),apparentHigh:h.calculateDisplayTemperature(s.apparentHigh),apparentLow:h.calculateDisplayTemperature(s.apparentLow),apparentTemperature:h.calculateDisplayTemperature(s.apparentTemperature),uvIndex:s.uvIndex,uvIndexText:s.uvIndexText,icon:h.getIconFromCode(s.code,c.get("provider")),humidity:s.humidity,dewPoint:h.calculateDisplayTemperature(s.dewPoint),pressure:h.calculateDisplayPressure(s.pressure),pressureTendency:s.pressureTendency,pressureDirection:w,pressureDirectionVisible:b,high:h.calculateDisplayTemperature(s.high),low:h.calculateDisplayTemperature(s.low),precipChance:l.chance,precipType:l.type,precipAmount:h.calculateDisplayLength(s.precipAmount),visibility:h.calculateDisplayLongLength(s.visibility),visibilityText:s.visibilityText,precipitationExpected:h.calculateDisplayLength(s.precipitationExpected),hoursOfSun:Math.round(s.hoursOfSun)}),o={location:t,locationExact:i,unit:this.displayUnit(),now:n,selected:u,unitClass:this.options.unitClass,message:this.model.get("error"),days:r,hours:d,plusDetails:0!=this.model.get("providerId"),detailVisible:m.models.customization.get("weatherDetail"),hourlyVisible:m.models.customization.get("weatherHourly"),loading:this.model.get("loading"),today:this.today,displayDay:a};var y=(this.options.order||"prepend")+"To";return this.$el[y]("#"+this.options.region).html(this.template(o)).fadeTo(500,1),this.$location=this.$(".weather-current-location .weather-location-name"),t==e?this.$location.addClass("ready-to-set"):this.$location.removeClass("ready-to-set"),this.renderedOnce=!0,this.$popup=this.$(".widget-pop"),this.open&&this.$popup.addClass("show fade-in"),this.dropdownOpen&&this.toggleDropdown(),this.$el.find(".toggle-metric .toggle-slider").toggleClass("on","c"===this.displayUnit()),this.daySelectionActive&&this.$el.find(".weather-forecast-day[data-day='"+this.selectedDayName+"']").first().addClass("selected"),this.updateDetails(),this.updateHourly(),this.updateCurrentInfo(),this.updateDaily(),this.open&&m.widgetManager.unfocusOverlap(this.options.region,this.$popup.height()),this}function k(e){var t=null==e.high?e.temperature:e.high,i=null==e.low?e.temperature:e.low,o=e.rainProbability,n=e.snowProbability,s=e.iceProbability,a=15<o,l=15<n,r=15<s,d="precip.",c=e.precipitationProbability;return a||l||r?!a||l||r?a||!l||r?a||l||!r||(d="ice",c=s):(d="snow",c=n):(c=o,d="rain"):h.calculateDisplayTemperature(t,!0)<0?(c=n,d="snow"):0<h.calculateDisplayTemperature(i,!0)&&(c=o,d="rain"),{type:d,chance:c}}},setLoading:function(){this.$el.find(".weather-current-location").toggleClass("loading",this.model.get("loading"))},convertTo12H:function(e,t){var i="AM",o=e=parseInt(e);return 12<=o&&(o=e-12,i="PM"),0==o&&(o=12),o+(null==t?"":":"+t)+i},visibleChanged:function(e){m.models.customization.get("weatherVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},calculateDisplayTemperature:function(e,t){var i=this.model.get("fetchUnit"),o=e;return o||0==o?"c"===this.displayUnit()||t?"c"===i?o:Math.round(5*(o-32)/9):"c"===i?Math.round(9*o/5+32):o:null},calculateDisplaySpeed:function(e){var t=this.model.get("fetchUnit");return e||0==e?"mph"===this.displaySpeedUnit()?("c"===t?Math.round(.62137*e):Math.round(e))+" mph":("c"===t?Math.round(e):Math.round(1.60934*e))+" km/h":null},calculateDisplayPressure:function(e){var t=this.model.get("fetchUnit");return e||0==e?"inHg"===this.displayPressureUnit()?("c"===t?Math.round(.02953*e):e)+" inHg":("c"===t?Math.round(e):Math.round(33.8639*e))+" hPa":null},calculateDisplayLength:function(e){var t=this.model.get("fetchUnit");return e||0==e?"in"===this.displayLengthUnit()?("c"===t?Math.round(.03937*e):e)+" in":("c"===t?Math.round(e):Math.round(25.4*e))+"mm":null},calculateDisplayLongLength:function(e){var t=this.model.get("fetchUnit");return e||0==e?"in"===this.displayLengthUnit()?("c"===t?Math.round(.62137*e):Math.round(e))+" mi":("c"===t?Math.round(e):Math.round(1.60934*e))+" km":null},displayPressureUnit:function(){return"f"==this.displayUnit()?"inHg":"kPa"},displaySpeedUnit:function(){return"f"==this.displayUnit()?"mph":"km/h"},displayLengthUnit:function(){return"f"==this.displayUnit()?"in":"mm"},displayLongLengthUnit:function(){return"f"==this.displayUnit()?"mi":"km"},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e||(this.defaultUnit?this.defaultUnit:"c")},setLocation:function(){this.$location.html(""),this.editLocation()},editLocation:function(){this.dropdownOpen&&this.toggleDropdown(),this.$el.hasClass("editing")||(this.$el.addClass("editing"),this.$location.html()==this.loadingMessage&&this.$location.html(""),this.$location.attr("contenteditable",!0).addClass("editing pulse"),this.selectElementContents(this.$location[0]),this.$location.parent().addClass("editing"))},selectElementContents:function(e){var t=document.createRange();t.selectNodeContents(e);var i=window.getSelection();i.removeAllRanges(),i.addRange(t)},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$location.removeClass("pulse")},onKeypress:function(e){13===e.keyCode&&(e.preventDefault(),this.saveLocation())},resetLocation:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.doneEditingLocation(),localStorage.removeItem("weather-manual"),this.model.set({error:null,firstLoad:!1}),this.model.set({location:null},{silent:!0}),this.model.trigger("change:location");var t=this;setTimeout(function(){t.$el.find(".weather-location-name").html(t.loadingMessage)},50)},saveLocation:function(){if(this.$el.hasClass("editing")){this.doneEditingLocation();var e=this.$location.text().trim();if(this.model.get("location")&&this.model.get("location").locationName&&this.model.get("location").locationName.toLowerCase()==e.toLowerCase())return this.doneEditingLocation(),!0;e&&0<e.length?this.model.getManualLocation(e):this.resetLocation()}},doneEditingLocation:function(){this.$el.removeClass("editing"),this.$location.parent().removeClass("editing"),this.$location.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},toggleUnit:function(e){e&&e.stopPropagation(),this.options.unitClass="","c"===this.displayUnit()?m.models.customization.save("temperatureUnit","f"):m.models.customization.save("temperatureUnit","c")},setUnit:function(e){this.defaultUnit=0<=["US","BM","BZ","JM","PW"].indexOf(e)?"f":"c"},getIconFromCode:function(e,t){return"yahoo"!=t&&t?this.baseCodes[e]:this.yahooCodes[e]},toggleDropdown:function(){var e=this.$el.find(".weather-settings");e.toggleClass("active"),this.dropdownOpen=e.hasClass("active")},showUpsell:function(e){if(this.upsellView)this.upsellView.options=e,this.upsellView.render();else{e.template=m.templates.weather.upsell,this.upsellView=new m.views.upsell.message(e);var t=this.upsellView.render().$el;this.$el.find(".weather-pane").append(t)}this.upsellView.show()}}),m.bootstrappers.RenderWeather=function(t,e){t.conditionalFeatures.checkPreferenceForRender("weatherVisible",function(){t.models.customization.get("weatherVisible")&&(t.models.weather=new t.models.Weather,t.views.weather=new t.views.Weather({model:t.models.weather,region:"top-right",order:"prepend"}),t.widgets.push(t.views.weather),t.stopListening(t.models.customization,"change:weatherVisible"))},function(e){t.listenTo(t.models.customization,"change:weatherVisible",e)})},m.models.Weather=Backbone.Model.extend({defaults:{location:{},now:{},fetchUnit:"c"},initialize:function(){var e,t=this,i=localStorage.getItem("manual-weather-location");(i=JSON.parse(i))&&(this.findPositionByYahooLocationId(i.woeid),e={enteredLocation:i.enteredLocation,locationId:i.woeid,latitude:1,longitude:1,locationName:i.location_name},localStorage.setItem("weather-manual",JSON.stringify(e)),localStorage.removeItem("manual-weather-location"));var o=localStorage.getItem("momentum-weather-1");o=JSON.parse(o);var n=localStorage.getItem("last-weather-location");if(n=JSON.parse(n),o){var s;s=e?{locationId:e.locationId,locationName:e.locationName,latitude:e.latitude,longitude:e.longitude,countryCode:localStorage.getItem("country")}:{locationId:o.woeid,locationName:o.location,latitude:n.latitude,longitude:n.longitude,countryCode:localStorage.getItem("country")};var a={temperature:o.fetchTemperature,condition:o.location,code:o.code};localStorage.setItem("weather",JSON.stringify({location:s,now:a,fetchUnit:o.fetchUnit,providerId:0,provider:"yahoo"})),localStorage.removeItem("momentum-weather-1"),localStorage.removeItem("momentum-weather"),localStorage.removeItem("last-weather-location")}this.loadFromLocalStorage(),(this.get("firstLoad")||this.get("loading"))&&(this.set({firstLoad:!1,loading:!1}),this.store()),setInterval(function(){t.updateWeather()},6e5);var l=this.getSavedManualWeatherLocation();setInterval(function(){t.getSavedManualWeatherLocation()||t.updateCoords()},6e6),this.listenTo(this,"change:providerId",function(){t.store(),t.get("location").locationId=null,t.set({updatedForecast:null,updated:null}),t.store(),t.trigger("change:location")}),this.listenTo(this,"change:location",function(){var e=t.get("location");e&&e.countryCode&&localStorage.setItem("country",e.countryCode),t.updateWeather(!0)}),m.conditionalFeatures.featureEnabled("weatherapi")?this.set("providerId",1):this.set("providerId",0),setTimeout(function(){t.updateWeather(),l||t.updateCoords()},100),window.addEventListener("focus",function(e){t.missedUpdate&&t.updateWeather()})},updateCoords:function(){var t=this;this.getCoordinates(function(e){e.changed&&(t.get("location")||t.set("location",{}),t.get("location").latitude=e.latitude,t.get("location").longitude=e.longitude,t.get("location").locationId=null,t.set({updatedForecast:null,updated:null,error:null}),t.updateWeather())})},store:function(){localStorage.setItem("weather",JSON.stringify(this.attributes))},loadFromLocalStorage:function(){var e=localStorage.getItem("weather");e&&(this.attributes=JSON.parse(e))},updateWeather:function(t,e){if(this.missedUpdate=!document.hasFocus(),!this.missedUpdate){var i=this,o=(new Date).getTime();if(this.get("location")&&this.get("location").latitude){if((!(t&&o-this.get("updatedForecast")<18e5)||e)&&(t||!(o-this.get("updated")<6e5)||e)){var n,s=this.get("location");if(n=t?"forecast":"current",0==this.get("providerId"))this.collectFromYahoo();else{if(this.url=m.globals.urlRoot+"weather/"+n+"?",s.locationId&&0<s.locationId.length)this.url+="locationId="+s.locationId;else{if(1==s.latitude&&1==s.longitude)return void this.updateCoords();this.url+="lat="+s.latitude+"&lon="+s.longitude}this.set("loading",!0),this.fetch({error:function(){i.set("loading",!1)},success:function(){if(t)i.set({loading:!1,updated:o,updatedForecast:o});else{var e=JSON.parse(JSON.stringify(i.attributes));i.loadFromLocalStorage(),Object.assign(i.get("now"),e.now),Object.assign(i.get("location"),e.location),i.set({provider:e.provider,fetchUnit:e.fetchUnit,loading:!1,updated:o})}i.trigger("change:now"),i.trigger("change:loading"),i.store()}})}}}else this.updateCoords()}},findPositionByYahooLocationId:function(e){var n=this,t="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+e+' and u="f"')+"&format=json";$.getJSON(t,function(e){if(e&&e.query&&1==e.query.count){var t=e.query.results.channel.item,i=n.getSavedManualWeatherLocation();i.latitude=t.lat,i.longitude=t.long;var o=n.get("location");o.latitude=t.lat,o.longitude=t.long,o.locationId=null,n.updateWeather(!1,!0)}})},collectFromYahoo:function(){if(this.get("location").locationId){var a=this,l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.set("loading",!0);var e="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+this.get("location").locationId+' and u="f"')+"&format=json";$.getJSON(e,function(e){if(a.set("loading",!1),e&&e.query&&1==e.query.count){var t=e.query.results.channel.item.condition,i=[],o=0;if(e.query.results.channel.item.forecast.forEach(function(e){var t=new Date;t.setDate(t.getDate()+o),++o<6&&i.push({high:e.high,low:e.low,code:e.code,condition:e.text,day:l[t.getDay()],error:null})}),t){var n={high:i[0].high,low:i[0].low,temperature:t.temp,code:t.code,condition:t.text},s=e.query.results.channel.units;a.set({fetchUnit:s.temperature.toLowerCase(),updated:(new Date).getTime(),updatedForecast:(new Date).getTime(),error:null,now:n,days:i,provider:"yahoo",providerId:0}),a.store()}}}).fail(function(e){a.set("loading",!1),console.log("Error getting weather data: "+e)})}else this.getLocationFromYahoo("("+this.get("location").latitude+","+this.get("location").longitude+")")},getManualLocation:function(e){var t=this;0==this.get("providerId")?this.getLocationFromYahoo(e,!0):(this.url=m.globals.urlRoot+"weather/location?location="+e,this.set("loading",!0),this.fetch({error:function(){t.set({loading:!1,error:e+" not found"}),setTimeout(function(){t.set({error:null})},5e3)},success:function(){t.set({loading:!1,error:null});var e=JSON.parse(JSON.stringify(t.attributes.location));t.loadFromLocalStorage(),t.foundLocation(e,!0)}}))},getLocationFromYahoo:function(e,o){this.set("loading",!0);var n=this,t="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(e)+"%22&format=json";function s(e){var t={yahooLocationId:e.woeid};return e.locality1&&e.locality1.content?t.city=e.locality1.content:t.city=e.name,e.country&&(t.countryCode=e.country.code),t.latitude=e.centroid.latitude,t.longitude=e.centroid.longitude,t}$.getJSON(t,function(e){n.set("loading",!1);var t=e.query.count,i=null;1<t?i=s(e.query.results.place[0]):1==t?e.query.results.place&&(i=s(e.query.results.place)):n.set("error","not found"),i&&n.foundLocation({locationName:i.city,latitude:o?i.latitude:n.get("location").latitude,longitude:o?i.longitude:n.get("location").longitude,countryCode:i.countryCode,locationId:i.yahooLocationId},o)}).fail(function(e){console.log("Error getting yahooLocationId"),n.set("loading",!1)})},foundLocation:function(e,t){t&&localStorage.setItem("weather-manual",JSON.stringify(e)),this.set({location:e,updated:null,updatedForecast:null,error:null,manual:1==t,firstLoad:1==t,loading:!1}),this.store(),e.countryCode&&(localStorage.country=e.countryCode)},getSavedManualWeatherLocation:function(){var e=localStorage.getItem("weather-manual");return e?JSON.parse(e):null},getCoordinates:function(i){var o=this;function t(e){if(o.waitingForLocation){o.waitingForLocation=!1,o.set("loading",!1),o.trigger("change:loading"),e&&console.log("Error getting location: "+e.code+", msg: "+e.message);var t=o.getSavedManualWeatherLocation();t?i({latitude:t.latitude,longitude:t.longitude,changed:!1}):o.lastPosition&&(o.lastPosition.changed=n(o.lastPosition),i(o.lastPosition)),o.set("error","")}}function n(e){var t=!0,i=o.get("location");return i&&(+i.latitude).toFixed(2)==(+e.latitude).toFixed(2)&&(+i.longitude).toFixed(2)==(+e.longitude).toFixed(2)&&(t=!1),t}this.get("location")&&this.get("location").latitude||(this.set("loading",!0),this.trigger("change:loading")),this.waitingForLocation=!0,navigator.geolocation.getCurrentPosition(function(e){o.lastPosition={latitude:e.coords.latitude,longitude:e.coords.longitude,changed:n(e.coords)},o.waitingForLocation=!1,o.set("loading",!1),o.trigger("change:loading");try{i(o.lastPosition)}catch(e){console.log(e),t(e)}},t),setTimeout(function(){t()},8e3)}}),m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",priority:5,views:0,viewLimit:3,deleted:!1,createdDate:Date.now(),visible:!1,loginOnClick:!1,fromServer:!1}},showMessage:function(e,t,i,o){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:o})},showMessageNow:function(e,t,i,o){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:o})},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t||(t={}),e||(e=_.clone(this.attributes)),e.hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i||(i=this.get("changed_props")||[]),_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){if(!this.cleaned){this.cleaned=!0;var i=[];this.each(function(e){if(e.get("deleted"))e.get("fromServer")&&e.get("sync_success")&&!e.get("changed_props")&&i.push(e);else{var t=e.get("filter");t&&m.conditionalFeatures.featureEnabled(t)?e.save({deleted:!0,filtered:!0}):5==e.get("priority")?e.get("fromServer")?e.save({deleted:!0}):i.push(e):e.get("visible")||e.save({deleted:!0})}}),0<i.length&&_.each(i,function(e){e.destroy()})}}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){if(!t.ignoreSave){var i=e.changedAttributes();i&&i.hasOwnProperty("changed_props")&&i.changed_props&&this.syncToServer()}},syncToServer:function(e){var s=this,t=this.findHavingAttribute(this.collection,"changed_props");t&&0!=t.length?nimble.each(t,function(i,e){if(i.get("fromServer")){var t=i.get("changed_props");if(t&&0!=t.length){var o={};if(_.each(t,function(e){"changed_props"!=e&&"sync_success"!=e&&(o[e]=i.get(e))}),1==Object.keys(o).length&&o.hasOwnProperty("views"))e();else{var n=s.baseUrl+"/"+encodeURIComponent(i.id);$.ajax({url:n,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(e){e&&e.success&&i.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(e,t){i.save({sync_success:!1},{silent:!0})}).always(function(){e()})}}else e()}},function(){e&&e()}):e&&e()}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,_parent:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var i=this;if(this.collection.cleanupMessagesIfRequired(),this._parent&&this.backgroundLoaded&&!this.settingsVisible){var e=this.notificationView();if(e&&!e.notifying){var t=_.chain(this.collection.where({deleted:!1,visible:!0})).reject(function(e){var t=e.get("filter");return!(!t||!m.conditionalFeatures.featureEnabled(t))||_.contains(i.displayed,e)}).sortBy("priority").sortBy("createdDate").value();if(t&&0!=t.length){var o=t[0];this.displayed.push(o),e.showMessage(o)}}}},setParent:function(e){e&&(this._parent=e,this.displayPendingMessages())},onAvailableTimestamp:function(e){if(e){var t=localStorage.getItem("ts_notifications");(!t||t<e)&&this.downloadNotifications()}},downloadNotifications:function(){var t=this,e=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";e&&(e=parseInt(e,10),Number.isInteger(e)&&(i=i+"?ts="+e));try{$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){e&&e.timestamp&&(e.notifications&&0<e.notifications.length&&(t.collection.reset(e.notifications),t.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",e.timestamp))}).fail(function(e,t){})}catch(e){}},showMessage:function(e,t,i,o){var n={title:e,message:t,visible:!0};null!=i&&(n.viewLimit=i),null!=o&&(n.loginOnClick=o),this.collection.create(n)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var o={};t&&(o.success=t),i&&(o.silent=!0),this.collection.create(e,o)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification({_parent:this._parent})),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{class:"notification-container"},template:m.templates.notification.notification,notifying:!1,timeoutId:null,events:{"click .hide":"hideNotificationClicked","click .notification-button":"ctaButtonClicked","click .secondary-text":"secondaryTextClicked"},initialize:function(e){this._parent=e._parent,this.renderedOnce=!1,this.listenTo(m,"settings:visible",this.settingsVisible)},showMessage:function(e){this.model&&this.model.cid==e.cid||(this.model=e,this.render())},render:function(){var e=this;this.notifying=!0,this.incrementViews(),this.renderedOnce?this.$el.fadeTo(0,0).html(this.template(this.model.toJSON())).fadeTo(500,1):(e.$el.html(e.template(e.model.toJSON())).fadeTo(500,1),this._parent.$el.append(e.$el),this.$message=this.$(".notification-description"),this.renderedOnce=!0),this.model.has("message_html")&&this.$message.html(this.model.get("message_html"));var t=this.model.get("display_time");!t||null==t||void 0===t||t<=0||(this.timeoutId=setTimeout(function(){e.hideNotification()},t))},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0})},settingsVisible:function(){this.hideNotification(!0,!0)},hideNotificationClicked:function(e){e.stopPropagation(),this.hideNotification(),this.model.save({dismissed:!0,visible:!1},{silent:!0})},hideNotification:function(e,t){var i=this;if(clearTimeout(this.timeoutId),this.notifying){var o=t?0:500;this.notifying=!1,this.$el.fadeTo(o,0,function(){i.$el.hide(),e||setTimeout(function(){m.models.notificationManager.displayPendingMessages()},500)})}},ctaButtonClicked:function(e){e.stopPropagation(),this.hideNotification(!0,!0),this.notifying=!1;var t=this.model.get("cta_cmd"),i=this.model.get("cta_options");t&&0<t.length&&(this.model.save({ctaClicked:Date.now(),visible:!1},{silent:!0}),m.commandManager.execute(t,null,i))},secondaryTextClicked:function(e){e.stopPropagation(),this.model.get("secondary_hide")&&(this.hideNotification(!0,!0),this.notifying=!1);var t=this.model.get("secondary_cmd"),i=this.model.get("secondary_options");t&&0<t.length&&(this.model.save({secondaryClicked:Date.now()},{silent:!0}),m.commandManager.execute(t,null,i))}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.views.BookmarksPrimer=Backbone.View.extend({template:m.templates.bookmarks.primer,attributes:{class:"overlay overlay-permissions"},events:{"click a":"handleClick"},initialize:function(e){this.callback=e.callback,this.permissions=e.permissions},render:function(){var t=m.models.bookmarksSettings;this.browser=getBrowserName(),this.$el.html(this.template(this));var i=$("body");i.addClass("blur"),this.$el.remove(),this.$el.appendTo("body").addClass("show");var o=this;return setTimeout(function(){o.$el.addClass("show-animate")},2),getBrowser().permissions.request(o.permissions,function(e){i.removeClass("blur"),o.$el.removeClass("show-animate"),setTimeout(function(){o.$el.removeClass("show")},500),e?(t.set("allowed",!0),o.callback()):(t.set("allowed",!1),t.optionsChanged())}),this}}),m.views.Bookmarks=Backbone.View.extend({attributes:{id:"bookmarks",class:"bookmarks top-widget"},template:m.templates.bookmarks.bookmarks,offline:!0,initialFetchStarted:!1,events:{mousedown:"mouseDown","mousedown .bookmarks-guide":"guided"},initialize:function(e){this.time=(new Date).getTime(),this.listToggle=!0,this.bookmarkViews=[],this.permissions=m.models.bookmarksSettings.permissions,this.renderedOnce=!1,this.mostVisited=[],e.lateInit?this.render("late"):e.tempInit?this.render("late",!0):this.render();var t=this;this.listenTo(m.models.customization,"change:bookmarksVisible",this.visibleChanged),this.listenTo(m.models.bookmarksSettings,"change",this.optionsChanged),this.listenTo(m,"bookmarks:toggle",this.handleHotKey);var i=$(window);i.on("mouseup",function(e){t.mouseUp(e)}),i.on("mousemove",function(e){t.mouseMove(e)})},render:function(e,t){var i=(this.options.order||"append")+"To";this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.$el[i]("#"+this.options.region).html(this.template());var o=this;return(t||m.models.customization.get("bookmarksVisible"))&&(null==getBrowser().topSites?(m.models.customization.save("bookmarksVisible",!1),localStorage.setItem("bookmarksEnabled",!1)):e&&"late"==e?(o.$el.addClass("animating"),this.showPopup(!0,!0)):($("body").addClass("has-bookmarks"),this.showPopup(!0,!1),setTimeout(function(){o.$el.addClass("animating")},500))),this.renderedOnce=!0,this},destroy:function(){this.remove(),this.unbind()},optionsChanged:function(e){this.resetView=!0,e&&null!=e.changed.defaultMostVisited&&this.doFetchIfNeeded()},visibleChanged:function(e){this.toggleShow(m.models.customization.get("bookmarksVisible"))},doFetchIfNeeded:function(){this.initialFetchStarted?this.resetView&&(this.resetView=!1,this.loadBookmarks(0,!0,!0)):this.doFetch()},doFetch:function(){this.initialFetchStarted=!0,this.bookmarkViews&&_.each(this.bookmarkViews,function(e){e&&e.destroy()}),this.bookmarkViews=[];this.bookmarksAccess=!0,this.getBookmarks()},getBookmarks:function(e){this.loaded=!1,this.loadBookmarks(0,!0,!0,e)},guided:function(){this.$el.find(".bookmarks-guide").removeClass("active")},loadBookmarks:function(i,o,n,e){var s=this,a=function(e){s.bookmarks=e[0].children[0].children,s.otherBookmarks=e[0].children[1].children};if(!this.bookmarks||o){s.mostVisited.length=0;var t=localStorage.getItem("bookmarks_mostVisited");null!=t&&0<t.length&&s.mostVisited.push.apply(s.mostVisited,JSON.parse(t));var l=localStorage.getItem("bookmarks_tree");null!=l&&0<l.length&&(a(JSON.parse(l)),s.showChildren(i,o,n)),getBrowser().topSites.get(function(e){var t=JSON.stringify(e);t!=localStorage.getItem("bookmarks_mostVisited")&&(s.mostVisited.length=0,s.mostVisited.push.apply(s.mostVisited,e),localStorage.setItem("bookmarks_mostVisited",t))}),getBrowser().bookmarks.getTree(function(e){var t=JSON.stringify(e);t!=localStorage.getItem("bookmarks_tree")&&(localStorage.setItem("bookmarks_tree",t),a(e),s.showChildren(i,o,n))})}else s.showChildren(i,!1,n)},getNewList:function(e){var t;(new Date).getTime();return this.listToggle=!this.listToggle,this.listToggle?(this.currentList=t=this.$el.find("#active-bookmarks"),this.oldList=this.$el.find("#active-bookmarks-alt")):(this.currentList=t=this.$el.find("#active-bookmarks-alt"),this.oldList=this.$el.find("#active-bookmarks")),t.html(""),t.css({"z-index":100,left:e+"px",opacity:1}),t},listLoaded:function(e){var t=this;this.oldList.addClass("bookmarks-hide-transition"),setTimeout(function(){t.oldList.css({"z-index":90,opacity:0}),t.currentList.css({transform:"translateX("+-1*e+"px)"})},5),setTimeout(function(){t.oldList.removeClass("bookmarks-hide-transition"),t.oldList.css({transform:"none"})},105),setTimeout(function(){var i=0;t.currentList.children().each(function(e,t){i+=$(t).width()}),i>t.$el.find(".bookmarks-wrapper").width()&&!m.models.bookmarksSettings.get("guided")&&setTimeout(function(){t.$el.find(".bookmarks-guide").addClass("active"),m.models.bookmarksSettings.set("guided",!0),m.models.bookmarksSettings.optionsChanged()},5)},400)},showChildren:function(e,t,i){var o=this,n=this.getNewList(e);if(!o.loaded||t){o.bookmarkViews=[];var s=o.addFolder({title:"Most Visited",momo_id:"mostVisited",children:o.mostVisited});if(m.models.bookmarksSettings.get("defaultMostVisited")&&i)return s.handleClick(null,!0),void(o.loaded=!1);isChrome()&&(o.addOne({url:"chrome-search://local-ntp/local-ntp.html",local:!0,title:"Chrome Tab",momo_id:"chromeTab",img:"img/icon-chrome.svg"}),o.addOne({url:"chrome://apps",local:!0,title:"Apps",momo_id:"apps"}),o.addOne({url:"chrome://bookmarks",local:!0,title:"Bookmarks",momo_id:"bookmarks"})),o.bookmarks.forEach(function(e){e.children?o.addFolder(e):o.addOne(e)}),o.addFolder({title:"Other",momo_id:"other",children:o.otherBookmarks}),o.loaded=!0}setTimeout(function(){o.bookmarkViews.forEach(function(e){n.append(e.render().$el),e.delegateEvents()})},1),o.listLoaded(e)},showAdd:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("#bookmarks-new-title").val(""),this.$el.find("#bookmarks-new-url").val(""),this.$el.find(".add").addClass("active"),this.$el.find(".bookmarks-new").toggle().find("#bookmarks-new-title").focus()},inputsClicked:function(e){e.stopPropagation()},addOne:function(e){var t=new m.views.Bookmark({model:new m.models.Bookmark(e),parent:this,bookmarksView:this});this.bookmarkViews.push(t)},addFolder:function(e){var t=new m.views.BookmarkFolder({model:new m.models.BookmarkFolder(e),parent:this,bookmarksView:this,root:this,zIndex:21});return this.bookmarkViews.push(t),t},toggleShow:function(e){0==e||!e&&this.$el.hasClass("show")?this.hidePopup():this.showPopup(!0,!0),setTimeout(function(){m.trigger("todolist:updateHeight")},20)},showPopup:function(e,t){this.showing=!0;var i=$("body");t&&i.addClass("has-bookmarks-animating");var o=this;setTimeout(function(){o.$el.addClass("show"),i.addClass("has-bookmarks"),setTimeout(function(){i.removeClass("has-bookmarks-animating")},500)},3),e&&this.doFetchIfNeeded()},hidePopup:function(e){if(this.showing=!1,this.$el.hasClass("show")){var t=this,i=$("body");i.addClass("has-bookmarks-animating"),setTimeout(function(){t.$el.removeClass("show"),i.removeClass("has-bookmarks"),setTimeout(function(){i.removeClass("has-bookmarks-animating")},500)},3)}},mouseUp:function(e){if(!this.isDragging(e))return this.dragStarted=!1,void(this.dragging=!1);e.preventDefault(),e.stopPropagation();var t=this;setTimeout(function(){t.dragging=!1,t.dragStarted=!1},20)},mouseDown:function(e){var t=this.currentList;this.lastMouseX=e.originalEvent.pageX,this.originalScroll=t.scrollLeft(),this.dragStarted=!0},mouseMove:function(e){if(this.dragStarted){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),this.dragging=!0;var t=this.currentList,i=this.originalScroll+(this.lastMouseX-e.originalEvent.pageX);t.scrollLeft(i)}else this.dragging=!1},isDragging:function(e){return this.dragging&&10<Math.abs(this.lastMouseX-e.originalEvent.pageX)},handleHotKey:function(){var t=this;getBrowser().permissions.contains(this.permissions,function(e){e&&t.toggleShow(!t.showing)})}}),m.bootstrappers.RenderBookmarks=function(i,e){i.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","bookmarksVisible","momentum-bookmarks",function(e){if(i.stopListening(i.models.customization,"change:bookmarksVisible"),!i.views.bookmarks&&i.models.customization.get("bookmarksVisible")){var t={region:"top-bar",order:"prepend"};e&&(t.lateInit=!0),i.collect.quicklinks=new i.collect.QuickLinks,i.views.bookmarks=new i.views.Bookmarks(t),i.widgets.push(i.views.bookmarks)}},function(e){if(i.stopListening(i.models.customization,"change:bookmarksVisible"),!i.views.bookmarks){var t={region:"top-bar",order:"prepend"};e&&(t.lateInit=!0),i.collect.quicklinks=new i.collect.QuickLinks,i.views.bookmarks=new i.views.Bookmarks(t),i.widgets.push(i.views.bookmarks)}},function(e){i.listenToOnce(i,"bookmarks:toggle",function(){i.stopListening(i.models.customization,"change:bookmarksVisible"),i.views.bookmarks||(i.views.bookmarks=new i.views.Bookmarks({region:"top-bar",order:"prepend",tempInit:!0}),i.widgets.push(i.views.bookmarks))}),i.listenTo(i.models.customization,"change:bookmarksVisible",e)})},m.views.Bookmark=Backbone.View.extend({tagName:"li",template:m.templates.bookmarks.bookmark,events:{"click a":"handleClick"},destroy:function(){this.remove(),this.unbind()},initialize:function(e){var t=this;this.parent=e.parent,this.bookmarksView=e.bookmarksView,setTimeout(function(){t.listenTo(t.model,"change",t.render),t.listenTo(t.model,"change:archive destroy",t.remove),t.listenTo(m.models.bookmarksSettings,"change:iconsOnly",t.render),t.listenTo(m.models.bookmarksSettings,"change:appsLocation",t.checkInclusion),t.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",t.checkInclusion),t.listenTo(m.models.bookmarksSettings,"change:includeBookmarks",t.checkInclusion)},1)},checkInclusion:function(){var e=m.models.bookmarksSettings;"apps"==this.model.get("momo_id")?this.$el.toggleClass("hidden","bookmarks"!=e.get("appsLocation")):"chromeTab"==this.model.get("momo_id")?this.$el.toggleClass("hidden","bookmarks"!=e.get("chromeTabLocation")):"bookmarks"==this.model.get("momo_id")&&this.$el.toggleClass("hidden",!e.get("includeBookmarks"))},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=t;m.models.bookmarksSettings.get("iconsOnly")&&(i="");var o=this.model.get("url"),n=this.model.get("local"),s=new Image;this.model.get("img")?(s.src=this.model.get("img"),this.model.get("class")&&this.$el.addClass(this.model.get("class"))):isChrome()?s.src="chrome://favicon/size/16@2x/"+o:s.src=getFavIcon(o);var a={tooltip:t,title:i,url:o,local:n};return e.$el.html(e.template(a)),s.onload=function(){a.favicon_url=s.src,e.$el.html(e.template(a))},this.checkInclusion(),e},handleClick:function(e){return e.preventDefault(),this.bookmarksView.isDragging(e)||(m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:e.currentTarget.href}):getBrowser().tabs.update({url:e.currentTarget.href})),!1},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.views.BookmarkFolder=Backbone.View.extend({tagName:"li",template:m.templates.bookmarks.bookmarkfolder,events:{"keypress .todo-input":"updateOnEnter"},destroy:function(){this.remove(),this.unbind()},initialize:function(e){var t=this;this.bookmarkViews=[],this.parent=e.parent,this.bookmarksView=e.bookmarksView,this.root=e.root,this.zIndex=e.zIndex,this.parentFolder=e.parentFolder,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove),this.mainClickHandler=function(e){t.handleClick(e)},this.backClickHandler=function(e){t.handleBack(e)},this.listenTo(m.models.bookmarksSettings,"change:iconsOnly",this.render),this.listenTo(m.models.bookmarksSettings,"change:includeMostVisited",this.checkInclusion),this.listenTo(m.models.bookmarksSettings,"change:includeOtherBookmarks",this.checkInclusion)},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=t,o=i.substring(0,1);m.models.bookmarksSettings.get("iconsOnly")&&(i=""),this.$el.css({zIndex:this.zIndex});var n={tooltip:t,title:i,label:o};return e.$el.html(e.template(n)),$(e.$el.find(".main-button")[0]).on("mouseup",e.mainClickHandler),this.checkInclusion(),e},checkInclusion:function(){var e=m.models.bookmarksSettings;"mostVisited"==this.model.get("momo_id")?this.$el.toggleClass("hidden",!e.get("includeMostVisited")):"other"==this.model.get("momo_id")&&this.$el.toggleClass("hidden",!e.get("includeOtherBookmarks"))},addFolder:function(e){var t=new m.views.BookmarkFolder({model:new m.models.BookmarkFolder(e),parent:this,bookmarksView:this.bookmarksView,root:this.root,zIndex:this.zIndex+1});this.bookmarkViews.push(t)},addOne:function(e){var t=new m.views.Bookmark({model:new m.models.Bookmark(e),bookmarksView:this.bookmarksView,parent:this});this.bookmarkViews.push(t)},handleBack:function(e){if(!this.isOpen)return!0;e.preventDefault(),e.stopPropagation(),this.isOpen=!1;return this.parent.loadBookmarks(-1*this.offset),!1},handleClick:function(e,t){if(this.isOpen||this.bookmarksView.isDragging(e))return!0;e&&2==e.which?this.model.get("children").forEach(function(e){e.url&&getBrowser().tabs.create({url:e.url,active:!1})}):(this.isOpen=!0,$(this.$el.find(".main-button")[0]).off("click",this.mainClickHandler),this.offset=this.$el.offset().left,this.loadBookmarks(t?0:this.offset))},loadBookmarks:function(e){var t=this;this.loaded||(this.bookmarkViews=[],this.model.get("children").forEach(function(e){e.children?t.addFolder(e):t.addOne(e)}),this.loaded=!0);var i=this.bookmarksView.getNewList(e);setTimeout(function(){i.append('<li><a href="#" class="bookmark bookmark-back-button active"><i class="icon icon-left"></i><span class="bookmark-label">'+t.model.get("title")+'</span>\x3c!--<span class="bookmark-icon bookmark-icon-hide">✕</span>--\x3e</a></li>'),$(".bookmark-back-button").on("click",t.backClickHandler),t.bookmarkViews.forEach(function(e){i.append(e.render().$el)}),t.bookmarksView.listLoaded(e)},5)}}),m.models.Bookmark=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",id:0,parentId:0,index:0,local:!1}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({index:e},this.saveOptions())},comparator:"index"}),m.models.BookmarkFolder=Backbone.Model.extend({defaults:function(){return{title:"New Folder",id:0,parentId:0,children:[],index:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({index:e},this.saveOptions())},comparator:"index"}),m.models.QuickLinks=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",local:!1,order:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({order:e},this.saveOptions())},comparator:"order"}),m.collect.QuickLinksBase=Backbone.Collection.extend({model:m.models.QuickLinks,initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},saveOptions:{},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",reorderItem:function(e){}}),m.collect.QuickLinks=m.collect.QuickLinksBase.extend({url:m.globals.urlRoot+"links",saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"links"}).done(function(e){}).fail(function(e,t){})}}),m.collect.QuickLinksLegacy=m.collect.QuickLinksBase.extend({localStorage:new Backbone.LocalStorage("momentum-quicklinks"),isLegacy:!0,fetch:function(e){return Backbone.Collection.prototype.fetch.call(this,e)},createOrderGaps:function(){var t=100;this.each(function(e){e.save({order:t},{silent:!0}),t+=100})},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),o=0<e.move_offset?1:-1,n=this.indexOf(i),s=1;if(0<=n+o&&n+o<this.length){var a=this.at(n+o);(s=Math.abs(a.get("order")-i.get("order")))<=20&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*o;t.save({order:l},{silent:!0})}}),m.views.QuickLinks=Backbone.View.extend({attributes:{id:"quicklinks",class:"quicklinks top-widget"},template:m.templates.quicklinks["quicklinks-template"],offline:!0,initialFetchStarted:!1,events:{"click .quicklinks-show":"toggleShow","click a":"handleClick","keypress #quicklinks-new-title":"createLink","keypress #quicklinks-new-url":"createLink","click .quicklinks-new-toggle":"showAdd","click .quicklinks-new-hide":"hideAdd","click .hide":"hideUsageHint","click .retry":"retryConnection","click .retry-add":"retryAdd","click .quicklinks-new":"inputsClicked",dragover:"dragover",dragend:"dragend",drop:"drop"},initialize:function(){this.subViews=[],_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.renderedOnce=!1,this.render(),this.listenTo(m,"globalEvent:click globalEvent:esc",this.hidePopup),this.listenTo(m,"globalEvent:toggleQuickLinks",this.toggleShow),this.listenTo(this.collection,"remove",this.checkOptionalLinks),this.listenTo(this.collection,"add",this.added),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:linksVisible",this.visibleChanged),this.listenTo(m.models.bookmarksSettings,"change:linksKeepOpen",this.keepOpenChanged),this.listenTo(m.models.bookmarksSettings,"change:appsLocation",this.checkOptionalLinks),this.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",this.checkOptionalLinks),(this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchlinks"))&&this.doFetchIfNeeded(),m.models.bookmarksSettings.get("linksKeepOpen")&&"false"!=localStorage.getItem("linksOpen")&&this.toggleShow();var t=this;null!=getBrowser().topSites?$.ajax({url:"chrome://favicon/size/16@2x/http://notfoundurl.com"}).done(function(e){t.notFoundIcon=e}):this.notFoundIcon=""},checkOptionalLinks:function(){var i=this;this.$el.find("li").removeClass("first-link"),this.$el.find(".optional-link").each(function(e,t){i.checkInclusion(t)}),this.$el.find(".optional-link.show").first().addClass("first-link"),0==this.$el.find(".first-link").length&&this.$el.find("li").not(".optional-link").first().addClass("first-link"),i.checkEmpty()},checkEmpty:function(){this.$el.find(".links-empty").toggleClass("active",0==this.$el.find(".optional-link.show").length&&0==this.collection.size())},checkInclusion:function(e){var t=m.models.bookmarksSettings,i=$(e);i.toggleClass("show",t.get(i.attr("data-momo-id")+"Location")==i.attr("data-place"))},render:function(){var e=(this.options.order||"append")+"To";this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.isChrome=isChrome(),this.$el[e]("#"+this.options.region).html(this.template(this)).fadeTo(500,1),this.$connectionmessage=this.$el.find(".connection-message"),this.$connectionmessage.show(),this.renderedOnce=!0;return this},destroy:function(){this.remove(),this.unbind()},keepOpenChanged:function(e){this.hidePopup()},visibleChanged:function(e){m.models.customization.get("linksVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){this.initialFetchStarted||this.doFetch()},hideUsageHint:function(e){e.preventDefault(),e.stopPropagation(),m.models.customization.save({linksHintHidden:!0}),this.checkUsageHint()},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},showAdd:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(".quicklinks-new");t.is(".active")||t.addClass("active"),this.$el.find(".quicklinks-new-title").attr("placeholder","Name")},hideAdd:function(e){this.$el.find(".quicklinks-new").removeClass("active"),this.$el.find(".quicklinks-new-title").val("").attr("placeholder","New Link"),this.$el.find(".quicklinks-new-url").val("")},inputsClicked:function(e){e.stopPropagation()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.collection.fetch({reset:!0})},collectionReset:function(){this.addAll()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},added:function(e){this.addOne(e),this.checkOptionalLinks()},addOne:function(e){var t=new m.views.QuickLink({model:e,parent:this,notFoundIcon:this.notFoundIcon});this.subViews.push(t),this.$(".quicklinks-pane ol").append(t.render().$el)},addAll:function(){this.offline=!1,_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[];this.collection.each(this.addOne),this.successfulConnection(),this.checkOptionalLinks()},successfulConnection:function(){this.$el.find(".quicklinks-new").show(),this.$connectionmessage.hide(),this.dismissConnectionError(),this.checkUsageHint()},failedConnection:function(){this.$el.find(".connection-message").html('Trouble connecting… <span class="message-action retry">Retry</span>'),this.$el.find(".connection-message").show(),this.checkUsageHint()},retryAdd:function(e){this.addLink()},createLink:function(e){13==e.keyCode&&this.addLink()},addLink:function(e){this.$el.find(".add-error-message").hide();var t=this.$el.find("#quicklinks-new-title")[0].value,i=this.$el.find("#quicklinks-new-url")[0].value,o=this;if(!t)return this.$el.find("#quicklinks-new-title").addClass("pulse"),void _.delay(function(){o.$el.find("#quicklinks-new-title").removeClass("pulse")},1e3);if(!i)return this.$el.find("#quicklinks-new-url").addClass("pulse"),void _.delay(function(){o.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3);if(this.offline)this.revealConnectionError();else{var n=!1;/^chrome|chrome-extension|chrome-search:\/\//i.test(i)&&(n=!0),i=ensureUrlScheme(i),m.sendEvent("Quick Links","Add");var s=0;if(0<this.collection.length)s=this.collection.max(function(e){return e.get("order")}).get("order")+100;this.collection.create({title:t,url:i,local:n,order:s},{wait:!0,success:function(){o.successfulConnection(),o.$el.find(".quicklinks-new input").val(""),o.$el.find(".quicklinks-new-title").focus()},error:function(e,t,i){o.$el.find(".add-error-message").show()}})}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),!(e.originalEvent.dataTransfer.dropEffect="move")},drop:function(e){e.preventDefault(),e.stopPropagation()},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"quicklink"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),this.checkOptionalLinks(),!1},toggleShow:function(e){this.$el.hasClass("show")?this.forceHidePopup():this.showPopup(),this.doFetchIfNeeded(),this.setMaxWidgetHeight()},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),localStorage.setItem("linksOpen",!0)},forceHidePopup:function(){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")}),localStorage.setItem("linksOpen",!1)},hidePopup:function(e){e!=this&&(e&&e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.$el[0],e.target)||this.$el.hasClass("show")&&!m.models.bookmarksSettings.get("linksKeepOpen")&&this.forceHidePopup())},handleClick:function(e){e.stopPropagation(),e.preventDefault();var t=e.currentTarget.href;m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:t}):getBrowser().tabs.update({url:t})},li_index:function(e){return this.$("li").index(e)},urlInvalid:function(){var e=this;this.$el.find("#quicklinks-new-url").addClass("pulse"),_.delay(function(){e.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)},setMaxWidgetHeight:function(){var e=$(window).height()-125;this.$el.find(".quicklinks-pane").css("max-height",e)},checkUsageHint:function(){var e=m.models.customization.get("linksHintHidden");this.offline||e?this.$el.find(".link-hint").hide():this.$el.find(".link-hint").show()}}),m.views.QuickLink=Backbone.View.extend({tagName:"li",template:m.templates.quicklinks["quicklinks-item-template"],events:{"keypress .todo-input":"updateOnEnter","click .destroy":"delete",dragstart:"dragstart",dragenter:"dragenter","click a":"handleClick"},initialize:function(e){_.bindAll(this,"dragstart","dragenter"),this.parent=e.parent,this.notFoundIcon=e.notFoundIcon,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove)},render:function(){var i=this,o=this.model.get("url"),n=new Image,s=getFavIcon(o);return this.loadLink(!1),isChrome()?getBrowser().permissions.contains(m.models.bookmarksSettings.permissions,function(e){if(e){var t="chrome://favicon/size/16@2x/"+o;$.ajax({url:t}).done(function(e){e==i.notFoundIcon?n.src=s:i.loadLink(t)})}else n.src=s}):n.src=s,n.onload=function(){i.loadLink(s)},i},loadLink:function(e){var t={title:m.utils.captionFormatter(this.model.get("title")),url:this.model.get("url"),local:this.model.get("local"),favicon_url:e};this.$el.html(this.template(t)),this.$el.prop("draggable","true")},delete:function(e){e.stopPropagation(),m.sendEvent("Quick Links","Delete"),this.model.destroy()},dragstart:function(e){e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="quicklink",this.parent.dragging=this},dragenter:function(e){if("quicklink"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},handleClick:function(e){e.stopPropagation(),e.preventDefault(),m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:e.currentTarget.href}):getBrowser().tabs.update({url:e.currentTarget.href})},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.bootstrappers.RenderQuickLinks=function(t,e){t.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","linksVisible","momentum-quicklinks",function(){t.models.customization.get("linksVisible")&&(t.collect.quicklinks=new t.collect.QuickLinks,t.views.quicklinks=new t.views.QuickLinks({collection:t.collect.quicklinks,region:"top-left",order:"prepend"}),t.widgets.push(t.views.quicklinks),t.stopListening(t.models.customization,"change:linksVisible"))},function(){t.models.customization.get("linksVisible")&&(t.collect.quicklinks=new t.collect.QuickLinksLegacy,t.views.quicklinks=new t.views.QuickLinks({collection:t.collect.quicklinks,region:"top-left",order:"prepend"}),t.widgets.push(t.views.quicklinks),t.stopListening(t.models.customization,"change:linksVisible"))},function(e){t.listenTo(t.models.customization,"change:linksVisible",e)})},m.views.DashLinks=Backbone.View.extend({attributes:{id:"dashlinks",class:"quicklinks dashlinks top-widget"},template:m.templates.quicklinks.dashlinks,events:{"click .toggle-icon":"handleClick"},initialize:function(){this.listenTo(m.models.bookmarksSettings,"change:appsLocation",this.checkOptionalLinks),this.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",this.checkOptionalLinks),this.render()},checkInclusion:function(e){var t=m.models.bookmarksSettings,i=$(e);i.toggleClass("show",t.get(i.attr("data-momo-id")+"Location")==i.attr("data-place"))},checkOptionalLinks:function(){var i=this;this.$el.find(".optional-link").each(function(e,t){i.checkInclusion(t)})},render:function(){if(!isChrome())return this;var i=this,e=(this.options.order||"append")+"To";return this.$el[e]("#"+this.options.region).html(this.template()).fadeTo(500,1),this.$el.find(".optional-link").each(function(e,t){i.checkInclusion(t)}),this},handleClick:function(e){e.stopPropagation(),e.preventDefault();var t=e.currentTarget.dataset.url||e.currentTarget.href;m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:t}):getBrowser().tabs.update({url:t})}}),m.bootstrappers.RenderDashLinks=function(e,t){e.views.dashlinks=new e.views.DashLinks({region:"top-left",order:"prepend"}),e.widgets.push(e.views.dashlinks)},m.models.PersistentSettings=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaults:{bookmarksVisible:!1,linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!1,requestSync:!1,keepTodoState:!0,countdownVisible:!1,notesVisible:!1,percentClock:!1,themeColour:"dark",autoFocus:!1,balanceModeStr:"",bookmarksSettingsStr:""},initialize:function(){var t=this;t.fetching=!1,window.addEventListener("storage",function(e){e.key&&0===e.key.indexOf("momentum-customization-1")&&(t.fetching=!0,t.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0}))})}}),m.models.Settings=Backbone.Model.extend({defaults:{},initialize:function(){}}),m.models.GenericSettings=Backbone.Model.extend({initialize:function(e){this.url=m.globals.urlRoot+e},save:function(e,t){(t=t||{}).patch=!0,Backbone.Model.prototype.save.call(this,e,t)},toggle:function(e){var t={};this.has(e)?t[e]=!this.get(e):t[e]=!0,this.save(t)}}),m.models.BalanceMode=Backbone.Model.extend({defaults:{enabled:!1,active:!1,balanceClock:!1,balanceTodo:!1,balanceFocus:!0,balanceNotes:!1,customTime:!1,customDays:!1,start:{hour:9,minute:"00",noon:"AM"},end:{hour:5,minute:"00",noon:"PM"},startCustom:{hour:9,minute:"00",noon:"AM"},endCustom:{hour:5,minute:"00",noon:"PM"},days:[!1,!0,!0,!0,!0,!0,!1],daysCustom:[!1,!0,!0,!0,!0,!0,!1]},initialize:function(e,t){this.customization=t.customization||m.models.customization,this.listenTo(this.customization,"change:balanceModeStr",this.customizationChanged),this.listenTo(this,"change:enabled",this.balanceChanged),this.listenTo(m.models.date,"change:date",this.checkBalance)},checkBalance:function(){var e=new Date,t=this.getStart(),i=this.getEnd(),o=this.getDays(),n=t.hour+":"+t.minute+t.noon,s=i.hour+":"+i.minute+i.noon,a=this.get("active"),l=m.utils.toTodaysTime(s),r=m.utils.toTodaysTime(n),d=new Date(r.getTime());d.setDate(r.getDate()-1);var c=new Date(l.getTime());c.setDate(l.getDate()+1),this.set("active",this.get("enabled")&&(!o[e.getDay()]||l.getTime()>r.getTime()&&(r.getTime()>e.getTime()||e.getTime()>l.getTime())||l.getTime()<r.getTime()&&!(d.getTime()<e.getTime()&&e.getTime()<l.getTime()||r.getTime()<e.getTime()&&e.getTime()<c.getTime()))),a!=this.get("active")&&this.balanceChanged()},customizationChanged:function(e,t){var i=this.customization.get("balanceModeStr");i&&i!=this.balanceModeStr&&0<i.length&&this.resetBalanceMode()},resetBalanceMode:function(){if(this.balanceModeStr=this.customization.get("balanceModeStr"),this.balanceModeStr&&0<this.balanceModeStr.length){var e=JSON.parse(this.balanceModeStr);this.set("enabled",void 0===e.enabled?this.defaults.enabled:e.enabled),this.set("start",e.start||this.defaults.start),this.set("end",e.end||this.defaults.end),this.set("days",e.days||this.defaults.days),this.set("customDays",void 0===e.customDays?this.defaults.customDays:e.customDays),this.set("customTime",void 0===e.customTime?this.defaults.customTime:e.customTime),this.set("startCustom",e.startCustom||this.defaults.startCustom),this.set("endCustom",e.endCustom||this.defaults.endCustom),this.set("daysCustom",e.daysCustom||this.defaults.daysCustom),this.set("balanceClock",void 0===e.balanceClock?this.defaults.balanceClock:e.balanceClock),this.set("balanceFocus",void 0===e.balanceFocus?this.defaults.balanceFocus:e.balanceFocus),this.set("balanceTodo",void 0===e.balanceTodo?this.defaults.balanceTodo:e.balanceTodo),this.set("balanceNotes",void 0===e.balanceNotes?this.defaults.balanceNotes:e.balanceNotes),this.initCompleted=!0,this.checkBalance()}},getDays:function(){return this.get("customDays")?this.get("daysCustom"):this.get("days")},getStart:function(){return this.get("customTime")?this.get("startCustom"):this.get("start")},getEnd:function(){return this.get("customTime")?this.get("endCustom"):this.get("end")},get:function(e){return!!("customDays"!=e&&"customTime"!=e||m.conditionalFeatures.featureEnabled("plus"))&&Backbone.Model.prototype.get.call(this,e)},balanceChanged:function(){this.initCompleted&&this.customization.save({balanceModeStr:JSON.stringify(this.attributes)})}}),m.models.BookmarksSettings=Backbone.Model.extend({defaults:{guided:!1,linksKeepOpen:!1,iconsOnly:!1,openInNewTab:!1,appsLocation:"links",includeBookmarks:!1,includeOtherBookmarks:!1,defaultMostVisited:!1,includeMostVisited:!0,chromeTabLocation:"links"},initialize:function(){this.listenTo(m.models.customization,"change:bookmarksSettingsStr",this.customizationChanged),this.permissions={permissions:["bookmarks","topSites"]},isChrome()&&(this.permissions.origins=["chrome://favicon/"])},customizationChanged:function(e,t){var i=m.models.customization.get("bookmarksSettingsStr");i&&i!=this.bookmarksSettingsStr&&0<i.length&&this.reset()},reset:function(){this.bookmarksSettingsStr=m.models.customization.get("bookmarksSettingsStr");if(this.bookmarksSettingsStr&&0<this.bookmarksSettingsStr.length){var t=JSON.parse(this.bookmarksSettingsStr),i=this;["linksKeepOpen","iconsOnly","openInNewTab","appsLocation","includeBookmarks","includeOtherBookmarks","defaultMostVisited","includeMostVisited","chromeTabLocation","guided"].forEach(function(e){i.set(e,null==t[e]?i.defaults[e]:t[e])}),localStorage.setItem("bookmarksEnabled",m.models.customization.get("bookmarksVisible")),setTimeout(function(){initializeBookmarksPlaceHolder()},500)}},optionsChanged:function(){m.models.customization.save({bookmarksSettingsStr:JSON.stringify(this.attributes)})}}),m.models.ComputedSettings=Backbone.Model.extend({defaults:{todoVisible:!1,focusVisible:!1,autoFocus:!1,clockVisible:!1,notesVisible:!1},initializeSettings:function(e){var t=this;this.persistentSettings=new m.models.PersistentSettings({id:1}),this.listenTo(this.persistentSettings,"change",this.computeProperties),this.listenTo(this.persistentSettings,"sync",function(){var e=t.persistentSettings.get("balanceModeStr");e&&0<e.length&&(m.models.balanceMode.resetBalanceMode(),t.computeProperties()),t.initialized||(t.initialized=!0,t.trigger("initialized"))}),m.conditionalFeatures=new m.models.ConditionalFeatures({customization:this}),m.models.balanceMode=this.balanceMode=new m.models.BalanceMode({id:1},{customization:this}),m.models.bookmarksSettings=new m.models.BookmarksSettings({id:1}),this.persistentSettings.fetch({error:function(e,t,i){"Record Not Found"==t&&e.save()}})},checkBalanceMode:function(e,t,i){var o=this.attributes[e],n=!!i||(!this.persistentSettings.has(e)||this.persistentSettings.get(e));this.attributes[e]=n&&!(m.models.balanceMode.get("active")&&m.models.balanceMode.get(t)),o!=this.attributes[e]&&this.trigger("change:"+e)},checkAutoFocus:function(){var e="autoFocus",t=this.attributes[e];return this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),t!=this.attributes[e]},computeProperties:function(t,i,o){var n=this;this.checkBalanceMode("todoVisible","balanceTodo"),this.checkBalanceMode("clockVisible","balanceClock",!0),this.checkBalanceMode("focusVisible","balanceFocus"),this.checkBalanceMode("notesVisible","balanceNotes");var e=this.persistentSettings.changedAttributes();e||(e={}),this.checkAutoFocus()&&!e.autoFocus&&(e.autoFocus=this.attributes.autoFocus),_.keys(e).forEach(function(e){n.trigger("change:"+e,t,i,o)}),this.trigger("change",t,i,o)},get:function(e){return this.persistentSettings.get(e)},getPersistentSettings:function(){return this.persistentSettings},getComputedSetting:function(e){return null!=this.attributes[e]?Backbone.Model.prototype.get.call(this,e):this.persistentSettings.get(e)},set:function(){arguments[0].id?Backbone.Model.prototype.set.apply(this,arguments):this.persistentSettings.set.apply(this.persistentSettings,arguments)},save:function(){this.persistentSettings.save.apply(this.persistentSettings,arguments)},fetch:function(){this.persistentSettings.fetch.apply(this.persistentSettings,arguments)},toggle:function(e){if(e){var t=!this.get(e),i={};i[e]=t,this.save(i)}}}),m.collect.Settings=Backbone.Collection.extend({model:m.models.Settings,saveOptions:{patch:!0},initialize:function(){}}),m.collect.TodoSettings=m.collect.Settings.extend({model:m.models.Settings,allowReorder:!1,saveOptions:{patch:!0},url:m.globals.urlRoot+"settings/todo/providers/1/lists",comparator:"order",initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},nextOrder:function(){return this.length?this.last().get("order")+100:100},parse:function(e){return e.lists?(this.allowReorder=e.allow_reorder,e.lists):e},reorderItem:function(e){console.log(e);var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRoot+"settings/todo/providers/1/lists"}).done(function(e){m.trigger("globalEvent:resetLists")}).fail(function(e,t){console.log("failed"),m.trigger("globalEvent:resetLists")})}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){return this.$el.html(this.template({})),this},close:function(){this.remove(),this.unbind(),this.panelClosing()},panelClosing:function(){}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{id:"settings-main",class:"pane-container settings-container"},template:m.templates.settings.main,events:{"click .hide":"hideSettings"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){return this.visible?(this.paneRendered||(this.$el.html(this.template()),this.$container=this.$(".subpanel-container"),this.paneRendered=!0),this.cssLoaded&&(this.renderedOnce||(this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide()),this.renderActivePanel()),this):this},renderActivePanel:function(e){this.activePanel&&this.cssLoaded&&this.renderedOnce&&(this.activePanel.render(e).$el.detach().appendTo(this.$container),this.$popBody=this.$container.find(".pop-body"),m.trigger("settings:panel:visible"))},navItemClicked:function(e){if(this.upsellView&&this.upsellView.hideUpsell(),e!=this.activePanelId){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})}},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},showUpsell:function(e){this.upsellView?(this.upsellView.options=e,this.upsellView.render()):(e.template=m.templates.settings.upsell,this.upsellView=new m.views.upsell.message(e),this.$el.find(".upsell-parent").prepend(this.upsellView.render().$el)),this.upsellView.show()},showSettings:function(e){this.cssLoaded||this.cssLoading||(this.cssLoading=!0,$("head").append('<link type="text/css" href="css/settings.css" rel="stylesheet" />'),this.cssLoaded=!0,this.render(),this.showSection(e)),this.visible=!0,m.trigger("globalEvent:toggle:bottom-left",this),this.paneRendered&&this.renderedOnce||this.render(),m.trigger("settings:visible"),this.cssLoaded&&this.showSection(e),this.$el.show()},showSection:function(e){e&&e.section?this.activateSection(e.section,e):this.activateSection(this.activePanelId&&"loading"!=this.activePanelId?this.activePanelId:"general")},hideSettings:function(e){if(this.$el.is(":visible")){e&&e.preventDefault(),this.visible=!1,m.trigger("settings:hidden"),this.$el.find(".settings").removeClass("fade-in");setTimeout(function(){},200),this.activePanel&&this.activePanel.close(),this.navMenu.closeUser()}},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i)},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active")},activateSection:function(t,i){var o=this;if(t){i&&i.nav?this.setActiveNavItem(i.nav):this.setActiveNavItem(t);var e=this.getNavItem(t);e||(e=this.getPanel(t));var n=null,s=!1,a=!1,l=!1;if(e&&e.cmd)m.commandManager.ensureCommandLoaded(e.cmd,function(){s=!0,n=m.commandManager.execute(e.cmd,i),o.setActivePanel(n,t,i),o.renderActivePanel(i)},function(){a||s||(a=!0,setTimeout(function(){l||s||o.showLoadingPanel()},400))},function(e){l=a=!0,o.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:t,options:i}})});else{if(!(n=_.findWhere(this.subViews,{panelid:t}))){var r=t.charAt(0).toUpperCase()+t.slice(1),d=m.views.settings.panels[r];d&&(n=new d(i))}this.setActivePanel(n,t,i),this.renderActivePanel()}}}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{class:"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return!!(this.$picker&&this.$picker.is(":visible")&&this.active)&&this.$picker.find(".cp-color-picker").first()[0]},settingsClick:function(e){if(!(0<$(e.target).closest(".cp-color-picker").length)){var t=$(e.currentTarget).data("option-value");t&&t==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(){this.$picker&&(this.$picker.hide(),this.$el.closest(".toggle-option").removeClass("color-picker-active"),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var o=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var i={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,i=m.models.themeManager.toRgbA(t);o.$swatch.css({backgroundColor:i,color:.22<t.RGBLuminance?"#222":"#ddd"}),m.models.themeManager.setColorValues(o.settingName,t)}}},n=m.models.themeManager.getThemeColourRGBA(this.settingName);n&&(i.color=n),this.picker=new m.views.settings.ColorPickerPopup(i),this.$picker=this.picker.render().$el,this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"preferences",class:"preferences"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).html('<span class="toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>'),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.append(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this.options.email,t=this.options.size,i=this.$el.attr({src:"https://www.gravatar.com/avatar/"+md5(e)+"?s="+t+"&d=mm"});return this.$el.html(i),this}}),m.views.settings.panels.About=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-about",class:"subpanel-container"},template:m.templates.settings.about,panelid:"about",events:{"dblclick #momo-version":"revealUuid","dblclick .about-logo":"logoDblClicked"},render:function(){var e={version:m.globals.version};return this.$el.html(this.template(e)),this},revealUuid:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find(".made").html(localStorage.client_uuid)},logoDblClicked:function(e){e.stopPropagation(),$(".preferences").first().toggleClass("infinispin",m.settingsManager.toggleInfinispin())}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{class:"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return!!(this.$picker&&this.$picker.is(":visible")&&this.active)&&this.$picker.find(".cp-color-picker").first()[0]},settingsClick:function(e){if(!(0<$(e.target).closest(".cp-color-picker").length)){var t=$(e.currentTarget).data("option-value");t&&t==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(){this.$picker&&(this.$picker.hide(),this.$el.closest(".toggle-option").removeClass("color-picker-active"),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var o=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var i={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,i=m.models.themeManager.toRgbA(t);o.$swatch.css({backgroundColor:i,color:.22<t.RGBLuminance?"#222":"#ddd"}),m.models.themeManager.setColorValues(o.settingName,t)}}},n=m.models.themeManager.getThemeColourRGBA(this.settingName);n&&(i.color=n),this.picker=new m.views.settings.ColorPickerPopup(i),this.$picker=this.picker.render().$el,this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPickerPopup=Backbone.View.extend({template:m.templates.settings["color-picker-popup"],events:{"mousedown .cp-xy-slider,.cp-z-slider,.cp-alpha":"mouseDown"},initialize:function(e){this._color=this.color=new Colors(e),this._options=this._color.options,this._GPU=!1,this._css="",this._pointermove="touchmove.tcp mousemove.tcp pointermove.tcp",this._pointerup="touchend.tcp mouseup.tcp pointerup.tcp"},render:function(){return this.$el.html(this.template()),this.delegateEvents(),this._$z_slider=this.$el.find(".cp-z-slider").first(),this._$xy_slider=this.$el.find(".cp-xy-slider").first(),this._$xy_cursor=this.$el.find(".cp-xy-cursor").first(),this._$z_cursor=this.$el.find(".cp-z-cursor").first(),this._$alpha=this.$el.find(".cp-alpha").first(),this._$alpha_cursor=this.$el.find(".cp-alpha-cursor").first(),this.setSizes(),this.preRender(),this.renderedOnce=!0,this},setSizes:function(){this._$alpha._width=this._$alpha.width(),this._$xy_slider._width=this._$xy_slider.width(),this._$xy_slider._height=this._$xy_slider.height(),this._$z_slider._height=this._$z_slider.height()},resolveEventType:function(e){return(e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e).originalEvent?e.originalEvent:e},findElement:function(e){return $(e.find(this._options.doRender)[0]||e[0])},mouseDown:function(e){var t=this;e.stopPropagation(),this._$trigger=$(e.currentTarget),this.setSizes();var i=e.currentTarget.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");1<(e.button||e.which)||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,this._$trigger._offset=this._$trigger.offset(),(i="xy_slider"===i?this.xy_slider:"z_slider"===i?this.z_slider:this.alpha).call(this,e),this.preRender(),this.$el.on(this._pointerup,function(e){t.$el.off(".tcp")}).on("mouseleave.tcp",function(e){i.call(t,e),t.preRender(),t.$el.off(".tcp")}).on(this._pointermove,function(e){i.call(t,e),t.preRender()}))},xy_slider:function(e){var t=this.resolveEventType(e),i=t.pageX-this._$trigger._offset.left,o=t.pageY-this._$trigger._offset.top;this._color.setColor({s:i/this._$xy_slider._width*100,v:100-o/this._$xy_slider._height*100},"hsv")},z_slider:function(e){var t=this.resolveEventType(e).pageY-this._$trigger._offset.top;this._color.setColor({h:360-t/this._$z_slider._height*360},"hsv")},alpha:function(e){var t=(this.resolveEventType(e).pageX-this._$trigger._offset.left)/this._$alpha._width;this._color.setColor({},"rgb",t)},preRender:function(e){colors=this._color.colors,hueRGB=colors.hueRGB,RGB=colors.RND.rgb,HSL=colors.RND.hsl,dark=this._options.dark,light=this._options.light,colorText=this._color.toString(this._color._colorMode,this._options.forceAlpha),HUEContrast=.22<colors.HUELuminance?dark:light,alphaContrast=.22<colors.rgbaMixBlack.luminance?dark:light,h=(1-colors.hsv.h)*this._$z_slider._height,s=colors.hsv.s*this._$xy_slider._width,v=(1-colors.hsv.v)*this._$xy_slider._height,a=colors.alpha*this._$alpha._width,translate3d=this._GPU?"translate3d":"",this._$trigger?(triggerValue=this._$trigger[0].value,hasNoValue=this._$trigger[0].hasAttribute("value")&&""===triggerValue&&void 0!==e):(triggerValue=null,hasNoValue=!0),this._$xy_slider._css={backgroundColor:"rgb("+hueRGB.r+","+hueRGB.g+","+hueRGB.b+")"},this._$xy_cursor._css={transform:translate3d+"("+s+"px, "+v+"px, 0)",left:this._GPU?"":s,top:this._GPU?"":v,borderColor:.22<colors.RGBLuminance?dark:light},this._$z_cursor._css={transform:translate3d+"(0, "+h+"px, 0)",top:this._GPU?"":h,borderColor:"transparent "+HUEContrast},this._$alpha._css={background:"linear-gradient(to left,#"+colors.HEX+",rgba(0,0,0,0))"},this._$alpha_cursor._css={transform:translate3d+"("+a+"px, 0, 0)",left:this._GPU?"":a,borderColor:alphaContrast+" transparent"},this.renderInternal(e)},renderInternal:function(e){this._$xy_slider.css(this._$xy_slider._css),this._$xy_cursor.css(this._$xy_cursor._css),this._$z_cursor.css(this._$z_cursor._css),this._$alpha.css(this._$alpha._css),this._$alpha_cursor.css(this._$alpha_cursor._css),this._options.doRender&&this._$trigger.css(this._$trigger._css),this._options.renderCallback.call(null,this._color,this._$trigger,"boolean"==typeof e?e:void 0)}}),m.views.settings.panels.General=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-general",class:"subpanel-container"},template:m.templates.settings.general,panelid:"general",events:{"click .slide-toggle":"toggleSlider","click .config-button":"configWidget","click .sync-option":"toggleSyncSlider","click .balanced-message":"switchToBalanceSettings","click .toggle-option":"toggleOption"},initialize:function(){this.model=m.models.customization,this.initializeCustomizeItems(),this.listenTo(this.model,"change",this.customizationModelChanged)},initializeCustomizeItems:function(){var e=m.models.themeManager.getAvailableFonts();this.customizeItems=[{name:"Theme",field:"themeColour",widget:"themeColour",options:[{label:"Dark",value:"dark"},{label:"Light",value:"light"},{label:"Custom",value:"custom",view_cmd:"settings.color.picker",view_opt:{settingName:"themeColour",ignoreClick:!0},show_always:!0}],default:"dark",plusOnly:!0,section:"customize"},{name:"Font",field:"themeFont",widget:"themeFont",options:e,default:"default",plusOnly:!0,section:"customize"},{name:"Links",widget:"linksVisible",field:"linksVisible",section:"widgets"},{name:"Bookmarks Bar",widget:"bookmarksVisible",field:"bookmarksVisible",section:"widgets"},{name:"Search",widget:"searchVisible",field:"searchVisible",section:"widgets"},{name:"Weather",widget:"weatherVisible",field:"weatherVisible",section:"widgets"},{name:"Focus",widget:"focusVisible",field:"focusVisible",section:"widgets"},{name:"Quote",widget:"quoteVisible",field:"quoteVisible",section:"widgets"},{name:"Todo",widget:"todoVisible",field:"todoVisible",section:"widgets"},{name:"Countdown",widget:"countdownVisible",field:"countdownVisible",plusOnly:!0,message:"Count down to important dates",section:"widgets",beta:!0},{name:"Notes",widget:"notesVisible",field:"notesVisible",plusOnly:!0,message:"Take quick notes and store wisdom to review",section:"widgets",beta:!0},{name:"Clock Format",field:"hour12clock",widget:"clock-format",boolean:!0,options:[{label:"12 hour",value:!0},{label:"24 hour",value:!1}],section:"misc"},{name:"Percent Clock",widget:"percentClock",field:"percentClock",message:"Visualize your progression through the work day",section:"misc",configLabel:"Customize",configCommand:"settings.display",configOptions:{section:"balance",scheduleVisible:!0}},{name:"Search Provider",field:"searchProvider",widget:"search-provider",options:[{label:"Google",value:"google"},{label:"Bing",value:"bing"}],section:"misc"}]},render:function(){m.models.customization.get("displayname"),localStorage.email;var e=!!localStorage.token;this.$el.html(this.template({loggedIn:e}));var t={customize:this.$el.find("#customize-list"),widgets:this.$el.find("#widgets-list"),misc:this.$el.find("#misc-list")};return _.each(t,function(e){e.empty()}),_.each(this.customizeItems,function(e){e.feature&&!m.conditionalFeatures.featureEnabled(e.feature)||(e.options?t[e.section].append(m.templates.settings["general-toggle-options"](e)):t[e.section].append(m.templates.settings["general-toggle-slider"](e)))}),this.updateControlStates(_.pluck(this.customizeItems,"field")),this},customizationModelChanged:function(e){if(e){var t=e.changedAttributes(),i=_.keys(t);this.updateControlStates(i)}},updateControlStates:function(e){var l=this,r=m.conditionalFeatures.featureEnabled("plus");_.each(e,function(e){var i=_.findWhere(l.customizeItems,{field:e});if(i){var o=l.model.get(e);if(i.options){i.plusOnly&&!r&&(o=i.default),l.$el.find("."+i.widget).removeClass("active");var n=l.$el.find("."+i.widget+"[data-option-value='"+o+"']").first();n.addClass("active"),_.each(i.options,function(e){if(e.view_cmd){var t=(n=l.$el.find("."+i.widget+"[data-option-value='"+e.value+"']").first()).find(".sub-view").first();if(!e.view&&e.show_always&&(e.view=m.commandManager.execute(e.view_cmd,e.value,e.view_opt)),0==t.children().length&&(t.html(e.view.render().$el),t.css("display","inline-block")),e.value!=o)return e.show_always||t.hide(),!e.view||!e.view.dismiss||e.view.dismiss(),void(!e.view||!e.view.setInactive||e.view.setInactive());!e.view||!e.view.setActive||e.view.setActive()}})}else{var t=l.model.getComputedSetting(e);o=!(i.plusOnly&&!r)&&!!o;var s=l.$el.find("[data-related-widget='"+i.widget+"']");if(s&&1===s.length){var a=s.first();a.toggleClass("on",o),o!=t&&(i.plusOnly&&r||!i.plusOnly)&&!a.hasClass("balanced")&&(a.append('<span class="option-message balanced-message"> &nbsp; &nbsp;Currently hidden by Balance mode (Customize here)</span>'),a.addClass("balanced"))}}}})},setOption:function(e){var t=e.attr("data-related-widget"),i=e.attr("data-option-value"),o=_.findWhere(this.customizeItems,{widget:t});if(!o)return null;if(!o.plusOnly||m.conditionalFeatures.featureEnabled("plus")){this.$el.find("."+t).removeClass("active"),e.addClass("active");var n={};return o.boolean?n[o.field]=JSON.parse(i):n[o.field]=i,this.model.save(n),o}var s={targetRegion:"settings",sourceEvent:t,buttonText:"Learn more",title:"Custom Themes",description:"Select a font and color theme to make Momentum your own"};m.commandManager.execute("upsell.message",s)},toggleOption:function(e){var t=$(e.currentTarget),i=$(e.currentTarget).attr("data-option-value"),o=this.setOption(t);if(o){var n=_.findWhere(o.options,{value:i});if(n&&n.view&&n.view.handleClick){if(0<$(e.target).closest(".sub-view").length&&n.view.ignoreClickEvent&&n.view.ignoreClickEvent(e.target))return;if(n.view.handleClick(e,!0),n.view.scrollIntoViewElement){var s=n.view.scrollIntoViewElement();s&&this.scrollIntoView(s)}}}m.trigger("globalEvent:settingsclick",e)},scrollIntoView:function(e){var t=$(e),i=t.closest(".pop-body"),o=t.offset().top,n=i.offset().top;o-n<0&&i.animate({scrollTop:i[0].scrollTop+o-n-12})},configWidget:function(e){e.stopPropagation();var t=$(e.currentTarget).closest(".slide-toggle").attr("data-related-widget");if(t){var i=_.findWhere(this.customizeItems,{widget:t});m.commandManager.execute(i.configCommand,null,i.configOptions)}},toggleSlider:function(e){var t=$(".cp-color-picker");if(!($(e.target).attr("data-option-value")||0<t.length&&$.contains(t[0],e.target)||$(e.currentTarget).hasClass("balanced"))){var i,o=$(e.currentTarget).attr("data-related-widget");if("bookmarksVisible"!=o){if(o){var n,s=_.findWhere(this.customizeItems,{widget:o}),a=this.model.get(s.field);if(s.options){for(i=0;i<s.options.length;i++)if(s.options[i].value==a){i==s.options.length-1&&(i=-1),n=s.options[i+1].value;break}var l=$(e.currentTarget).find("."+s.widget+"[data-option-value='"+n+"']").first();this.setOption(l)}else{var r;if(n=!this.model.get(o),this.model.toggle(o),s.plusOnly&&!m.conditionalFeatures.featureEnabled("plus"))return s.plusOnly&&!m.conditionalFeatures.featureEnabled("plus")&&("Countdown"==s.name?r={targetRegion:"settings",sourceEvent:o,buttonText:"Learn more",title:"Countdown",description:"Track your upcoming milestones"}:"Notes"==s.name&&(r={targetRegion:"settings",sourceEvent:o,buttonText:"Learn more",title:"Notes",description:"Take longer form notes"})),void m.commandManager.execute("upsell.message",r);var d={};d[o]=n,this.model.save(d)}}m.trigger("globalEvent:settingsclick",e)}else this.enableBookmarks(e)}},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),m.commandManager.execute("account.login")},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),$(".action-logout").addClass("action-logout-disabled").text("Logging out..."),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},accountClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"POST",beforeSend:setMomentumAuthHeader,data:JSON.stringify({medium:"account"}),url:m.globals.urlRootApi+"login/onetime"}).done(function(e){e&&e.otp&&e.email&&(window.location.href="http://localdev:8995/onetime?email="+encodeURIComponent(e.email)+"&otp="+encodeURIComponent(e.otp))}).fail(function(e,t){}).always(function(){})},panelClosing:function(){_.each(this.customizeItems,function(e){_.each(e.options,function(e){e.view_cmd&&(!e.view||!e.view.close||e.view.close())})})},switchToBalanceSettings:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("settings.display",null,{section:"balance",showAdvanced:!0})},enableBookmarks:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("settings.enableBookmarks",{callback:function(){$(e.currentTarget).toggleClass("on",m.models.customization.get("bookmarksVisible"))}})}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this.options.email,t=this.options.size,i=this.$el.attr({src:"https://www.gravatar.com/avatar/"+md5(e)+"?s="+t+"&d=mm"});return this.$el.html(i),this}}),m.views.settings.panels.Help=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help",class:"subpanel-container"},template:m.templates.settings.help,panelid:"help",initialize:function(){},render:function(){return this.$el.html(this.template({isChrome:isChrome()})),this}}),m.views.settings.panels.Loading=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-loading"},template:m.templates.settings.loading,panelid:"loading",events:{"click .button-retry":"retryClicked"},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;this.$el.html(this.template({})),this.$errorMessage=this.$(".settings-loading-error-message"),this.$retryButton=this.$(".button-retry"),this.$loading=this.$(".settings-loading-loading-message")}return this.renderDisplayState(),this},renderDisplayState:function(){if(this.displayOptions){var e=this.displayOptions;if(e.error)return this.$errorMessage.text(e.error),this.$errorMessage.show(),this.$retryButton.show(),void this.$loading.hide()}this.$loading.show(),this.$errorMessage.hide(),this.$retryButton.hide()},setDisplayOptions:function(e){this.displayOptions=e||null},retryClicked:function(e){if(e.stopPropagation(),this.displayOptions&&this.displayOptions.retryInfo){var t=this.displayOptions.retryInfo,i=t.options||{};i.section=t.id,m.commandManager.execute("settings.display",null,i)}}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{id:"settings-main",class:"pane-container settings-container"},template:m.templates.settings.main,events:{"click .hide":"hideSettings"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){return this.visible?(this.paneRendered||(this.$el.html(this.template()),this.$container=this.$(".subpanel-container"),this.paneRendered=!0),this.cssLoaded&&(this.renderedOnce||(this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide()),this.renderActivePanel()),this):this},renderActivePanel:function(e){this.activePanel&&this.cssLoaded&&this.renderedOnce&&(this.activePanel.render(e).$el.detach().appendTo(this.$container),this.$popBody=this.$container.find(".pop-body"),m.trigger("settings:panel:visible"))},navItemClicked:function(e){if(this.upsellView&&this.upsellView.hideUpsell(),e!=this.activePanelId){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})}},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},showUpsell:function(e){this.upsellView?(this.upsellView.options=e,this.upsellView.render()):(e.template=m.templates.settings.upsell,this.upsellView=new m.views.upsell.message(e),this.$el.find(".upsell-parent").prepend(this.upsellView.render().$el)),this.upsellView.show()},showSettings:function(e){this.cssLoaded||this.cssLoading||(this.cssLoading=!0,$("head").append('<link type="text/css" href="css/settings.css" rel="stylesheet" />'),this.cssLoaded=!0,this.render(),this.showSection(e)),this.visible=!0,m.trigger("globalEvent:toggle:bottom-left",this),this.paneRendered&&this.renderedOnce||this.render(),m.trigger("settings:visible"),this.cssLoaded&&this.showSection(e),this.$el.show()},showSection:function(e){e&&e.section?this.activateSection(e.section,e):this.activateSection(this.activePanelId&&"loading"!=this.activePanelId?this.activePanelId:"general")},hideSettings:function(e){if(this.$el.is(":visible")){e&&e.preventDefault(),this.visible=!1,m.trigger("settings:hidden"),this.$el.find(".settings").removeClass("fade-in");setTimeout(function(){},200),this.activePanel&&this.activePanel.close(),this.navMenu.closeUser()}},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i)},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active")},activateSection:function(t,i){var o=this;if(t){i&&i.nav?this.setActiveNavItem(i.nav):this.setActiveNavItem(t);var e=this.getNavItem(t);e||(e=this.getPanel(t));var n=null,s=!1,a=!1,l=!1;if(e&&e.cmd)m.commandManager.ensureCommandLoaded(e.cmd,function(){s=!0,n=m.commandManager.execute(e.cmd,i),o.setActivePanel(n,t,i),o.renderActivePanel(i)},function(){a||s||(a=!0,setTimeout(function(){l||s||o.showLoadingPanel()},400))},function(e){l=a=!0,o.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:t,options:i}})});else{if(!(n=_.findWhere(this.subViews,{panelid:t}))){var r=t.charAt(0).toUpperCase()+t.slice(1),d=m.views.settings.panels[r];d&&(n=new d(i))}this.setActivePanel(n,t,i),this.renderActivePanel()}}}}),m.views.settings.NavMenu=Backbone.View.extend({syncState:!1,template:m.templates.settings.navmenu,events:{"click .main-nav-item":"onClickNavItem","click .user-info":"toggleUserPanel","click .sync-option":"toggleSyncSlider","click .action-profile":"accountClicked","click .action-logout":"logoutClicked","click .user-close":"closeUser","click .login-button":"loginClicked"},initialize:function(){var t=this;this.listenTo(m.settingsManager,"navItemsChanged",this.render),this.listenTo(m.models.customization,"change:displayname",this.onChangeDisplayname),this.render(),this.$el.closest(".pane").on("click",function(e){$.contains(t.$user[0],e.target)||e.target===t.$user[0]||t.closeUser()})},render:function(){var e=localStorage.getItem("email"),t=!!localStorage.token;this.syncMessage||(m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")?(this.syncMessage="Your account data is available anywhere you log in",this.syncState=!0):(this.syncMessage="Access your Momentum account from any computer",this.syncState=!1));var i={displayName:m.models.customization.get("displayname"),email:e,loggedIn:t,menu:m.settingsManager.getNavItems(),syncMessage:this.syncMessage};this.$el.html(this.template(i)),this.$user=this.$(".user"),this.$userInfoName=this.$(".user-info-name"),this.$userHidden=this.$(".user-hidden"),this.$synclist=this.$(".sync-option"),t&&this.renderGravatar(e),m.conditionalFeatures.featureEnabled("plus")&&this.$user.addClass("has-plus"),this.syncState&&this.$user.addClass("hide-sync");var o=this;return _.defer(_.bind(function(){o.$user.css("transform","translateY("+o.$userHidden.height()+"px)")},this)),this},onChangeDisplayname:function(){this.$userInfoName.text(m.models.customization.get("displayname"))},renderGravatar:function(e){this.$userAvatarImg=this.$(".user-avatar img"),this.$userAvatarHidden=this.$(".user-avatar-hidden");var t=new m.views.Gravatar({email:e,size:50});this.$userAvatarHidden.html(t.render().$el);var i=this;setTimeout(function(){i.$(".user-avatar-hidden img").one("load",function(){i.$userAvatarImg.attr("src",$(this).attr("src"))}).each(function(){this.complete&&$(this).load()})},0)},onClickNavItem:function(e){var t=$(e.currentTarget).data("navitem");this.trigger("navItemClicked",t)},toggleUserPanel:function(){this.updateSyncToggleState(),this.$user.removeClass("no-transition"),this.$user.hasClass("open")?this.$user.css("transform","translateY("+this.$userHidden.height()+"px)"):this.$user.css("transform","translateY(0)"),this.$user.toggleClass("u--bg open")},toggleSyncSlider:function(e){e.preventDefault(),e.stopPropagation();var t=this;this.syncState||(localStorage.token?m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){t.updateSyncCaption("Account Sync Activated"),t.updateSyncMessage("Refresh or load a new tab to use your synced account"),t.syncState=!0,t.updateSyncToggleState()},function(){t.syncState=!1,t.updateSyncToggleState(),t.updateSyncCaption("Account Sync Access Request Failed"),t.updateSyncMessage("Please check that you are online and try again"),t.syncState=!1,t.updateSyncToggleState()}):(t.updateSyncCaption("Login required for Account Sync"),t.updateSyncMessage("Click Log In to log in or create an account, and try again"),t.syncState=!1,t.updateSyncToggleState()))},updateSyncToggleState:function(){this.$synclist&&this.$synclist.toggleClass("fixed on",this.syncState)},updateSyncMessage:function(e){if(this.$synclist){var t=this.$synclist.find(".option-message");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},updateSyncCaption:function(e){if(this.$synclist){var t=this.$synclist.find(".sync-caption");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},accountClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching…"),$.ajax({type:"POST",beforeSend:setMomentumAuthHeader,data:JSON.stringify({medium:"account"}),url:m.globals.urlRootApi+"login/onetime"}).done(function(e){e&&e.otp&&e.email&&(window.location.href="https://account.momentumdash.com/onetime?email="+encodeURIComponent(e.email)+"&otp="+encodeURIComponent(e.otp))}).fail(function(e,t){}).always(function(){})},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),$(".action-logout").addClass("action-logout-disabled").text("Logging out…"),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},closeUser:function(){this.$user.css("transform","translateY("+this.$userHidden.height()+"px)").removeClass("u--bg open")},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),m.commandManager.execute("account.login")},onChangeDisplayname:function(){this.$userInfoName.text(m.models.customization.get("displayname"))}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"preferences",class:"preferences"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).html('<span class="toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>'),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.append(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){return this.$el.html(this.template({})),this},close:function(){this.remove(),this.unbind(),this.panelClosing()},panelClosing:function(){}}),m.views.settings.panels.Whatsnew=m.views.settings.SettingsPanel.extend({attributes:{id:"whats-new-panel",class:"subpanel-container"},template:m.templates.settings.whatsnew,panelid:"whatsnew",events:{"click .action-back":"clickBack"},initialize:function(){m.sendEvent("Whats New","Show Whats New Panel")},render:function(){return this.$el.html(this.template({})),this.$whatsnew=$(this.$el.find(".whatsnew-body")[0]),this.$whatsnew.html('<span class="loading"><i class="loading-icon"></i>Loading...</span>'),this.fetchLatestWhatsNew(),this},fetchLatestWhatsNew:function(){var i=this;$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings/whatsnew"}).done(function(e){e.html&&i.$whatsnew.html(e.html)}).fail(function(e,t){i.$el.html(i.template({}))})}}),m.views.Introduction=Backbone.View.extend({attributes:{id:"introduction",class:"intro"},template:m.templates.introduction["introduction-template"],initialize:function(){this.activeView=null,localStorage.removeItem("doLoginOnNextLoad"),this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(1e3,1),m.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},promptForName:function(){m.sendEvent("Introduction","Name","Show"),m.views.namePrompt=new m.views.NamePrompt,this.activeView=m.views.namePrompt,this.$el.find(".content").append(m.views.namePrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForEmail:function(){m.views.emailPrompt=new m.views.EmailPrompt,this.activeView=m.views.emailPrompt,this.$el.find(".content").append(m.views.emailPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordLogin:function(){m.sendEvent("Introduction","Password For Login","Show"),m.views.loginPasswordPrompt=new m.views.LoginPasswordPrompt,this.activeView=m.views.loginPasswordPrompt,this.$el.find(".content").append(m.views.loginPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordCreate:function(){m.sendEvent("Introduction","Password For Create","Show"),m.views.createPasswordPrompt=new m.views.CreatePasswordPrompt,this.activeView=m.views.createPasswordPrompt,this.$el.find(".content").append(m.views.createPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordReset:function(){m.sendEvent("Introduction","Password For Reset","Show"),m.views.resetPasswordPrompt=new m.views.ResetPasswordPrompt,this.activeView=m.views.resetPasswordPrompt,this.$el.find(".content").append(m.views.resetPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},doneIntroductionWithMessage:function(){this.handledDone||(this.handledDone=!0,localStorage.removeItem("doLoginOnNextLoad"),this.$el.fadeTo(1e3,0,function(){m.bootstrappers.InitializeFocus(m,$),m.appView.render(!0)}))},showLoading:function(){this.$el.find(".tip").html('<div class="loading"><span class="loading-icon"></span>Loading...</div>').css("opacity","0").fadeTo(500,1)},hideLoading:function(){}}),m.views.NamePrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},render:function(){var e={message:"Hello, what's your name?"};this.$el.html(this.template(e));var t=new m.views.ExpandableInput;this.$el.find("#introduction-question").after(t.render().$el),t.$el.attr("id","introduction-input");var i=this;return setTimeout(function(){var e=i.$el.find(".introduction-question-title").outerWidth();i.$el.find(".input").css({"min-width":e}).focus()},10),this},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||(e.preventDefault(),this.save())},save:function(){m.sendEvent("Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(m.models.customization.save({displayname:t}),this.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForEmail()}))}}),m.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown .input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"What's your email, "+m.models.customization.get("displayname")+"?"},i=new m.views.IntroductionButton({value:"Stay logged out",clicked:function(){return e.stayOffline()}});this.$el.html(this.template(t)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(i.render().$el);var o=new m.views.ExpandableInput;this.$el.find("#introduction-question").after(o.render().$el),o.$el.attr("id","introduction-input");var n=this;return setTimeout(function(){var e=n.$el.find(".introduction-question-title").outerWidth();n.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){13!==e.keyCode&&9!==e.keyCode||(e.preventDefault(),this.checkEmail())},stayOffline:function(){m.sendEvent("Introduction","Email","Stay Offline Clicked"),localStorage.stayOffline=!0,m.views.introduction.doneIntroductionWithMessage()},checkEmail:function(){m.sendEvent("Introduction","Email","Submit");var i=this,e=this.$el.find(".input").val().trim();if(e&&!(e.length<1))if(validateEmail(e))i.loading||(i.loading=!0,localStorage.email=e,m.views.introduction.showLoading(),$.ajax({type:"GET",url:m.globals.urlRootApi+"user-search?email="+encodeURIComponent(e)}).done(function(e){i.$el.fadeTo(1e3,0,function(){i.remove(),m.views.introduction.promptForPasswordLogin()}),m.views.introduction.hideLoading(),i.loading=!1}).fail(function(e,t){404===e.status?(i.$el.fadeTo(1e3,0,function(){i.remove(),m.views.introduction.promptForPasswordCreate()}),i.loading=!1,m.views.introduction.hideLoading()):(i.loading=!1,i.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1))}));else{var t=new m.views.IntroductionTip({value:"Sorry, "+e+" doesn't seem to be a valid email address. Please try again."});this.$el.find(".tip").html(t.render().$el.fadeTo(500,1))}}}),m.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"What's your password?"},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}}),o=new m.views.IntroductionButton({value:"Change your password",clicked:function(){return e.resetPassword()}});this.$el.html(this.template(t)),this.$el.find(".buttons").append(i.render().$el),this.$el.find(".buttons").append(o.render().$el);var n=new m.views.ExpandableInput;this.$el.find("#introduction-question").after(n.render().$el),n.$el.attr("id","introduction-input"),this.$el.find(".input").attr("type","password").focus();var s=this;return setTimeout(function(){var e=s.$el.find(".introduction-question-title").outerWidth();s.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Password For Login","Escape Pressed"),this.changeEmail(e)},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.login()},changeEmail:function(e){m.sendEvent("Introduction","Password For Login","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},resetPassword:function(e){m.sendEvent("Introduction","Password For Login","Reset Password Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForPasswordReset()})},login:function(){m.sendEvent("Introduction","Password For Login","Submit");var o=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});o.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}else o.loading||(o.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:e,password:t}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/authenticate"}).done(function(e){o.loading=!1,e.token&&(m.commandManager.execute("notification.dismiss"),localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&m.conditionalFeatures.setFeatures(e.features),m.trigger("user:successfulLogin",function(){localStorage.setItem("loggedIn",Date.now()),m.views.introduction.doneIntroductionWithMessage()}),m.views.introduction.hideLoading())}).fail(function(e,t){if(400===e.status||401===e.status){var i=new m.views.IntroductionTip({value:"The password you entered for the email "+localStorage.email+" isn't right."});o.$el.find(".tip").html(i.render().$el.fadeTo(500,1)),o.loading=!1,m.views.introduction.hideLoading()}else o.loading=!1,o.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)}))}}),m.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"Please choose a password."},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});this.$el.html(this.template(t));var o=new m.views.ExpandableInput;this.$el.find("#introduction-question").after(o.render().$el),o.$el.attr("id","introduction-input"),this.$el.find("input").attr("type","password").focus(),this.$el.find(".buttons").append(i.render().$el);var n=this;return setTimeout(function(){var e=n.$el.find(".introduction-question-title").outerWidth();n.$el.find(".input").css({"min-width":e}).focus()},10),this},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.create()},handleBack:function(e){m.sendEvent("Introduction","Password For Create","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Create","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},create:function(){m.sendEvent("Introduction","Password For Create","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var o=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});e.$el.find(".tip").html(o.render().$el.fadeTo(500,1))}else e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:i,version:m.globals.version}),url:m.globals.urlRootLogin+"user/register"}).done(function(e){e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&m.conditionalFeatures.setFeatures(e.features)):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=Date.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){m.views.introduction.hideLoading(),e.loading=!1}))}}),m.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(e){var t=this,i={message:"What would you like your new password to be?"},o=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}});this.$el.html(this.template(i));var n=new m.views.ExpandableInput;this.$el.find("#introduction-question").after(n.render().$el),n.$el.attr("id","introduction-input"),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(o.render().$el),this.$el.find("input").attr("type","password").focus();var s=this;return setTimeout(function(){var e=s.$el.find(".introduction-question-title").outerWidth();s.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Password For Reset","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Reset","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.reset()},reset:function(){m.sendEvent("Introduction","Password For Reset","Submit");var i=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var o=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});i.$el.find(".tip").html(o.render().$el.fadeTo(500,1))}else i.loading||(i.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:m.models.customization.get("displayname"),email:e,password:t}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/forgot"}).done(function(e){m.commandManager.execute("notification.show","Password change started","Check your email to change your password. Your password change email may take a few moments to arrive."),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){i.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)}).always(function(){i.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.IntroductionTip=Backbone.View.extend({template:m.templates.introduction["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this}}),m.views.IntroductionButton=Backbone.View.extend({template:m.templates.introduction["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this},clicked:function(e){this.options.clicked()}}),m.views.ExpandableInput=Backbone.View.extend({attributes:{class:"width-dynamic input",spellcheck:"false"},tagName:"input",initialize:function(){},render:function(){function t(e){var t=e.val()||e.text()||e.attr("placeholder");return t||(t=""),t}this.fakeEl=$("<span>").hide().appendTo(document.body),this.fakeEl.text(t(this.$el)).css("font",this.$el.css("font"));var i=this;return this.$el.on("input",function(){i.fakeEl.text(t(i.$el)).css("font",i.$el.css("font"));var e=i.fakeEl.width();i.$el.css({width:e+20})}).trigger("input"),this}}),m.models.DropdownMenuItem=Backbone.Model.extend({}),m.collect.TopDropdownMenuItems=Backbone.Collection.extend({model:m.models.DropdownMenuItem,url:m.globals.urlRoot+"settings/todo/menu",fetchCompleted:!1,initialize:function(e,t){t&&t.listId&&(this.listId=t.listId)},parse:function(e){return e.menuoptions},fetchIfRequired:function(e){if(!this.fetchCompleted){var t={data:{},reset:this.fetchCompleted=!0,error:function(e,t,i){self.fetchCompleted=!1}};return e&&(t.data.providerId=e),this.fetch(t),!0}return!1},queueFetch:function(){this.fetchCompleted=!1},fetch:function(e){return this.listId?(additionalData={listId:this.listId},e.data=_.extend(e.data||{},additionalData),Backbone.Collection.prototype.fetch.call(this,e)):null}}),m.models.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},attemptSave:function(e,t){},retrySave:function(){this.get("isProxy")?this.collection.parentList&&this.collection.parentList.createNewModel&&this.collection.parentList.createNewModel(this):this.attemptedSaveValues&&this.attemptSave(this.model)},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t},isSibling:function(e){return e.get("parentId")==this.get("parentId")}}),m.models.Todo=m.models.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null,listId:"inbox"}},parse:function(e){return e&&e.done&&e.archive&&(e.listId="1-done"),e},archive:function(){this.setArchiveState(!0)},setArchiveState:function(e){var t={};t.archive=void 0===e?!this.get("archive"):e,t.archive?(t.archivedDate=new Date,this.get("done")||(t.done=!0,t.completedDate=new Date)):t.archivedDate=null,this.attemptSave(t)},toggleDoneState:function(){this.setDoneState()},setDoneState:function(e,t){var i=this.getDoneStateChanges(e,t);this.attemptSave(i),i.done&&m.sendEvent("Todo","Done"),m.trigger("todo:loadingStateChange",status)},getDoneStateChanges:function(e,t){var i={};if(i.done=void 0===e?!this.get("done"):e,i.done){var o=this.collection.parentList;if(o.has("done_disabled")){var n=o.get("done_disabled");return void(n.message&&m.trigger("todo:status",n))}i.completedDate=new Date,t&&(i.archive=!0,i.archivedDate=new Date)}else i.archive=!1,i.archivedDate=null,i.completedDate=null;return i},getTodayStateChanges:function(e){var t={};return(t.today=e)&&this.get("archive")&&(t.archive=!1,t.archivedDate=null),t},setTodayState:function(e){var t=this.getTodayStateChanges(e);this.attemptSave(t)},deleteItem:function(){this.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},attemptSave:function(e,n){var s=this;s.displayConnectingText('<i class="loading-icon"></i>Saving...');var t=s.saveOptions();t.wait=!0;var i=this.collection.parentList.project;e&&(e.projectId=this.get("projectId")||i.id,e.providerId=i.provider.id),t.success=function(){var e={};jQuery.extend(e,s.attemptedSaveValues),s.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",s.id,e),setTimeout(function(){s.set(e),s.successfulConnection(),n&&n(!0)},50)},t.error=function(e,t,i){if(200==t.status){var o={};jQuery.extend(o,s.attemptedSaveValues),s.attemptedSaveValues=null,jQuery.extend(o,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",s.id,o),setTimeout(function(){s.set(o),s.successfulConnection(),n&&n(!0)},50)}else{s.set({saveFailed:!0,isLoading:!1,deleted:!1,deletedDate:null}),m.trigger("todo:loadingStateChange"),s.failedConnection('Error saving… <span class="retry">Retry</span>'),n&&n(!1)}},e?(s.attemptedSaveValues?jQuery.extend(s.attemptedSaveValues,e):s.attemptedSaveValues=e,s.save(e,t)):s.attemptedSaveValues?(e=s.attemptedSaveValues,s.save(s.attemptedSaveValues,t)):s.pendingReorderData&&(s.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(s.pendingReorderData),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){s.set({isLoading:!1,saveFailed:!1})}).fail(function(e,t){s.set({saveFailed:!0,isLoading:!1})})),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),s.set(e),m.trigger("todo:changing",s.id,e)},comparator:"order",save:function(e,t){t||(t={}),e||(e=_.clone(this.attributes));try{if(this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data&&jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data}),this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data_cmd){var i=m.commandManager.execute(this.collection.parentList.collection.aux_data_cmd,this,this.collection.parentList.collection.aux_data);jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data,aux_data_result:i})}}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)},fetch:function(e){var t=e||{};return t.data=$.param({projectId:this.get("projectId"),providerId:this.get("providerId"),listId:this.get("listId")}),Backbone.Model.prototype.fetch.call(this,t)}}),m.models.TodoProxy=m.models.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.models.TodoList=Backbone.Model.extend({itemFetchStarted:!1,showAssignedTodosOnly:!1,defaults:{selected:!1},initialize:function(e,t){t&&(t.project&&(this.project=t.project),e.isDummy&&Object.assign(this.attributes,this.project.attributes)),this.itemCollection=new m.collect.Todos(null,{parentList:this}),this.listenTo(this.itemCollection,"add remove change reset",this.triggerChangeEvent),this.listenTo(this.itemCollection,"remainingCountChanged",this.remainingCountChanged),this.proxyCollection=new m.collect.TodoProxy(null,{parentList:this}),this.listenTo(this.proxyCollection,"add change",this.triggerChangeEvent),this.supportsFeature("assigned")&&this.refreshShowAssignedTodosOnly()},supportsFeature:function(e){return this.get("isDummy")?this.project.get(e+"_support"):this.get(e+"_support")},todoItemMenuOptions:function(){if(this.itemCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.itemCollection.menuOptions)),!this._todoItemMenuOptions){var e=[{captionText:"Edit",commandId:"todo.edit"},{captionText:"Set to Focus",commandId:"todo.focus.pin"},{css_class:"line"},{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}},{captionText:"Move Back",commandId:"todo.undone",options:{}},{captionText:"Move to...",commandId:"todo.moveTo"},{captionText:"Archive",commandId:"todo.archive"},{css_class:"line"},{captionText:"Delete",commandId:"todo.delete"}];m.conditionalFeatures.featureEnabled("plus")||e.splice(1,1),this._todoItemMenuOptions=new Backbone.Collection(e)}return this._todoItemMenuOptions},toggleSubtasks:function(){m.models.customization.get("assigned-"+this.id)||(this.allSubtasksLoaded=!0),this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},loadOldCompletedTodos:function(){this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},showAssignedTodosOnlyChanged:function(){this.refreshShowAssignedTodosOnly(),this.itemCollection.checkRemainingItemCount(),this.loadMineOnly||!this.allSubtasksLoaded&&m.models.customization.get("subtask-"+this.id)&&this.showAssignedTodosOnly||this.itemCollection.noAssigned&&!this.allFetched?(this.loadMineOnly=!1,this.itemFetchStarted=!0,this.loadMineOnly&&(this.allFetched=!0),this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})):m.trigger("todo:showAssignedTodosOnlyChanged",this.id),!m.models.customization.get("assigned-"+this.id)&&m.models.customization.get("subtask-"+this.id)&&(this.allSubtasksLoaded=!0)},refreshShowAssignedTodosOnly:function(){this.showAssignedTodosOnly=m.models.customization.get("assigned-"+this.id)},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},refreshItems:function(){this.doFetchIfNeeded(!0)},doFetchIfNeeded:function(e,t){this.loadedOnce||(this.loadMineOnly=!1,this.loadedOnce=!0),!e&&this.itemFetchStarted||(this.itemFetchStarted=!0,this.showAssignedTodosOnly&&(this.loadMineOnly=!0)),this.itemCollection.doFetchIfNeeded(t)},triggerChangeEvent:function(e){this.trigger("change",this),m.trigger("todo:globalChange",e)},getDefaultCommands:function(){return this.collection&&1!=this.collection.project.provider.id?[]:this.isDoneList()?[{commandId:"todo.undone",options:{}}]:[{commandId:"todo.toggle.today",options:{}}]},isDoneList:function(){return"done"==this.get("type")},isTodayList:function(){return"today"==this.get("type")},listType:function(){return this.get("type")},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},remainingTodoCount:function(){var e=this.get("count");return null!=e&&null!=e?e:""},remainingCountChanged:function(e){this.get("count")!=e&&this.set("count",e)},changeCount:function(e){if(void 0===this.get("count")){var t=this;setTimeout(function(){t.refreshItems()},500)}else this.set("count",this.get("count")+(e?1:-1)),this.collection&&this.collection.cacheLists()},supportsReordering:function(){return!!this.get("reorder")},groupingInfo:function(){return this.isDoneList()?{type:"date",field:"completedDate"}:this.itemCollection.groupingInfo?this.itemCollection.groupingInfo:null},createNewModel:function(e,t,i){var o={};this.collection&&1!=this.collection.project.provider.id&&(i=!1),(i=i||"top"==this.get("defaultTaskPosition"))&&(o={at:0}),this.addedToTop=i;var n=0;if("bottomOfIncomplete"==this.get("defaultTaskPosition")){for(;n<this.itemCollection.models.length&&!this.itemCollection.models[n].get("done");)n++;o={at:n}}var s=null;e instanceof Backbone.Model?s=e:(e.listId=this.id,this.isDoneList()&&(e.done=!0),this.isTodayList()&&(e.today=!0),e.viewSection=this.get("defaultSection"),s=new m.models.TodoProxy(e),this.proxyCollection.add(s,o)),this.showAssignedTodosOnly&&s.set("assigned",!0),s.set("viewSection",this.get("defaultSection"));var a=this;t?a.displayConnectingText('<i class="loading-icon"></i>Retrying...'):a.displayConnectingText('<i class="loading-icon"></i>Saving...'),s.set({saveFailed:!1,isLoading:!0});var l=this.collection?this.collection.project.getDefaultList():this,r=l?l.get("id"):null,d=a.isDoneList()&&r?r:s.get("listId"),c=null;Object.assign(o,{wait:!0,success:function(e){a.successfulConnection(),i&&1==a.project.provider.id&&c?(c.move_id=e.get("id"),a.waitForReorder=!0,a.itemCollection.reorderItem(c,function(){s.set("proxyValid",!1),a.waitForReorder=!1})):s.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(e,t,i){a.failedConnection('Error saving… <span class="retry">Retry</span>'),s.set({saveFailed:!0,isLoading:!1}),s.targetList=a}}),0<a.itemCollection.models.length&&(c={move_target_id:a.itemCollection.models[0].get("id"),move_offset:"-1",list_id:d}),a.itemCollection.create({title:s.get("title"),listId:s.get("listId"),today:s.get("today"),done:s.get("done"),assigned:s.get("assigned"),homeListId:d,viewSection:s.get("viewSection"),providerId:this.project.provider.id,projectId:this.project.id,completedDate:s.get("done")?new Date:null},o)}}),m.models.TodoProject=Backbone.Model.extend({itemFetchStarted:!1,defaults:{selected:!1},initialize:function(e,t){t&&t.provider?this.provider=t.provider:this.get("providerId")&&m.models.todoListManager&&(this.provider=m.models.todoListManager.todoProviderDetails(this.get("providerId"),!0)),this.listCollection=new m.collect.ProjectTodoLists(null,{project:this,prefetchTodos:this.prefetchTodos,isDummy:!(void 0===this.get("supportLists")?this.provider.get("supportLists"):this.get("supportLists"))}),this.listenTo(this,"add",this.onAdd),this.listenTo(this.listCollection,"add remove change reset selectionChanged",this.triggerChangeEvent)},todoItemMenuOptions:function(){return this.listCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.listCollection.menuOptions)),this._todoItemMenuOptions},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},resetSelection:function(){this.listCollection.selectedListId=null},refreshItems:function(){this.doFetchIfNeeded(!0)},triggerChangeEvent:function(e){this.trigger("change",this),m.trigger("todo:globalChange",e)},doFetchIfNeeded:function(e){!e&&this.fetchStarted||(this.fetchStarted=!0,this.listCollection.doFetchIfNeeded(e))},refreshTodoItems:function(){var e=this.selectedList();e?e.refreshItems():this.listCollection.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(e){return this.listCollection.getListOfType(e)},getListById:function(e){return this.listCollection.getListById(e)},triggerParentChangeEvent:function(){this.trigger("change",this),this.listCollection.doFetchIfNeeded(!0)},selectedList:function(){return this.listCollection?this.listCollection.selectedList():null},projectStatus:function(){if(this.listCollection.listStatus)return this.listCollection.listStatus;var e=this.selectedList();return e?e.listCollection.listStatus:null},addNewList:function(e,t,i){var o=this,n=m.globals.urlRootApi+"todos/lists",s={providerId:m.models.todoListManager.activeProvider.id,projectId:this.id,title:e};$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:n}).done(function(e){e&&e.success&&o.listCollection.fetch({success:function(){o.selectList(e.id),t&&t()}})}).fail(function(e,t){i&&i()})},selectList:function(e){this.listCollection.selectItem(e),this.provider.trigger("change",this.provider)},getNeighboringList:function(e){if(this.listCollection){var t=this.listCollection.selectedList();if(t){var i=this.listCollection.indexOf(t);if(0<e&&i<this.listCollection.length-1||e<0&&0<i)return this.listCollection.at(i+e)}}return null},selectPreviousList:function(){var e=this.getNeighboringList(-1);e&&this.selectList(e.id)},selectNextList:function(){var e=this.getNeighboringList(1);e&&this.selectList(e.id)}}),m.models.TodoProvider=Backbone.Model.extend({fetchStarted:!1,initialize:function(e){this.prefetchTodos=this.get("prefetchTodos"),void 0===e.supportLists&&(this.attributes.supportLists=!0,this.attributes.supportProjects=!1),this.projectCollection=new m.collect.ProviderTodoProjects(null,{provider:this,prefetchTodos:this.prefetchTodos,isDummy:!this.get("supportProjects")}),this.get("supportProjects")&&(this.allProjectsCollection=new m.collect.ProviderTodoProjectsAll(null,{provider:this})),this.listenTo(this.projectCollection,"reset",this.projectsAvailable),this.get("supportProjects")&&this.listenTo(this.allProjectsCollection,"sync",this.projectsAvailableSynced),this.listenTo(this,"add",this.onAdd),this.listenTo(m,"globalEvent:altUp",this.altReleased),this.listenTo(this.projectCollection,"reset selectionChanged",this.triggerChangeEvent)},isProviderModel:function(){},refreshItems:function(){this.projectCollection.fetch({reset:!0})},doFetchIfNeeded:function(e){!e&&this.fetchStarted||(this.fetchStarted=!0,this.projectCollection.doFetchIfNeeded(e))},getAllProjects:function(){if(this.allProjectsCollection&&0<this.allProjectsCollection.length)return this.allProjectsCollection;var e=localStorage.getItem("cachedTodoProjects-"+this.id);return!e||this.loadingFromCache||this.allProjectsCollection.loading?this.refreshAllProjects():(this.loadingFromCache=!0,this.allProjectsCollection.reset(JSON.parse(e)),this.loadingFromCache=!1),this.allProjectsCollection},projectsAvailableSynced:function(){var o=this;this.projectCollection.models.map(function(e,t){var i=o.allProjectsCollection.findWhere({id:e.get("id")});i?e.set("title",i.get("title")):(o.projectCollection.models.splice(t,1),o.projectCollection.length--)}),this.cacheAllProjects(),m.trigger("todo:allProjectsLoaded")},refreshAllProjects:function(){this.allProjectsCollectionSynced||(this.allProjectsCollectionSynced=!0,this.allProjectsCollection&&this.allProjectsCollection.doFetchIfNeeded()&&m.trigger("todo:allProjectsLoaded"))},cacheAllProjects:function(){var e=new Date;localStorage.setItem("tsCachedTodoProjects-"+this.id,JSON.stringify(e.getTime()));var t=this.allProjectsCollection.toJSON();localStorage.setItem("cachedTodoProjects-"+this.id,JSON.stringify(t))},projectsAvailable:function(){this.selectedProject()&&this.selectedProject().doFetchIfNeeded()},refreshTodoItems:function(){var e=this.selectedProject();e?e.refreshTodoItems():this.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(e){return this.selectedProject().getListOfType(e)},getListById:function(e){return this.selectedProject().getListById(e)},triggerChangeEvent:function(){this.trigger("change",this)},triggerParentChangeEvent:function(){this.trigger("change",this),this.projectCollection.doFetchIfNeeded(!0)},selectedList:function(){var e=this.selectedProject();return e?e.selectedList():null},selectedProject:function(){return this.projectCollection?this.projectCollection.selectedProject():null},providerStatus:function(){if(this.projectCollection.projectStatus)return this.projectCollection.projectStatus;var e=this.selectedProject();if(e&&e.listCollection.projectStatus)return e.listCollection.projectStatus;var t=this.selectedList();return t?t.itemCollection.listStatus:null},selectList:function(e){this.selectedProject().selectList(e)},selectProject:function(e,t){var i=this.projectCollection.get(e);i?(this.projectCollection.selectItem(e),t&&i.set({last_active:(new Date).toISOString()})):this.allProjectsCollection&&(i=this.allProjectsCollection.get(e))&&(this.projectCollection.add(i),this.projectCollection.selectItem(e),t&&i.set({last_active:(new Date).toISOString()})),t&&m.trigger("todo:resetProjectList")},getNeighboringProject:function(e){var t=this.projectCollection;if(t=t.sortBy("last_active").reverse()){var i=this.selectedProject();if(i){var o=t.indexOf(i);if(0<e&&o<t.length-1||e<0&&0<o)return t[o+e]}}return null},selectPreviousProject:function(){this.altReleased=!1;var e=this.getNeighboringProject(-1);e&&(this.watchingAlt=!0,this.selectProject(e.id,!1))},selectNextProject:function(){this.altReleased=!1;var e=this.getNeighboringProject(1);e&&(this.watchingAlt=!0,this.selectProject(e.id,!1))},altReleased:function(){(this.altReleased=!0,this.watchingAlt)&&(this.selectedProject().set({last_active:(new Date).toISOString()}),m.trigger("todo:resetProjectList"))}}),m.collect.TodoProxy=Backbone.Collection.extend({model:m.models.TodoProxy,initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList)}}),m.collect.TodosBase=Backbone.Collection.extend({model:m.models.Todo,saveOptions:{},initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList),localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"sync",this.onSync),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.fetchedOnce=!0,this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onSync:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged"),m.trigger("todo:listSync")},onNewDay:function(){this.fetchedOnce&&(this.parentList&&m.models.todoListManager&&m.models.todoListManager.activeProvider.selectedList().id!==this.parentList.id||this.fetch({reset:!0}))},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){var n=this;return this.filter(function(e){var t=e.get("completedDate");if(t){var i="";if(t instanceof Date)i=activeDateStringForDate(t);else{var o=t.split("T");if(1<o.length)i=o[0]}if(i!=getActiveDateString())return!1}if(1==e.get("done")&&0==e.get("archive")&&0==e.get("deleted")&&e.get("listId")==n.parentList.id)return!0})},completedCount:function(){return this.completeToday().length},activeToday:function(){var i=this;return this.parentList.isDoneList()?this.where({deleted:!1,done:!0}):this.filter(function(e){if(0==e.get("archive")&&0==e.get("deleted")){var t=e.get("listId");if(t==i.parentList.id||!t)return!0;if("1-##default"==i.parentList.id)return!0}})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){var e=this.activeToday();return this.parentList.isDoneList()?e:_.filter(e,function(e){return!e.get("done")})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return null==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.ProjectTodoLists=Backbone.Collection.extend({model:m.models.TodoList,url:m.globals.urlRoot+"todos/lists",loadedFromCache:!1,listStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(m,"globalEvent:resetLists",this.resetLists),this.project=t.project,t)if(this.project=t.project,t.isDummy)this.setAsDummy();else{t.prefetchTodos&&(this.externallyFetchedOnce=!0),t.provider&&(this.provider=t.provider);var i=this.listCacheKey(),o=localStorage[i];if(o){var n=JSON.parse(o);n&&0<n.length&&(this.loadedFromCache=!0,this.reset(n,{project:this.project}))}}},comparator:"order",resetLists:function(e){(!e||e.providerId==(this.provider||this.project.provider).id||e.listId&&this.get(e.listId))&&this.fetch()},setAsDummy:function(){this.isDummy=!0,this.models=[],this.models.push(new m.models.TodoList({id:this.project.get("id"),title:this.project.get("title"),isDummy:!0},{project:this.project}))},mergeLists:function(e){var t=e;e&&e.lists&&(t=e.lists);var i=this,o=this.selectedList();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(o)){var n=this.models[0];this.selectItem(n.id)}},listCacheKey:function(){return this.project?"listCache-"+this.project.id:"listCache-default"},selectedListCacheKey:function(){return this.project?"activeTodoListId-"+this.project.id:null},cacheLists:function(){var e=JSON.stringify(this.models),t=this.listCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.isDummy&&(this.selectedList().doFetchIfNeeded(),this.trigger("reset")),this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){if(null!=e)return e.setAsDummy?(this.setAsDummy(),this.doFetchIfNeeded(!0),[]):(e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.providerReset&&m.models.todoListManager.resetProvider(e.providerReset),e.lists)},handleCountChanged:function(){this.checkSelectedList(),this.cacheLists()},collectionSync:function(){this.setStatus("Done"),this.checkSelectedList(this.forceFetch),this.forceFetch=!1,this.cacheLists()},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var o=this;if(!this.isDummy){var t=e||{};if(this.project){var i={};i.data={provider_id:this.project.get("providerId"),project_id:this.project.get("id")},t=_.extend(t,i)}return t.error=function(e,t,i){this.externallyFetchedOnce=!0,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?o.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):o.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},t&&null!=t.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),t.project=this.project,Backbone.Collection.prototype.fetch.call(this,t)}setTimeout(function(){o.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedList(this.forceFetch),this.forceFetch=!1},selectedList:function(){var e;if(this.selectedListId&&this.get(this.selectedListId))e=this.get(this.selectedListId);else{if(!(e=this.findWhere({selected:!0}))&&(e=this.getListOfType("today"))){var t=this.getListOfType("inbox");t&&t.doFetchIfNeeded()}e||(e=this.getListOfType("inbox")),e?this.selectItem(e.id):this.models.length&&(e=this.models[0],this.selectItem(e.id)),!e&&this.models.length&&(e=this.models[0])}return e?(this.selectItem(e.id),e):null},getListOfType:function(e){return this.findWhere({type:e})},getListById:function(e){return this.findWhere({id:e})},unselectedLists:function(){var t=this;return this.selectedListId?this.reject(function(e){return e.id==t.selectedListId}):this.toArray()},isDoneList:function(){var e=this.selectedList();return!(!e||!e.get("done"))},checkSelectedList:function(e){if(!this.selectedListId){var t=null,i=this.selectedListCacheKey();if(i&&localStorage.getItem(i)){var o=localStorage.getItem(i);t=this.findWhere({id:o})}t||(t=this.findWhere({selected:!0})),!t&&0<this.models.length&&(t=this.models[0]),t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedListId){var t=this.selectedListCacheKey();t&&localStorage.setItem(t,e),this.selectedListId=e,this.project.triggerChangeEvent("Selected"),this.project.provider.triggerChangeEvent(),null!=e&&this.externallyFetchedOnce&&this.selectedList().doFetchIfNeeded(!1,!0)}}}),m.collect.ProviderTodoProjectsAll=Backbone.Collection.extend({model:m.models.TodoProject,url:m.globals.urlRoot+"todos/projects/all",loadedFromCache:!1,projectStatus:null,initialize:function(e,t){this.listenTo(this,"sync",this.collectionSync),this.provider=t.provider},comparator:"order",collectionSync:function(){this.loaded=!0,this.loading=!1},mergeProjects:function(e){var t=e;e&&e.projects&&(t=e.projects);var i=this,o=this.selectedProject();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(o)){var n=this.models[0];this.selectItem(n.id)}},doFetchIfNeeded:function(e){return e||!this.loaded&&!this.loading?(this.fetch(),!(this.loading=!0)):!!this.loaded||void 0},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.projects},fetch:function(e){var t=this,i=e||{};if(i.reset=!0,this.provider){var o={};o.data={provider_id:this.provider.id},i=_.extend(i,o)}return i.error=function(){t.loading=!1,m.trigger("todo:failedLoadingItems")},this.reset(null,{silent:!0}),Backbone.Collection.prototype.fetch.call(this,i)}}),m.collect.ProviderTodoProjects=Backbone.Collection.extend({model:m.models.TodoProject,url:m.globals.urlRoot+"todos/projects",loadedFromCache:!1,projectStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"add",this.cacheProjects),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(m,"globalEvent:resetLists",this.fetch),this.provider=t.provider,t&&t.isDummy){this.isDummy=!0,this.models=[];var i=new m.models.TodoProject({id:this.provider.get("id"),title:this.provider.get("title"),isDummy:!this.provider.get("supportProjects"),providerId:this.provider.get("id")},{provider:this.provider});this.models.push(i)}t&&t.prefetchTodos&&(this.externallyFetchedOnce=!0),t&&t.allProjects&&(this.allProjects=!0,this.url+="/all");var o=this.projectCacheKey(),n=localStorage[o];if(n){var s=JSON.parse(n);s&&0<s.length&&(this.loadedFromCache=!0,this.reset(s,{provider:this.provider}))}},comparator:"order",mergeProjects:function(e){var t=e;e&&e.projects&&(t=e.projects);var i=this,o=this.selectedProject();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(o)){var n=this.models[0];this.selectItem(n.id)}},fetchSelectedProject:function(){var e=this.selectedProject();e&&e.doFetchIfNeeded()},projectCacheKey:function(){return this.provider?"projectCache-"+this.provider.id:"projectCache-default"},selectedProjectCacheKey:function(){return this.provider?"activeTodoProjectId-"+this.provider.id:null},cacheProjects:function(){var e=JSON.stringify(this.models),t=this.projectCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.projects},handleCountChanged:function(){this.checkSelectedProject(),this.cacheProjects()},collectionSync:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1,this.cacheProjects()},setStatus:function(e){this.projectStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var o=this;if(!this.isDummy){var t=e||{};if(this.provider){var i={};i.data={provider_id:this.provider.id},t=_.extend(t,i)}return t.error=function(e,t,i){this.externallyFetchedOnce=!0,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?o.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):o.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},t&&null!=t.reset?this.setStatus({status:"loading",message:"Loading..."}):this.projectStatus&&"loading"!=this.projectStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,t)}setTimeout(function(){o.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1},selectedProject:function(){var e;return this.selectedProjectId&&this.findWhere({id:this.selectedProjectId})?this.findWhere({id:this.selectedProjectId}):((e=this.findWhere({selected:!0}))?this.selectItem(e.id):this.models.length&&(e=this.models[0],this.selectItem(e.id)),e||null)},getProjectById:function(e){return this.findWhere({id:e})},checkSelectedProject:function(e){if(!this.selectedProjectId){var t=null,i=this.selectedProjectCacheKey();if(i&&localStorage.getItem(i)){var o=localStorage.getItem(i);t=this.findWhere({id:o})}if(t||(t=this.findWhere({selected:!0})),!t&&0<this.models.length)return t=this.models[0],void this.selectItem(t.id);t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedProjectId){var t=this.findWhere({id:this.selectedProjectId});t&&t.resetSelection();var i=this.selectedProjectCacheKey();i&&localStorage.setItem(i,e),this.selectedProjectId=e,this.trigger("selectionChanged"),null!=e&&this.externallyFetchedOnce&&this.selectedProject().doFetchIfNeeded()}}}),m.collect.Todos=m.collect.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},listStatus:null,firstLoadCompleted:!1,reorderItem:function(e,t){var i=this,o={operations:[{REORDER:Object.assign({},e)}]},n=this.get(e.move_id);if(n){n.set({isLoading:!0});var s=n.collection.parentList.project;o.providerId=s.provider.id,o.projectId=s.id,$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(o),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){n.set({isLoading:!1}),i.fetch({success:t})}).fail(function(e,t){n.pendingReorderData=o,n.set({saveFailed:!0,isLoading:!1})})}},onLoadingFromServerChanged:function(){this.setStatus("Done"),this.checkRemainingItemCount()},onCollectionChanged:function(e){this.checkRemainingItemCount()},completedCount:function(){return this.completeToday().length},checkRemainingItemCount:function(){if(!this.loadingFromServer){this.firstLoadCompleted=!0;var e=this.remaining().length;e!=this.previousCount&&(this.previousCount=e,this.trigger("remainingCountChanged",e))}},doFetchIfNeeded:function(e){this.firstItemFetchStarted?this.fetch(this.moreLoaded?{remove:!1,listChanged:e}:{listChanged:e}):(this.firstItemFetchStarted=!0,this.fetch({reset:!0}))},loadMore:function(e){this.moreLoaded=!0,this.todoChangedListener||(this.todoChangedListener=!0,this.listenTo(m,"todo:changed",this.todoChanged)),this.fetch({endDate:e,remove:!1})},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},parse:function(e){if(null!=e)return e.items?(e.sections?this.itemSections=e.sections:this.itemSections=null,e.hasOldTodos?this.hasOldTodos=e.hasOldTodos:this.hasOldTodos=!1,e.menu_options?this.menuOptions=e.menu_options:this.menuOptions=null,e.default_commands?this.defaultCommands=e.default_commands:this.defaultCommands=null,this.noAssigned=e.noAssigned,this.groupingInfo=e.groupingInfo,e.items):e},todoChanged:function(e){if(this.moreLoaded){var t=this.get(e);t&&t.fetch()}},activeToday:function(){var i=this;if(!this.firstItemFetchStarted)return this.parentList.doFetchIfNeeded(),[];if(this.parentList.isDoneList()){if(i.parentList.showAssignedTodosOnly&&!item.get("assigned"))return;return this.where({deleted:!1,done:!0})}return this.filter(function(e){if((!i.parentList.showAssignedTodosOnly||e.get("assigned"))&&(!e.get("today")||i.parentList.isTodayList())&&(e.get("today")||!i.parentList.isTodayList())&&e.get("title")&&0!=e.get("title").length&&0==e.get("archive")&&0==e.get("deleted")){var t=e.get("listId");if(t==i.parentList.id||e.get("today")&&i.parentList.isTodayList()||!t)return!0;if("1-##default"==i.parentList.id)return!0}})},fetch:function(e){var o=this;if(!this.loadingFromServer){this.loadingFromServer=!0;var t={data:{}};return this.parentList&&(t.data.listId=this.parentList.id),this.parentList.project&&!this.parentList.project.get("isDummy")&&(t.data.projectId=this.parentList.project.get("id"),t.data.providerId=this.parentList.project.provider.get("id")),m.models.customization.get("assigned-"+this.parentList.id)&&(t.data.loadMineOnly=!0),m.models.customization.get("subtask-"+this.parentList.id)&&(t.data.loadSubtasks=!0),m.models.customization.get("showOld-"+this.parentList.id)&&(t.data.loadOldCompleted=!0),e&&e.endDate&&(t.data=t.data||{},t.data.endDate=e.endDate),t.error=function(e,t,i){o.loadingFromServer=!1,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?o.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):o.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},(e=_.extend(e||{},t))&&null!=e.reset?(this.setStatus({status:"loading",message:"Loading...",listChanged:e.listChanged}),this.moreLoaded=!1):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading...",listChanged:e.listChanged}),Backbone.Collection.prototype.fetch.call(this,e)}}}),m.collect.TodoProviders=Backbone.Collection.extend({model:m.models.TodoProvider,url:m.globals.urlRoot+"todos/providers",loadedOnce:!1,initialize:function(e,t){this.listenTo(this,"reset",this.collectionReset)},collectionReset:function(){this.loadedOnce=!0},parse:function(e){return e.connected?e.connected:null}}),m.models.TodoListManager=Backbone.Model.extend({mergeLists:function(e){},defaults:{activeTodoList:null},initialize:function(e){if(e&&e.prefetchTodos&&(this.prefetchTodos=!0),this.todoProviders=new m.collect.TodoProviders,this.listenTo(m,"globalEvent:refreshInbox",this.refreshInbox),this.listenTo(this.todoProviders,"reset",this.todoProvidersReset),localStorage.activeTodoProvider){var t=JSON.parse(localStorage.activeTodoProvider);t&&t.id?this.changeProvider(t.id,!0,t):t?this.changeProvider(t,!0):this.changeProvider(1,!0)}else this.changeProvider(1,!0)},refreshInbox:function(){this.activeProvider.selectedProject().getDefaultList()&&this.activeProvider.selectedProject().getDefaultList().refreshItems()},triggerChangeEvent:function(){this.trigger("change",this)},doFetchIfNeeded:function(e){this.externallyFetchedOnce=!0,this.activeProvider.doFetchIfNeeded(e)},changeProvider:function(e,t){var i=this.todoProviderDetails(e,!0);if(!i){var o={id:e,prefetchTodos:this.prefetchTodos};1==e&&(o.add_lists=!0,o.supportLists=!0,o.supportProjects=!1),this.todoProviders.add(o),this.todoProviders.fetch({reset:!0}),i=this.todoProviders.get(e)}null==i.get("supportProjects")&&(i.set("supportProjects",!1),i.set("supportLists",!0)),i&&this.activeProvider!=i&&(m.trigger("todo:topmenu:reset"),localStorage.activeTodoProvider=JSON.stringify(i.id),this.activeProvider&&this.stopListening(this.activeProvider),this.activeProvider=i,this.listenTo(this.activeProvider,"change",this.triggerChangeEvent),this.triggerChangeEvent(),(this.externallyFetchedOnce||this.prefetchTodos)&&this.activeProvider.refreshTodoItems(),m.trigger("todo:providerChanged",e))},switchProject:function(e){this.activeProvider.selectProject(e,!0)},todoProvidersReset:function(){this.pendingResetCallback&&(this.pendingResetCallback(),this.pendingResetCallback=null)},resetProvider:function(e){-1<(e.id+"").indexOf(this.activeProvider.id)&&this.todoProviders.remove(this.activeProvider),this.todoProviders.add(e),this.fetchAndCacheTodoProviders(),this.changeProvider(e.id)},todoProviderDetails:function(e,t){var i;if(this.todoProviders){if(0<this.todoProviders.length&&(i=this.todoProviders.get(e)))return i;if(this.cachedTodoProviders){if(!(i=this.cachedTodoProviders.findWhere({id:e+""}))){var o=e+"-";this.cachedTodoProviders.forEach(function(e){0<=e.id.indexOf(o)&&(i=e)})}if(i)return t&&!i.isProviderModel&&(this.cachedTodoProviders.remove(i),i=new m.models.TodoProvider(i.attributes),this.cachedTodoProviders.add(i)),i}if(localStorage.cachedTodoProviders){var n=JSON.parse(localStorage.cachedTodoProviders);this.cachedTodoProviders=new Backbone.Collection;if(this.cachedTodoProviders.reset(n),i=this.cachedTodoProviders.get(e+"")){if(localStorage.tsCachedTodoProviders){var s=new Date,a=JSON.parse(localStorage.tsCachedTodoProviders);new Date(a)<new Date(s.getTime()-864e5)&&this.fetchAndCacheTodoProviders()}else this.fetchAndCacheTodoProviders();return t&&(this.cachedTodoProviders.remove(i),i=new m.models.TodoProvider(i.attributes),this.cachedTodoProviders.add(i)),i}}return this.fetchAndCacheTodoProviders(),null}},fetchAndCacheTodoProviders:function(e){var t=this;this.fetchingTodoProviders||(this.fetchingTodoProviders=!0,this.pendingResetCallback=function(){t.cacheTodoProviders(),e?e():t.triggerChangeEvent()},this.todoProviders.fetch({reset:!0}))},cacheTodoProviders:function(){if(this.todoProviders&&this.todoProviders.loadedOnce){var e=new Date;localStorage.setItem("tsCachedTodoProviders",JSON.stringify(e.getTime()));var t=this.todoProviders.toJSON();localStorage.setItem("cachedTodoProviders",JSON.stringify(t))}},selectPreviousProvider:function(){var o=this,e=function(){var e=o.todoProviders.get(o.activeProvider.id);if(e){var t=o.todoProviders.indexOf(e);if(0<t){var i=o.todoProviders.at(t-1);i&&o.changeProvider(i.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?e():this.fetchAndCacheTodoProviders(e))},selectNextProvider:function(){var o=this,e=function(){var e=o.todoProviders.get(o.activeProvider.id);if(e){var t=o.todoProviders.indexOf(e);if(t<o.todoProviders.length-1){var i=o.todoProviders.at(t+1);i&&o.changeProvider(i.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?e():this.fetchAndCacheTodoProviders(e))}}),m.views.TodoDropdownMenu=Backbone.View.extend({template:m.templates.todos.dropdownmenu,expanded:!1,renderedOnce:!1,menuOptionsFetched:!1,events:{"click .control-dropdown":"toggleDropdown","dblclick .control-dropdown":"eatDblClick","click li":"clickMenuItem","click .show-dropdown-detail":"showDropdownDetail","click .dropdown-detail-back":"hideDropdownDetail","mouseover .todo-project-dropdown":"removeActiveItemClass","mouseleave .todo-project-dropdown":"addActiveItemClass","click .failed-loading":"retryLoadingItems"},initialize:function(e){this.submenu=null,this.menuItems=e.menuItems,this.loadAllOnExpand=e.loadAllOnExpand,this.parentContext=e.parentContext,this.comparisonNode=e.comparisonNode,this.iClassName=e.iClassName,this.dropdownClassName=e.dropdownClassName,this.providerLogo=e.providerLogo,this.keepOpen=e.keepOpen,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.listenTo(m,"globalEvent:closeDropdowns",this.closeDropdown),this.listenTo(m,"globalEvent:esc globalEvent:click",this.closeDropdown),this.listenTo(m,"todo:submenuUpdate",this.showDropdownDetail),this.listenTo(this.menuItems,"failedLoadingItems",this.failedLoading),this.listenTo(m,"todo:providerChanged",this.resetMenuItems),this.subViews=[]},render:function(){var e={};e.providerLogo=this.providerLogo,this.iClassName&&(e.iClassName=this.iClassName),"icon-cog"==this.iClassName&&(e.iClassName=""),this.dropdownClassName&&(e.dropdownClassName=this.dropdownClassName);var t=this.template(e);this.$el.html(t),this.$dropdown=$(this.$el.find(".dropdown")[0]),this.$dropdownList=$(this.$el.find(".dropdown-list")[0]),this.$todoProjectDropdown=$(".todo-project-dropdown .dropdown-list"),this.isOpen&&this.keepOpen&&(this.renderMenuOptions(),this.setExpandedState(!0));var i=this;this.dropdownClassName.includes("todo-project-dropdown")&&this.$todoProjectDropdown.scroll(function(){i.refreshItems()})},updateModel:function(e){this.model=e},resetMenuItems:function(){this.menuOptionsFetched=!1,this.isLoading=!1,this.itemsRefreshed=!1;var e=this.expanded;delete this.expanded,e&&this.setExpandedState(e)},setExpandedState:function(e,t){if(this.expanded!=e){this.expanded=null!=e?e:!this.expanded,this.$el.toggleClass("active",this.expanded),this.$dropdown.closest(".dropdown-parent").toggleClass("dropdown-parent-active",this.expanded);var i=this;this.expanded?(this.$dropdown.show(),t?(i.$dropdown.css({opacity:1,display:"block"}),this.renderMenuOptions(),i.ensureVisible(i.$dropdown.outerHeight()),this.$dropdown.hasClass("todo-project-dropdown")&&i.forceScrollableHeight(i.$dropdown)):setTimeout(function(){i.$dropdown.css({opacity:1,display:"block"}),i.renderMenuOptions(),i.ensureVisible(i.$dropdown.outerHeight()),i.$dropdown.hasClass("todo-project-dropdown")&&i.forceScrollableHeight(i.$dropdown)},10),this.isOpen=!0):(this.$dropdown.css("opacity",0),this.hideDropdownDetail(null),this.isOpen=!1,setTimeout(function(){i.$dropdown.css("opacity")<.7&&i.$dropdown.hide()},300))}},forceScrollableHeight:function(e){if(e.find(".dropdown-list").children().length<=7){var t=e.outerHeight();e.addClass("short-list"),e.find(".dropdown-list").css("max-height",t)}else e.removeClass("short-list")},eatDblClick:function(e){e&&(e.preventDefault(),e.stopPropagation())},closeDropdown:function(e){this!=e&&!0===this.expanded&&this.setExpandedState(!1)},attachMenuItems:function(e,t){this.isLoading=!1,this.menuItems&&this.menuItems!=t&&this.stopListening(this.menuItems),this.$el[0]!=e[0]&&(this.setElement(e),this.renderedOnce=!1),this.menuItems!=t&&(this.menuItems=t,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.menuOptionsFetched=!1),this.render()},renderMenuOptions:function(){var o=this;if(this.items=this.getActiveMenuOptions(),this.items&&0<this.items.length){this.$dropdownList.html("");var e=this.items.filter(function(e){return m.commandManager.canExecute(e.get("commandId"),o.model,e.get("options"),o.parentContext)}),n=e.length;if(0<n){var s=0,a=null;_.each(e,function(e){var t,i=e.get("css_class");(!i||"line"!=i||"line"!=a&&"header"!=a)&&("line"!=i||0!=s&&s!=n-1?(t=o.buildMenuItem(e),o.$dropdownList.append(t)):s+=1,s+=1,a=i)})}}else 0==this.items&&o.$dropdownList.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>');10<o.$dropdownList.outerHeight(!0)&&(m.trigger("todolist:updateHeight",o.$dropdownList.outerHeight(!0)+5),this.ensureVisible(this.$dropdown.outerHeight(!0))),this.menuOptionsFetched=!0},buildMenuItem:function(e){var t,i=m.commandManager.getProperties(e.get("commandId"),this.model,e.get("options"),this.parentContext);i&&i.captionText&&(t=i.captionText);var o=e.get("css_class"),n=$("<li/>");e.id?n.attr("data-itemid",e.id):n.attr("data-itemid",e.cid),e.get("toolTip")&&n.attr("title",e.get("toolTip"));var s=$("<span/>");if(s.addClass("dropdown-list-label"),s.text(t||e.get("captionText")),n.append(s),e.get("imageUrl")){var a=$("<img />");a.addClass("dropdown-list-icon"),e.get("captionText").includes("GitHub")&&a.addClass("GitHub"),a.attr("src",e.get("imageUrl")),n.prepend(a)}if(e.get("color")){var l=$("<span />");l.html("&nbsp;"),l.addClass("todo-list-color menu-item-color"),l.css("background-color",e.get("color")),n.prepend(l)}if(e.get("todoIcon")&&($svg=e.get("todoIcon"),n.prepend($svg)),e.get("checkStateCmd")){var r=m.commandManager.execute(e.get("checkStateCmd"),this.model,e.get("options"),this.parentContext);e.get("todoIcon")?r?n.children().first().addClass("active"):n.children().first().removeClass("active"):r&&n.prepend('<i class="icon icon-check dropdown-list-icon"></i>')}return o&&n.addClass(o),n},getActiveMenuOptions:function(){return!(this.menuItems&&this.menuItems.fetchIfRequired&&this.menuItems.fetchIfRequired(this.model.collection.provider.id))&&this.menuItems},toggleDropdown:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.expanded||m.trigger("globalEvent:closeDropdowns",this),this.loadAllOnExpand&&!this.expanded&&this.showAllAvailableItems(),this.setExpandedState(!this.expanded)},clickMenuItem:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("itemid");if(t&&this.items){var i=this.items.get(t);null==i&&(i=this.submenu.items.get(t));var o=i.get("commandId");if(void 0===o)return;var n=m.commandManager.getCommand(o);isOpen=this.isOpen,this.isOpen=!1;var s=n.execute(this.model,i.get("options"),this.parentContext);this.isOpen=isOpen,n.getSubmenu&&(this.submenu=n.getSubmenu()),i.get("checkStateCmd")&&this.renderMenuOptions(),s||this.closeDropdown(),n.getSubmenu&&(this.listenTo(this.submenu.items,"sync",this.showDropdownDetail),this.submenu.items.fetchIfRequired&&this.submenu.items.fetchIfRequired(this.parentContext.id),this.showDropdownDetail())}},expandedHeight:function(){return this.expanded?this.$dropdown.outerHeight():0},ensureVisible:function(e){var t=$(this.comparisonNode);if(this.comparisonNode&&this.$dropdown&&this.expanded){var i,o=this.$dropdown.parentsUntil(".todo-item").parent(),n=e;n>t.outerHeight()&&(i=Math.min(n+5,document.body.getBoundingClientRect().height-150),m.trigger("todolist:updateHeight",i));var s=t.offset().top+t.outerHeight()-(o.offset().top+o.outerHeight()+n);s<0?this.$dropdown.css({top:Math.max(t.offset().top-o.offset().top,s+18)+"px",right:"30px"}):this.$dropdown.css({top:"20px"}),this.$dropdown.css({bottom:"auto"}).show()}else this.$dropdown&&!this.expanded&&m.trigger("todolist:updateHeight",0)},showDropdownDetail:function(){if(this.submenu){var o=this,n=$(this.$el.find(".dropdown-detail")[0]);if(n.html(""),this.submenu.items&&0<this.submenu.items.length){n.removeClass("todo-provider-loading"),this.$dropdown.hasClass("todo-actions-dropdown")&&this.$el.find(".dropdown").addClass("provider-submenu");var e=this.submenu.items.length,t=this.submenu.title;t?n.append($('<li class="dropdown-detail-back dropdown-title">'+t+"</li>")):n.append($('<li class="dropdown-detail-back dropdown-list-label"><i class="icon icon-left dropdown-detail-title-back"></i></li>'));if(0<e){var s=null,i=this.submenu.items.models.filter(function(e){return m.commandManager.canExecute(e.get("commandId"),o.model,e.get("options"),o.parentContext)});_.each(i,function(e){var t=e.get("css_class");if(!t||"line"!=t||"line"!=s&&"header"!=s){var i=o.buildMenuItem(e);n.append(i),1,s=t}})}var a=this.$el.find(".dropdown-detail").outerHeight(!0);m.trigger("todolist:updateHeight",a),this.$el.find(".dropdown").addClass("show-detail").height(a),setTimeout(function(){o.ensureVisible(a+20)},0)}else n.addClass("todo-provider-loading"),n.append($('<li class="loading dropdown-detail-back dropdown-title u--no-hover">Loading...</li>')),this.$el.find(".dropdown").addClass("show-detail")}},hideDropdownDetail:function(e){var t=this.$el.find(".dropdown-list").outerHeight(!0);m.trigger("todolist:updateHeight",t+20),this.$el.find(".dropdown").removeClass("show-detail").removeClass("provider-submenu").height("auto");this.ensureVisible(t+20)},removeActiveItemClass:function(){this.$el.find(".active-item").removeClass("highlighted")},addActiveItemClass:function(){this.$el.find(".active-item").addClass("highlighted")},showAllAvailableItems:function(){this.isLoading||(this.isLoading=!0,this.trigger("showAllItems"))},failedLoading:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Trouble connecting... Retry",css_class:"message failed-loading no-icon"})},retryLoadingItems:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Loading...",css_class:"loading-dropdown u--no-hover"}),this.showAllAvailableItems()},refreshItems:function(){this.itemsRefreshed||(this.trigger("refreshItems"),this.itemsRefreshed=!0)}}),m.views.AddTodoList=Backbone.View.extend({tagName:"li",attributes:{class:"todo-list-add-row"},template:m.templates.todos.addtodolist,events:{keyup:"handleKeyup",keydown:"handleKeydown",click:"ignoreClick","click #add-label":"handleClick"},initialize:function(e){this.parent=e.parent,this.listenTo(m,"todo:loadingStateChange",this.render),this.adding=!1},render:function(){this.adding=!1,this.$el.html(this.template()),this.$inputNewList=$(this.$el.find("#list-new")[0]),this.$addListLabel=$(this.$el.find("#add-label")[0]),this.$loading=$(this.$el.find(".new-list-loading")[0]);var e=this.model.activeProvider.selectedList();return e&&e.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New List")),this.$inputNewList.hide(),this.$loading.hide(),this.$addListLabel.show(),this)},ignoreClick:function(e){e.stopPropagation(),e.preventDefault()},handleClick:function(e){if(e.stopPropagation(),e.preventDefault(),!m.conditionalFeatures.featureEnabled("plus")){return m.commandManager.execute("upsell.message",{targetRegion:"todos",sourceEvent:"todoAddList",buttonText:"Learn more",title:"Multi-todo lists",description:"Create and customize multiple todo lists"}),void m.trigger("globalEvent:closeDropdowns")}this.adding=!0,this.$inputNewList.show(),this.$addListLabel.hide(),this.focusInputField()},cancelEdit:function(e){this.adding=!1,this.$inputNewList.hide(),this.$inputNewList.val(""),this.$addListLabel.show()},createOnEnter:function(e){var t=m.utils.capitalizeFirstLetter(this.$inputNewList.val());t&&0!=t.length&&0!=t.trim().length&&this.model.activeProvider&&(this.$inputNewList.val(""),this.model.activeProvider.selectedProject().addNewList(t,function(){m.trigger("todo:listAdded")}),this.adding=!1,this.$inputNewList.hide(),this.$inputNewList.val(""),this.$loading.show())},focusInputField:function(){this.$inputNewList.focus()},handleKeyup:function(e){13==e.keyCode?this.createOnEnter():27==e.keyCode&&(e.stopPropagation(),this.cancelEdit(),this.$el.blur())},handleKeydown:function(e){}}),m.views.NewTodoInput=Backbone.View.extend({events:{keyup:"handleKeyup",keydown:"handleKeydown"},initialize:function(e){this.parent=e.parent,this.todoList=e.todoList,this.listenTo(m,"todo:loadingStateChange",this.render),this.listenTo(m,"todo:listAdded",this.focusInputField)},render:function(){var e=this.model.activeProvider.selectedList(),t=this.model.activeProvider.selectedProject();if(e){if(e.get("add_hidden"))return this.$el.prop("disabled",!0),void this.$el.prop("placeholder","");if(e.get("todo_type")||t&&t.get("todo_type")){var i="New "+(t.get("todo_type")?t.get("todo_type"):e.get("todo_type"));this.$el.prop("disabled",!1),this.$el.prop("placeholder",i)}else this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo")}this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo"))},createOnEnter:function(e){if(!this.todoList.isLoading()){var t=this.$el.val();if(t&&0!=t.length&&0!=t.trim().length){var i=this.model.activeProvider.selectedList();if(i){i.changeCount(!0),this.$el[0].value="";var o=e&&(e.ctrlKey||e.metaKey);i.createNewModel({title:t},!1,o)}}}},focusInputField:function(){this.$el.focus()},handleKeyup:function(e){27==e.keyCode&&(e.stopPropagation(),this.$el.blur())},handleKeydown:function(e){var t=null;if(13==e.keyCode?this.createOnEnter(e):32==e.keyCode?t="globalEvent:spacebar":37==e.keyCode?t="globalEvent:arrowLeft":39==e.keyCode&&(t="globalEvent:arrowRight"),t){var i=this.$el.val();i&&0!=i.length&&0!=i.trim().length||(e.preventDefault(),e.stopPropagation(),m.trigger(t,e))}}}),m.views.TodoListHeader=Backbone.View.extend({events:{"click .todo-list-name-wrapper":"handleHeaderClick","click .todo-provider-wrapper":"toggleProjectDropdown","click .todo-list-choice":"chooseList","click .control-autofocus":"toggleAutoFocus","click .control-assignee":"toggleAssignee","click #status-action":"statusActionClick"},choosing:!1,initialize:function(e){this.listeningTo=null,this.parent=e.parent,this.listenTo(m,"globalEvent:closeDropdowns",this.stopChoosing),this.listenTo(this.model,"change",this.handleManagerChange),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m.models.customization,"change:assigned-"+this.id,this.showAssignedTodosOnlyChanged),this.listenTo(m,"globalEvent:click",this.globalClick),this.listenTo(m,"todo:status",this.renderActiveItem),this.listenTo(m,"todo:topmenu:reset",this.topMenuReset),this.listenTo(m,"todo:addParentList",this.prepareProjectList),this.listenTo(m,"todo:resetProjectList",this.resetProjectList),this.listenTo(m,"todo:allProjectsLoaded",this.prepareProjectList),this.defaultColor="rgba(0,0,0,0)",this.model.activeProvider.selectedProject()&&(this.activeList=this.model.activeProvider.selectedProject().listCollection)},render:function(e){this.$activeContainer=$(this.$el.find(".main-list-active")[0]),this.$activeParentContainer=$(this.$el.find(".parent-list-active")[0]),this.$chooserContainer=$(this.$el.find(".main-list-chooser")[0]);var t=this.activeList;t&&this.listeningTo!=t&&(this.listenTo(t,"change",this.handleCollectionChange),this.listeningTo&&this.stopListening(this.listeningTo,"change"),this.listeningTo=t),this.model.activeProvider.get("supportProjects")&&this.prepareProjectList(),this.renderActiveItem(e),this.model.activeProvider.selectedProject()&&this.renderListChooser(this.model.activeProvider.selectedProject().listCollection,this.$chooserContainer,"todo-list-choice");var i=this.model.todoProviderDetails(this.model.activeProvider.id);if(i){if(this.$el.closest(".todo").removeClass(this.providerClass),i.get("provider_title")){var o=i.get("provider_title").indexOf("-");this.providerClass="todo-"+i.get("provider_title").substring(0,0<o?o:i.get("provider_title").length)}this.$el.closest(".todo").addClass(this.providerClass)}},handleHeaderClick:function(e){$(e.currentTarget.parentElement).hasClass("show-external")?(this.handleIconHoverOff(),this.visitExternal()):this.toggleChooser(e,!this.model.activeProvider.get("supportLists"))},visitExternal:function(e){var t=this.model.activeProvider.selectedList().get("url");t||(t=this.providerUrl),getBrowser().tabs.create({url:t})},toggleChooser:function(e,t){e&&(e.preventDefault(),e.stopPropagation()),1<this.model.activeProvider.selectedProject().listCollection.length&&(m.trigger("globalEvent:closeDropdowns",this),this.setChoosingState(!this.choosing)),t&&this.toggleProjectDropdown()},toggleProjectDropdown:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.model.activeProvider.get("supportProjects")&&this.projectDropdownView.toggleDropdown()},globalClick:function(e){e!=this&&this.setChoosingState(!1)},todoChanged:function(e,t){t&&(t.hasOwnProperty("done")||t.hasOwnProperty("listId"))&&this.renderActiveItem()},topMenuReset:function(){this.topMenuDropdownView&&this.topMenuDropdownView.resetMenuItems()},autoFocusChanged:function(e){this.renderActiveItem()},showAssignedTodosOnlyChanged:function(){this.renderActiveItem()},setChoosingState:function(e){this.choosing!=e&&(this.choosing=e,this.$activeContainer.toggleClass("choosing",this.choosing),this.choosing?(this.$el.closest(".todo-pane").css("overflow-y","auto"),m.trigger("todolist:updateHeight",this.$chooserContainer.height()),this.$chooserContainer.show()):(this.$el.closest(".todo-pane").css("overflow-y","hidden"),m.trigger("todolist:updateHeight",0),this.$chooserContainer.hide()))},expandedHeight:function(){var e=0,t=0;return this.choosing&&(e=this.$chooserContainer.outerHeight()),this.topMenuDropdownView&&(t=this.topMenuDropdownView.expandedHeight()),_.max([e,t])},stopChoosing:function(e){m.views;e!=this&&e!=m.views.todoPane&&this.setChoosingState(!1)},chooseList:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectList(t)},chooseProject:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectProject(t)},statusActionClick:function(e){if(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("action");t&&m.commandManager.execute(t,this.lastStatus)}},handleCollectionChange:function(e){var t=e.get("count"),i=this.$el.find("[data-list-id='"+e.id+"']");$(i.find(".todo-count")[0]).text(t);var o=this.model.activeProvider.selectedList();o&&o.id==e.id&&$(this.$el.find(".active-todo-count")[0]).text(t)},handleTodoCountUpdate:function(e,t){var i;if((i=e?this.model.activeProvider.getListById(e):this.model.activeProvider.selectedList())&&i.itemCollection){var o=i.remainingTodoCount();this.$el.find("span.active-todo-count").text(t)}var n=this.$el.find("[data-list-id='"+i.id+"']");$(n.find(".todo-count")[0]).text(o)},renderActiveItem:function(e){if(this.$activeContainer){if(this.model.activeProvider.selectedProject()&&this.model.activeProvider.selectedProject().listCollection){var t={},i={};e||(e=this.model.activeProvider.providerStatus()),e&&"loading"!=(this.lastStatus=e).status&&e.message&&(t.statusMessage=e.message,e.actionMessage&&(t.actionMessage=e.actionMessage),e.action&&(t.action=e.action)),t.supportProjects=this.model.activeProvider.get("supportProjects"),t.no_caps=this.model.activeProvider.get("no_caps");var o=this.model.activeProvider.selectedProject();t.supportLists=void 0===o.get("supportLists")?this.model.activeProvider.get("supportLists"):o.get("supportLists");var n,s,a,l,r,d,c=o.selectedList();if(c){var h=c.get("color");t.color=h?h.indexOf("rgb")<0&&"#"!=h.charAt(0)?"#"+h:h:this.defaultColor,t.listTitle=c.get("title"),t.providerLogo=c.get("small_icon_url"),t.remaining=c.remainingTodoCount()}if(o&&(h=o.get("color"),i.color=h?h.indexOf("rgb")<0&&"#"!=h.charAt(0)?"#"+h:h:this.defaultColor,i.listTitle=o.get("title"),i.providerLogo=o.get("small_icon_url")),!t.providerLogo&&this.model.activeProvider&&1!=this.model.activeProvider.id&&(n=this.model.todoProviderDetails(this.model.activeProvider.id))&&(t.providerLogo=i.providerLogo=n.get("small_icon_url"),t.providerTitle=i.providerTitle=n.get("provider_title"),this.providerUrl=n.get("provider_url")),!this.compareObjects(t,this.lastContext)||!this.compareObjects(i,this.lastParentContext)){this.lastContext=t,this.lastParentContext=i,n=this.model.todoProviderDetails(this.model.activeProvider.id);var u=m.templates.todos.todolistactive(t),g=m.templates.todos.parentlistactive(i);c&&(s=c.supportsFeature("assigned"),a=c.supportsFeature("subtask"),l=c.supportsFeature("showComplete"),r=c.supportsFeature("showArchivedProject"),d=c.supportsFeature("archiveCompleted"),m.models.customization.get("assigned-"+c.id)),this.$activeContainer.html(u),this.$activeParentContainer.html(g);var p=[];if(n&&n.attributes.provider_url&&p.push({commandId:"todo.visit.external",captionText:"View in "+n.get("provider_title"),options:{urlField:o?this.model.activeProvider.selectedProject().get("url"):this.model.activeProvider.selectedList().get("url"),providerUrl:this.providerUrl},todoIcon:'<span class="todo-action"><svg class="icon icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 438.536 438.536"><path d="M414.41 24.123C398.333 8.042 378.963 0 356.315 0H82.228C59.58 0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648 0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225c-.001-22.649-8.043-42.021-24.123-58.102zm-48.961 204.279c0 7.994-3.717 13.606-11.136 16.844-2.471.951-4.859 1.427-7.139 1.427-5.134 0-9.418-1.811-12.847-5.424l-41.11-41.112-152.453 152.462c-3.621 3.614-7.9 5.425-12.85 5.425-4.952 0-9.235-1.811-12.851-5.425l-29.121-29.126c-3.617-3.61-5.426-7.901-5.426-12.847 0-4.944 1.809-9.229 5.426-12.843l152.462-152.464-41.113-41.112c-5.902-5.52-7.233-12.178-3.999-19.985 3.234-7.421 8.852-11.136 16.846-11.136h137.037c4.948 0 9.232 1.81 12.854 5.428 3.613 3.614 5.421 7.898 5.421 12.847v137.041z"/></svg></span>',toolTip:"Open in "+n.get("provider_title")}),n&&this.model.activeProvider.get("supportSubtasks")&&p.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks"}),p.push({checkStateCmd:"todo.list.check.state.autofocus",commandId:"todo.toggle.autofocus",captionText:"Autofocus",todoIcon:'<span class="todo-action"><svg class="icon icon-autofocus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg></span>',toolTip:"Automatically set top todo as focus"}),s&&p.push({checkStateCmd:"todo.list.check.state.assigned",commandId:"todo.toggle.assignee",captionText:"Assigned to me",todoIcon:'<span class="todo-action"><svg class="icon icon-assigned" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><path d="M9.56 48.67v2.91c0 4.18 13.21 5.35 20.46 5.4s20.46-1.21 20.46-5.4v-2.91a8.11 8.11 0 0 0-4.23-7.12l-7.81-4.26-.21-.12A2.38 2.38 0 0 1 37 35.08v-3l.26-.36a18.89 18.89 0 0 0 2.89-6.15 3.58 3.58 0 0 0 1.35-2.8V19.2a3.59 3.59 0 0 0-.9-2.36v-4.78a8.06 8.06 0 0 0-1.88-5.87C36.93 4.16 33.85 3.1 30 3c-3.83.08-6.91 1.14-8.69 3.17a8.07 8.07 0 0 0-1.88 5.87v4.78a3.59 3.59 0 0 0-.9 2.36v3.6a3.58 3.58 0 0 0 1.35 2.8 18.89 18.89 0 0 0 2.89 6.15l.26.36v3a2.38 2.38 0 0 1-1.24 2.09l-.21.12-7.81 4.26a8.11 8.11 0 0 0-4.21 7.11z"/></svg></span>',toolTip:"Show assigned to me only"}),(a||l||r||d)&&p.push({css_class:"line"}),a&&p.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks",todoIcon:'<span class="todo-action"><svg class="icon icon-subtasks" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500"><path d="M36 387c-19 0-36 16-36 35s17 36 36 36 35-17 35-36-16-35-35-35zM36 215c-19 0-36 16-36 35s17 35 36 35 35-16 35-35-16-35-35-35zM164 110h303c18 0 33-14 33-32s-15-33-33-33H164c-18 0-33 15-33 33s15 32 33 32zM36 42C17 42 0 59 0 78s17 35 36 35 35-16 35-35-16-36-35-36zM467 217H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33zM467 389H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33z"/></svg></span>'}),l&&p.push({checkStateCmd:"todo.list.check.state.old.todos",commandId:"todo.list.show.old.todos",captionText:"Show all completed tasks",todoIcon:'<span class="todo-action"><svg class="icon icon-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.5 497.5"><path d="M487.75 78.125c-13-13-33-13-46 0l-272 272-114-113c-13-13-33-13-46 0s-13 33 0 46l137 136c6 6 15 10 23 10s17-4 23-10l295-294c13-13 13-34 0-47z"/></svg></span>'}),r&&p.push({checkStateCmd:"todo.check.state.archived.projects",commandId:"todo.show.archived.projects",captionText:"Show archived projects",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),d&&p.push({commandId:"todo.list.archive",captionText:"Archive completed tasks",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),p.push({css_class:"line"}),p.push({commandId:"todo.switch.feed",captionText:"Switch to...",css_class:"no-icon"}),p.push({commandId:"todo.show.settings",captionText:"Settings",css_class:"no-icon"}),p=new Backbone.Collection(p),c){var f=$(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView&&this.lastProvider==this.model.activeProvider?this.topMenuDropdownView.attachMenuItems(f,p):(this.topMenuDropdownView&&(this.topMenuDropdownView.unbind(),this.topMenuDropdownView.remove()),this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:f,iClassName:"icon-cog",dropdownClassName:"todo-actions-dropdown",menuItems:p,model:c,parentContext:this.model.activeProvider})),this.topMenuDropdownView.render();var v=this.$el.find(".todo-project-chooser");this.projectDropdownView?(this.projectDropdownView.dropdownClassName="todo-project-dropdown",this.projectDropdownView.providerLogo=n?n.get("small_icon_url"):null,this.projectDropdownView.attachMenuItems(v,this.projectMenuCollection)):(this.projectDropdownView=new m.views.TodoDropdownMenu({el:v,loadAllOnExpand:!0,menuItems:this.projectMenuCollection,dropdownClassName:"todo-project-dropdown",model:c,parentContext:this.project,providerLogo:n?n.get("small_icon_url"):null,keepOpen:!0}),this.listenTo(this.projectMenuCollection,"failedLoadingItems",this.failedLoadingProjects),this.listenTo(this.projectDropdownView,"refreshItems",this.refreshProjects)),this.projectDropdownView.render(),this.lastProvider=this.model.activeProvider,s=c.supportsFeature("assigned"),this.$activeContainer.find(".control-assignee").toggleClass("disabled",!s),this.$activeContainer.find(".control-autofocus").removeClass("disabled"),this.$activeContainer.toggleClass("has-assignee",s),this.$activeContainer.find(".control-assignee").toggleClass("active",1==m.models.customization.get("assigned-"+c.id))}}this.$activeContainer&&this.$activeContainer.find(".control-autofocus").toggleClass("active",m.models.customization.getComputedSetting("autoFocus"));var w=!c||this.model.activeProvider.selectedProject().listCollection.length<=1;this.$activeContainer.find(".icon-angle-down").toggle(!w),w&&this.$activeContainer.find("li").css({Cursor:"default"}),this.parent.setMaxWidgetHeight(),this.$activeContainer.toggleClass("momentum-todo",1==this.model.activeProvider.id),this.fetchedAllProjects=!1}}else{var b=this;setTimeout(function(){b.renderActiveItem(e)},300)}},compareObjects:function(e,t){return e==t||JSON.stringify(e)==JSON.stringify(t)},prepareProjectList:function(){if(!(this.preparing||this.lastPreparedProjects&&this.lastPreparedProjects==this.model.activeProvider.projectCollection&&this.lastPreparedProjects.models[0]==this.model.activeProvider.projectCollection)){var t=this;this.preparing=!0;var i=this.projectItems=[];this.projectMenuCollection||(this.projectMenuCollection=new Backbone.Collection(i)),this.fetchedAllProjects=!0,this.loadingProjects=!1,this.fetchProjectsFailed=!1;var o=this.lastPreparedProjects=this.model.activeProvider.projectCollection,n=this.model.activeProvider.getAllProjects();if(o&&n){if(sortedProjects=o.sortBy("last_active").reverse(),sortedProjects=_.chain(sortedProjects).first(10).value().filter(function(e){return n.get(e.get("id"))}),sortedAllProjects=n.toArray().filter(function(e){return!o.get(e.get("id"))}),1<this.model.activeProvider.id.length){var e=this.model.activeProvider.get("variant_title")||this.model.activeProvider.get("provider_title");i.push({captionText:e,css_class:"provider-name no-icon"})}var s=this.model.activeProvider.selectedProject();if(s)var a=s.selectedList();i.push({captionText:"Recent",css_class:"section-title no-icon"}),_.map(sortedProjects,function(e){i.push({commandId:"todo.switch.parent.project",captionText:e.get("title"),color:e.get("color"),options:{projectId:e.get("id")},css_class:t.model.activeProvider.get("supportProjects")&&s&&s.id==e.get("id")||a&&e.get("id")==a.id?"active-item no-icon":"no-icon",projectId:e.get("id")})}),5<n.length&&i.push({captionText:"Other",css_class:"section-title empty-list no-icon"}),_.map(sortedAllProjects,function(e){var t;for(t in i)if(i[t].projectId==e.get("id"))return;i.push({commandId:"todo.switch.parent.project",captionText:e.get("title"),color:e.get("color"),options:{projectId:e.get("id")},css_class:"no-icon",projectId:e.get("id")})}),this.projectMenuCollection.set(i,{silent:!0}),this.projectMenuCollection.trigger("reset"),this.fetchedAllProjects=this.loadingProjects=!1,this.preparing=!1}else this.preparing=!1}},resetProjectList:function(){var e=this;setTimeout(function(){e.projectDropdownView.resetMenuItems()},250)},failedLoadingProjects:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!0},renderListChooser:function(n,s,a){if(n){var e=n.toArray();s.html("");var l=null;_.map(e,function(e){var t={};t.listId=e.id,t.title=e.get("title"),t.color=e.get("color"),t.count=e.get("count"),t.class=a;var i=e.get("parentTitle");i&&(t.hasParent=!0,i!=l&&(t.parentTitle=i),l=i),e.id==n.selectedList().get("id")&&(t.class="todo-list-choice-active");var o=m.templates.todos.todolistchoice(t);s.append(o).data("list-id",e.id)});var t=m.models.todoListManager.todoProviderDetails(this.model.activeProvider.get("id"));t&&t.get("add_lists")&&(this.addTodoListView||(this.addTodoListView=new m.views.AddTodoList({model:this.model}),this.listenTo(m,"todo:listAdded",this.stopChoosing)),s.append(this.addTodoListView.render().el),this.addTodoListView.delegateEvents())}},handleManagerChange:function(){if(this.topMenuDropdownView){var e=this.model.activeProvider.selectedList();this.topMenuDropdownView.updateModel(e)}this.render()},handleTodoLoadingStateChange:function(e){e!=this.lastStatus&&this.render(e),this.lastStatus=e},providerChanged:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!1,this.render()},handleIconHoverOn:function(){},handleIconHoverOff:function(){},refreshProjects:function(){this.model.activeProvider.refreshAllProjects()}}),m.views.TodoItem=Backbone.View.extend({attributes:{class:"todo-item"},tagName:"li",template:m.templates.todos.todoitem,events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},editing:!1,renderedOnce:!1,initialize:function(e){this.parent=e.parent,this.provider=e.provider,this.listId=e.list_id,this.menu_options=e.menu_options,this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"todo:edit",this.edit),this.listenTo(this.model,"todo:close",this.toggleDone),this.listenTo(this.model,"todo:open",this.toggleDone),this.listenTo(m,"todo:refresh",this.refreshTodo),this.listenTo(m,"todo:set:done",this.setDone),this.listenTo(m,"globalEvent:esc",this.abortEdit)},refreshTodo:function(e){e==this.model.id&&this.model.fetch()},setDone:function(e,t){e==this.model.id&&this.toggleDone()},render:function(){if(this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.model.get("deleted"))return this.hideTodoItem(),this;if(!this.isDoneList&&(this.model.get("listId")!=this.listId&&(!this.isTodayList||!this.model.get("today"))||this.model.get("archive")))return this.hideTodoItem(),this;if(this.isDoneList&&!this.model.get("done"))return this.hideTodoItem(),this;if(!this.isTodayList&&!this.isDoneList&&this.model.get("today"))return this.hideTodoItem(),this;if(this.isTodayList&&!this.model.get("today"))return this.hideTodoItem(),this;var e=m.utils.captionFormatter(this.model.getValue("title"));if(this.renderedOnce)this.$title.text(e);else{var t={title:e};this.$el.html(this.template(t)),this.$title=this.$el.find(".todo-item-title").first(),this.$checkbox=this.$el.find(".todo-item-checkbox").first(),this.renderedOnce=!0}if(this.$checkbox.prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",this.model.isTrue("done")),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.$el.attr("data-todo-id",this.model.id),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):!this.selectedList.supportsReordering()&&!this.selectedList.get("boardId")||this.model.get("noMove")||this.$el.prop("draggable","true"),this.menu_options&&"subsection"!=this.model.get("viewType")){var i=$(this.$el.find(".dropdown-container")[0]);this.topMenuDropdownView||(this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:i,iClassName:"icon-ellipsis",dropdownClassName:"todo-item-dropdown",menuItems:this.menu_options,model:this.model,parentContext:this.provider,comparisonNode:this.parent.$el})),this.topMenuDropdownView.render()}return"subsection"==this.model.get("viewType")&&this.$el.addClass("todo-subsection"),this.model.get("viewSectionId")&&this.$el.attr("data-view-section-id",this.model.get("viewSectionId")),this},hideTodoItem:function(){this.$el.html(""),this.$el.hide(),this.stopListening(m,"globalEvent:spacebar"),this.parent&&this.parent.checkForEmptyState()},isHidden:function(){return!this.$el.is(":visible")},scrollIntoView:function(){this.parent.isScrolling&&this.$el[0].scrollIntoView(!1)},destroy:function(){this.stopListening(),this.remove(),this.unbind()},abortEdit:function(){this.editing&&(this.parent.toggleScroll(!0),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),this.editing=!1)},setEditable:function(e,t){e.attr("contentEditable",t),e.closest(".todo-item").attr("draggable",!t)},saveEdit:function(){if(this.editing){this.$el.removeClass("editing"),this.parent.toggleScroll(!0);var e=this.$title.text();e?0==(e=e.trim()).length?this.abortEdit():this.model.attemptSave({title:e}):this.abortEdit(),this.editing=!1,this.setEditable(this.$title,!1),this.parent.updateHeight()}},retrySave:function(){this.model.isTrue("isProxy")?this.model.targetList&&this.model.targetList.createNewModel(this.model,!0):(this.model.attemptedSaveValues||this.model.pendingReorderData)&&this.model.attemptSave()},edit:function(e){this.editing||(this.originalText=this.$title.text(),e&&e.stopPropagation(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.parent.toggleScroll(!1),this.$el.addClass("editing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){if(e.stopPropagation(),this.editing||this.topMenuDropdownView&&this.topMenuDropdownView.expanded)return!1;if(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("todo_id",this.model.id),0==this.model.get("leafNode")){var t=this.$el.cloneNode(!0);t.className="ghost",t.style.position="absolute",t.style.zIndex="-1",t.querySelector(".todo-item-checkbox").style.marginTop="3px",e.currentTarget.appendChild(t),e.originalEvent.dataTransfer.setDragImage(t,e.originalEvent.offsetX-15,e.originalEvent.offsetY+2)}this.parent.dragmode="todo",m.trigger("todo:dragging",this),(this.parent.dragging=this).parent.original_index=this.parent.li_index(this.$el,!0),0!=this.parent.original_index?(this.parent.$preceeding_item=this.previousSiblingTodo(),this.parent.preceedingTodoId=this.previousSiblingTodoId()):(this.parent.$preceeding_item=null,this.parent.preceedingTodoId=null),m.sendEvent("Todo","Reorder")},dragenter:function(e){if(e.stopPropagation(),!this.parent.selectedList.get("reorder"))return!1;if("todo"==this.parent.dragmode){if(!this.isSibling(this.parent.dragging.model))return!0;this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;return this.parent.$placeholder.css("display","list-item"),t.height(this.parent.dragging.$el.height()),t.after(this.parent.dragging.$el),!1}},isSibling:function(e){return this.model.isSibling(e)},previousSiblingTodo:function(){return this.$el.prevAll("li").not(".placeholder").first()},previousSiblingTodoId:function(){return this.$el.prevAll("li").not(".placeholder").first().data("todo-id")},onMouseEnter:function(e){m.views.todoPane.isHovered=!0,this.listenTo(m,"globalEvent:spacebar",this.invokeDefaultCommand)},onMouseLeave:function(e){this.stopListening(m,"globalEvent:spacebar"),m.views.todoPane.isHovered=!1},invokeDefaultCommand:function(){var t=this,e=this.selectedList.getDefaultCommands();if(e&&0<e.length){var i=_.find(e,function(e){return!!m.commandManager.canExecute(e.commandId,t.model,e.options,t.provider)});i&&(m.commandManager.execute(i.commandId,t.model,i.options,t.provider),this.parent.updateHeight())}},toggleDone:function(e){if(e&&e.stopPropagation(),this.selectedList.has("done_disabled")){e&&e.preventDefault();var t=this.selectedList.get("done_disabled");t.message&&m.trigger("todo:status",t)}else{m.sendEvent("Todo","Done");var i=!this.model.get("done");this.model.attemptSave({done:i,completedDate:i?new Date:null}),this.selectedList.recurseOnDone=!0,(this.selectedList.get("recurse_on_done")&&i||this.selectedList.get("recurse_on_done")&&this.selectedList.get("recurse_on_reopen"))&&this.recurseToggleDone(this.model.id,i),this.topMenuDropdownView.resetMenuItems(),m.trigger("todo:loadingStateChange",null);var o=this.provider.getDoneList();o&&!this.selectedList.isDoneList()&&o.changeCount(i)}},recurseToggleDone:function(e,t){var i=this;this.selectedList.itemCollection.where({parentId:e}).forEach(function(e){e.set({done:t,completedDate:new Date}),i.recurseToggleDone(e.get("id"),t)})},handleInput:function(e){this.editing&&(this.parent.updateHeight(),13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.TodoList=Backbone.View.extend({events:{dragover:"dragover",dragend:"dragend",drop:"drop","click .empty-link":"clickEmptyStateLink","click .empty-title":"clickEmptyTitleLink","click .todo-load-more-button":"loadMore","click .todo-section-collapsible":"toggleSection"},reordered:!1,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],itemsRendered:!0,initialize:function(){this.scrollingAllowed=!0,this.emptyListGreeting="Add a todo to get started",this.subViews=[],this.isScrolling=!1,this.$loading=$('<span class="overlay loading todo-loading"><i class="loading-icon"></i> Loading...</span>'),this.$inPlaceLoading=$('<span class="loading"><i class="loading-icon"></i> <span class="loading-title">Loading...</span></span>'),this.listenTo(this.model,"change",this.providerChanged),this.listenTo(this.model.project,"change",this.providerChanged),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(m,"todolist:updateHeight",this.updateHeight),this.listenTo(m,"todo:loadingStateChange",this.renderLoading),this.listenTo(m,"todo:dragging",this.todoDragging),this.providerChanged();var e=this;$(window).on("resize",function(){e.updateHeight()})},render:function(){if(!this.renderedOnce){this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.renderLoading({status:"loading"}),this.$el.css("max-height",this.getHeightLimit()+"px");var e=localStorage.getItem("todo-list-min-height");this.$el.css("min-height",e||"22px"),this.renderedOnce=!0}this.$el.removeClass().addClass("todo-list");var t=this.model.activeProvider.selectedList(),i=this.model.activeProvider.selectedProject();if(t){if(t.list_class)var o=t.get("list_class");o&&this.$el.addClass(o),t.get("todo_type")?this.emptyListGreeting="Add a new "+t.get("todo_type")+" to get started":this.emptyListGreeting="Add a new todo to get started"}i&&i.get("todo_type")&&(this.emptyListGreeting="Add a new "+i.get("todo_type")+" to get started");var n=this;this.addAll(function(e){n.renderItems(e)})},renderItems:function(e){var t=this.model.activeProvider.selectedList();e?t&&t.isDoneList()&&0==this.$el.find(".todo-load-more").length&&(this.lastCount&&this.lastCount==t.itemCollection.length?this.$el.append('<li class="todo-load-more"><span class="todo-load-more-done" style="text">That\'s all!</span></li>'):this.$el.append('<li class="todo-load-more"><span class="button todo-load-more-button">Load More</span></li>')):this.renderEmptyState();this.$el.css("opacity",1),this.updateHeight(0),t&&!t.itemCollection.loadingFromServer&&this.removeLoading()},showAssignedTodosOnly:function(){this.model.activeProvider.selectedList().showAssignedTodosOnlyChanged()},toggleSubtasks:function(){this.model.activeProvider.selectedList().toggleSubtasks()},toggleShowOld:function(){this.model.activeProvider.selectedList().loadOldCompletedTodos()},loadMore:function(){this.$el.find(".todo-load-more-button").remove(),this.$el.find(".todo-load-more").prepend(this.$inPlaceLoading);var e=this.model.activeProvider.selectedList();this.lastCount=e.itemCollection.length,e.itemCollection.loadMore(this.endDate)},dismissEmptyState:function(){this.emptyStateActive&&(this.$el.find(".empty").hide(),this.emptyStateActive=!1)},checkForEmptyState:function(){this.subViews&&(_.every(this.subViews,function(e){return e.isHidden()})&&this.render())},renderEmptyState:function(){var e,t=this.model.activeProvider.selectedList();if(t&&t.itemCollection&&t.itemCollection.firstLoadCompleted){var i={};if(t.has("empty_message"))i.message=t.get("empty_message"),i.submessage=t.get("empty_submessage"),i.use_command=!!t.get("empty_command");else if("today"==t.listType()){i.message=this.emptyListGreeting;var o=this.model.activeProvider.selectedProject().getListOfType("inbox");if(o){i.targetListId=o.id;var n=o.get("count");i.submessage=1==n?"1 todo in Inbox":1<n?n+" todos in Inbox":"Switch to Inbox"}}else if("inbox"==t.listType())i.message=this.emptyListGreeting,(e=this.model.activeProvider.selectedProject().getListOfType("today"))&&(i.targetListId=e.id,i.submessage="Switch to Today");else if("done"==t.listType())i.message="No completed todos yet",(e=this.model.activeProvider.selectedProject().getListOfType("today"))&&(i.targetListId=e.id,i.submessage="Get started in Today");else if(t.showAssignedTodosOnly&&0<t.itemCollection.models.length){var s="No tasks assigned to me";t.get("todo_type")&&(s="No "+t.get("todo_type")+"s assigned to me"),t.get("project")&&t.get("project").get("todo_type")&&(s="No "+t.get("project").get("todo_type")+"s assigned to me"),i.message=s}else i.message=this.emptyListGreeting;this.emptyStateActive=!0,this.$el.append(m.templates.todos["todo-list-empty-state"](i)),this.itemsRendered=!0,this.updateHeight(0)}},addedToProxyCollection:function(e,t,i){this.isScrolling||this.$el.addClass("hide-scroll"),this.dismissEmptyState(),this.addOne(e,i?i.at:null)},addOne:function(e,t,i){var o=this,n=null,s=this.model.activeProvider.selectedList();s&&(n=s.todoItemMenuOptions());var a=new m.views.TodoItem({model:e,parent:this,menu_options:n,provider:this.model.activeProvider,list_id:s.id});this.subViews.push(a);var l=a.render().el,r=e.get("parentId");if(r){var d=this.getTodoSubelementContainer(r);d?d.append(l):this.$el.append(l)}else if(1<e.get("depth")){var c=this.$el.find("li").last().attr("data-todo-id"),h=s.itemCollection.where({id:c});if(0<h.length&&(e.get("depth")==h[0].get("depth")&&h[0].get("parentId")&&(c=h[0].get("parentId")),e.get("depth")<=h[0].get("depth")-1&&h[0].get("parentId"))){c=h[0].get("parentId");var u=s.itemCollection.where({id:c});if(u[0].get("parentId")&&(c=u[0].get("parentId")),e.get("depth")==h[0].get("depth")-2&&h[0].get("parentId")){c=u[0].get("parentId");var g=s.itemCollection.where({id:c});g[0].get("parentId")&&(c=g[0].get("parentId"))}}e.set("parentId",c);var p=this.getTodoSubelementContainer(c);p&&p.append(l)}else if(e.get("isProxy")&&s.isDoneList())$(this.$el.find("li.todo-section")[0]).after(l);else if(t||0===t){for(var f=-1,v=this.$el.children(),w=0;f<t;){var b=$(v[w++]);b.hasClass("todo-section")||f++}0<=f?b.before(l):this.$el.prepend(l)}else this.$el.append(l);e.get("isProxy")&&e.get("proxyValid")?(this.isScrolling&&a.scrollIntoView(),this.newTodoAdded=!0,function(){var e=!1;o.addedToTop&&(o.$el.addClass("drop-top-margin"),e=!0);m.trigger("todolist:updateHeight"),$(l).addClass("transition"),setTimeout(function(){e&&o.$el.removeClass("drop-top-margin"),$(l).addClass("visible"),setTimeout(function(){$(l).removeClass("transition")},200)},1)}()):$(l).addClass("visible")},getTodoSubelementContainer:function(e){var t=this.$el.find('[data-todo-id="'+e+'"]');if(t&&0<t.length){var i=$(t[0]).find("ol").first();if(!i||0==i.length){var o=$("<ol />");return $(t[0]).append(o),o}return $(i)}return null},addAll:function(t){var i=this,e=function(){var e=i.addAllNow();t(e)};this.lastLisId!=this.model.activeProvider.selectedList()?(this.lastLisId=this.model.activeProvider.selectedList(),setTimeout(e,200),this.$el.css("opacity",0)):e()},addAllNow:function(){_.each(this.subViews,function(e){e&&e.destroy()});var e=!(this.subViews=[]);this.reordered=!1;var t,o=this;if(this.$el.html(""),t=this.model.activeProvider.selectedList()){var i=t.itemCollection.activeToday(),n=t.proxyCollection.where({proxyValid:!0});0<i.length&&(e=!0),n&&0<n.length&&(e=!0);var s,a=!1,l=t.groupingInfo();if(l){var r=[];if("date"==l.type){if(!_.isEmpty(i)){var d=_.map(i,function(e){var t=e.get(l.field),i=new Date(t);return{sortDate:i.getTime(),year:i.getFullYear(),month:i.getMonth(),day:i.getDate(),item:e}});s=_(d).chain().sortBy("sortDate").reverse().value();var c=null,h=null,u=null;_.each(s,function(e){if(e.year!=c||e.month!=h||e.day!=u){c=e.year,h=e.month,u=e.day;var t=o.formatDate(e),i=t.calendarDate;r.push(i),o.$el.append('<li draggable="false" data-view-section-parent-id="'+i+'" class="todo-section" title="'+t.calendarDate+'">'+t.friendlyDate+"</li>"),e.item.set("viewSectionId",t.calendarDate)}o.addOne(e.item),o.endDate=e.item.get("completedDate")})}a=!0}else if("viewSection"==l.type){var m="";s=_.sortBy(i,function(e){return l.order[e.get("viewSection")]}),_.each(s,function(e){if(e.get("viewSection")!=m){m=e.get("viewSection");r.push(m),o.$el.append('<li data-view-section-parent-id="'+m+'"class="todo-section todo-section-collapsible">'+m.replace("_"," ")+'<svg class="icon-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg></li>')}e.set("viewSectionId",m),o.addOne(e)}),a=!0}r.forEach(function(e){o.updateSectionExpansion(e)})}a||(_.each(i,function(e,t){o.addOne(e,!1,t==i.length-1),o.endDate=e.get("completedDate")},this),_.each(n,function(e){o.addOne(e)},this))}if(e&&(this.itemsRendered=!0),(t=this.model.activeProvider.selectedList())&&(this.addedToTop=t.addedToTop),this.newTodoAdded){var g=this.addedToTop?this.$el.children().first():this.$el.children().last();g&&0<g.length&&this.isScrolling&&g[0].scrollIntoView(!1),this.newTodoAdded=!1,this.addedToTop=!1}return e},updateSectionExpansion:function(e){var t="collapsed-"+this.model.activeProvider.selectedList().id+":"+e,i=m.models.customization.get(t);null==i&&(i=!1),this.$el.find('[data-view-section-id="'+e+'"]').toggleClass("hidden",i),this.$el.find('[data-view-section-parent-id="'+e+'"]').toggleClass("todo-section-collapsed",i),m.trigger("todo:sectionExpansion")},toggleSection:function(e){var t=this.model.activeProvider.selectedList(),i=e.currentTarget.dataset.viewSectionParentId,o="collapsed-"+t.id+":"+i;m.models.customization.set(o,!m.models.customization.get(o)),this.updateSectionExpansion(i),this.updateHeight()},formatDate:function(e){var t=new Date,i=this.monthNames[e.month]+" "+e.day+(t.getFullYear()==e.year?"":", "+e.year);if(e.year==t.getFullYear()&&e.month==t.getMonth()&&e.day==t.getDate())return{friendlyDate:"Today",calendarDate:i};var o=new Date(t.getTime()-864e5);if(e.year==o.getFullYear()&&e.month==o.getMonth()&&e.day==o.getDate())return{friendlyDate:"Yesterday",calendarDate:i};var n=new Date(e.sortDate);return new Date(t.getTime()-5184e5)<n?{friendlyDate:this.weekdayNames[n.getDay()],calendarDate:i}:{friendlyDate:i,calendarDate:""}},clickEmptyStateLink:function(e){if(e&&e.currentTarget){if(e.preventDefault(),e.stopPropagation(),$(e.currentTarget).data("use-command")){var t=this.model.activeProvider.selectedList(),i=t.get("empty_command"),o=t.get("empty_command_options");return void m.commandManager.execute(i,null,o)}var n=$(e.currentTarget).data("target-list-id");n&&this.model.activeProvider.selectList(n)}},clickEmptyTitleLink:function(e){if(e&&e.currentTarget&&(e.preventDefault(),e.stopPropagation(),$(e.currentTarget).text()==this.emptyListGreeting)){var t=this.$el.parent().find(".todo-new")[0];t&&t.focus()}},dragover:function(e){return e.preventDefault(),!(e.originalEvent.dataTransfer.dropEffect="move")},dragend:function(e,t){e.preventDefault(),this.$el.removeClass("dragging"),this.$el.closest(".todo-pane").removeClass("has-drop-left has-drop-right");var i=this.$el[0].getBoundingClientRect(),o=e.originalEvent.pageX,n=e.originalEvent.pageY,s=this.dragging.model.id;if(this.move_target_id!=s&&!0!==t){if(o-10<i.right&&o+30>i.left&&n-20<i.top&&i.top-n<40)return void this.drop(e);if(o-10<i.right&&o+30>i.left&&n+20>i.bottom&&n-i.bottom<40)return void this.drop(e)}if("todo"==this.dragmode){var a=this.dragging.$el;"none"==e.originalEvent.dataTransfer.dropEffect&&(null!=this.$preceeding_item?this.$preceeding_item.after(a):this.$el.prepend(a)),this.$placeholder.hide(),a.show(),a.find(".ghost").remove()}return!1},drop:function(e){if(!this.selectedList.get("reorder"))return this.dragend(e,!0),!1;if("todo"==this.dragmode){var t=this.dragging.$el,i=this.dragging.model.id,o=this.move_target_id;if(o==i)return void this.dragend(e);e.preventDefault(),this.$el.closest(".todo-pane").removeClass("has-drop-left has-drop-right");var n=this.move_offset;if(0==this.li_index(this.dragging.$el,!0)&&0==this.original_index)return this.dragend(e,!0),!1;if(i==o)return!1;if(this.preceedingTodoId==this.dragging.previousSiblingTodoId())return!1;var s=this.model.activeProvider.selectedList(),a=s.itemCollection.get(i),l=s.itemCollection.get(o);if(!a||!l||!a.isSibling(l))return!1;this.$placeholder.hide(),t.show(),s.itemCollection.reorderItem({move_id:i,move_target_id:o,move_offset:n,list_id:s.id}),this.reordered=!0}},getTopActiveTodoId:function(){return this.$("li:not(.done, .placeholder, .todo-section, .todo-subsection, .hidden)").first().data("todo-id")},li_index:function(e,t){return t?this.$("li").not(".placeholder").index(e):this.$("li").index(e)},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(e){this.selectedList&&this.selectedList.waitForReorder||e&&"loading"==e.status||this.render()},showAssignedTodosOnlyChanged:function(e){var t=this.model.activeProvider.selectedList();t&&t.id==e&&this.render()},providerChanged:function(){var e=this.model.activeProvider.selectedList();this.selectedList!=e&&(this.itemsRendered=!1,this.selectedList&&this.stopListening(this.selectedList.proxyCollection),(this.selectedList=e)&&this.listenTo(e.proxyCollection,"add",this.addedToProxyCollection)),this.render(),e&&e.supportsFeature("assigned")&&this.listenTo(m.models.customization,"change:assigned-"+e.id,this.showAssignedTodosOnly),e&&(this.listenTo(m.models.customization,"change:subtask-"+e.id,this.toggleSubtasks),this.listenTo(m.models.customization,"change:showOld-"+e.id,this.toggleShowOld))},todoDragging:function(){this.$el.addClass("dragging"),this.isScrolling||this.$el.addClass("hide-scroll")},toggleScroll:function(e){this.scrollingAllowed=e,this.$el.toggleClass("hide-scroll",!e)},updateHeight:function(o){if(!(0<this.lastHeight&&void 0===o)){this.lastHeight=o;var e,t=0,i=this;0==o&&(o=void 0);var n=this.$el;if(n.is(":visible")){var s=this.$el.closest(".todo-pane");this.isScrolling?o>n.outerHeight(!0)&&n.addClass("animating"):n.addClass("hide-scroll"),s.addClass("animating"),this.$el.bind("transitionend webkitTransitionEnd",l),setTimeout(l,500);var a=this.getHeightLimit();if(void 0===o){if(o=0,this.$loading.parent()&&0==n.children().length)return;n.children().each(function(e,t){var i=$(t);"none"!=i.css("display")&&(o+=i.outerHeight(!0)+2)}),e=!0,this.contentHeight=o,this.visibleHeight=Math.min(o,a)}o>=n.outerHeight(!0)?(o=Math.min(o,a),this.isScrolling=o==a,t=o+"px",n.parent().css({"min-height":t})):(n.parent().css({"min-height":Math.max(this.visibleHeight,o)+"px"}),t=Math.max(this.visibleHeight,o)+"px"),n.css({"min-height":t}),n.parent().css({"max-height":(e?o:a)+"px"}),n.css({"max-height":(e?o:a)+"px"}),localStorage.setItem("todo-list-min-height",t)}}function l(){i.scrollingAllowed&&n.removeClass("hide-scroll"),n.removeClass("animating"),s.removeClass("animating"),i.$el.unbind("transitionend webkitTransitionEnd",l)}},renderLoading:function(e){this.renderedOnce&&this.updateHeight();var t=this;e&&("loading"==e.status?(this.loadingRemoved=!1,setTimeout(function(){t.loadingRemoved||(0<t.subViews.length||t.$el.find(".empty").is(":visible")?(t.$loading.addClass("todo-loading-inline u--bg"),e.listChanged||t.$el.parent().append(t.$loading)):(t.$loading.removeClass("todo-loading-inline u--bg"),t.$el.parent().append(t.$loading)))},10)):"error"==e.status&&setTimeout(function(){t.removeLoading()},20))},removeLoading:function(){this.loadingRemoved=!0,this.$loading.remove(),this.$inPlaceLoading.remove(),this.updateHeight()},isLoading:function(){return 0<this.$loading.parent().length},getHeightLimit:function(){var e=this.$el.parent().parent(),t=e.find(".todo-header").outerHeight(!0),i=e.find(".todo-message").outerHeight(!0)||0,o=e.find(".todo-new").outerHeight(),n=$("#top-right").outerHeight(!0)+$("#bottom-right").outerHeight(!0),s=$(".bookmarks-wrapper"),a=0;return s.css("transform")&&(a=parseInt(s.css("height"))-parseInt(s.css("transform").split(",")[5])),document.body.getBoundingClientRect().height-(n+t+i+o+a+4)}}),m.views.TodoPane=Backbone.View.extend({attributes:{id:"todo",class:"widget-bottom-right todo"},template:m.templates.todos.todopane,renderedOnce:!1,todoListOpen:!1,events:{"click .todo-toggle":"toggleShow","dragover .drop-left-zone":"ignoreDragOver","dragover .drop-right-zone":"ignoreDragOver","dragenter .drop-left-zone":"hoverLeftBar","dragenter .drop-right-zone":"hoverRightBar","dragleave .drop-left-zone":"hoverLeftBar","dragleave .drop-right-zone":"hoverRightBar","dragend .drop-right-zone":"dragend","dragend .drop-left-zone":"dragend","drop .drop-right-zone":"drop","drop .drop-left-zone":"drop"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:toggle:bottom-right",this.onToggleBottomRight),this.listenTo(m,"globalEvent:esc globalEvent:click",this.setTodoStateClosed),this.listenTo(m,"todo:visible",this.todoVisible),this.listenTo(m,"globalEvent:key:shiftN",this.focusOnNewTodo),this.listenTo(m,"globalEvent:key:A",this.focusOnNewTodo),this.listenTo(m,"globalEvent:arrowLeft",this.arrowLeft),this.listenTo(m,"globalEvent:arrowRight",this.arrowRight),this.listenTo(m,"globalEvent:altArrowUp",this.altUp),this.listenTo(m,"globalEvent:altArrowDown",this.altDown),this.listenTo(m,"globalEvent:window:resize",this.windowResize),this.listenTo(m,"todo:hidden",this.todoHidden),this.listenTo(m,"todo:dragging",this.todoDragging),this.listenTo(m,"todo:newProvider",this.openTodo),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),m.models.customization.get("keepTodoState")&&this.showTodoList()&&this.toggleShow(),this.isHovered=!1},render:function(){if(!this.renderedOnce){this.setMaxWidgetHeight();var e=this.template({}),t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(e).fadeTo(500,1),this.$panecontainer=this.$el.find(".todo-pane")[0],this.$listcontainer=this.$el.find(".todo-list")[0],this.$headercontainer=this.$el.find(".todo-header")[0],this.$newtodoinput=this.$el.find("#todo-new")[0],this.$el.toggleClass("show",this.todoListOpen),this.renderedOnce=!0}var i=this;return setTimeout(function(){i.$el.find(".todo-item").first().find(".dropdown").show()},1e3),this},showUpsell:function(e){if(this.upsellView)this.upsellView.options=e,this.upsellView.render();else{e.template=m.templates.todos.upsell,this.upsellView=new m.views.upsell.message(e);var t=this.upsellView.render().$el;this.$el.find(".todo-pane").append(t)}this.upsellView.show()},showTodoList:function(){var e=localStorage.getItem("showTodoList");return!!e&&JSON.parse(e)},toggleShow:function(e){m.trigger("globalEvent:closeDropdowns",this),m.trigger("globalEvent:toggle:bottom-left",this),!this.todoListOpen?this.todoVisible():this.todoHidden(),this.setMaxWidgetHeight()},onToggleBottomRight:function(e){e!=this&&this.todoListOpen&&this.todoHidden()},openTodo:function(){this.setTodoOpenState(!0)},setTodoStateClosed:function(e){if(e!=this&&!(e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.el,e.target))){var i=!1;$(".todo-item-title").each(function(e,t){"true"==$(this).attr("contentEditable")&&(i=!0)}),i||m.models.customization.get("keepTodoState")&&"27"!=e.keyCode||this.todoHidden()}},setTodoOpenState:function(e){this.todoListOpen=e,m.models.customization.get("keepTodoState")?localStorage.showTodoList=e:localStorage.showTodoList=!1,1==e?this.showPopup():this.hidePopup(),e?(this.newTodoInput&&this.newTodoInput.focusInputField(),this.doFirstFetch()):this.todoHeader&&this.todoHeader.stopChoosing()},windowResize:function(){this.setMaxWidgetHeight()},setMaxWidgetHeight:function(){var e=$(window).height()-125,t=this.$el;if(t.css("max-height",e),t){var i=t.find(".todo-list-active").outerHeight(),o=t.find(".todo-message").outerHeight(!0),n=t.find(".todo-new").outerHeight();0==i&&(i=39),null==o&&(o=0),0==n&&(n=38)}return e},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto")},hidePopup:function(){if(this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show").find(".pane").css("height","auto")})}},providerChanged:function(){m.models.todoListManager&&this.supportParentList!=m.models.todoListManager.activeProvider.supportParentList&&(this.supportParentList=m.models.todoListManager.activeProvider.supportParentList,this.$el.find(".parent-list-support").toggleClass("active",this.supportParentList))},doFirstFetch:function(){this.initializeManager(),m.models.todoListManager.externallyFetchedOnce=!0,m.models.todoListManager.activeProvider.doFetchIfNeeded(),this.supportParentList=m.models.todoListManager.activeProvider.supportParentList,this.$el.find(".parent-list-support").toggleClass("active",this.supportParentList)},todoVisible:function(){this.setTodoOpenState(!0)},todoDragging:function(e){if(this.draggingTodo=e,this.hoverCounter=0,!e.model.get("noMove")){var t=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(-1);t&&t.get("boardId")&&t.get("boardId")==e.selectedList.get("boardId")&&(this.$el.find(".todo-pane").addClass("has-drop-left"),this.$el.find(".left-bar .bar-name").html(t.get("title")));var i=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(1);i&&i.get("boardId")&&i.get("boardId")==e.selectedList.get("boardId")&&(this.$el.find(".todo-pane").addClass("has-drop-right"),this.$el.find(".right-bar .bar-name").html(i.get("title")))}},todoHidden:function(){this.setTodoOpenState(!1)},onBackgroundLoaded:function(){this.initializeManager()},initializeManager:function(){m.models.todoListManager||(m.models.todoListManager=new m.models.TodoListManager({prefetchTodos:this.todoListOpen}),m.trigger("todo:managerReady"),this.todoHeader=new m.views.TodoListHeader({el:this.$headercontainer,model:m.models.todoListManager,parent:this}),this.todoList=new m.views.TodoList({el:this.$listcontainer,model:m.models.todoListManager}),this.newTodoInput=new m.views.NewTodoInput({todoList:this.todoList,el:this.$newtodoinput,model:m.models.todoListManager}),this.setMaxWidgetHeight())},visibleChanged:function(e){m.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},arrowLeft:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectPreviousProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedProject().selectPreviousList())},arrowRight:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectNextProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedProject().selectNextList())},altUp:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),m.models.todoListManager.activeProvider.selectPreviousProject())},altDown:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),m.models.todoListManager.activeProvider.selectNextProject())},focusOnNewTodo:function(e){this.todoListOpen&&(e&&(e.preventDefault(),e.stopPropagation()),this.newTodoInput.focusInputField())},getHoverInfo:function(e){var t=this,i="dragenter"==e.type;i&&e.preventDefault(),this.hoverCounter+=i?1:-1;var o=0<this.hoverCounter;return o?this.$el.find(".todo-list .placeholder").hide():setTimeout(function(){t.dropListOffset=null},400),o},hoverRightBar:function(e){var t=this.getHoverInfo(e);this.$el.find(".drop-right-zone").toggleClass("hover",t),t&&(this.dropListOffset=1)},hoverLeftBar:function(e){var t=this.getHoverInfo(e);this.$el.find(".drop-left-zone").toggleClass("hover",t),t&&(this.dropListOffset=-1)},dragend:function(e){this.hoverCounter=0,e.preventDefault(),this.$el.find(".todo-list").removeClass("dragging"),this.$el.find(".todo-list .placeholder").hide(),this.$el.find(".drop-left-zone").removeClass("hover"),this.$el.find(".drop-right-zone").removeClass("hover"),this.$el.find(".todo-pane").removeClass("has-drop-left has-drop-right"),this.dropListOffset=null,this.draggingTodo=null},drop:function(e){if(this.$el.find(".todo-list .placeholder").hide(),this.dropListOffset){var t=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(this.dropListOffset);(new m.commands.TodoMove).execute(this.draggingTodo.model,{target_id:t.id}),this.dragend(e)}else this.dragend(e)},ignoreDragOver:function(e){return e.preventDefault(),!(e.originalEvent.dataTransfer.dropEffect="move")},storedTodoPaneHeight:function(e){if(null!=e)return 0<e&&localStorage.setItem("todo-pane-height",e),e;var t=localStorage["todo-pane-height"];return t?JSON.parse(t):null}}),m.views.upsell=m.views.upsell||{},m.views.upsell.message=Backbone.View.extend({events:{"click .upsell-hide":"hideUpsell","click .upsell-action":"clickButton"},initialize:function(e){this.template=e.template,this.options=e,this.listenTo(m,"globalEvent:click",this.handleClick)},render:function(){return this.options.class=(this.options.class?this.options.class+" ":"")+this.options.targetRegion+"-upsell",this.$el.html(this.template(this.options)),this.$el.addClass("overlay upsell-overlay"),this.$el.addClass(this.options.class),this},show:function(){var e=this,t=e.$el.height();e.$el.css("max-height",e.$el.parent().outerHeight(!0)),e.$el.css("z-index",1e3),setTimeout(function(){e.parentMinHeight=e.$el.parent().css("min-height"),e.parentMinHeight&&(e.parentMinHeight=parseInt(e.parentMinHeight.substring(0,e.parentMinHeight.length-2))),e.$el.parent().css("min-height",Math.max(t,e.parentMinHeight)),e.parentOverflow=e.$el.parent().css("overflow-y"),e.$el.parent().css("overflow-y","hidden"),e.$el.addClass("active")},20)},handleClick:function(e){$.contains(this.$el,e.target)||1!=this.$el.css("opacity")||this.hideUpsell()},hideUpsell:function(e){e&&e.stopPropagation(),this.$el.removeClass("active");var t=this;t.$el.parent().css("min-height",t.parentMinHeight?t.parentMinHeight:0),setTimeout(function(){t.$el.parent().css("overflow-y",t.parentOverflow),parseFloat(t.$el.css("opacity"))<.5&&t.$el.css("z-index",-1)},300)},clickButton:function(e){e.stopPropagation(),m.commandManager.execute("upsell.website",null,{source:this.options.sourceEvent})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){switch(e.targetRegion){case"settings":m.views.settings.mainSettings.showUpsell(e);break;case"todos":m.views.todoPane.showUpsell(e);break;case"weather":m.views.weather.showUpsell(e)}}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t,i){var o="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?o+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(o+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:o})}}),m.views.Greeting=Backbone.View.extend({id:"greeting",template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e={period:this.getPeriod(),name:m.models.customization.get("displayname")},t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(this.template(e)).fadeTo(500,1),this.$period=this.$(".period"),this.$name=this.$(".name");var i=this;m.models.customization.getComputedSetting("clockVisible")?i.$el.addClass("transition"):setTimeout(function(){i.moveToCenter(),setTimeout(function(){i.$el.addClass("transition")},1e3)},10),setTimeout(function(){i.renderedOnce=!0},1e3)},getPeriod:function(){var e,t=this.model.get("date").getHours();return 3<=t&&t<12&&(e="morning"),12<=t&&t<17&&(e="afternoon"),(17<=t||t<3)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1),this.renderedOnce&&this.$name.addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.html();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},moveToCenter:function(){var e=(document.body.getBoundingClientRect().height-this.$el.outerHeight(!0))/2-this.$el[0].getBoundingClientRect().top;this.$el.css("transform","translateY("+e+"px)")},moveOffCenter:function(){this.$el.css("transform","translateY(0)")}}),m.views.CenterClock=Backbone.View.extend({id:"centerclock",events:{dblclick:"toggleMode"},initialize:function(){var e=localStorage.getItem("percentClockActive");e&&(m.models.customization.save("percentClockActive",e),localStorage.removeItem("percentClockActive")),this.listenTo(m.models.customization,"change:percentClock",this.percentClockToggled),this.listenTo(m.models.customization,"change:percentClockActive",this.percentClockToggled),this.listenTo(m.models.customization,"change:clockVisible",this.balanceChanged),this.listenTo(m.models.customization,"change:balanceModeStr",this.chooseClock),this.renderedOnce=!1,this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).html(""),m.models.customization.getComputedSetting("clockVisible")&&this.$el.fadeTo(500,1),m.models.customization.get("percentClock")&&m.models.customization.get("percentClockActive")&&m.models.balanceMode.getDays()[(new Date).getDay()]?m.views.percentClock=m.views.clockView=new m.views.PercentClock({model:this.model,parent:this}):m.views.clockView=new m.views.DefaultClock({model:this.model,parent:this,renderedOnce:this.renderedOnce});var t=this;return this.$el.append(m.views.clockView.render().$el),setTimeout(function(){t.renderedOnce=!0},1e3),this},chooseClock:function(){var e=!m.models.balanceMode.getDays()[(new Date).getDay()];(!e&&"default"==m.views.clockView.type||e&&"percent"==m.views.clockView.type)&&this.render()},balanceChanged:function(){var e=m.models.customization.getComputedSetting("clockVisible"),t=this,i=!1,o=!1;e?(this.renderedOnce?i=!0:(setTimeout(function(){t.render()},5),o=!0),setTimeout(function(){i&&t.$el.animate({opacity:1},{duration:700,queue:!1}),m.views.greeting.moveOffCenter()},o?10:0)):(t.$el.animate({opacity:0},{duration:300,queue:!1}),m.views.greeting.moveToCenter())},percentClockToggled:function(e){e&&e.changed&&1==Object.keys(e.changed).length&&e.changed.percentClock&&m.models.customization.get("percentClock")&&m.models.customization.save("percentClockActive",!0),this.render()},toggleMode:function(){m.models.customization.get("percentClock")&&(m.models.customization.save("percentClockActive",!m.models.customization.get("percentClockActive")),this.render())}}),m.views.DefaultClock=Backbone.View.extend({attributes:{class:"clock default-clock"},template:m.templates.centerclock.clock,events:{dblclick:"toggleFormat"},initialize:function(e){this.type="default",this.renderedOnce=e.renderedOnce,this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e={time:this.model.getTimeString(),format:this.model.getTimePeriod()};this.$el.html(this.template(e)),this.$time=this.$(".time"),this.$format=this.$(".format"),this.update();var t=this;return this.renderedOnce?this.setTimeFormat(m.models.customization.get("hour12clock")):setTimeout(function(){t.renderedOnce=!0},1e3),this},update:function(){this.$time.html(this.formatOnes(this.model.getTimeString()))},formatOnes:function(e){return e.replace(/1/g,'<span class="clock-one">1</span>')},toggleFormat:function(){if(!m.models.customization.get("percentClock")){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e,!0)}},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e,!0),this.update()},setTimeFormat:function(e,t){e&&this.renderedOnce?(t&&setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")}}),m.views.PercentClock=Backbone.View.extend({attributes:{class:"percent-clock"},template:m.templates.centerclock.clock,events:{},initialize:function(){this.type="percent",this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.balanceMode,"change",this.update,this)},render:function(){return this.$el.html(this.template({time:this.getPercent(),format:"%"})),this.$time=this.$(".time"),this.$format=this.$(".format"),this.$format.css({opacity:1,"font-size":"250%",left:"106%",bottom:"7%"}),this},getPercent:function(){var e=m.models.balanceMode.getStart(),t=m.models.balanceMode.getEnd(),i=parseInt(e.hour);12==i&&(i=0);var o=parseInt(t.hour);12==o&&(o=0);var n=i+("PM"==e.noon?12:0),s=e.minute,a=o+("PM"==t.noon?12:0),l=t.minute;24<a-n&&(a-=24);var r=new Date;a<n&&(r.getHours()<=a?n-=24:a+=24);var d=60*(a+parseInt(l)/60-(n+parseInt(s)/60))*60*1e3,c=new Date;c.setHours(n,s,0,0);var h=r.getTime()-c.getTime(),u=Math.floor(h/d*100);return 100<u&&(u="+"+(u-100)),u},update:function(){this.$time.html(this.getPercent())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){m.commandManager.execute("auth.connect.provider",e.actionParameter,function(){m.models.todoListManager.doFetchIfNeeded(!0)})}}),m.commands.AuthConnectProvider=m.models.Command.extend({defaults:{id:"auth.connect.provider"},execute:function(e,t,i){if(e&&e.status&&"authRequired"===e.status&&e.authorizationUrl){var o=e.winWidth?e.winWidth:600,n=e.winHeight?e.winHeight:510,s=e.windowFeatures?e.windowFeatures:"titlebar,resizable,status",a=window.screen.width/2-o/2,l=window.screen.height/2-n/2,r=window.open(e.authorizationUrl,"MomentumAuthWindow",s+",left="+a+",top="+l+",width="+o+",height="+n),d=function(){r.closed||setTimeout(function(){r.closed||r.close()},1e3),t&&t()},c=e.authorizationUrl.split("/"),h="";1<c.length&&(h=c[c.length-1]);var u=m.globals.urlRootApi+"user/auth/status/"+h,g=0,p=1e3,f=function(){r.closed?d():100<++g||(g%30&&(p+=1e3),$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:u}).done(function(e){e&&e.token_obtained?d():setTimeout(function(){f()},p)}).fail(function(e,t){setTimeout(function(){f()},p)}))};f()}else i&&i()}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=Date.now()-1728e5},execute:function(){var n=this;if(!(localStorage.getItem("last_cleanup")>this.twoDaysAgo))var s=setTimeout(function(){try{if(!m||!m.collect||!m.collect.backgrounds)return;clearTimeout(s);for(var e=[],t=!1,i=null,o=0;o<localStorage.length;o++)t=!1,"archived-"==(i=localStorage.key(o)).substring(0,9)&&(t=!0),"fallback-"==i.substring(0,9)&&(t=!0),"image_displayed-"==i.substring(0,16)&&(t=!0),"weather-loc-"==i.substring(0,12)?t=!0:"ddl-bg-"==i.substring(0,7)?localStorage.getItem(i)<n.twoDaysAgo&&(t=!0):"ddl-qt-"==i.substring(0,7)&&localStorage.getItem(i)<n.twoDaysAgo&&(t=!0),t&&e.push(i);for(o=0;o<e.length;o++)localStorage.removeItem(e[o]);e.length,n.collectionCleaner(m.collect.backgrounds),n.collectionCleaner(m.collect.quotes),n.collectionCleaner(m.collect.shortquotes),m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",Date.now())}catch(e){}},500)},collectionCleaner:function(e,i){var o=this;if(e){i=i||"forDate",entriesToClean=[],e.each(function(e){var t=e.get(i);Date.parse(t)<o.twoDaysAgo&&entriesToClean.push(t)});for(var t=0;t<entriesToClean.length;t++){e.get(entriesToClean[t]).destroy()}return entriesToClean.length}return 0}}),m.commands.CleanupUserData=m.models.Command.extend({defaults:{id:"user.cleanup"},execute:function(e,t){e&&e.type&&("notifications"==e.type?this.cleanNotifications():"all"==e.type&&(this.cleanUserData(),this.managerCleanup(m),this.managerCleanup(m.models))),t&&t()},managerCleanup:function(e){var t=Object.keys(e);for(i in t){var o=t[i];if(m.hasOwnProperty(o)){var n=m[o];(n instanceof m.models.Manager||n instanceof m.collect.Manager)&&n.cleanup&&n.cleanup()}}},cleanNotifications:function(){for(var e=[],t=!1,i=null,o=0;o<localStorage.length;o++)t=!1,(i=localStorage.key(o)).startsWith("momentum-messages")?t=!0:"ts_notifications"==i&&(t=!0),t&&e.push(i);for(o=0;o<e.length;o++)localStorage.removeItem(e[o])},cleanUserData:function(){for(var e=[],t=!1,i=null,o=0;o<localStorage.length;o++)t=!1,"notes"==(i=localStorage.key(o))?t=!0:i.startsWith("momentum-messages")?t=!0:"notes-"==i.substring(0,6)?t=!0:"cachedTodoProviders"==i?t=!0:"cachedFocus"==i?t=!0:"f3t6b23d"==i?t=!0:"current-countdown"==i?t=!0:"countdowns"==i?t=!0:"countdown"==i?t=!0:"countdown-"==i.substring(0,10)?t=!0:"countdowns-"==i.substring(0,11)?t=!0:"activeTodoProvider"==i?t=!0:"activeTodoListId-"==i.substring(0,17)?t=!0:"font-"==i.substring(0,5)?t=!0:"listCache-"==i.substring(0,10)?t=!0:"projectCache-"==i.substring(0,13)?t=!0:"activeTodo"==i.substring(0,10)?t=!0:"tsCachedTodoProviders"==i?t=!0:"ts_notifications"==i?t=!0:"todos-updated"==i&&(t=!0),t&&e.push(i);for(o=0;o<e.length;o++)localStorage.removeItem(e[o])}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.AccountLogin=m.models.Command.extend({defaults:{id:"account.login"},execute:function(e,t,i){localStorage.token?m.commandManager.execute("notification.show.enhanced",{message:"You are already logged in.",viewLimit:1,priority:2}):(m.commandManager.execute("user.cleanup",{type:"notifications"}),localStorage.doLoginOnNextLoad=!0,window.location.reload())}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(){var i=this;if(m.commandManager.execute("user.cleanup",{type:"all"}),localStorage.token&&localStorage.token_uuid){var e={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(e),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){}).fail(function(e,t){}).always(function(e,t){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.conditionalFeatures.clearFeatures(),i.showLogoutMessageAndReload()})}else localStorage.removeItem("token"),this.showLogoutMessageAndReload()},showLogoutMessageAndReload:function(e){localStorage.setItem("loggedOut",Date.now()),m.commandManager.execute("notification.show.enhanced",{message:"You have been logged out.",display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)}}),m.commands.SyncEnable=m.models.Command.extend({defaults:{id:"sync.enable"},execute:function(e,t,i){m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")||localStorage.token&&m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){window.location.reload()},function(){m.commandManager.execute("notification.show.enhanced",{message:"Unable to enable account sync. Reload the tab and try again, or check our help site.",viewLimit:1,priority:2})})}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&(window.location.href=i)}}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&window.open(i,t.windowName||"_blank")}}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.commands.SettingsColorPicker=m.models.Command.extend({defaults:{id:"settings.color.picker"},initialize:function(){this.views=[]},execute:function(e,t){if(t&&t.settingName){var i=_.findWhere(this.views,{settingName:t.settingName});return i||(i=new m.views.settings.ColorPicker(t.settingName,e,t),this.views.push(i)),i}return null}}),m.commands.SettingsDisplay=m.models.Command.extend({defaults:{id:"settings.display"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.showSettings(t)}}),m.commands.SettingsDisplayUpgrade=m.models.Command.extend({defaults:{id:"settings.display.upgrade"},execute:function(e,t,i){var o="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?o+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(o+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:o})}}),m.commands.SettingsDisplayUpgradePanel=m.models.Command.extend({defaults:{id:"settings.display.upgrade.panel"},execute:function(e,t,i){m.views.settings.mainSettings&&((t=t||{}).section="upgrade",m.views.settings.mainSettings.showSettings(t))}}),m.commands.SettingsToggle=m.models.Command.extend({defaults:{id:"settings.toggle"},execute:function(e,t){t&&t.section?(m.views.settings.mainSettings.toggleVisible(),m.views.settings.mainSettings.visible&&m.views.settings.mainSettings.showSettings(t)):m.views.settings.mainSettings&&m.views.settings.mainSettings.toggleVisible()}}),m.commands.SettingsHide=m.models.Command.extend({defaults:{id:"settings.hide"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.hideSettings()}}),m.commands.SettingEnable=m.models.Command.extend({defaults:{id:"setting.enable"},execute:function(e,t){if(t&&t.name){var i={};i[t.name]=!!t.value,m.models.customization.set(i)}}}),m.commands.SettingsCacheUpgradeCopy=m.models.Command.extend({defaults:{id:"settings.cache.upgradecopy"},fetching:!1,fetched:!1,execute:function(e,t){var i=this;if((e||!m.conditionalFeatures.featureEnabled("plus"))&&(e||!i.fetching&&!i.fetched)){i.fetching=!0;var o=m.globals.urlRootApi+"settings/upgradecopy";t&&e?o=o+"?refresh=1&src="+encodeURIComponent(t):t?o=o+"?src="+encodeURIComponent(t):e&&(o+="?refresh=1"),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:o}).done(function(e){i.fetching=!1,e&&(i.fetched=!0,localStorage.setItem("cachedUpgradeCopy",JSON.stringify(e)),m.trigger("settings:upgradeCopyChanged"))}).fail(function(e,t){i.fetched=!1,i.fetching=!1}),setTimeout(function(){i.fetching&&(i.fetching=!1)},1e4)}}}),m.commands.enableBookmarks=m.models.Command.extend({defaults:{id:"settings.enableBookmarks"},execute:function(e){var t=m.models.bookmarksSettings.permissions,i=e.callback,o=m.models.customization;if(o.get("bookmarksVisible"))return m.views.bookmarks.hidePopup(),o.save("bookmarksVisible",!1),void i();var n=function(){o.save("bookmarksVisible",!0),i()};try{getBrowser().bookmarks.get("1",function(){}),n()}catch(e){new m.views.BookmarksPrimer({permissions:t,callback:function(){n()}}).render()}}}),m.commands.TodoAsanaMoveSectionMenu=m.models.Command.extend({defaults:{id:"todo.asana.move.section.menu"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var n=[],s=this,a=s.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(e){var t=a.substring(0,a.lastIndexOf("-")),i=e.id.substring(0,e.id.lastIndexOf("-"));if(s.parentContext.selectedList().id!=e.id&&i==t){var o={};o.listId=e.id,o.captionText=e.get("title"),o.count=e.get("count"),n.push(o),o.commandId="todo.asana.move.section",o.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(n)}}}),m.commands.TodoAsanaMoveSection=m.models.Command.extend({defaults:{id:"todo.asana.move.section"},execute:function(e,t){var i={listId:t.target_id};e.attemptSave(i),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t){return t&&e.get("listId")!=t.target_id}}),m.commands.TodoGithubMoveSectionMenu=m.models.Command.extend({defaults:{id:"todo.github.move.section.menu"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var n=[],s=this,a=s.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(e){var t=a.substring(0,a.lastIndexOf("-")),i=e.id.substring(0,e.id.lastIndexOf("-"));if(s.parentContext.selectedList().id!=e.id&&i==t){var o={};o.listId=e.id,o.captionText=e.get("title"),o.count=e.get("count"),n.push(o),o.commandId="todo.github.move.section",o.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(n)}}}),m.commands.TodoGithubMoveSection=m.models.Command.extend({defaults:{id:"todo.github.move.section"},execute:function(e,t){var i={listId:t.target_id};e.attemptSave(i),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t){return!!t&&e.get("listId")!=t.target_id}}),m.commands.TodoMove=m.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(e,t){var i=e.collection.parentList.collection.findWhere({id:t.target_id}),o={};e.collection.parentList.isTodayList()?m.utils.mergeObjects(o,e.getTodayStateChanges(!1)):e.collection.parentList.isDoneList()&&m.utils.mergeObjects(o,e.getDoneStateChanges(!1)),i.isTodayList()?m.utils.mergeObjects(o,e.getTodayStateChanges(!0)):i.isDoneList()&&m.utils.mergeObjects(o,e.getDoneStateChanges(!0)),i.isTodayList()||i.isDoneList()||m.utils.mergeObjects(o,{listId:t.target_id}),e.attemptSave(o),i.changeCount(!0),m.trigger("todo:loadingStateChange",null),setTimeout(function(){i.refreshItems()},200)},canExecute:function(e,t){return!!t&&e.get("listId")!=t.target_id}}),m.commands.TodoDoneAndArchive=m.models.Command.extend({defaults:{id:"todo.done.archive"},execute:function(e,t){e.setDoneState(!0,!0),e.collection.parentList.collection.findWhere({id:"1-done"}).changeCount(!0)},canExecute:function(e,t,i){return!i.selectedList().isDoneList()}}),m.commands.TodoToggleToday=m.models.Command.extend({defaults:{id:"todo.toggle.today"},execute:function(e,t,i){var o=!e.get("today");e.setTodayState(o),"today"!=e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({type:"today"}).changeCount(o),"today"==e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!o)},canExecute:function(e,t,i){return!(e.collection.parentList.id==e.get("homeListId")&&e.get("today")||i.selectedList().isDoneList())},getProperties:function(e,t,i){var o=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return o?{captionText:"Move to "+(e.get("today")?o.get("title"):"Today")}:{captionText:null}}}),m.commands.TodoUnDone=m.models.Command.extend({defaults:{id:"todo.undone"},execute:function(e,t,i){e.get("archive");e.setDoneState(!1),e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!0),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t,i){return i.selectedList().isDoneList()},getProperties:function(e,t,i){var o=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return o?{captionText:"Move to "+(e.get("today")?"Today":o.get("title"))}:{captionText:null}}}),m.commands.TodoArchive=m.models.Command.extend({defaults:{id:"todo.archive"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0),m.trigger("todolist:updateHeight")},canExecute:function(e,t,i){return!i.selectedList().isDoneList()&&e.get("done")}}),m.commands.TodoArchiveAlways=m.models.Command.extend({defaults:{id:"todo.archive.always"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0),m.trigger("todolist:updateHeight")},canExecute:function(e,t,i){return!0}}),m.commands.TodoDelete=m.models.Command.extend({defaults:{id:"todo.delete"},execute:function(t){t.collection.models.map(function(e){e.get("parentId")==t.get("id")&&e.deleteItem()}),t.deleteItem(),m.trigger("todo:loadingStateChange")},canExecute:function(e,t){return!0}}),m.commands.TodoMoveTo=m.models.Command.extend({defaults:{id:"todo.moveTo"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var i=[],o=this;return this.parentContext.selectedProject().listCollection.map(function(e){if(o.parentContext.selectedList().id!=e.id){var t={};t.listId=e.id,t.captionText=e.get("title"),t.color=e.get("color"),t.count=e.get("count"),i.push(t),e.isDoneList()&&(t.commandId="todo.done.archive"),t.commandId||(t.commandId="todo.move.id"),t.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(i)}}}),m.commands.TodoSwitchFeed=m.models.Command.extend({defaults:{id:"todo.switch.feed"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return!0},getSubmenu:function(){var e=this.parentContext.selectedList().topMenuItems();return e.fetchIfRequired(this.parentContext.id),{title:null,items:e}}}),m.commands.TodoVisitExternal=m.models.Command.extend({defaults:{id:"todo.visit.external"},execute:function(e,t,i){var o=t.urlField;return o||(o=t.providerUrl),getBrowser().tabs.create({url:o}),!0}}),m.commands.TodoToggleAssignee=m.models.Command.extend({defaults:{id:"todo.toggle.assignee"},execute:function(e,t,i){var o="assigned-"+i.selectedList().id;m.models.customization.set(o,!m.models.customization.get(o)),m.trigger("toggleAssignee",o)}}),m.commands.ToggleAutoFocus=m.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(e){if(m.conditionalFeatures.featureEnabled("pinfocus"))return m.models.customization.toggle("autoFocus"),m.trigger("toggleAutoFocus",m.models.customization.get("autoFocus")),!0;m.commandManager.execute("settings.display",null,{section:"upgrade",source:"autofocus"})}}),m.commands.TodoShowSettings=m.models.Command.extend({defaults:{id:"todo.show.settings"},execute:function(){m.commandManager.execute("settings.display",null,{section:"todo"})}}),m.commands.MenuIgnore=m.models.Command.extend({defaults:{id:"menu.ignore"},execute:function(e){return!0},canExecute:function(e,t){return!0}}),m.commands.TodoDeleteWarn=m.models.Command.extend({defaults:{id:"todo.delete.warn"},execute:function(e){return!0},canExecute:function(e,t){return!0},getSubmenu:function(){return{title:"Delete?",items:new Backbone.Collection([{captionText:"Yes",commandId:"todo.delete"},{captionText:"No",commandId:"menu.ignore",css_class:"dropdown-detail-back"}])}}}),m.commands.TodoFocusPin=m.models.Command.extend({defaults:{id:"todo.focus.pin"},execute:function(e){m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString(),i=e.collection.parentList.project,o={todoId:e.id,listId:e.get("listId"),projectId:e.get("projectId")||i.id,providerId:i.provider.id,forDate:t};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(o),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"focus/pin"}).done(function(e){e.success&&1==e.success&&(m.views.focuses.successfulConnection(),m.models.customization.getComputedSetting("autoFocus")?m.models.customization.set("autoFocus",!1):m.collect.focuses.fetch({reset:!0}))}).fail(function(e,t){})},canExecute:function(e,t){return!e.get("done")}}),m.commands.TodoRetryConnection=m.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(e){m.models.todoListManager&&(m.models.todoListManager.doFetchIfNeeded(!0),m.models.todoListManager.activeProvider.refreshTodoItems())}}),m.commands.ToggleKeepTodoState=m.models.Command.extend({defaults:{id:"todo.toggle.keepstate"},execute:function(e){m.models.customization.toggle("keepTodoState"),m.models.customization.get("keepTodoState")||(localStorage.showTodoList=!1)}}),m.commands.EditTodo=m.models.Command.extend({defaults:{id:"todo.edit"},execute:function(e){e.trigger("todo:edit")}}),m.commands.CloseTodo=m.models.Command.extend({defaults:{id:"todo.close"},execute:function(e){e.trigger("todo:close")},canExecute:function(e,t){return!e.get("done")}}),m.commands.OpenTodo=m.models.Command.extend({defaults:{id:"todo.open"},execute:function(e){e.trigger("todo:open")},canExecute:function(e,t){return!!e.get("done")}}),m.commands.TodoListDefaultCommand=m.models.Command.extend({defaults:{id:"todo.list.defaultcommand"},execute:function(e,t){return t&&t.get("done")?{captionText:"Archive to Done",commandId:"todo.move.done"}:{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}}}}),m.commands.TodoListArchiveAllDone=m.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(e,t){if(e&&!e.isDoneList()){var i=e.itemCollection.models;_.each(i,function(e){e.get("done")&&!e.get("archive")&&e.archive()}),m.trigger("globalEvent:closeDropdowns"),m.trigger("todolist:updateHeight")}},canExecute:function(e){if(e&&e.isDoneList())return!1;if(e)var t=e.itemCollection;return!!(t&&0<t.completedCount())}}),m.commands.TodoProviderChange=m.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(e,t){t&&t.provider_id&&m.models.todoListManager.changeProvider(t.provider_id)},canExecute:function(e,t){return t.provider_id!=m.models.todoListManager.activeProvider.id}}),m.commands.TodoSwitchParentProject=m.models.Command.extend({defaults:{id:"todo.switch.parent.project"},execute:function(e,t){m.models.todoListManager.switchProject(t.projectId)},canExecute:function(e,t){return!0}}),m.commands.TodoListCheckStateAutofocus=m.models.Command.extend({defaults:{id:"todo.list.check.state.autofocus"},execute:function(){return m.models.customization.get("autoFocus")}}),m.commands.TodoListCheckStateAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.state.assigned"},execute:function(e,t,i){if(e){var o=e.get("id");return!!m.models.customization.get("assigned-"+o)}}}),m.commands.TodoListCheckToggleAssigned=m.models.Command.extend({defaults:{id:"todo.list.toggle.assigned"},execute:function(e,t){var i=e.get("id"),o=m.models.customization.get("assigned-"+i);return m.models.customization.set("assigned-"+i,!o),!1}}),m.commands.TodoListCheckStateSubtasks=m.models.Command.extend({defaults:{id:"todo.list.check.state.subtasks"},execute:function(e,t,i){if(e){var o=e.get("id");return 1==m.models.customization.get("subtask-"+o)}}}),m.commands.TodoListToggleSubtasks=m.models.Command.extend({defaults:{id:"todo.list.toggle.subtasks"},execute:function(e,t){var i=e.get("id"),o=m.models.customization.get("subtask-"+i);return m.models.customization.set("subtask-"+i,!o),!1}}),m.commands.TodoListShowOldTasks=m.models.Command.extend({defaults:{id:"todo.list.show.old.todos"},execute:function(e,t,i){var o=e.get("id"),n=m.models.customization.get("showOld-"+o);return m.models.customization.set("showOld-"+o,!n),!1}}),m.commands.TodoListCheckStateOldTodos=m.models.Command.extend({defaults:{id:"todo.list.check.state.old.todos"},execute:function(e,t,i){if(e){var o=e.get("id");return 1==m.models.customization.get("showOld-"+o)}}}),m.commands.TodoShowArchivedProjects=m.models.Command.extend({defaults:{id:"todo.show.archived.projects"},execute:function(e,t,i){var o="archived-"+i.id,n=m.models.customization.get(o);return m.models.customization.save(o,!n),i.doFetchIfNeeded(!0),!1}}),m.commands.TodoCheckStateArchivedProjects=m.models.Command.extend({defaults:{id:"todo.check.state.archived.projects"},execute:function(e,t,i){return 1==m.models.customization.get("archived-"+i.id)}}),m.commands.TodoTrelloAuxData=m.models.Command.extend({defaults:{id:"todo.trello.aux"},execute:function(e,t){var i={};return e.collection&&e.collection.parentList&&(i.showAssignedOnly=m.models.customization.get("assigned-"+e.collection.parentList.id)),i}}),m.commands.TodoTrelloOpenConfig=m.models.Command.extend({defaults:{id:"todo.trello.config"},execute:function(){m.commandManager.execute("settings.display",null,{section:"trello"})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){switch(e.targetRegion){case"settings":m.views.settings.mainSettings.showUpsell(e);break;case"todos":m.views.todoPane.showUpsell(e);break;case"weather":m.views.weather.showUpsell(e)}}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t,i){var o="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?o+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(o+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:o})}}),m.isValidDate=function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},m.models.Date=Backbone.Model.extend({defaults:function(){return{date:new Date}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},setUpdateTimer:function(){var e=this,t=6e4,i=new Date;t=t-1e3*i.getSeconds()-i.getMilliseconds(),this.dateTimeoutId=setTimeout(function(){e.set("date",new Date),e.setUpdateTimer()},t)},getTimeString:function(e){var t=m.models.customization.get("hour12clock"),i=(e=e||this.get("date")).getHours(),o=e.getMinutes();return 1==t&&(i=(i+11)%12+1),i<10&&!t&&(i="0"+i),o<10&&(o="0"+o),i+":"+o},getTimePeriod:function(){return 12<=this.get("date").getHours()?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){var t=this;this.$loading=$('<span class="overlay loading todo-loading""><i class="loading-icon"></i> Loading...</span>'),m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.views.background=new m.views.Background({region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({region:"bottom-left"}),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.bootstrappers.InitializeQuote(m,$),m.models.date&&m.models.date.setUpdateTimer(),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),!m.models.customization.get("displayname")||localStorage.doLoginOnNextLoad?m.views.introduction=new m.views.Introduction({region:"full"}):(m.bootstrappers.InitializeFocus(m,$),this.render());var i=$("body");i.addClass(getBrowserName()),"Firefox"==getBrowserName()&&getBrowserVersion()<57&&i.addClass("oldFireFox"),m.conditionalFeatures.featureEnabled("custom-bg")&&!m.models.customization.get("disableDrop")&&(this.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),window.addEventListener("dragenter",function(e){_.contains(e.dataTransfer.types,"Files")&&(t.lastTarget=e.target,i.addClass("blur drop"))}),window.addEventListener("dragleave",function(e){e.preventDefault(),e.target!==document&&e.target!==t.lastTarget||i.removeClass("blur drop")},!1),window.addEventListener("dragover",function(e){e.preventDefault()}),this.addEventHandler(document.body,"drop",function(e){if(e.stopPropagation(),e.preventDefault(),i.removeClass("blur drop"),_.contains(e.dataTransfer.types,"Files"))if(m.conditionalFeatures.featureEnabled("custom-bg")){var t=e.dataTransfer.files;t&&0<t.length&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",t)},null,function(e){})}else{m.commandManager.execute("upsell.message",{targetRegion:"settings",sourceEvent:"customBackgrounds-dropFiles",buttonText:"Learn more",title:"Custom Backgrounds",description:"Add your own backgrounds with Plus"})}})),this.initializeCompleted=!0},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;m.conditionalFeatures.featureEnabled("randomWidget")&&(m.models.genericMetric=new m.models.GenericMetric,m.views.genericMetric=new m.views.GenericMetric({model:m.models.genericMetric,region:"top-right",order:"append"}),m.widgets.push(m.views.genericMetric)),e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending())},50)},render:function(e){this.renderedOnce||(this.renderedOnce=!0,m.bootstrappers.RenderQuote(m,$,e),m.bootstrappers.RenderFocus(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.models.notificationManager.setParent(m.views.settingsPane),m.bootstrappers.RenderSearch(m,$),m.bootstrappers.RenderDashLinks(m,$),m.bootstrappers.RenderQuickLinks(m,$),m.bootstrappers.RenderBookmarks(m,$),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.bootstrappers.RenderTodos(m,$),m.bootstrappers.RenderWeather(m,$),m.trigger("main-render-complete"))},getViewById:function(t){var i=null;return _.each(m.widgets,function(e){e.el.id===t&&(i=e)}),i},removeView:function(t){_.each(m.widgets,function(e){e.el.id===t&&e.$el.fadeTo(500,0,function(){e.remove(),m.widgets.splice(m.widgets.indexOf(e),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){!function(){try{for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<1e3;i++)e+=t.charAt(Math.floor(Math.random()*t.length));localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(e){try{localStorage.removeItem("capacityTest");var o=Date.now()-1728e5,n=[],s=!1,a=null;for(i=0;i<localStorage.length;i++)s=!1,"last_cleanup"==(a=localStorage.key(i)).substring(0,12)&&(s=!0),"archived-"==a.substring(0,9)&&(s=!0),"fallback-"==a.substring(0,9)&&(s=!0),"listCache-"==a.substring(0,10)&&(s=!0),"font-"==a.substring(0,5)&&(s=!0),"image_displayed-"==a.substring(0,16)&&(s=!0),"weather-loc-"==a.substring(0,12)?s=!0:"ddl-bg-"==a.substring(0,7)?localStorage.getItem(a)<o&&(s=!0):"ddl-qt-"==a.substring(0,7)&&localStorage.getItem(a)<o&&(s=!0),s&&n.push(a);for(i=0;i<n.length;i++)localStorage.removeItem(n[i])}catch(e){}}}(),m.utils.captionFormatter=function(e){return e},m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.twoDigit=twoDigit,m.utils.mergeObjects=function(e,t,i){for(var o in e=e||{},t)e[o]=i&&e[o]||t[o];return e},m.utils.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},m.utils.toTodaysTime=function(e){var t=new Date,i=e.indexOf(":"),o=e.substring(0,i);return o=12==o?0:o,t.setHours(parseInt(o)+("p"===e[e.length-2].toLowerCase()?12:0)),t.setMinutes(parseInt(e.substring(i+1,e.length-2))),t},m.utils.memberwiseCompareObject=function(e,t,i){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var o in e)if((!i||!_.contains(i,o))&&e.hasOwnProperty(o)){if(!t.hasOwnProperty(o))return!1;if(e[o]!==t[o]){if("object"!=typeof e[o])return!1;if(!Object.equals(e[o],t[o]))return!1}}for(o in t)if((!i||!_.contains(i,o))&&t.hasOwnProperty(o)&&!e.hasOwnProperty(o))return!1;return!0},m.models.date=new m.models.Date;m.models.customization=new m.models.ComputedSettings({id:1}),m.listenToOnce(m.models.customization,"initialized",function(){m.sendEvent("/dashboard.html?v="+m.globals.version,null,null,"pageview");var e="installed-"+m.globals.version;localStorage.getItem(e)||localStorage.setItem(e,!0),window.onblur=function(){m.trigger("globalEvent:windowBlur")},$(document).click(function(e){m.trigger("globalEvent:click",e)}),$(document).keyup(function(e){27==e.keyCode&&m.trigger("globalEvent:esc",e),32==e.keyCode&&self.focusingOnBg&&(self.focusingOnBg=!1,m.views.backgroundInfo.unfocusBg(),$(".background-info-title, .background-info-source").removeClass("hotkey-hover")),"Alt"==e.key&&m.trigger("globalEvent:altUp",e)}),$(document).keydown(function(e){if(8==e.keyCode&&e.shiftKey&&e.metaKey&&m.trigger("globalEvent:metaBackspace",e),13==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaEnter",e),219==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketLeft",e),221==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketRight",e),78==e.keyCode&&e.ctrlKey&&m.trigger("globalEvent:ctrlN",e),e.altKey&&38==e.keyCode&&m.trigger("globalEvent:altArrowUp",e),e.altKey&&40==e.keyCode&&m.trigger("globalEvent:altArrowDown",e),!(e.ctrlKey||e.metaKey||e.altKey&&78!=e.keyCode||"INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName||1==document.activeElement.isContentEditable)){var t;if(76==e.keyCode)t="Quick Links";else if(70==e.keyCode)t="Focus";else if(84==e.keyCode)t="Todo";else if(83==e.keyCode)t="Search";else if(188==e.keyCode){if(e.metaKey)return;t="Settings"}else{if(67==e.keyCode&&isChrome())return t="Chrome Tab",m.sendEvent(t,"Hotkey"),void getBrowser().tabs.update({url:"chrome-search://local-ntp/local-ntp.html"});if(8==e.keyCode)m.trigger("globalEvent:key:backspace",e);else if(13==e.keyCode)m.trigger("globalEvent:key:enter",e);else if(32==e.keyCode){if(m.trigger("globalEvent:spacebar",e),m.views.todoPane&&m.views.todoPane.isHovered)return;self.focusingOnBg=!0,m.views.backgroundInfo.focusOnBg(),$(".background-info-title, .background-info-source").addClass("hotkey-hover")}else 38==e.keyCode?m.trigger("globalEvent:arrowUp",e):40==e.keyCode?m.trigger("globalEvent:arrowDown",e):37==e.keyCode?m.trigger("globalEvent:arrowLeft",e):65==e.keyCode?m.trigger("globalEvent:key:A",e):39==e.keyCode?m.trigger("globalEvent:arrowRight",e):78==e.keyCode&&e.shiftKey?m.trigger("globalEvent:key:shiftN",e):78!=e.keyCode||e.shiftKey||m.trigger("globalEvent:key:N",e)}87==e.keyCode?m.views.weather.togglePopup():66==e.keyCode?null!=getBrowser().topSites&&m.trigger("bookmarks:toggle",e):e.shiftKey&&191==e.keyCode&&m.commandManager.execute("settings.toggle",null,{section:"help"}),t&&(m.trigger("globalEvent:toggle"+t.replace(/\s+/g,"")),m.sendEvent(t,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.settingsManager=new m.models.SettingsManager,m.widgetManager=new m.models.WidgetManager,m.appView=new m.views.Dashboard,$(window).resize(function(){m.trigger("globalEvent:window:resize")}),localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.syncCoordinator=new m.models.SyncCoordinator,window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),m.syncCoordinator.syncSettings()}),m.models.customization.initializeSettings()});